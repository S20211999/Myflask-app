{% extends "base.html" %}
{% block title %}Footprint Database - License Manager{% endblock %}
{% block page_title %}Footprint Database{% endblock %}
{% block content %}

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body text-center">
                <h3>{{ total_footprints }}</h3>
                <p class="mb-0">Total Footprints</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body text-center">
                <h3>{{ package_stats|length }}</h3>
                <p class="mb-0">Package Types</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body text-center">
                <h3>{{ user_stats|length }}</h3>
                <p class="mb-0">Contributors</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body text-center">
                <h3>{{ table_widgets|length }}</h3>
                <p class="mb-0">Table Widgets</p>
            </div>
        </div>
    </div>
</div>

<!-- Package Type Filter -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Filter by Package Type</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-2 mb-2">
                        <button class="btn btn-outline-primary w-100" onclick="filterByPackage('all')">
                            All Types ({{ total_footprints }})
                        </button>
                    </div>
                    {% for package, count in package_stats.items() %}
                    <div class="col-md-2 mb-2">
                        <button class="btn btn-outline-secondary w-100" onclick="filterByPackage('{{ package }}')">
                            {{ package }} ({{ count }})
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Table Widgets Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Package-Specific Database Tables</h5>
                {% if current_user.is_admin %}
                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addTableModal">
                    <i class="fas fa-plus me-1"></i>
                    Add Table Widget
                </button>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Predefined Package Widgets -->
                    <div class="col-md-4 mb-3">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">Discrete Normal</h6>
                            </div>
                            <div class="card-body">
                                <p class="card-text">Table: DiscreteNFootprint</p>
                                <p class="card-text"><small class="text-muted">Count: {{ package_stats.get('DiscreteN', 0) }}</small></p>
                                <a href="{{ url_for('footprint_by_package', package_type='DiscreteN') }}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-table me-1"></i>View Details
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0">Discrete Fillet</h6>
                            </div>
                            <div class="card-body">
                                <p class="card-text">Table: DiscreteFFootprint</p>
                                <p class="card-text"><small class="text-muted">Count: {{ package_stats.get('DiscreteF', 0) }}</small></p>
                                <a href="{{ url_for('footprint_by_package', package_type='DiscreteF') }}" class="btn btn-sm btn-success">
                                    <i class="fas fa-table me-1"></i>View Details
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">SOT-23 Normal</h6>
                            </div>
                            <div class="card-body">
                                <p class="card-text">Table: Sot23NFootprint</p>
                                <p class="card-text"><small class="text-muted">Count: {{ package_stats.get('Sot23N', 0) }}</small></p>
                                <a href="{{ url_for('footprint_by_package', package_type='Sot23N') }}" class="btn btn-sm btn-info">
                                    <i class="fas fa-table me-1"></i>View Details
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-white">
                                <h6 class="mb-0">SOT-23 Normal MPE</h6>
                            </div>
                            <div class="card-body">
                                <p class="card-text">Table: Sot23NMPEFootprint</p>
                                <p class="card-text"><small class="text-muted">Count: {{ package_stats.get('Sot23NMPE', 0) }}</small></p>
                                <a href="{{ url_for('footprint_by_package', package_type='Sot23NMPE') }}" class="btn btn-sm btn-warning">
                                    <i class="fas fa-table me-1"></i>View Details
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <div class="card border-secondary">
                            <div class="card-header bg-secondary text-white">
                                <h6 class="mb-0">SOT-23 Fillet</h6>
                            </div>
                            <div class="card-body">
                                <p class="card-text">Table: Sot23FFootprint</p>
                                <p class="card-text"><small class="text-muted">Count: {{ package_stats.get('Sot23F', 0) }}</small></p>
                                <a href="{{ url_for('footprint_by_package', package_type='Sot23F') }}" class="btn btn-sm btn-secondary">
                                    <i class="fas fa-table me-1"></i>View Details
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Custom Table Widgets -->
                    {% for widget in table_widgets %}
                    <div class="col-md-4 mb-3">
                        <div class="card border-dark">
                            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">{{ widget.widget_name }}</h6>
                                {% if current_user.is_admin %}
                                <a href="{{ url_for('delete_table_widget', widget_id=widget.id) }}" 
                                   class="btn btn-sm btn-outline-light"
                                   onclick="return confirm('Are you sure you want to delete this widget?')">
                                    <i class="fas fa-trash"></i>
                                </a>
                                {% endif %}
                            </div>
                            <div class="card-body">
                                <p class="card-text">Table: {{ widget.table_name }}</p>
                                <p class="card-text"><small class="text-muted">Created: {{ widget.created_at.strftime('%Y-%m-%d') }}</small></p>
                                <button class="btn btn-sm btn-dark" onclick="viewTable('{{ widget.table_name }}')">
                                    <i class="fas fa-table me-1"></i>View Table
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Footprint Table -->
<div class="row">
    <div class="col-md-9">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">All Footprints Overview</h5>
                <div class="d-flex gap-2">
                    <div class="input-group" style="width: 300px;">
                        <input type="text" class="form-control" id="searchInput" placeholder="Search footprints...">
                        <button class="btn btn-outline-secondary" type="button" onclick="searchFootprints()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <button class="btn btn-outline-primary" onclick="exportToCSV()">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="footprintTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0)">Part Number <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable(1)">Footprint Name <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable(2)">Package Type <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable(3)">Created By <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable(4)">Created Date <i class="fas fa-sort"></i></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for footprint in footprints %}
                            <tr data-package="{{ footprint.package_type }}">
                                <td>{{ footprint.part_number or 'N/A' }}</td>
                                <td>{{ footprint.footprint_name or 'N/A' }}</td>
                                <td>
                                    <span class="badge bg-secondary">{{ footprint.package_type }}</span>
                                </td>
                                <td>{{ footprint.user_created or 'Unknown' }}</td>
                                <td>{{ footprint.created_at.strftime('%Y-%m-%d %H:%M') if footprint.created_at else 'N/A' }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-primary" onclick="viewFootprint({{ footprint.id }})" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-info" onclick="viewSpecs({{ footprint.id }})" title="View Specifications">
                                            <i class="fas fa-cogs"></i>
                                        </button>
                                        <a href="{{ url_for('footprint_by_package', package_type=footprint.package_type) }}" 
                                           class="btn btn-outline-success" title="View Package Details">
                                            <i class="fas fa-table"></i>
                                        </a>
                                        {% if current_user.is_admin %}
                                        <button class="btn btn-outline-danger" onclick="deleteFootprint({{ footprint.id }})" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center text-muted">
                                    <i class="fas fa-inbox fa-3x mb-3"></i>
                                    <h5>No footprints found</h5>
                                    <p>Start generating footprints using the PySide6 application to see them here.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Statistics Sidebar -->
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Package Statistics</h5>
            </div>
            <div class="card-body">
                {% for package, count in package_stats.items() %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <a href="{{ url_for('footprint_by_package', package_type=package) }}" class="text-decoration-none">
                        {{ package }}
                    </a>
                    <span class="badge bg-primary">{{ count }}</span>
                </div>
                {% else %}
                <div class="text-center text-muted">
                    <i class="fas fa-chart-pie mb-2"></i>
                    <p>No package data available</p>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">User Contributions</h5>
            </div>
            <div class="card-body">
                {% for user, count in user_stats.items() %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>{{ user }}</span>
                    <span class="badge bg-success">{{ count }}</span>
                </div>
                {% else %}
                <div class="text-center text-muted">
                    <i class="fas fa-users mb-2"></i>
                    <p>No user data available</p>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Recent Activity -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">Recent Activity</h5>
            </div>
            <div class="card-body">
                {% set recent_footprints = footprints[:5] %}
                {% for footprint in recent_footprints %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small>{{ footprint.footprint_name[:20] }}{% if footprint.footprint_name|length > 20 %}...{% endif %}</small>
                    <small class="text-muted">{{ footprint.created_at.strftime('%m-%d') if footprint.created_at else '' }}</small>
                </div>
                {% else %}
                <div class="text-center text-muted">
                    <i class="fas fa-clock mb-2"></i>
                    <p>No recent activity</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Add Table Widget Modal -->
<div class="modal fade" id="addTableModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Custom Table Widget</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_table_widget') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="table_name" class="form-label">Table Name</label>
                        <input type="text" class="form-control" id="table_name" name="table_name" required>
                        <div class="form-text">Enter the actual database table name (e.g., CustomPackageFootprint)</div>
                    </div>
                    <div class="mb-3">
                        <label for="widget_name" class="form-label">Widget Display Name</label>
                        <input type="text" class="form-control" id="widget_name" name="widget_name" required>
                        <div class="form-text">Enter a user-friendly name for the widget (e.g., Custom Package)</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Widget</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Footprint Modal -->
<div class="modal fade" id="viewFootprintModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Footprint Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="footprintDetails">
                <!-- Content loaded via JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- View Specifications Modal -->
<div class="modal fade" id="viewSpecsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Footprint Specifications</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="specsDetails">
                <!-- Content loaded via JavaScript -->
            </div>
        </div>
    </div>
</div>

<script>
// Search functionality
function searchFootprints() {
    const input = document.getElementById('searchInput');
    const filter = input.value.toUpperCase();
    const table = document.getElementById('footprintTable');
    const tr = table.getElementsByTagName('tr');
    
    for (let i = 1; i < tr.length; i++) {
        const td = tr[i].getElementsByTagName('td');
        let txtValue = '';
        for (let j = 0; j < td.length - 1; j++) {
            txtValue += td[j].textContent || td[j].innerText;
        }
        if (txtValue.toUpperCase().indexOf(filter) > -1) {
            tr[i].style.display = '';
        } else {
            tr[i].style.display = 'none';
        }
    }
}

// Filter by package type
function filterByPackage(packageType) {
    const table = document.getElementById('footprintTable');
    const tr = table.getElementsByTagName('tr');
    
    for (let i = 1; i < tr.length; i++) {
        const row = tr[i];
        const packageData = row.getAttribute('data-package');
        
        if (packageType === 'all' || packageData === packageType) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    }
    
    // Update active button
    document.querySelectorAll('.btn-outline-primary, .btn-outline-secondary').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
    });
    event.target.classList.remove('btn-outline-primary');
    event.target.classList.add('btn-primary');
}

// Sort table functionality
function sortTable(n) {
    const table = document.getElementById("footprintTable");
    let rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
    switching = true;
    dir = "asc";
    
    while (switching) {
        switching = false;
        rows = table.rows;
        
        for (i = 1; i < (rows.length - 1); i++) {
            shouldSwitch = false;
            x = rows[i].getElementsByTagName("TD")[n];
            y = rows[i + 1].getElementsByTagName("TD")[n];
            
            if (dir == "asc") {
                if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                    shouldSwitch = true;
                    break;
                }
            } else if (dir == "desc") {
                if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                    shouldSwitch = true;
                    break;
                }
            }
        }
        
        if (shouldSwitch) {
            rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
            switching = true;
            switchcount++;
        } else {
            if (switchcount == 0 && dir == "asc") {
                dir = "desc";
                switching = true;
            }
        }
    }
}

// View functions
function viewTable(tableName) {
    // This could be enhanced to show a modal with table data
    window.open(`/footprint/table/${tableName}`, '_blank');
}

function viewFootprint(id) {
    // Load footprint details via AJAX
    fetch(`/api/footprint/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const footprint = data.footprint;
                document.getElementById('footprintDetails').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Basic Information</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Part Number:</strong></td><td>${footprint.part_number || 'N/A'}</td></tr>
                                <tr><td><strong>Footprint Name:</strong></td><td>${footprint.footprint_name || 'N/A'}</td></tr>
                                <tr><td><strong>Package Type:</strong></td><td>${footprint.package_type}</td></tr>
                                <tr><td><strong>Created By:</strong></td><td>${footprint.user_created || 'Unknown'}</td></tr>
                                <tr><td><strong>Created Date:</strong></td><td>${new Date(footprint.created_at).toLocaleString()}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Description</h6>
                            <p>${footprint.description || 'No description available'}</p>
                        </div>
                    </div>
                `;
                new bootstrap.Modal(document.getElementById('viewFootprintModal')).show();
            }
        })
        .catch(error => {
            alert('Error loading footprint details');
            console.error('Error:', error);
        });
}

function viewSpecs(id) {
    // Load specifications via AJAX
    fetch(`/api/footprint/${id}/specs`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const specs = data.specifications;
                let specsHtml = '<div class="row">';
                
                if (specs && Object.keys(specs).length > 0) {
                    specsHtml += '<div class="col-12"><h6>Technical Specifications</h6><table class="table table-sm table-striped">';
                    for (const [key, value] of Object.entries(specs)) {
                        specsHtml += `<tr><td><strong>${key.replace(/_/g, ' ').toUpperCase()}:</strong></td><td>${value}</td></tr>`;
                    }
                    specsHtml += '</table>';
                } else {
                    specsHtml += '<div class="col-12"><p class="text-muted">No specifications available</p>';
                }
                
                specsHtml += '</div></div>';
                
                document.getElementById('specsDetails').innerHTML = specsHtml;
                new bootstrap.Modal(document.getElementById('viewSpecsModal')).show();
            }
        })
        .catch(error => {
            alert('Error loading specifications');
            console.error('Error:', error);
        });
}

function deleteFootprint(id) {
    if (confirm('Are you sure you want to delete this footprint?')) {
        fetch(`/api/footprint/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert('Error deleting footprint: ' + data.message);
            }
        });
    }
}

function exportToCSV() {
    const table = document.getElementById('footprintTable');
    const rows = Array.from(table.querySelectorAll('tr:not([style*="display: none"])'));
    
    let csv = [];
    for (let i = 0; i < rows.length; i++) {
        const row = [], cols = rows[i].querySelectorAll('td, th');
        for (let j = 0; j < cols.length - 1; j++) { // Skip actions column
            row.push('"' + cols[j].innerText.replace(/"/g, '""') + '"');
        }
        csv.push(row.join(','));
    }
    
    const csvContent = csv.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('hidden', '');
    a.setAttribute('href', url);
    a.setAttribute('download', 'footprints_' + new Date().toISOString().split('T')[0] + '.csv');
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// Initialize search on Enter key
document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchFootprints();
    }
});
</script>

<style>
.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.card-header {
    background-color: rgba(0, 0, 0, 0.03);
    border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}

th {
    cursor: pointer;
    user-select: none;
}

th:hover {
    background-color: rgba(0, 0, 0, 0.05);
}

.badge {
    font-size: 0.75em;
}

.btn-group-sm > .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.05);
}
</style>

{% endblock %}
