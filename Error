from flask import Flask, render_template, request, jsonify, session, redirect, url_for, send_file
from openpyxl import Workbook
from openpyxl.styles import Font, Alignment, PatternFill, Border, Side
from openpyxl.utils import get_column_letter
from io import BytesIO
from flask_sqlalchemy import SQLAlchemy
from werkzeug.security import generate_password_hash, check_password_hash
from datetime import datetime, timedelta
from functools import wraps
import secrets
import json

app = Flask(__name__)
app.secret_key = secrets.token_hex(32)
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///dashboard.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

db = SQLAlchemy(app)

# ============================================================================
# Database Models
# ============================================================================

class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(80), unique=True, nullable=False)
    email = db.Column(db.String(120), unique=True, nullable=False)
    password_hash = db.Column(db.String(200), nullable=False)
    role = db.Column(db.String(20), default='employee')  # admin, manager, employee
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

class Project(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(200), nullable=False)
    description = db.Column(db.Text)
    status = db.Column(db.String(20), default='active')
    start_date = db.Column(db.Date)
    end_date = db.Column(db.Date)
    progress = db.Column(db.Integer, default=0)
    created_by = db.Column(db.Integer, db.ForeignKey('user.id'))
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    working_saturdays = db.Column(db.Text, default='[]')
    current_reschedule_number = db.Column(db.Integer, default=0)  # ‚úÖ ADD THIS LINE    # Store as JSON array

class ProjectStage(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    project_id = db.Column(db.Integer, db.ForeignKey('project.id'), nullable=False)
    name = db.Column(db.String(100), nullable=False)
    order = db.Column(db.Integer, nullable=False)
    duration_days = db.Column(db.Integer, default=0)
    status = db.Column(db.String(20), default='pending')
    progress = db.Column(db.Integer, default=0)
    start_date = db.Column(db.Date)
    end_date = db.Column(db.Date)
    manager_id = db.Column(db.Integer, db.ForeignKey('user.id'))  # ADD THIS LINE

class ProjectMember(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    project_id = db.Column(db.Integer, db.ForeignKey('project.id'), nullable=False)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    added_at = db.Column(db.DateTime, default=datetime.utcnow)

class Task(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    title = db.Column(db.String(200), nullable=False)
    description = db.Column(db.Text)
    project_id = db.Column(db.Integer, db.ForeignKey('project.id'))
    assigned_to = db.Column(db.Integer, db.ForeignKey('user.id'))
    priority = db.Column(db.String(20), default='medium')  # low, medium, high
    status = db.Column(db.String(20), default='pending')  # pending, in-progress, completed
    deadline = db.Column(db.Date)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    completed_at = db.Column(db.DateTime)

class ScheduleHistory(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    project_id = db.Column(db.Integer, db.ForeignKey('project.id'), nullable=False)
    stage_id = db.Column(db.Integer, db.ForeignKey('project_stage.id'))
    reschedule_number = db.Column(db.Integer, default=1)  # ‚úÖ ADD THIS
    original_date = db.Column(db.Date)
    new_date = db.Column(db.Date)
    reason = db.Column(db.Text)
    rescheduled_by = db.Column(db.Integer, db.ForeignKey('user.id'))
    rescheduled_at = db.Column(db.DateTime, default=datetime.utcnow)

class Notification(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    message = db.Column(db.Text, nullable=False)
    is_read = db.Column(db.Boolean, default=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

class ActivityLog(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    action = db.Column(db.String(200), nullable=False)
    timestamp = db.Column(db.DateTime, default=datetime.utcnow)

class StageDailyTask(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    stage_id = db.Column(db.Integer, db.ForeignKey('project_stage.id'), nullable=False)
    project_id = db.Column(db.Integer, db.ForeignKey('project.id'), nullable=False)
    day_number = db.Column(db.Integer, nullable=False)  # 1, 2, 3, etc.
    scheduled_date = db.Column(db.Date, nullable=False)
    original_date = db.Column(db.Date)  # Track if rescheduled
    status = db.Column(db.String(20), default='pending')  # pending, completed, rescheduled
    completed_at = db.Column(db.DateTime)
    rescheduled_reason = db.Column(db.Text)
    reschedule_count = db.Column(db.Integer, default=0)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

class DailyTaskRescheduleHistory(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    project_id = db.Column(db.Integer, db.ForeignKey('project.id'), nullable=False)
    stage_id = db.Column(db.Integer, db.ForeignKey('project_stage.id'), nullable=False)
    task_id = db.Column(db.Integer, db.ForeignKey('stage_daily_task.id'), nullable=False)
    day_number = db.Column(db.Integer, nullable=False)
    reschedule_number = db.Column(db.Integer, default=1)  # ‚úÖ ADD THIS
    original_date = db.Column(db.Date, nullable=False)
    new_date = db.Column(db.Date, nullable=False)
    days_shifted = db.Column(db.Integer, nullable=False)
    reason = db.Column(db.Text)
    rescheduled_by = db.Column(db.Integer, db.ForeignKey('user.id'))
    rescheduled_at = db.Column(db.DateTime, default=datetime.utcnow)


class HoldDate(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    project_id = db.Column(db.Integer, db.ForeignKey('project.id'), nullable=False)
    stage_id = db.Column(db.Integer, db.ForeignKey('project_stage.id'), nullable=False)
    hold_date = db.Column(db.Date, nullable=False)  # The date that became HOLD
    reason = db.Column(db.Text)  # Why it's on hold
    created_by = db.Column(db.Integer, db.ForeignKey('user.id'))
    created_at = db.Column(db.DateTime, default=datetime.utcnow)


# ============================================================================
# Default Stages Configuration
# ============================================================================

DEFAULT_STAGES = [
    {'name': 'Foot prints - library - FP-LIB', 'order': 1, 'duration_days': 3},
    {'name': 'Scrubbing - SCRB', 'order': 2, 'duration_days': 2},
    {'name': 'Schematic - SCH', 'order': 3, 'duration_days': 7},
    {'name': 'Length Matching - LM', 'order': 4, 'duration_days': 4},
    {'name': 'Deliverables - DLBS', 'order': 5, 'duration_days': 3},
    {'name': 'Placement - PLC', 'order': 6, 'duration_days': 5},  # Added comma
    {'name': 'Placement - review - PLC-R', 'order': 7, 'duration_days': 3},  # Changed order to 7
    {'name': 'Routing - RTNG', 'order': 8, 'duration_days': 2},  # Fixed syntax and order
    {'name': 'Routing - Review - RTNG-R', 'order': 9, 'duration_days': 7},  # Changed order to 9
    {'name': 'Post Screen - P-SI', 'order': 10, 'duration_days': 4},  # Changed order to 10
    {'name': 'Fan out - FNT', 'order': 11, 'duration_days': 3},  # Changed order to 11
    {'name': 'Silk Screen - SLK', 'order': 12, 'duration_days': 5},  # Added comma, changed order to 12
    {'name': 'Approval - APRVL', 'order': 13, 'duration_days': 3},  # Changed order to 13
    {'name': 'Fab setup - FB-STP', 'order': 14, 'duration_days': 5}  # Changed order to 14
]

# ============================================================================
# Helper Functions
# ============================================================================

def login_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session:
            return redirect(url_for('login'))
        return f(*args, **kwargs)
    return decorated_function

def get_current_user():
    if 'user_id' in session:
        return User.query.get(session['user_id'])
    return None

def log_activity(action):
    user = get_current_user()
    if user:
        log = ActivityLog(user_id=user.id, action=action)
        db.session.add(log)
        db.session.commit()

def create_notification(user_id, message):
    notification = Notification(user_id=user_id, message=message)
    db.session.add(notification)
    db.session.commit()

def is_working_day(date, include_saturday=False, working_saturdays=None):
    """Check if a date is a working day"""
    if working_saturdays is None:
        working_saturdays = set()
        
    weekday = date.weekday()
    date_str = date.strftime('%Y-%m-%d')
    
    if weekday == 6:  # Sunday
        return False
    if weekday == 5:  # Saturday
        return date_str in working_saturdays
    return True

def add_working_days(start_date, days, include_saturday=False, working_saturdays=None):
    """Add working days to a date, properly handling working Saturdays"""
    if working_saturdays is None:
        working_saturdays = set()
        
    if days == 0:
        return start_date
        
    current_date = start_date
    direction = 1 if days > 0 else -1
    days_remaining = abs(days)
    
    while days_remaining > 0:
        current_date = current_date + timedelta(days=direction)
        if is_working_day(current_date, include_saturday, working_saturdays):
            days_remaining -= 1
    
    return current_date

def get_next_working_day(date, include_saturday=False, working_saturdays=None):
    """Get the next working day from a given date"""
    if working_saturdays is None:
        working_saturdays = set()
    check_date = date
    while not is_working_day(check_date, include_saturday, working_saturdays):
        check_date = check_date + timedelta(days=1)
    return check_date

def calculate_stage_dates(project_start_date, stages_data, include_saturday=False, working_saturdays=None):
    """Calculate start and end dates for each stage based on working days (excluding weekends)"""
    
    if working_saturdays is None:
        working_saturdays = set()
    
    calculated_stages = []
    current_date = get_next_working_day(project_start_date, False, working_saturdays)
    
    for stage_info in stages_data:
        stage_start = stage_info.get('start_date')
        
        if stage_start:
            # Custom start date provided
            custom_start = datetime.strptime(stage_start, '%Y-%m-%d').date()
            stage_start_date = get_next_working_day(custom_start, False, working_saturdays)
        else:
            # Use current date
            stage_start_date = current_date
        
        # Calculate end date based on duration
        duration = stage_info.get('duration_days', 1)
        if duration > 0:
            stage_end_date = add_working_days(stage_start_date, duration - 1, False, working_saturdays)
        else:
            stage_end_date = stage_start_date
        
        calculated_stages.append({
            'name': stage_info['name'],
            'order': stage_info['order'],
            'duration_days': duration,
            'start_date': stage_start_date,
            'end_date': stage_end_date
        })
        
        # If no custom start date, update current_date for next stage
        if not stage_start:
            current_date = add_working_days(stage_end_date, 1, False, working_saturdays)
    
    return calculated_stages

def generate_daily_tasks_for_project(project_id, working_saturdays=None):
    """Generate daily tasks for all stages in a project"""
    if working_saturdays is None:
        working_saturdays = set()
    
    project = Project.query.get(project_id)
    if not project:
        raise ValueError(f"Project {project_id} not found")
    
    stages = ProjectStage.query.filter_by(project_id=project_id).order_by(ProjectStage.order).all()
    
    for stage in stages:
        # Delete existing daily tasks for this stage (in case of regeneration)
        StageDailyTask.query.filter_by(stage_id=stage.id).delete()
        
        if not stage.start_date or not stage.end_date:
            continue
        
        # Generate daily tasks
        current_date = stage.start_date
        day_number = 1
        
        while current_date <= stage.end_date:
            # Only create task for working days
            if is_working_day(current_date, False, working_saturdays):
                daily_task = StageDailyTask(
                    stage_id=stage.id,
                    project_id=project_id,
                    day_number=day_number,
                    scheduled_date=current_date,
                    status='pending'
                )
                db.session.add(daily_task)
                day_number += 1
            
            current_date = current_date + timedelta(days=1)
    
    # Don't commit here - let the caller handle the commit
    db.session.flush()

# ============================================================================
# Routes
# ============================================================================

@app.route('/')
@login_required
def index():
    return redirect(url_for('dashboard'))

@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        data = request.get_json()
        username = data.get('username')
        password = data.get('password')
        
        user = User.query.filter_by(username=username).first()
        
        if user and check_password_hash(user.password_hash, password):
            session['user_id'] = user.id
            session['username'] = user.username
            return jsonify({'success': True})
        
        return jsonify({'success': False, 'message': 'Invalid credentials'}), 401
    
    return render_template('login.html')

@app.route('/logout')
def logout():
    session.clear()
    return redirect(url_for('login'))

@app.route('/dashboard')
@login_required
def dashboard():
    user = get_current_user()
    return render_template('index.html', current_user=user)

@app.route('/stage_popup.html')
def stage_popup():
    return render_template('stage_popup.html')

# ============================================================================
# API Endpoints
# ============================================================================

@app.route('/api/default-stages', methods=['GET'])
@login_required
def get_default_stages():
    """Return default stages for frontend"""
    return jsonify(DEFAULT_STAGES)

@app.route('/api/stats', methods=['GET'])
@login_required
def get_stats():
    total_projects = Project.query.count()
    active_projects = Project.query.filter_by(status='active').count()
    total_tasks = Task.query.count()
    completed_tasks = Task.query.filter_by(status='completed').count()
    total_employees = User.query.filter_by(role='employee').count()
    
    return jsonify({
        'total_projects': total_projects,
        'active_projects': active_projects,
        'total_tasks': total_tasks,
        'completed_tasks': completed_tasks,
        'total_employees': total_employees
    })

@app.route('/api/projects', methods=['GET', 'POST'])
@login_required
def projects():
    if request.method == 'POST':
        data = request.get_json()
        user = get_current_user()
        
        try:
            project_start_date = datetime.strptime(data['start_date'], '%Y-%m-%d').date() if data.get('start_date') else datetime.now().date()

            include_saturday = data.get('include_saturday', False)
            working_saturdays = set(data.get('working_saturdays', []))
            
            # Calculate stage dates based on duration
            stages_data = data.get('stages', [])
            calculated_stages = calculate_stage_dates(project_start_date, stages_data, include_saturday, working_saturdays)

            # Calculate project end date from last stage
            project_end_date = calculated_stages[-1]['end_date'] if calculated_stages else project_start_date
            
            project = Project(
                name=data['name'],
                description=data.get('description', ''),
                start_date=project_start_date,
                end_date=project_end_date,
                created_by=user.id,
                working_saturdays=json.dumps(list(working_saturdays))
            )
            db.session.add(project)
            db.session.flush()


            
            # Add stages with calculated dates
            for stage_data in calculated_stages:
                stage = ProjectStage(
                    project_id=project.id,
                    name=stage_data['name'],
                    order=stage_data['order'],
                    duration_days=stage_data.get('duration_days', 0),
                    start_date=stage_data['start_date'],
                    end_date=stage_data['end_date'],
                    manager_id=stage_data.get('manager_id')  # ADD THIS LINE
                )
                db.session.add(stage)
                            
            # Add project members
            member_ids = data.get('members', [])
            for member_id in member_ids:
                member = ProjectMember(
                    project_id=project.id,
                    user_id=member_id
                )
                db.session.add(member)
                create_notification(member_id, f"You have been added to job: {project.name}")
            
            db.session.commit()
            
        # ‚úÖ NEW: Generate daily tasks immediately after project creation
            try:
                generate_daily_tasks_for_project(project.id, working_saturdays)
                print(f"\u2714 Generated daily tasks for project {project.id}")
            except Exception as e:
                print(f"Warning: Could not generate daily tasks: {e}")            
            log_activity(f"Created job: {project.name}")
            
            return jsonify({'success': True, 'id': project.id}), 201
        except Exception as e:
            db.session.rollback()
            print(f"Error creating project: {str(e)}")
            import traceback
            traceback.print_exc()
            return jsonify({'error': str(e)}), 400
    
    # GET - Return list of all projects
    projects = Project.query.order_by(Project.created_at.desc()).all()
    return jsonify([{
        'id': p.id,
        'name': p.name,
        'description': p.description,
        'status': p.status,
        'progress': p.progress,
        'start_date': p.start_date.isoformat() if p.start_date else None,
        'end_date': p.end_date.isoformat() if p.end_date else None
    } for p in projects])



@app.route('/api/projects/<int:project_id>/details', methods=['GET'])
@login_required
def project_details(project_id):
    project = Project.query.get_or_404(project_id)
    stages = ProjectStage.query.filter_by(project_id=project_id).order_by(ProjectStage.order).all()
    tasks = Task.query.filter_by(project_id=project_id).all()
    schedule_history = ScheduleHistory.query.filter_by(project_id=project_id).order_by(ScheduleHistory.rescheduled_at.desc()).all()
    members = ProjectMember.query.filter_by(project_id=project_id).all()
    
    # Parse working Saturdays
    try:
        if project.working_saturdays:
            working_saturdays = json.loads(project.working_saturdays)
        else:
            working_saturdays = []
    except:
        working_saturdays = []
    
    # Calculate task stats
    task_stats = {
        'pending': sum(1 for t in tasks if t.status == 'pending'),
        'in-progress': sum(1 for t in tasks if t.status == 'in-progress'),
        'completed': sum(1 for t in tasks if t.status == 'completed')
    }
    
    # Calculate stage completion
    completed_stages = sum(1 for s in stages if s.status == 'completed')
    
    return jsonify({
        'id': project.id,
        'name': project.name,
        'description': project.description,
        'status': project.status,
        'progress': project.progress,
        'start_date': project.start_date.isoformat() if project.start_date else None,
        'end_date': project.end_date.isoformat() if project.end_date else None,
        'saturdayWorkingDays': working_saturdays,
        'stages': [{
            'id': s.id,
            'name': s.name,
            'order': s.order,
            'duration_days': s.duration_days,
            'status': s.status,
            'progress': s.progress,
            'start_date': s.start_date.isoformat() if s.start_date else None,
            'end_date': s.end_date.isoformat() if s.end_date else None
        } for s in stages],
        'members': [{
            'id': User.query.get(m.user_id).id,
            'username': User.query.get(m.user_id).username,
            'email': User.query.get(m.user_id).email
        } for m in members],
        'task_stats': task_stats,
        'stage_completion': {
            'completed': completed_stages,
            'total': len(stages)
        },
        'schedule_history': [{
            'original_date': h.original_date.isoformat() if h.original_date else None,
            'new_date': h.new_date.isoformat() if h.new_date else None,
            'reason': h.reason,
            'rescheduled_by': User.query.get(h.rescheduled_by).username if h.rescheduled_by else 'Unknown',
            'rescheduled_at': h.rescheduled_at.strftime('%Y-%m-%d %H:%M')
        } for h in schedule_history]
    })

@app.route('/api/tasks', methods=['GET', 'POST'])
@login_required
def tasks():
    if request.method == 'POST':
        data = request.get_json()
        
        try:
            task = Task(
                title=data['title'],
                description=data.get('description', ''),
                project_id=data.get('project_id'),
                assigned_to=data.get('assigned_to'),
                priority=data.get('priority', 'medium'),
                deadline=datetime.strptime(data['deadline'], '%Y-%m-%d').date() if data.get('deadline') else None
            )
            db.session.add(task)
            db.session.commit()
            
            log_activity(f"Created task: {task.title}")
            
            # Notify assigned user
            if task.assigned_to:
                create_notification(task.assigned_to, f"New task assigned: {task.title}")
            
            return jsonify({'success': True, 'id': task.id}), 201
        except Exception as e:
            db.session.rollback()
            return jsonify({'error': str(e)}), 400
    
    # GET
    tasks = Task.query.order_by(Task.created_at.desc()).all()
    return jsonify([{
        'id': t.id,
        'title': t.title,
        'description': t.description,
        'project': Project.query.get(t.project_id).name if t.project_id else None,
        'assigned_to': User.query.get(t.assigned_to).username if t.assigned_to else None,
        'priority': t.priority,
        'status': t.status,
        'deadline': t.deadline.isoformat() if t.deadline else None
    } for t in tasks])

@app.route('/api/tasks/<int:task_id>/status', methods=['PUT'])
@login_required
def update_task_status(task_id):
    task = Task.query.get_or_404(task_id)
    data = request.get_json()
    
    task.status = data['status']
    if data['status'] == 'completed':
        task.completed_at = datetime.utcnow()
    
    db.session.commit()
    log_activity(f"Updated task status: {task.title} to {task.status}")
    
    return jsonify({'success': True})

@app.route('/api/employees', methods=['GET'])
@login_required
def employees():
    users = User.query.all()
    return jsonify([{
        'id': u.id,
        'username': u.username,
        'email': u.email,
        'role': u.role
    } for u in users])

@app.route('/api/notifications', methods=['GET'])
@login_required
def notifications():
    user = get_current_user()
    notifications = Notification.query.filter_by(user_id=user.id).order_by(Notification.created_at.desc()).limit(10).all()
    
    return jsonify([{
        'id': n.id,
        'message': n.message,
        'is_read': n.is_read,
        'created_at': n.created_at.strftime('%Y-%m-%d %H:%M')
    } for n in notifications])

@app.route('/api/notifications/<int:notification_id>/read', methods=['PUT'])
@login_required
def mark_notification_read(notification_id):
    notification = Notification.query.get_or_404(notification_id)
    notification.is_read = True
    db.session.commit()
    return jsonify({'success': True})

@app.route('/api/activity-logs', methods=['GET'])
@login_required
def activity_logs():
    logs = ActivityLog.query.order_by(ActivityLog.timestamp.desc()).limit(10).all()
    
    return jsonify([{
        'user': User.query.get(l.user_id).username,
        'action': l.action,
        'timestamp': l.timestamp.strftime('%Y-%m-%d %H:%M')
    } for l in logs])

@app.route('/api/projects/<int:project_id>/stages/<int:stage_id>', methods=['PUT'])
@login_required
def update_stage_status(project_id, stage_id):
    stage = ProjectStage.query.get_or_404(stage_id)
    data = request.get_json()
    
    old_status = stage.status
    stage.status = data['status']
    
    # Update progress percentage
    if stage.status == 'in-progress':
        stage.progress = 50
    elif stage.status == 'completed':
        stage.progress = 100
    else:
        stage.progress = 0
    
    db.session.commit()
    
    # Update project progress
    update_project_progress(project_id)
    
    log_activity(f"Updated stage '{stage.name}' status from {old_status} to {stage.status}")
    
    return jsonify({'success': True})

def update_project_progress(project_id):
    """Calculate and update project progress based on stages"""
    stages = ProjectStage.query.filter_by(project_id=project_id).all()
    
    if not stages:
        return
    
    total_progress = sum(stage.progress for stage in stages)
    average_progress = total_progress // len(stages) if stages else 0
    
    project = Project.query.get(project_id)
    project.progress = average_progress
    
    # Auto-update project status
    completed_stages = sum(1 for s in stages if s.status == 'completed')
    if completed_stages == len(stages):
        project.status = 'completed'
    elif any(s.status == 'in-progress' for s in stages):
        project.status = 'active'
    
    db.session.commit()

@app.route('/api/projects/<int:project_id>/reschedule', methods=['POST'])
@login_required
def reschedule_stage(project_id):
    data = request.get_json()
    stage_id = data.get('stage_id')
    days = data.get('days', 0)
    reason = data.get('reason', '')
    working_saturdays = set(data.get('working_saturdays', []))
    
    try:
        project = Project.query.get_or_404(project_id)
        stage = ProjectStage.query.get_or_404(stage_id)
        
        # ‚úÖ INCREMENT GLOBAL RESCHEDULE COUNTER
        project.current_reschedule_number += 1
        global_reschedule_num = project.current_reschedule_number
        
        print(f"\nüìã RESCHEDULE REQUEST:")
        print(f"   Stage: {stage.name}")
        print(f"   Global Reschedule Number: {global_reschedule_num}")
        
        # Store EXACT original dates BEFORE any modifications
        original_start_date = stage.start_date
        original_end_date = stage.end_date
        
        print(f"   Original dates: {original_start_date} to {original_end_date}")
        print(f"   Shift: {days} days")
        
        # Calculate which dates will become HOLD
        if days != 0 and original_start_date and original_end_date:
            # Get all original working dates
            original_dates = set()
            current = original_start_date
            while current <= original_end_date:
                if is_working_day(current, False, working_saturdays):
                    original_dates.add(current)
                current += timedelta(days=1)
            
            # Calculate new dates
            new_start = add_working_days(original_start_date, days, False, working_saturdays)
            new_end = add_working_days(original_end_date, days, False, working_saturdays)
            
            new_dates = set()
            current = new_start
            while current <= new_end:
                if is_working_day(current, False, working_saturdays):
                    new_dates.add(current)
                current += timedelta(days=1)
            
            # HOLD dates = dates that were in original but NOT in new schedule
            hold_dates = original_dates - new_dates
            
            print(f"   New dates: {new_start} to {new_end}")
            print(f"   HOLD dates: {sorted(hold_dates)}")
            
            # Store each HOLD date in database
            for hold_date in hold_dates:
                hold_record = HoldDate(
                    project_id=project_id,
                    stage_id=stage_id,
                    hold_date=hold_date,
                    reason=reason if reason else f"Stage rescheduled by {abs(days)} day(s)",
                    created_by=get_current_user().id
                )
                db.session.add(hold_record)
                print(f"   ‚úÖ Stored HOLD: {hold_date}")
        
        # Update stage dates
        if days != 0:
            if stage.start_date:
                stage.start_date = add_working_days(stage.start_date, days, False, working_saturdays)
            if stage.end_date:
                stage.end_date = add_working_days(stage.end_date, days, False, working_saturdays)
            
            print(f"   ‚úÖ Updated stage dates: {stage.start_date} to {stage.end_date}")
            
            # Move subsequent stages
            subsequent_stages = ProjectStage.query.filter(
                ProjectStage.project_id == project_id,
                ProjectStage.order > stage.order,
                ProjectStage.status != 'completed'
            ).order_by(ProjectStage.order).all()
            
            for subsequent_stage in subsequent_stages:
                if subsequent_stage.start_date:
                    subsequent_stage.start_date = add_working_days(
                        subsequent_stage.start_date, days, False, working_saturdays
                    )
                if subsequent_stage.end_date:
                    subsequent_stage.end_date = add_working_days(
                        subsequent_stage.end_date, days, False, working_saturdays
                    )
                print(f"   ‚Ü™Ô∏è Shifted subsequent stage: {subsequent_stage.name}")
        
        # ‚úÖ CREATE HISTORY WITH GLOBAL RESCHEDULE NUMBER
        history = ScheduleHistory(
            project_id=project_id,
            stage_id=stage_id,
            reschedule_number=global_reschedule_num,  # ‚úÖ Use global counter
            original_date=original_start_date,
            new_date=stage.start_date,
            reason=reason if reason else f"Reschedule #{global_reschedule_num}: Shifted {abs(days)} day(s)",
            rescheduled_by=get_current_user().id
        )
        db.session.add(history)
        
        print(f"   ‚úÖ Created ScheduleHistory record: Reschedule #{global_reschedule_num}")
        print(f"      Original: {original_start_date} ‚Üí New: {stage.start_date}")
        
        # Update project end date
        all_stages = ProjectStage.query.filter_by(project_id=project_id).all()
        if all_stages:
            latest_end = max(s.end_date for s in all_stages if s.end_date)
            project.end_date = latest_end
            project.working_saturdays = json.dumps(list(working_saturdays))
        
        # Regenerate daily tasks
        generate_daily_tasks_for_project(project_id, working_saturdays)
        
        # ‚úÖ COMMIT EVERYTHING
        db.session.commit()
        
        # ‚úÖ VERIFY the record was created
        verification = ScheduleHistory.query.filter_by(
            project_id=project_id,
            stage_id=stage_id,
            reschedule_number=global_reschedule_num
        ).first()
        
        if verification:
            print(f"   ‚úÖ VERIFIED: ScheduleHistory record #{verification.id} exists in database")
            print(f"      Reschedule number: {verification.reschedule_number}")
        else:
            print(f"   ‚ö†Ô∏è WARNING: ScheduleHistory record not found after commit!")
        
        log_activity(f"Rescheduled stage '{stage.name}' (Global Reschedule #{global_reschedule_num})")
        
        return jsonify({
            'success': True,
            'reschedule_number': global_reschedule_num,
            'new_start': stage.start_date.isoformat() if stage.start_date else None,
            'new_end': stage.end_date.isoformat() if stage.end_date else None
        })
        
    except Exception as e:
        db.session.rollback()
        print(f"‚ùå Error: {str(e)}")
        import traceback
        traceback.print_exc()
        return jsonify({'error': str(e)}), 400

@app.route('/api/projects/<int:project_id>', methods=['DELETE'])
@login_required
def delete_project(project_id):
    try:
        project = Project.query.get_or_404(project_id)
        project_name = project.name
        
        # Delete associated records first (foreign key constraints)
        ProjectStage.query.filter_by(project_id=project_id).delete()
        ProjectMember.query.filter_by(project_id=project_id).delete()
        Task.query.filter_by(project_id=project_id).delete()
        ScheduleHistory.query.filter_by(project_id=project_id).delete()
        
        # Delete the project
        db.session.delete(project)
        db.session.commit()
        
        log_activity(f"Deleted job: {project_name}")
        
        return jsonify({'success': True}), 200
    except Exception as e:
        db.session.rollback()
        return jsonify({'error': str(e)}), 400
    
@app.route('/api/projects/<int:project_id>/update-saturdays', methods=['POST'])
@login_required
def update_saturdays(project_id):
    """Update working Saturdays and recalculate all stage dates"""
    data = request.get_json()
    working_saturdays = set(data.get('working_saturdays', []))
    
    try:
        project = Project.query.get_or_404(project_id)
        
        # Save working Saturdays to database
        project.working_saturdays = json.dumps(list(working_saturdays))
        
        # Get all stages ordered by their order field
        stages = ProjectStage.query.filter_by(project_id=project_id).order_by(ProjectStage.order).all()
        
        # Recalculate all stage dates from project start
        current_date = get_next_working_day(project.start_date, False, working_saturdays)
        
        for stage in stages:
            # Set start date
            stage.start_date = current_date
            
            # Calculate end date based on duration
            if stage.duration_days > 0:
                stage.end_date = add_working_days(current_date, stage.duration_days - 1, False, working_saturdays)
            else:
                stage.end_date = current_date
            
            # Next stage starts the next working day after THIS stage ends
            current_date = add_working_days(stage.end_date, 1, False, working_saturdays)
        
        # Update project end date
        if stages:
            latest_end = max(s.end_date for s in stages if s.end_date)
            project.end_date = latest_end
        
        db.session.commit()
        
        log_activity(f"Updated working Saturdays for project '{project.name}'")
        
        return jsonify({'success': True})
        
    except Exception as e:
        db.session.rollback()
        print(f"Error updating Saturdays: {str(e)}")
        import traceback
        traceback.print_exc()
        return jsonify({'error': str(e)}), 400
    
@app.route('/api/projects/<int:project_id>/stages/<int:stage_id>/daily-tasks', methods=['GET'])
@login_required
def get_stage_daily_tasks(project_id, stage_id):
    """Get all daily tasks for a stage"""
    try:
        tasks = StageDailyTask.query.filter_by(
            project_id=project_id,
            stage_id=stage_id
        ).order_by(StageDailyTask.day_number).all()
        
        return jsonify([{
            'id': t.id,
            'day_number': t.day_number,
            'scheduled_date': t.scheduled_date.isoformat(),
            'original_date': t.original_date.isoformat() if t.original_date else None,
            'status': t.status,
            'completed_at': t.completed_at.strftime('%Y-%m-%d %H:%M') if t.completed_at else None,
            'rescheduled_reason': t.rescheduled_reason,
            'is_rescheduled': t.original_date is not None
        } for t in tasks])
    except Exception as e:
        print(f"Error loading daily tasks: {str(e)}")
        import traceback
        traceback.print_exc()
        return jsonify({'error': str(e)}), 500
    

@app.route('/api/projects/<int:project_id>/stages/<int:stage_id>/daily-tasks/<int:task_id>/complete', methods=['PUT'])
@login_required
def complete_daily_task(project_id, stage_id, task_id):
    """Mark a daily task as completed"""
    task = StageDailyTask.query.get_or_404(task_id)
    task.status = 'completed'
    task.completed_at = datetime.utcnow()
    db.session.commit()
    
    log_activity(f"Completed day {task.day_number} of stage")
    return jsonify({'success': True})


@app.route('/api/projects/<int:project_id>/stages/<int:stage_id>/daily-tasks/<int:task_id>/reschedule', methods=['POST'])
@login_required
def reschedule_daily_task(project_id, stage_id, task_id):
    data = request.get_json()
    days_to_shift = data.get('days', 0)
    reason = data.get('reason', '')
    working_saturdays = set(data.get('working_saturdays', []))
    
    try:
        task = StageDailyTask.query.get_or_404(task_id)
        stage = ProjectStage.query.get_or_404(stage_id)
        project = Project.query.get_or_404(project_id)
        
        # PREVENT RESCHEDULING COMPLETED TASKS
        if task.status == 'completed':
            return jsonify({'error': 'Cannot reschedule a completed task'}), 400
        
        # ‚úÖ INCREMENT GLOBAL RESCHEDULE COUNTER
        project.current_reschedule_number += 1
        global_reschedule_num = project.current_reschedule_number
        
        # ‚úÖ INCREMENT TASK-LEVEL RESCHEDULE COUNT (for tracking)
        task.reschedule_count = (task.reschedule_count or 0) + 1
        
        # Store EXACT original date BEFORE any changes
        original_date = task.original_date if task.original_date else task.scheduled_date
        
        if not task.original_date:
            task.original_date = task.scheduled_date
        
        # Calculate new date
        new_date = add_working_days(task.scheduled_date, days_to_shift, False, working_saturdays)
        
        task.scheduled_date = new_date
        task.status = 'rescheduled'
        task.rescheduled_reason = reason
        
        print(f"\nüìã DAILY TASK RESCHEDULE:")
        print(f"   Stage: {stage.name}, Day {task.day_number}")
        print(f"   Global Reschedule Number: {global_reschedule_num}")
        print(f"   Original: {original_date} ‚Üí New: {new_date}")
        print(f"   Task Reschedule count: {task.reschedule_count}")
        
        # ‚úÖ CREATE DAILY TASK HISTORY WITH GLOBAL NUMBER
        task_history = DailyTaskRescheduleHistory(
            project_id=project_id,
            stage_id=stage_id,
            task_id=task.id,
            day_number=task.day_number,
            reschedule_number=global_reschedule_num,  # ‚úÖ Use global counter
            original_date=original_date,
            new_date=new_date,
            days_shifted=abs(days_to_shift),
            reason=reason if reason else f"Reschedule #{global_reschedule_num}: Shifted {abs(days_to_shift)} day(s)",
            rescheduled_by=get_current_user().id
        )
        db.session.add(task_history)
        
        # ‚úÖ ALSO CREATE STAGE-LEVEL HISTORY (for Excel export)
        stage_history = ScheduleHistory(
            project_id=project_id,
            stage_id=stage_id,
            reschedule_number=global_reschedule_num,  # ‚úÖ Use same global number
            original_date=stage.start_date,
            new_date=new_date,
            reason=f"Daily task reschedule: Day {task.day_number}",
            rescheduled_by=get_current_user().id
        )
        db.session.add(stage_history)
        
        print(f"   ‚úÖ Created histories with global reschedule #{global_reschedule_num}")
        
        # UPDATE SUBSEQUENT NON-COMPLETED TASKS
        all_stage_tasks = StageDailyTask.query.filter_by(
            stage_id=stage_id
        ).filter(
            StageDailyTask.day_number > task.day_number,
            StageDailyTask.status != 'completed'
        ).order_by(StageDailyTask.day_number).all()
        
        for subsequent_task in all_stage_tasks:
            subsequent_task.reschedule_count = (subsequent_task.reschedule_count or 0) + 1
            
            subsequent_original = subsequent_task.original_date if subsequent_task.original_date else subsequent_task.scheduled_date
            
            if not subsequent_task.original_date:
                subsequent_task.original_date = subsequent_task.scheduled_date
            
            subsequent_new_date = add_working_days(
                subsequent_task.scheduled_date, 
                days_to_shift, 
                False, 
                working_saturdays
            )
            
            subsequent_task.scheduled_date = subsequent_new_date
            subsequent_task.status = 'rescheduled'
            if not subsequent_task.rescheduled_reason:
                subsequent_task.rescheduled_reason = f"Auto-shifted due to Day {task.day_number} reschedule"
            
            subsequent_history = DailyTaskRescheduleHistory(
                project_id=project_id,
                stage_id=stage_id,
                task_id=subsequent_task.id,
                day_number=subsequent_task.day_number,
                reschedule_number=global_reschedule_num,  # ‚úÖ Same global number
                original_date=subsequent_original,
                new_date=subsequent_new_date,
                days_shifted=abs(days_to_shift),
                reason=f"Auto-reschedule due to Day {task.day_number}",
                rescheduled_by=get_current_user().id
            )
            db.session.add(subsequent_history)
        
        # Update stage dates based on actual task dates
        all_tasks_in_stage = StageDailyTask.query.filter_by(stage_id=stage_id).order_by(
            StageDailyTask.day_number
        ).all()
        
        if all_tasks_in_stage:
            stage.start_date = min(t.scheduled_date for t in all_tasks_in_stage)
            stage.end_date = max(t.scheduled_date for t in all_tasks_in_stage)
            print(f"   ‚úÖ Updated stage dates: {stage.start_date} to {stage.end_date}")
        
        # ‚úÖ COMMIT
        db.session.commit()
        
        # ‚úÖ VERIFY
        verification = DailyTaskRescheduleHistory.query.filter_by(
            project_id=project_id,
            task_id=task_id,
            reschedule_number=global_reschedule_num
        ).first()
        
        if verification:
            print(f"   ‚úÖ VERIFIED: Daily task history record exists")
        else:
            print(f"   ‚ö†Ô∏è WARNING: History record not found!")
        
        log_activity(f"Rescheduled day {task.day_number} of stage '{stage.name}' (Global Reschedule #{global_reschedule_num})")
        
        return jsonify({
            'success': True,
            'new_date': new_date.isoformat(),
            'reschedule_count': task.reschedule_count,
            'global_reschedule_number': global_reschedule_num
        })
        
    except Exception as e:
        db.session.rollback()
        print(f"‚ùå Error: {str(e)}")
        import traceback
        traceback.print_exc()
        return jsonify({'error': str(e)}), 400

@app.route('/api/projects/<int:project_id>/generate-daily-tasks', methods=['POST'])
@login_required
def generate_daily_tasks(project_id):
    """Generate daily tasks for all stages in a project"""
    try:
        project = Project.query.get_or_404(project_id)
        stages = ProjectStage.query.filter_by(project_id=project_id).order_by(ProjectStage.order).all()
        
        working_saturdays = set(json.loads(project.working_saturdays) if project.working_saturdays else [])
        
        for stage in stages:
            # Delete existing daily tasks for this stage
            StageDailyTask.query.filter_by(stage_id=stage.id).delete()
            
            if not stage.start_date or not stage.end_date:
                continue
            
            # Generate daily tasks
            current_date = stage.start_date
            day_number = 1
            
            while current_date <= stage.end_date:
                # Only create task for working days
                if is_working_day(current_date, False, working_saturdays):
                    daily_task = StageDailyTask(
                        stage_id=stage.id,
                        project_id=project_id,
                        day_number=day_number,
                        scheduled_date=current_date,
                        status='pending'
                    )
                    db.session.add(daily_task)
                    day_number += 1
                
                current_date = current_date + timedelta(days=1)
        
        db.session.commit()
        log_activity(f"Generated daily tasks for project '{project.name}'")
        
        return jsonify({'success': True})
    except Exception as e:
        db.session.rollback()
        return jsonify({'error': str(e)}), 400


@app.route('/api/projects/<int:project_id>/reschedule-history', methods=['GET'])
@login_required
def get_reschedule_history(project_id):
    """Get reschedule history for a project"""
    history = ScheduleHistory.query.filter_by(project_id=project_id).order_by(
        ScheduleHistory.rescheduled_at.desc()
    ).all()
    
    return jsonify([{
        'stage_id': h.stage_id,
        'stage_name': ProjectStage.query.get(h.stage_id).name if h.stage_id else 'Unknown',
        'original_date': h.original_date.isoformat() if h.original_date else None,
        'new_date': h.new_date.isoformat() if h.new_date else None,
        'days_shifted': (h.new_date - h.original_date).days if h.new_date and h.original_date else 0,
        'direction': 'forward' if (h.new_date and h.original_date and h.new_date > h.original_date) else 'backward',
        'reason': h.reason,
        'rescheduled_by': User.query.get(h.rescheduled_by).username if h.rescheduled_by else 'Unknown',
        'rescheduled_at': h.rescheduled_at.strftime('%Y-%m-%d %H:%M')
    } for h in history])

@app.route('/api/projects/<int:project_id>/complete-reschedule-history', methods=['GET'])
@login_required
def get_complete_reschedule_history(project_id):
    """Get ALL reschedule history - both stage-level and daily task reschedules"""
    
    # Force a database commit to ensure all records are visible
    db.session.commit()
    
    # Stage-level reschedules
    stage_history = ScheduleHistory.query.filter_by(
        project_id=project_id
    ).order_by(ScheduleHistory.rescheduled_at.desc()).all()
    
    # Daily task reschedules
    task_history = DailyTaskRescheduleHistory.query.filter_by(
        project_id=project_id
    ).order_by(DailyTaskRescheduleHistory.rescheduled_at.desc()).all()
    
    print(f"\n=== Complete Reschedule History for Project {project_id} ===")
    print(f"Stage-level reschedules: {len(stage_history)}")
    print(f"Daily task reschedules: {len(task_history)}")
    
    combined = []
    
    # Add stage reschedules
    for h in stage_history:
        stage = ProjectStage.query.get(h.stage_id) if h.stage_id else None
        record = {
            'type': 'stage',
            'stage_id': h.stage_id,
            'stage_name': stage.name if stage else 'Unknown',
            'day_number': None,
            'original_date': h.original_date.isoformat() if h.original_date else None,
            'new_date': h.new_date.isoformat() if h.new_date else None,
            'days_shifted': abs((h.new_date - h.original_date).days) if h.new_date and h.original_date else 0,
            'direction': 'forward' if (h.new_date and h.original_date and h.new_date > h.original_date) else 'backward',
            'reason': h.reason or 'No reason provided',
            'rescheduled_by': User.query.get(h.rescheduled_by).username if h.rescheduled_by else 'Unknown',
            'rescheduled_at': h.rescheduled_at.strftime('%Y-%m-%d %H:%M') if h.rescheduled_at else None
        }
        combined.append(record)
        print(f"  √¢≈ì‚Äú Stage: {record['stage_name']}, {record['original_date']} √¢‚Ä†‚Äô {record['new_date']}")
    
    # Add daily task reschedules
    for h in task_history:
        stage = ProjectStage.query.get(h.stage_id) if h.stage_id else None
        record = {
            'type': 'daily_task',
            'stage_id': h.stage_id,
            'stage_name': stage.name if stage else 'Unknown',
            'day_number': h.day_number,
            'original_date': h.original_date.isoformat() if h.original_date else None,
            'new_date': h.new_date.isoformat() if h.new_date else None,
            'days_shifted': abs(h.days_shifted),
            'direction': 'forward' if h.days_shifted > 0 else 'backward',
            'reason': h.reason or 'No reason provided',
            'rescheduled_by': User.query.get(h.rescheduled_by).username if h.rescheduled_by else 'Unknown',
            'rescheduled_at': h.rescheduled_at.strftime('%Y-%m-%d %H:%M') if h.rescheduled_at else None
        }
        combined.append(record)
        print(f"  √¢≈ì‚Äú Daily Task: {record['stage_name']} Day {record['day_number']}, {record['original_date']} √¢‚Ä†‚Äô {record['new_date']}")
    
    # Sort by reschedule time (most recent first)
    combined.sort(key=lambda x: x['rescheduled_at'] if x['rescheduled_at'] else '', reverse=True)
    
    print(f"Total records returned: {len(combined)}")
    print("=" * 60 + "\n")
    
    return jsonify(combined)


@app.route('/api/projects/<int:project_id>/export-data', methods=['GET'])
@login_required
def get_project_export_data(project_id):
    """Get complete project data optimized for Excel export"""
    try:
        project = Project.query.get_or_404(project_id)
        stages = ProjectStage.query.filter_by(project_id=project_id).order_by(ProjectStage.order).all()
        
        # Get working saturdays
        try:
            working_saturdays = set(json.loads(project.working_saturdays) if project.working_saturdays else [])
        except:
            working_saturdays = set()
        
        # Get all daily tasks for all stages
        stage_data = []
        for stage in stages:
            daily_tasks = StageDailyTask.query.filter_by(
                stage_id=stage.id
            ).order_by(StageDailyTask.day_number).all()
            
            stage_data.append({
                'id': stage.id,
                'name': stage.name,
                'order': stage.order,
                'duration_days': stage.duration_days,
                'status': stage.status,
                'start_date': stage.start_date.isoformat() if stage.start_date else None,
                'end_date': stage.end_date.isoformat() if stage.end_date else None,
                'daily_tasks': [{
                    'id': t.id,
                    'day_number': t.day_number,
                    'scheduled_date': t.scheduled_date.isoformat(),
                    'original_date': t.original_date.isoformat() if t.original_date else None,
                    'status': t.status,
                    'is_rescheduled': t.original_date is not None,
                    'rescheduled_reason': t.rescheduled_reason
                } for t in daily_tasks]
            })
        
        # Get complete reschedule history
        stage_history = ScheduleHistory.query.filter_by(project_id=project_id).all()
        task_history = DailyTaskRescheduleHistory.query.filter_by(project_id=project_id).all()
        
        return jsonify({
            'project': {
                'id': project.id,
                'name': project.name,
                'start_date': project.start_date.isoformat() if project.start_date else None,
                'end_date': project.end_date.isoformat() if project.end_date else None,
                'working_saturdays': list(working_saturdays)
            },
            'stages': stage_data,
            'reschedule_history': {
                'stages': [{
                    'stage_id': h.stage_id,
                    'stage_name': ProjectStage.query.get(h.stage_id).name if h.stage_id else 'Unknown',
                    'original_date': h.original_date.isoformat() if h.original_date else None,
                    'new_date': h.new_date.isoformat() if h.new_date else None,
                    'reason': h.reason,
                    'rescheduled_at': h.rescheduled_at.isoformat() if h.rescheduled_at else None
                } for h in stage_history],
                'daily_tasks': [{
                    'stage_id': h.stage_id,
                    'stage_name': ProjectStage.query.get(h.stage_id).name if h.stage_id else 'Unknown',
                    'day_number': h.day_number,
                    'original_date': h.original_date.isoformat() if h.original_date else None,
                    'new_date': h.new_date.isoformat() if h.new_date else None,
                    'days_shifted': h.days_shifted,
                    'reason': h.reason,
                    'rescheduled_at': h.rescheduled_at.isoformat() if h.rescheduled_at else None
                } for h in task_history]
            }
        })
    except Exception as e:
        print(f"Error in export-data endpoint: {str(e)}")
        import traceback
        traceback.print_exc()
        return jsonify({'error': str(e)}), 500
    
@app.route('/api/projects/<int:project_id>/debug-reschedules', methods=['GET'])
@login_required
def debug_reschedules(project_id):
    """Debug endpoint to see all reschedule history"""
    
    # Get all stage-level reschedules
    stage_reschedules = ScheduleHistory.query.filter_by(
        project_id=project_id
    ).order_by(ScheduleHistory.stage_id, ScheduleHistory.reschedule_number).all()
    
    # Get all daily task reschedules
    task_reschedules = DailyTaskRescheduleHistory.query.filter_by(
        project_id=project_id
    ).order_by(DailyTaskRescheduleHistory.stage_id, DailyTaskRescheduleHistory.day_number).all()
    
    result = {
        'stage_reschedules': [{
            'id': r.id,
            'stage_id': r.stage_id,
            'stage_name': ProjectStage.query.get(r.stage_id).name if r.stage_id else 'Unknown',
            'reschedule_number': r.reschedule_number,
            'original_date': r.original_date.isoformat() if r.original_date else None,
            'new_date': r.new_date.isoformat() if r.new_date else None,
            'reason': r.reason,
            'rescheduled_at': r.rescheduled_at.isoformat() if r.rescheduled_at else None
        } for r in stage_reschedules],
        'task_reschedules': [{
            'id': r.id,
            'stage_id': r.stage_id,
            'stage_name': ProjectStage.query.get(r.stage_id).name if r.stage_id else 'Unknown',
            'day_number': r.day_number,
            'reschedule_number': r.reschedule_number if hasattr(r, 'reschedule_number') else None,
            'original_date': r.original_date.isoformat() if r.original_date else None,
            'new_date': r.new_date.isoformat() if r.new_date else None,
            'rescheduled_at': r.rescheduled_at.isoformat() if r.rescheduled_at else None
        } for r in task_reschedules],
        'total_stage_reschedules': len(stage_reschedules),
        'total_task_reschedules': len(task_reschedules)
    }
    
    return jsonify(result)



@app.route('/api/projects/<int:project_id>/export-excel', methods=['GET'])
@login_required
def export_project_to_excel(project_id):
    """Generate Excel with comprehensive debugging"""
    try:
        print(f"\n{'='*80}")
        print(f"üìã STARTING EXCEL EXPORT FOR PROJECT {project_id}")
        print(f"{'='*80}\n")
        
        project = Project.query.get_or_404(project_id)
        stages = ProjectStage.query.filter_by(project_id=project_id).order_by(ProjectStage.order).all()
        
        print(f"Project: {project.name}")
        print(f"Total stages: {len(stages)}")
        for s in stages:
            print(f"  - Stage {s.id}: {s.name} ({s.start_date} to {s.end_date})")
        
        # Get working saturdays
        try:
            working_saturdays = set(json.loads(project.working_saturdays) if project.working_saturdays else [])
        except:
            working_saturdays = set()
        
        print(f"\nWorking Saturdays: {working_saturdays}")
        
        # ==========================================
        # ‚úÖ FIXED: Build reschedule map from ACTUAL rescheduled dates
        # ==========================================
        print(f"\n{'='*80}")
        print(f"üìú LOADING RESCHEDULE HISTORY")
        print(f"{'='*80}\n")
        
        # Get ALL reschedules ordered by time
        daily_reschedules = DailyTaskRescheduleHistory.query.filter_by(
            project_id=project_id
        ).order_by(DailyTaskRescheduleHistory.rescheduled_at).all()
        
        stage_reschedules = ScheduleHistory.query.filter_by(
            project_id=project_id
        ).order_by(ScheduleHistory.rescheduled_at).all()
        
        print(f"Daily task reschedules: {len(daily_reschedules)}")
        print(f"Stage-level reschedules: {len(stage_reschedules)}\n")
        
        # Collect all unique reschedule numbers
        all_reschedule_numbers = set()
        
        for r in daily_reschedules:
            if hasattr(r, 'reschedule_number') and r.reschedule_number:
                all_reschedule_numbers.add(r.reschedule_number)
        
        for r in stage_reschedules:
            if hasattr(r, 'reschedule_number') and r.reschedule_number:
                all_reschedule_numbers.add(r.reschedule_number)
        
        # Sort them to get sequential order
        sorted_reschedule_nums = sorted(all_reschedule_numbers)
        
        print(f"Found reschedule numbers: {sorted_reschedule_nums}")
        
        # Map global reschedule numbers to Excel rows (1, 2, 3, 4)
        reschedule_num_map = {actual: idx + 1 for idx, actual in enumerate(sorted_reschedule_nums[:4])}
        
        print(f"Mapping: {reschedule_num_map}")
        print(f"Example: Reschedule #1 ‚Üí Excel row {reschedule_num_map.get(1, 'N/A')}")
        print(f"Example: Reschedule #2 ‚Üí Excel row {reschedule_num_map.get(2, 'N/A')}")
        
        # Initialize reschedule map
        stage_reschedule_map = {1: {}, 2: {}, 3: {}, 4: {}}
        
        # ‚úÖ FIXED: Process daily task reschedules - show ALL dates where tasks were moved TO
        print(f"\nüìÑ Processing daily task reschedules...")
        for task_reschedule in daily_reschedules:
            if not hasattr(task_reschedule, 'reschedule_number') or not task_reschedule.reschedule_number:
                print(f"  ‚ö†Ô∏è Skipping task reschedule without reschedule_number")
                continue
            
            actual_num = task_reschedule.reschedule_number
            if actual_num not in reschedule_num_map:
                print(f"  ‚ö†Ô∏è Reschedule #{actual_num} not in map (only showing first 4)")
                continue
            
            mapped_num = reschedule_num_map[actual_num]
            
            stage = ProjectStage.query.get(task_reschedule.stage_id)
            if not stage:
                continue
            
            parts = stage.name.split('-')
            stage_abbr = parts[-1].strip() if len(parts) > 1 else stage.name[:6]
            
            # Use the NEW date (where it was rescheduled TO)
            date_str = task_reschedule.new_date.strftime('%Y-%m-%d')
            
            if date_str not in stage_reschedule_map[mapped_num]:
                stage_reschedule_map[mapped_num][date_str] = []
            
            # ‚úÖ ALWAYS append - don't check for duplicates yet
            stage_reschedule_map[mapped_num][date_str].append(stage_abbr)
            
            print(f"  ‚úÖ Mapped: Reschedule #{actual_num} ‚Üí Row {mapped_num}, Date {date_str}, Stage {stage_abbr}")
        
        # Process stage-level reschedules (fallback)
        print(f"\nüìÑ Processing stage-level reschedules...")
        for reschedule_record in stage_reschedules:
            if not hasattr(reschedule_record, 'reschedule_number') or not reschedule_record.reschedule_number:
                continue
            
            actual_num = reschedule_record.reschedule_number
            if actual_num not in reschedule_num_map:
                continue
            
            mapped_num = reschedule_num_map[actual_num]
            
            stage = ProjectStage.query.get(reschedule_record.stage_id)
            if not stage or not reschedule_record.new_date:
                continue
            
            parts = stage.name.split('-')
            stage_abbr = parts[-1].strip() if len(parts) > 1 else stage.name[:6]
            
            # Calculate all working days in the rescheduled range
            new_start = reschedule_record.new_date
            new_end = add_working_days(new_start, stage.duration_days - 1, False, working_saturdays)
            
            current_date = new_start
            while current_date <= new_end:
                if is_working_day(current_date, False, working_saturdays):
                    date_str = current_date.strftime('%Y-%m-%d')
                    if date_str not in stage_reschedule_map[mapped_num]:
                        stage_reschedule_map[mapped_num][date_str] = []
                    # ‚úÖ ALWAYS append
                    stage_reschedule_map[mapped_num][date_str].append(stage_abbr)
                current_date += timedelta(days=1)
        
        # ‚úÖ Remove duplicates AFTER all entries are added
        print(f"\nüßπ Cleaning up duplicates...")
        for row_num in range(1, 5):
            for date_str in stage_reschedule_map[row_num]:
                # Keep unique stage abbreviations
                stage_reschedule_map[row_num][date_str] = list(set(stage_reschedule_map[row_num][date_str]))
        
        # Print verification summary
        print(f"\n{'='*60}")
        print(f"RESCHEDULE MAP VERIFICATION")
        print(f"{'='*60}")
        for row_num in range(1, 5):
            total_dates = len(stage_reschedule_map[row_num])
            total_stages = sum(len(stages) for stages in stage_reschedule_map[row_num].values())
            print(f"\nReschedule Row {row_num}:")
            print(f"  Total dates: {total_dates}")
            print(f"  Total stage entries: {total_stages}")
            if total_dates > 0:
                sample_dates = sorted(stage_reschedule_map[row_num].keys())[:5]
                for sample_date in sample_dates:
                    stage_list = stage_reschedule_map[row_num][sample_date]
                    print(f"    {sample_date}: {stage_list}")
        print(f"{'='*60}\n")
        
        # Create workbook
        wb = Workbook()
        ws = wb.active
        ws.title = "Schedule_Tracker"
        
        # Define styles
        orange_header = PatternFill(start_color="FFA500", end_color="FFA500", fill_type="solid")
        yellow_fill = PatternFill(start_color="FFFF00", end_color="FFFF00", fill_type="solid")
        green_fill = PatternFill(start_color="00FF00", end_color="00FF00", fill_type="solid")
        orange_fill = PatternFill(start_color="FFA500", end_color="FFA500", fill_type="solid")
        cyan_fill = PatternFill(start_color="00FFFF", end_color="00FFFF", fill_type="solid")
        light_gray = PatternFill(start_color="D3D3D3", end_color="D3D3D3", fill_type="solid")
        
        thin_border = Border(
            left=Side(style='thin'),
            right=Side(style='thin'),
            top=Side(style='thin'),
            bottom=Side(style='thin')
        )
        
        medium_border = Border(
            left=Side(style='medium'),
            right=Side(style='medium'),
            top=Side(style='medium'),
            bottom=Side(style='medium')
        )
        
        # ==========================================
        # STAGE NAMES HEADER ROW
        # ==========================================
        current_row = 1
        header_col = 1
        
        for stage in stages:
            parts = stage.name.split('-')
            stage_main = '-'.join(parts[:-1]).strip() if len(parts) > 1 else stage.name
            stage_code = parts[-1].strip() if len(parts) > 1 else ''
            
            cell = ws.cell(current_row, header_col)
            cell.value = stage_main
            cell.font = Font(size=9, bold=False)
            cell.alignment = Alignment(vertical='center', horizontal='left', wrap_text=True)
            cell.border = thin_border
            header_col += 1
            
            cell = ws.cell(current_row, header_col)
            cell.value = stage_code
            cell.font = Font(size=9, bold=False)
            cell.alignment = Alignment(vertical='center', horizontal='left')
            cell.border = thin_border
            header_col += 1
        
        ws.row_dimensions[current_row].height = 25
        current_row += 2
        
        # Generate date range
        project_start = project.start_date
        project_end = project.end_date
        all_dates = []
        current_date = project_start
        while current_date <= project_end:
            all_dates.append(current_date)
            current_date += timedelta(days=1)
        
        print(f"\nüìÖ Date range: {project_start} to {project_end} ({len(all_dates)} total days)")
        
        # ==========================================
        # PROJECT NAME AND DATE HEADER ROW
        # ==========================================
        ws.cell(current_row, 1, project.name).font = Font(size=12, bold=True)
        ws.cell(current_row, 1).alignment = Alignment(vertical='center', horizontal='center')
        ws.cell(current_row, 1).fill = orange_header
        ws.cell(current_row, 1).border = medium_border
        
        ws.cell(current_row, 2, "Date").font = Font(size=10, bold=True)
        ws.cell(current_row, 2).alignment = Alignment(vertical='center', horizontal='center')
        ws.cell(current_row, 2).fill = orange_header
        ws.cell(current_row, 2).border = thin_border
        
        for idx, date in enumerate(all_dates):
            cell = ws.cell(current_row, idx + 3, date.day)
            cell.font = Font(size=9, bold=True)
            cell.alignment = Alignment(vertical='center', horizontal='center')
            cell.fill = orange_header
            cell.border = thin_border
        
        ws.row_dimensions[current_row].height = 25
        current_row += 1
        
        # ==========================================
        # MONTH GROUPINGS ROW
        # ==========================================
        month_names = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                      'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
        
        ws.cell(current_row, 1, "")
        ws.cell(current_row, 2, "")
        
        last_month = None
        month_start_col = 3
        
        for idx, date in enumerate(all_dates):
            current_month = date.month
            col_num = idx + 3
            
            if last_month is None:
                last_month = current_month
            
            if last_month != current_month or idx == len(all_dates) - 1:
                end_col = col_num - 1 if last_month != current_month else col_num
                
                if month_start_col <= end_col:
                    if month_start_col < end_col:
                        ws.merge_cells(start_row=current_row, start_column=month_start_col,
                                     end_row=current_row, end_column=end_col)
                    
                    display_date = all_dates[idx - 1 if last_month != current_month else idx]
                    cell = ws.cell(current_row, month_start_col, 
                                 f"{month_names[display_date.month - 1]}-{str(display_date.day).zfill(2)}")
                    cell.font = Font(size=9, bold=True)
                    cell.alignment = Alignment(vertical='center', horizontal='center')
                    cell.border = thin_border
                
                last_month = current_month
                month_start_col = col_num
        
        ws.row_dimensions[current_row].height = 20
        current_row += 1
        
        # Set column widths
        ws.column_dimensions['A'].width = 25
        ws.column_dimensions['B'].width = 15
        for i in range(3, len(all_dates) + 3):
            ws.column_dimensions[get_column_letter(i)].width = 3.5
        
        # ==========================================
        # PLANNED ROW
        # ==========================================
        print(f"\nüìÖ Building PLANNED row...")
        ws.cell(current_row, 1, "").fill = light_gray
        ws.cell(current_row, 1).border = medium_border
        
        ws.cell(current_row, 2, "Planned").font = Font(size=10, bold=False)
        ws.cell(current_row, 2).alignment = Alignment(vertical='center', horizontal='left')
        ws.cell(current_row, 2).border = thin_border
        
        planned_map = {}
        for stage in stages:
            if stage.start_date and stage.end_date:
                parts = stage.name.split('-')
                stage_abbr = parts[-1].strip() if len(parts) > 1 else stage.name[:6]
                
                current_date = stage.start_date
                while current_date <= stage.end_date:
                    if is_working_day(current_date, False, working_saturdays):
                        date_str = current_date.strftime('%Y-%m-%d')
                        if date_str not in planned_map:
                            planned_map[date_str] = []
                        planned_map[date_str].append(stage_abbr)
                    current_date += timedelta(days=1)
        
        for idx, date in enumerate(all_dates):
            day_of_week = date.weekday()
            cell = ws.cell(current_row, idx + 3)
            date_str = date.strftime('%Y-%m-%d')
            
            if day_of_week in [5, 6]:
                cell.fill = yellow_fill
            
            if date_str in planned_map:
                stage_abbrs = planned_map[date_str]
                cell.value = ','.join(sorted(set(stage_abbrs)))
                cell.fill = yellow_fill
                cell.font = Font(size=7)
                cell.alignment = Alignment(vertical='center', horizontal='center', text_rotation=90)
            
            cell.border = thin_border
        
        ws.row_dimensions[current_row].height = 60
        current_row += 1
        
        # ==========================================
        # ‚úÖ RESCHEDULE ROWS (1-4) - WITH DETAILED LOGGING
        # ==========================================
        print(f"\n{'='*80}")
        print(f"üìÑ BUILDING RESCHEDULE ROWS IN EXCEL")
        print(f"{'='*80}\n")
        
        for reschedule_num in range(1, 5):
            print(f"\nüîç Writing Reschedule-{reschedule_num} row to Excel...")
            
            ws.cell(current_row, 1, "").fill = light_gray
            ws.cell(current_row, 1).border = medium_border
            
            ws.cell(current_row, 2, f"Reschedule -{reschedule_num}").font = Font(size=10)
            ws.cell(current_row, 2).alignment = Alignment(vertical='center', horizontal='left')
            ws.cell(current_row, 2).border = thin_border
            
            reschedule_dates = stage_reschedule_map.get(reschedule_num, {})
            print(f"   Available dates in map: {len(reschedule_dates)}")
            
            cells_filled = 0
            for idx, date in enumerate(all_dates):
                day_of_week = date.weekday()
                cell = ws.cell(current_row, idx + 3)
                date_str = date.strftime('%Y-%m-%d')
                
                # Yellow fill for weekends
                if day_of_week in [5, 6]:
                    cell.fill = yellow_fill
                
                # Check if this date has rescheduled stages
                if date_str in reschedule_dates:
                    stage_abbrs = reschedule_dates[date_str]
                    cell.value = ','.join(sorted(set(stage_abbrs)))
                    cell.fill = yellow_fill
                    cell.font = Font(size=7)
                    cell.alignment = Alignment(vertical='center', horizontal='center', text_rotation=90)
                    cells_filled += 1
                
                cell.border = thin_border
            
            print(f"   ‚úÖ Filled {cells_filled} cells in Excel for Reschedule-{reschedule_num}")
            
            ws.row_dimensions[current_row].height = 20
            current_row += 1
        
        print(f"\n{'='*80}\n")
        
        # ==========================================
        # ACTUAL ROW
        # ==========================================
        print(f"\n‚úÖ Building ACTUAL row...")
        ws.cell(current_row, 1, "").fill = light_gray
        ws.cell(current_row, 1).border = medium_border
        
        ws.cell(current_row, 2, "Actual").font = Font(size=10, bold=True)
        ws.cell(current_row, 2).alignment = Alignment(vertical='center', horizontal='center')
        ws.cell(current_row, 2).fill = PatternFill(start_color="C0C0C0", end_color="C0C0C0", fill_type="solid")
        ws.cell(current_row, 2).border = thin_border
        
        actual_map = {}
        hold_dates_map = {}
        
        for stage in stages:
            parts = stage.name.split('-')
            stage_abbr = parts[-1].strip() if len(parts) > 1 else stage.name[:6]
            
            daily_tasks = StageDailyTask.query.filter_by(stage_id=stage.id).order_by(
                StageDailyTask.day_number
            ).all()
            
            for task in daily_tasks:
                date_str = task.scheduled_date.strftime('%Y-%m-%d')
                if date_str not in actual_map:
                    actual_map[date_str] = []
                actual_map[date_str].append((stage_abbr, task.status))
                
                if task.original_date and task.original_date != task.scheduled_date:
                    hold_date_str = task.original_date.strftime('%Y-%m-%d')
                    if hold_date_str not in hold_dates_map:
                        hold_dates_map[hold_date_str] = []
                    hold_dates_map[hold_date_str].append(stage_abbr)
        
        for idx, date in enumerate(all_dates):
            day_of_week = date.weekday()
            cell = ws.cell(current_row, idx + 3)
            date_str = date.strftime('%Y-%m-%d')
            
            if day_of_week in [5, 6]:
                cell.fill = yellow_fill
            
            has_hold = date_str in hold_dates_map
            has_active = date_str in actual_map
            
            if has_hold and has_active:
                hold_stages = sorted(set(hold_dates_map[date_str]))
                active_stages = sorted(set([abbr for abbr, _ in actual_map[date_str]]))
                cell.value = f"{','.join(hold_stages)}=HOLD,{','.join(active_stages)}"
                if day_of_week not in [5, 6]:
                    cell.fill = orange_fill
                cell.font = Font(size=6, bold=True)
                cell.alignment = Alignment(vertical='center', horizontal='center', text_rotation=90)
                
            elif has_hold:
                hold_stages = sorted(set(hold_dates_map[date_str]))
                cell.value = f"{','.join(hold_stages)}=HOLD" if len(hold_stages) > 1 else "HOLD"
                if day_of_week not in [5, 6]:
                    cell.fill = orange_fill
                cell.font = Font(size=7, bold=True)
                cell.alignment = Alignment(vertical='center', horizontal='center', text_rotation=90)
                
            elif has_active:
                task_info = actual_map[date_str]
                completed = [abbr for abbr, status in task_info if status == 'completed']
                rescheduled = [abbr for abbr, status in task_info if status == 'rescheduled']
                
                all_stages = sorted(set([abbr for abbr, _ in task_info]))
                cell.value = ','.join(all_stages)
                
                if day_of_week not in [5, 6]:
                    if completed:
                        cell.fill = green_fill
                    elif rescheduled:
                        cell.fill = cyan_fill
                    else:
                        cell.fill = yellow_fill
                
                cell.font = Font(size=7)
                cell.alignment = Alignment(vertical='center', horizontal='center', text_rotation=90)
            
            cell.border = thin_border
        
        ws.row_dimensions[current_row].height = 60
        current_row += 1
        
        # ==========================================
        # REMARKS ROW
        # ==========================================
        ws.cell(current_row, 1, "").fill = light_gray
        ws.cell(current_row, 1).border = medium_border
        
        ws.cell(current_row, 2, "Remarks").font = Font(size=10, italic=True)
        ws.cell(current_row, 2).alignment = Alignment(vertical='top', horizontal='left')
        ws.cell(current_row, 2).border = thin_border
        
        for stage in stages:
            if not stage.start_date or not stage.end_date:
                continue
                
            stage_duration_days = (stage.end_date - stage.start_date).days + 1
            weeks_needed = max(1, stage_duration_days // 7)
            
            for week_num in range(1, min(weeks_needed + 1, 4)):
                week_day_offset = (stage_duration_days // weeks_needed) * week_num
                week_date = stage.start_date + timedelta(days=week_day_offset)
                
                if week_date <= stage.end_date and week_date in all_dates:
                    col_idx = all_dates.index(week_date) + 3
                    cell = ws.cell(current_row, col_idx)
                    
                    ordinal = f"{week_num}{'st' if week_num == 1 else 'nd' if week_num == 2 else 'rd' if week_num == 3 else 'th'}"
                    cell.value = f"{ordinal} Week"
                    
                    day_of_week = week_date.weekday()
                    if day_of_week not in [5, 6]:
                        cell.fill = yellow_fill
                    
                    cell.font = Font(size=7, bold=True)
                    cell.alignment = Alignment(vertical='center', horizontal='center', text_rotation=90)
        
        for date_str, hold_stages in hold_dates_map.items():
            date = datetime.strptime(date_str, '%Y-%m-%d').date()
            if date in all_dates:
                col_idx = all_dates.index(date) + 3
                cell = ws.cell(current_row, col_idx)
                
                reason_found = False
                for stage in stages:
                    daily_tasks = StageDailyTask.query.filter_by(stage_id=stage.id).filter(
                        StageDailyTask.original_date == date
                    ).all()
                    
                    for task in daily_tasks:
                        if task.rescheduled_reason:
                            cell.value = task.rescheduled_reason
                            reason_found = True
                            break
                    if reason_found:
                        break
                
                if not reason_found:
                    cell.value = "HOLD, waiting for issue tracker and schematic from customer side"
                
                day_of_week = date.weekday()
                if day_of_week not in [5, 6]:
                    cell.fill = yellow_fill
                
                cell.font = Font(size=6, italic=True)
                cell.alignment = Alignment(vertical='top', horizontal='left', wrap_text=True, text_rotation=90)
        
        for idx, date in enumerate(all_dates):
            day_of_week = date.weekday()
            cell = ws.cell(current_row, idx + 3)
            
            if day_of_week in [5, 6] and not cell.value:
                cell.fill = yellow_fill
            
            if not cell.border or cell.border == Border():
                cell.border = thin_border
        
        ws.row_dimensions[current_row].height = 80
        current_row += 2
        
        # ==========================================
        # LEGEND
        # ==========================================
        ws.cell(current_row, 1, "Hold").fill = orange_fill
        ws.cell(current_row, 1).font = Font(size=10, bold=True)
        ws.cell(current_row, 1).alignment = Alignment(vertical='center', horizontal='center')
        ws.cell(current_row, 1).border = thin_border
        ws.cell(current_row, 2, "If project goes on hold from Customer").font = Font(size=9)
        current_row += 1
        
        ws.cell(current_row, 1, "Changes").border = thin_border
        ws.cell(current_row, 1).font = Font(size=10, bold=True)
        ws.cell(current_row, 1).alignment = Alignment(vertical='center', horizontal='center')
        ws.cell(current_row, 2, "from Customer").font = Font(size=9)
        current_row += 1
        
        ws.cell(current_row, 1, "Holidays").fill = yellow_fill
        ws.cell(current_row, 1).font = Font(size=10, bold=True)
        ws.cell(current_row, 1).alignment = Alignment(vertical='center', horizontal='center')
        ws.cell(current_row, 1).border = thin_border
        
        # Save to BytesIO
        excel_file = BytesIO()
        wb.save(excel_file)
        excel_file.seek(0)
        
        filename = f"{project.name}_Tracker_{datetime.now().strftime('%Y%m%d')}.xlsx"
        
        print(f"\n{'='*80}")
        print(f"‚úÖ EXCEL EXPORT COMPLETE")
        print(f"{'='*80}\n")
        
        return send_file(
            excel_file,
            mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            as_attachment=True,
            download_name=filename
        )
        
    except Exception as e:
        print(f"\n‚ùå ERROR IN EXCEL EXPORT:")
        print(f"   {str(e)}")
        import traceback
        traceback.print_exc()
        return jsonify({'error': str(e)}), 500
    
@app.route('/api/projects/<int:project_id>/hold-dates', methods=['GET'])
@login_required
def get_hold_dates(project_id):
    """Get all HOLD dates for a project"""
    hold_dates = HoldDate.query.filter_by(project_id=project_id).order_by(
        HoldDate.hold_date
    ).all()
    
    return jsonify([{
        'id': h.id,
        'stage_id': h.stage_id,
        'stage_name': ProjectStage.query.get(h.stage_id).name if h.stage_id else 'Unknown',
        'hold_date': h.hold_date.isoformat(),
        'reason': h.reason,
        'created_by': User.query.get(h.created_by).username if h.created_by else 'Unknown',
        'created_at': h.created_at.strftime('%Y-%m-%d %H:%M')
    } for h in hold_dates])   
# ============================================================================
# Initialize Database & Create Default User
# ============================================================================

def init_db():
    with app.app_context():
        db.create_all()
        
        try:
            from sqlalchemy import inspect, text
            inspector = inspect(db.engine)


            # ==========================================
            # ADD GLOBAL RESCHEDULE COUNTER TO PROJECT
            # ==========================================
            project_columns = [col['name'] for col in inspector.get_columns('project')]
            if 'current_reschedule_number' not in project_columns:
                print("[INFO] Adding current_reschedule_number to project table...")
                with db.engine.connect() as conn:
                    conn.execute(text("ALTER TABLE project ADD COLUMN current_reschedule_number INTEGER DEFAULT 0"))
                    conn.commit()
                print("[SUCCESS] Added current_reschedule_number column")

            
            # ==========================================
            # 1. SCHEDULE_HISTORY TABLE (Stage-level reschedules)
            # ==========================================
            schedule_history_columns = [col['name'] for col in inspector.get_columns('schedule_history')]
            if 'reschedule_number' not in schedule_history_columns:
                print("[WARNING] Adding reschedule_number column to schedule_history...")
                with db.engine.connect() as conn:
                    conn.execute(text("ALTER TABLE schedule_history ADD COLUMN reschedule_number INTEGER DEFAULT 1"))
                    conn.commit()
                print("[SUCCESS] Added reschedule_number column to schedule_history")
            
            # CRITICAL: Backfill existing records with sequential numbers
            existing_records = ScheduleHistory.query.all()
            if existing_records:
                print(f"[INFO] Checking {len(existing_records)} existing reschedule records...")
                
                # Group by project_id and stage_id
                from collections import defaultdict
                grouped = defaultdict(list)
                
                for record in existing_records:
                    key = (record.project_id, record.stage_id)
                    grouped[key].append(record)
                
                # Number them sequentially per stage
                for (proj_id, stage_id), records in grouped.items():
                    records.sort(key=lambda r: r.rescheduled_at)
                    for idx, record in enumerate(records, 1):
                        if not record.reschedule_number or record.reschedule_number == 0:
                            record.reschedule_number = idx
                            print(f"  [UPDATE] Record ID {record.id} set to reschedule #{idx}")
                
                db.session.commit()
                print("[SUCCESS] Backfilled reschedule numbers for stage-level reschedules")
            
            # ==========================================
            # 2. STAGE_DAILY_TASK TABLE (Add reschedule_count)
            # ==========================================
            if inspector.has_table('stage_daily_task'):
                task_columns = [col['name'] for col in inspector.get_columns('stage_daily_task')]
                if 'reschedule_count' not in task_columns:
                    print("[WARNING] Adding reschedule_count column to stage_daily_task...")
                    with db.engine.connect() as conn:
                        conn.execute(text("ALTER TABLE stage_daily_task ADD COLUMN reschedule_count INTEGER DEFAULT 0"))
                        conn.commit()
                    print("[SUCCESS] Added reschedule_count column to stage_daily_task")
            else:
                db.create_all()
                print("‚úÖ Created stage_daily_task table")
            
            # ==========================================
            # 3. DAILY_TASK_RESCHEDULE_HISTORY TABLE (Add reschedule_number)
            # ==========================================
            if inspector.has_table('daily_task_reschedule_history'):
                history_columns = [col['name'] for col in inspector.get_columns('daily_task_reschedule_history')]
                if 'reschedule_number' not in history_columns:
                    print("[WARNING] Adding reschedule_number column to daily_task_reschedule_history...")
                    with db.engine.connect() as conn:
                        conn.execute(text("ALTER TABLE daily_task_reschedule_history ADD COLUMN reschedule_number INTEGER DEFAULT 1"))
                        conn.commit()
                    print("[SUCCESS] Added reschedule_number column to daily_task_reschedule_history")
                
                # Backfill existing daily task reschedule records
                existing_task_history = DailyTaskRescheduleHistory.query.all()
                if existing_task_history:
                    print(f"[INFO] Backfilling {len(existing_task_history)} daily task reschedule records...")
                    
                    from collections import defaultdict
                    task_grouped = defaultdict(list)
                    
                    for record in existing_task_history:
                        key = (record.project_id, record.task_id)
                        task_grouped[key].append(record)
                    
                    for (proj_id, task_id), records in task_grouped.items():
                        records.sort(key=lambda r: r.rescheduled_at)
                        for idx, record in enumerate(records, 1):
                            if not hasattr(record, 'reschedule_number') or not record.reschedule_number or record.reschedule_number == 0:
                                record.reschedule_number = idx
                                print(f"  [UPDATE] Task history ID {record.id} set to reschedule #{idx}")
                    
                    db.session.commit()
                    print("[SUCCESS] Backfilled reschedule numbers for daily task reschedules")
            else:
                print("‚ö†Ô∏è  daily_task_reschedule_history table missing, creating...")
                db.create_all()
                print("‚úÖ Created daily_task_reschedule_history table")
            
            # ==========================================
            # 4. PROJECT TABLE (working_saturdays)
            # ==========================================
            columns = [col['name'] for col in inspector.get_columns('project')]
            if 'working_saturdays' not in columns:
                with db.engine.connect() as conn:
                    conn.execute(text("ALTER TABLE project ADD COLUMN working_saturdays TEXT DEFAULT '[]'"))
                    conn.commit()
                print("‚úÖ Added working_saturdays column to project")
            
            # ==========================================
            # 5. PROJECT_STAGE TABLE (manager_id)
            # ==========================================
            stage_columns = [col['name'] for col in inspector.get_columns('project_stage')]
            if 'manager_id' not in stage_columns:
                with db.engine.connect() as conn:
                    conn.execute(text("ALTER TABLE project_stage ADD COLUMN manager_id INTEGER"))
                    conn.commit()
                print("‚úÖ Added manager_id column to project_stage")
            
            # ==========================================
            # 6. HOLD_DATE TABLE
            # ==========================================
            if not inspector.has_table('hold_date'):
                print("‚ö†Ô∏è  hold_date table missing, creating...")
                db.create_all()
                print("‚úÖ Created hold_date table")
            
            print("\n" + "="*60)
            print("‚úÖ DATABASE INITIALIZATION COMPLETE")
            print("="*60 + "\n")
            
        except Exception as e:
            print(f"‚ùå Error during database initialization: {e}")
            import traceback
            traceback.print_exc()
        
        # Create default admin user if not exists
        if not User.query.filter_by(username='admin').first():
            admin = User(
                username='admin',
                email='admin@example.com',
                password_hash=generate_password_hash('admin123'),
                role='admin'
            )
            db.session.add(admin)
            db.session.commit()
            print("‚úÖ Default admin user created (username: admin, password: admin123)")

if __name__ == '__main__':
    init_db()
    app.run(debug=True, host='0.0.0.0', port=5000)





<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Management Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
    <!-- Add this in the <head> section of index.html -->
    <style>
:root {
    --primary-color: #667eea;
    --secondary-color: #764ba2;
}

body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px;
}

.stat-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: transform 0.3s;
    height: 100%;
}

.stat-card:hover { 
    transform: translateY(-5px);
}

.stat-card .icon {
    width: 60px;
    height: 60px;
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    margin-bottom: 15px;
}

.stat-card h3 { 
    font-size: 2rem; font-weight: 700; margin: 10px 0; 
}

.card-custom {
    background: white;
    border-radius: 15px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.card-custom .card-header {
    background: transparent;
    border-bottom: 2px solid #f1f3f5;
    padding: 20px;
    font-weight: 600;
    font-size: 1.2rem;
}

.btn-primary-custom {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    border: none;
    border-radius: 10px;
    padding: 10px 20px;
    color: white;
    font-weight: 600;
}

.btn-primary-custom:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(95, 116, 206, 0.4);
    color: white;
}

.top-bar-custom {
    background: white;
    padding: 15px 30px;
    border-radius: 15px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #dc3545;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
}

.modal-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    border-top-left-radius: 15px;
    border-top-right-radius: 15px;
    border: none; /* √É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Remove border that causes white corners */
}
.modal-content {
    border-radius: 15px;
    overflow: hidden; /* √É¬¢√Ö‚Äú√¢‚Ç¨¬¶ This fixes the white corners */
    border: none;
}

.modal-body {
    padding: 20px 25px;
    background: #f8f9fa; /* √É¬¢√Ö‚Äú√¢‚Ç¨¬¶ Light background for better contrast */
}


/* ===== PROJECT PROGRESS STEPS ===== */
.progress-steps {
    position: relative;
    display: flex;
    flex-direction: row;
    margin: 30px 0;
    align-items: flex-start;
}

.progress-line {
    position: absolute;
    top: 25px;
    left: 20px;
    right: 20px;
    height: 4px;
    background: #dee2e6;
    z-index: 1;
}

.progress-line-fill {
    position: absolute;
    height: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    transition: width 0.5s ease;
}

.progress-step {
    position: relative;
    z-index: 2;
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    transition: all 0.3s;
}

.progress-step.normal-spacing {
    flex: 1;
    padding: 0 15px;
}

.progress-step.tight-spacing {
    flex: 0 0 70px;
    margin: 0 -5px;
}

.progress-step.medium-spacing {
    flex: 0 0 80px;
    margin: 0 0px;
}

.stage-group-container {
    display: flex;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
    border: 2px dashed #667eea;
    border-radius: 15px;
    padding: 15px 10px;
    margin: 0 10px;
    position: relative;
}

.stage-group-container::before {
    content: 'Parallel Stages';
    position: absolute;
    top: -10px;
    left: 10px;
    background: white;
    padding: 2px 10px;
    font-size: 0.7rem;
    color: #667eea;
    font-weight: 700;
    border-radius: 10px;
    border: 1px solid #667eea;
}

.step-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: white;
    border: 4px solid #dee2e6;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: #6c757d;
    transition: all 0.3s;
}

.step-circle.completed {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-color: #667eea;
    color: white;
}

.step-circle.active {
    background: #17a2b8;
    border-color: #17a2b8;
    color: white;
    box-shadow: 0 0 0 4px rgba(23,162,184,0.2);
}

.step-label {
    margin-top: 10px;
    padding: 5px 10px;
    background: white;
    border-radius: 8px;
    font-size: 0.75rem;
    font-weight: 600;
    text-align: center;
    max-width: 150px;
    word-wrap: break-word;
}

.step-label.completed {
    background: linear-gradient(135deg, #e8eef9 0%, #f0e8f5 100%);
    color: #667eea;
}

.step-label.active {
    background: #17a2b8;
    color: white;
}

.duration-badge {
    background: #667eea;
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 0.65rem;
    margin-left: 5px;
}

.project-progress-container {
    margin-bottom: 40px;
    padding: 25px;
    background: #f8f9fa;
    border-radius: 15px;
}

.project-status-badge {
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.status-active {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
}

.status-completed {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.project-actions {
    display: flex;
    gap: 8px;
    align-items: center;
}

.btn-delete-project {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 6px 12px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-delete-project:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
}

    /* ===== CALENDAR MODAL ===== */
    .calendar-modal .modal-dialog {
        max-width: 1200px;
        width: 95%;
        margin: 1.75rem auto;
    }

    .calendar-modal .modal-content {
        border-radius: 15px;
    }

    #calendar {
        width: 100%;
        min-height: 450px;
    }

    .fc {
        font-family: inherit !important;
        font-size: 0.75rem;
        background: white;
        border-radius: 10px;
        padding: 10px;
    }

    .fc-toolbar-title {
        font-size: 1rem !important;
        font-weight: 700 !important;
    }

    .fc-button {
        padding: 5px 10px !important;
        font-size: 0.75rem !important;
        border-radius: 6px !important;
    }

    .fc-event {
        padding: 2px 4px;
        margin: 1px;
        font-size: 0.7rem;
        border-radius: 4px;
    }

    /* ===== LEGEND ===== */
    .calendar-legend {
        background: transparent;
        padding: 0;
    }

    .legend-item {
        padding: 6px 8px;
        margin-bottom: 4px;
        background: #f8f9fa;
        border-radius: 6px;
        font-size: 0.7rem;
        border-left: 3px solid;
        transition: all 0.2s;
    }

    .legend-item:hover {
        background: #e9ecef;
        transform: translateX(2px);
    }

/* ===== CALENDAR TOOLBAR BUTTONS ===== */
.fc-toolbar-chunk {
    display: flex;
    gap: 5px;
}

.fc-button {
    padding: 6px 12px !important;  /* Changed from 8px 16px */
    font-size: 0.75rem !important;
}
.fc-button:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5) !important;
}

.fc-button:active,
.fc-button:focus {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%) !important;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4) !important;
}

.fc-button-active {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%) !important;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.2) !important;
}

.fc-prev-button,
.fc-next-button {
    padding: 8px 12px !important;
    font-size: 1.1rem !important;
}

.fc-today-button {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
}

.fc-today-button:hover {
    background: linear-gradient(135deg, #218838 0%, #1ba881 100%) !important;
}
/* Weekend styling */
.fc-day-sun {
    background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%) !important;
    opacity: 0.8 !important;
}

.fc-day-sat {
    background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%) !important;
    opacity: 0.8 !important;
}

/* ===== CLEAN EVENT STYLING ===== */
.fc-event {
    padding: 2px 4px;     /* Changed from 3px 6px */
    margin: 1px 1px;      /* Changed from 2px 1px */
    font-size: 0.7rem;    /* Changed from 0.8rem */
    border-left: 3px solid rgba(0,0,0,0.2) !important;  /* Changed from 4px */
}

.fc-event:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
}

/* ===== COMPLETED TASKS - Small green corner badge ===== */
.fc-event.event-completed::after {
    width: 14px;          /* Changed from 18px */
    height: 14px;
    font-size: 8px;       /* Changed from 10px */
}

.fc-event.event-completed {
    opacity: 0.85 !important;
    border-left-color: #28a745 !important;
    text-decoration: none !important;
}

.fc-event.event-rescheduled::before {
    content: '‚á¢';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 20px;
    height: 20px;
    background: #ff9800;
    border-radius: 50%;
    z-index: 10;
    box-shadow: 0 2px 6px rgba(255, 152, 0, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 14px;
    font-weight: bold;
    animation: pulse-dot 2s infinite;
}

@keyframes pulse-dot {
    0%, 100% {
        box-shadow: 0 2px 6px rgba(255, 152, 0, 0.4);
        transform: scale(1);
    }
    50% {
        box-shadow: 0 2px 12px rgba(255, 152, 0, 0.7);
        transform: scale(1.1);
    }
}
.fc-event.event-rescheduled {
    border-left-color: #ff9800 !important;
}

/* ===== STAGE RESCHEDULED - Subtle blue accent ===== */
.fc-event.stage-rescheduled {
    border-left-width: 5px !important;
    border-left-color: #17a2b8 !important;
}
.fc-event.stage-rescheduled::after {
    content: 'üîÑ';
    position: absolute;
    bottom: 2px;
    left: 2px;
    font-size: 10px;
    opacity: 0.7;
    z-index: 5;
}

/* Adjust for both completed and rescheduled */
.fc-event.event-completed.stage-rescheduled::after {
    content: '‚úì';
    top: 2px;
    right: 2px;
    bottom: auto;
    left: auto;
}

/* ===== DURATION BADGE - Cleaner design ===== */
.parallel-stage-indicator {
    position: absolute !important;
    top: 2px !important;
    right: 2px !important;
    background: rgba(255, 255, 255, 0.95) !important;
    color: #495057 !important;
    border-radius: 4px !important;
    padding: 2px 6px !important;
    font-size: 10px !important;
    font-weight: 700 !important;
    z-index: 10 !important;
    border: 1px solid rgba(0,0,0,0.1) !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.15) !important;
}

/* If completed, move duration badge to left */
.fc-event.event-completed .parallel-stage-indicator {
    right: auto !important;
    left: 2px !important;
}

/* ===== PARALLEL JOBS BADGE ===== */
.parallel-jobs-badge {
    position: absolute !important;
    top: 3px !important;
    right: 30px !important;
    background: #dc3545 !important;
    color: white !important;
    border-radius: 8px !important;
    padding: 2px 6px !important;
    font-size: 9px !important;
    font-weight: 700 !important;
    z-index: 200 !important;
    border: none !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.3) !important;
    pointer-events: none !important;
}

/* ===== ACTIVE STAGE ===== */
.fc-event.stage-event-active {
    box-shadow: 0 0 0 3px #ffc107 !important;
    animation: pulse-glow 2s infinite !important;
}

@keyframes pulse-glow {
    0%, 100% {
        box-shadow: 0 0 0 3px #ffc107;
    }
    50% {
        box-shadow: 0 0 0 6px #ffc107, 0 0 20px rgba(255, 193, 7, 0.6);
    }
}

/* ===== CLEAN TOOLTIPS ===== */
.fc-event {
    position: relative !important;
    --tooltip-x: 0;
    --tooltip-y: 0;
}

.fc-event[data-tooltip]:hover::after {
    content: attr(data-tooltip);
    position: fixed !important;  /* Changed from absolute to fixed */
    left: var(--tooltip-x, 50%);
    top: var(--tooltip-y, auto);
    transform: translate(-50%, -100%);
    background: rgba(44, 62, 80, 0.98);
    color: white;
    padding: 12px 16px;
    border-radius: 8px;
    white-space: pre-line;
    font-size: 11.5px;
    line-height: 1.6;
    z-index: 999999 !important;  /* Maximum z-index */
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    min-width: 180px;
    max-width: 300px;
    pointer-events: none;
    display: block !important;
    animation: tooltipFadeIn 0.2s ease-out;
    border: 1px solid rgba(255,255,255,0.1);
}

@keyframes tooltipFadeIn {
    from {
        opacity: 0;
        transform: translate(-50%, -90%);
    }
    to {
        opacity: 1;
        transform: translate(-50%, -100%);
    }
}

.fc-event[data-tooltip]:hover::before {
    content: '';
    position: fixed !important;
    left: var(--tooltip-x, 50%);
    top: var(--tooltip-y, auto);
    transform: translate(-50%, 0);
    border: 8px solid transparent;
    border-top-color: rgba(44, 62, 80, 0.98);
    z-index: 999999 !important;
    display: block !important;
    margin-top: -1px;
}

/* Tooltip below element (when near top of screen) */
.fc-event.tooltip-below[data-tooltip]:hover::after {
    transform: translate(-50%, 0) !important;
    margin-top: 8px;
}

.fc-event.tooltip-below[data-tooltip]:hover::before {
    transform: translate(-50%, -100%) !important;
    border-top-color: transparent !important;
    border-bottom-color: rgba(44, 62, 80, 0.98) !important;
    margin-top: 0;
    margin-bottom: -16px;
}

/* Ghost event tooltips */
.fc-event.ghost-event[data-tooltip]:hover::after {
    background: rgba(255, 152, 0, 0.98) !important;
    border-color: rgba(255,255,255,0.15);
}

.fc-event.ghost-event[data-tooltip]:hover::before {
    border-top-color: rgba(255, 152, 0, 0.98) !important;
}

.fc-event.ghost-event.tooltip-below[data-tooltip]:hover::before {
    border-bottom-color: rgba(255, 152, 0, 0.98) !important;
}

/* Ensure calendar containers don't clip tooltips */
.calendar-modal .modal-body,
#calendar, 
.fc, 
.fc-view-harness,
.fc-daygrid-body, 
.fc-scrollgrid,
.fc-scrollgrid-sync-table {
    overflow: visible !important;
}

/* ===== LEGEND ===== */
.calendar-legend {
    padding: 12px;        /* Changed from 15px */
    max-height: 400px;    /* Changed from 450px */
}

.calendar-legend h6 {
    font-size: 0.85rem;   /* Changed from 0.95rem */
}

.legend-item {
    padding: 8px;         /* Changed from 10px */
    font-size: 0.75rem;   /* Changed from 0.8rem */
}

.legend-item:hover {
    background: #e9ecef;
    transform: translateX(5px);
}

/* ===== DAY RESCHEDULE BUTTON ===== */
.day-reschedule-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 0.65rem;
    cursor: pointer;
    z-index: 150;
    transition: all 0.3s;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

.fc-daygrid-day:hover .day-reschedule-btn {
    display: flex;
}

.day-reschedule-btn:hover {
    transform: scale(1.15);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
}

/* ===== MINI RESCHEDULE POPUP ===== */
.mini-reschedule-popup {
    position: fixed;
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    padding: 15px;
    z-index: 9999;
    min-width: 280px;
    display: none;
    border: 2px solid #667eea;
}

.mini-reschedule-popup.active {
    display: block;
    animation: popIn 0.3s ease-out;
}

@keyframes popIn {
    from {
        opacity: 0;
        transform: scale(0.8) translateY(-20px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.mini-reschedule-popup h6 {
    margin: 0 0 10px 0;
    color: #667eea;
    font-weight: 700;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.mini-reschedule-popup .stage-chip {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 6px 10px;
    margin: 4px 0;
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
}

.mini-reschedule-popup .stage-chip:hover {
    border-color: #667eea;
    background: #e8eef9;
}

/* ===== DAILY TASK MODAL ===== */
.daily-task-item {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 15px;
    transition: all 0.3s;
    border: 2px solid transparent;
}

.daily-task-item:hover {
    border-color: #667eea;
    background: #e8eef9;
}

.daily-task-item.completed {
    opacity: 0.7;
    background: #e8f5e9;
    border-left: 4px solid #10b981;
}

.daily-task-item.rescheduled {
    border-left: 4px solid #f59e0b;
    background: #fffbeb;
}

.task-day-number {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.1rem;
}

.task-day-number.completed {
    background: #28a745;
}

.task-status-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

.badge-pending {
    background: #6c757d;
    color: white;
}

.badge-completed {
    background: #28a745;
    color: white;
}

.badge-rescheduled {
    background: #ffc107;
    color: #000;
}

/* ===== ANIMATIONS ===== */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ===== RESPONSIVE ===== */
@media (max-width: 992px) {
    .calendar-legend {
        max-height: 250px;  /* Changed from 300px */
    }
    
    .fc {
        font-size: 0.7rem;
        padding: 8px;
    }
    
    #calendar {
        min-height: 400px;
    }
}

/* ===== SCROLLBAR ===== */
.calendar-legend::-webkit-scrollbar {
    width: 6px;
}

.calendar-legend::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.calendar-legend::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 10px;
}
/* Ghost Events - Show original locations */
.fc-event.ghost-event {
    opacity: 0.5 !important;
    border: 2px dashed rgba(220, 53, 69, 0.6) !important;
    background: repeating-linear-gradient(
        45deg,
        rgba(255, 255, 255, 0.8),
        rgba(255, 255, 255, 0.8) 8px,
        rgba(220, 53, 69, 0.15) 8px,
        rgba(220, 53, 69, 0.15) 16px
    ) !important;
    cursor: help !important;
    pointer-events: auto !important;
}
.fc-event.ghost-event .fc-event-main {
    color: #ff9800 !important;
    font-weight: 600 !important;
    text-decoration: line-through !important;
}
.fc-event.ghost-event::before {
    display: none !important;
}
/* Date cell reschedule indicator */
.date-reschedule-badge {
    position: absolute;
    bottom: 3px;
    left: 3px;
    background: #ff9800;
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: bold;
    z-index: 100;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* Enhanced tooltip for ghost events */
.fc-event.ghost-event {
    opacity: 0.6 !important;
    border: 2px dashed rgba(255, 152, 0, 0.8) !important;
    background: repeating-linear-gradient(
        45deg,
        rgba(255, 255, 255, 0.9),
        rgba(255, 255, 255, 0.9) 8px,
        rgba(255, 152, 0, 0.2) 8px,
        rgba(255, 152, 0, 0.2) 16px
    ) !important;
    cursor: help !important;
    pointer-events: auto !important;
    position: relative !important;
}

.fc-event.ghost-event::after {
    content: 'MOVED';
    position: absolute !important;
    top: 2px !important;
    right: 2px !important;
    background: #ff9800 !important;
    color: white !important;
    border-radius: 4px !important;
    padding: 2px 5px !important;
    font-size: 8px !important;
    font-weight: bold !important;
    z-index: 999 !important;
    display: block !important;
}


/* Enhanced reschedule indicator */
.reschedule-indicator {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-10px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.daily-task-item.rescheduled {
    border-left: 4px solid #ff9800 !important;
    background: linear-gradient(135deg, #fffbf0 0%, #fff8e8 100%) !important;
}

.daily-task-item {
    transition: all 0.3s ease;
}

.task-info {
    min-width: 0; /* Allow flex shrinking */
}

.card.mb-2 {
    border-radius: 12px !important;
    border: 2px solid #e9ecef !important;
    transition: all 0.3s ease;
    background: white !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.card.mb-2:hover {
    border-color: #667eea !important;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    transform: translateY(-2px);
}
.card.mb-2[style*="border-left: 3px solid rgb(102, 126, 234)"] {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.03) 0%, rgba(118, 75, 162, 0.03) 100%) !important;
}
/* ===== FORM CONTROLS - BETTER STYLING ===== */
.modal-body .form-control,
.modal-body .form-select {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    transition: all 0.3s ease;
    background: white;
}

.modal-body .form-control:focus,
.modal-body .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.modal-body .form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
}

/* ===== STAGE CONTAINER - BETTER SCROLLBAR ===== */
#stagesContainer {
    background: white;
    border-radius: 12px;
    padding: 15px;
    max-height: 50vh;
    overflow-y: auto;
}

#stagesContainer::-webkit-scrollbar {
    width: 8px;
}

#stagesContainer::-webkit-scrollbar-track {
    background: #f1f3f5;
    border-radius: 10px;
}

#stagesContainer::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 10px;
}

/* ===== CHECKBOX STYLING ===== */
.form-check-input {
    width: 20px;
    height: 20px;
    border: 2px solid #dee2e6;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.form-check-input:checked {
    background-color: #667eea;
    border-color: #667eea;
}

.form-check-input:focus {
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.25);
}

/* ===== PROJECTED END DATE - ENHANCED ===== */
.alert-info {
    background: linear-gradient(135deg, #e8f4fd 0%, #f3e8fd 100%) !important;
    border: 2px solid #667eea !important;
    border-radius: 12px !important;
    color: #495057 !important;
}

/* ===== MANAGER DROPDOWN - BETTER VISIBILITY ===== */
.form-select {
    font-weight: 500;
    color: #495057;
}

.form-select option {
    padding: 10px;
}

/* ===== DELETE BUTTON - SUBTLE ===== */
.btn-outline-danger {
    border-radius: 8px !important;
    opacity: 0.7;
    transition: all 0.2s ease;
}

.btn-outline-danger:hover {
    opacity: 1;
    transform: scale(1.05);
}

/* ===== ADD CUSTOM / RESET BUTTONS ===== */
.btn-success, .btn-outline-secondary {
    border-radius: 8px !important;
    font-weight: 600 !important;
    transition: all 0.2s ease !important;
}

.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
}

/* ===== CREATE JOB BUTTON - ENHANCED ===== */
.btn-primary-custom.w-100 {
    padding: 15px !important;
    font-size: 1.1rem !important;
    border-radius: 12px !important;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.btn-primary-custom.w-100:hover {
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    transform: translateY(-2px);
}

/* ===== MODAL BACKDROP - BETTER BLUR ===== */
.modal-backdrop {
    backdrop-filter: blur(3px);
}

/* ===== RESPONSIVE ADJUSTMENTS ===== */
@media (max-width: 768px) {
    .modal-body {
        padding: 15px;
    }
    
    .card.mb-2 .card-body {
        padding: 12px !important;
    }
}

/* ===== STAGE CONTENT OPACITY FIX ===== */
#stageContent-1, #stageContent-2, #stageContent-3,
#stageContent-4, #stageContent-5, #stageContent-6,
#stageContent-7, #stageContent-8, #stageContent-9,
#stageContent-10, #stageContent-11, #stageContent-12,
#stageContent-13, #stageContent-14 {
    transition: opacity 0.3s ease;
}

/* ===== DURATION BADGE IN STAGE CARDS ===== */
.duration-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 3px 8px;
    border-radius: 8px;
    font-size: 0.7rem;
    font-weight: 700;
    margin-left: 8px;
}

/* ===== WORKING DAYS BADGE ===== */
span[style*="background: rgb(102, 126, 234)"] {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    border-radius: 8px !important;
    padding: 4px 10px !important;
    font-size: 0.7rem !important;
    font-weight: 700 !important;
}


    </style>
</head>
<body>
    <div class="container-fluid" style="max-width: 1400px;">
        <div class="top-bar-custom d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-0">Welcome, {{ current_user.username }}!</h4>
                <small class="text-muted">Have a productive day</small>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="position-relative">
                    <button class="btn btn-link text-dark" onclick="toggleNotifications()">
                        <i class="fas fa-bell fa-lg"></i>
                        <span class="notification-badge" id="notifBadge">0</span>
                    </button>
                </div>
                <a href="/logout" class="btn btn-outline-danger">
                    <i class="fas fa-sign-out-alt me-2"></i> Logout
                </a>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <i class="fas fa-briefcase"></i>
                    </div>
                    <p>Total Jobs</p>
                    <h3 id="totalProjects">0</h3>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="icon" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <p>Active Jobs</p>
                    <h3 id="activeProjects">0</h3>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="icon" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: white;">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <p>Total Tasks</p>
                    <h3 id="totalTasks">0</h3>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="icon" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white;">
                        <i class="fas fa-users"></i>
                    </div>
                    <p>Team Members</p>
                    <h3 id="totalEmployees">0</h3>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card-custom">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>All Jobs</span>
                        <button class="btn btn-sm btn-primary-custom" onclick="openProjectModal()">
                            <i class="fas fa-plus me-1"></i> New Job
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="allProjectsSection"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<div class="modal fade" id="projectModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content" style="border-radius: 15px; overflow: hidden;">
            <div class="modal-header" style="border: none;">
                <h5 class="modal-title">Create New Job</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
        <div class="modal-body" style="max-height: 75vh; overflow-y: auto;">
        <form id="projectForm">
            <div class="row">
                <!-- Left Column -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Job Number</label>
                        <input type="text" class="form-control form-control-sm" id="projectName" required placeholder="Enter job number">
                    </div>
                    <!-- REMOVED DESCRIPTION FIELD -->
                    <div class="mb-3">
                        <label class="form-label">Start Date</label>
                        <input type="date" class="form-control form-control-sm" id="projectStartDate" required onchange="updateProjectEndDate()">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Team Members</label>
                        <select class="form-select form-select-sm" id="memberSelect" onchange="addMember()">
                            <option value="">Select member to add...</option>
                        </select>
                        <div id="selectedMembers" class="mt-2"></div>
                    </div>
                    <div class="alert alert-info py-2 mb-0">
                        <small>
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>Projected End Date:</strong> <span id="projectedEndDate">Not calculated</span>
                        </small>
                    </div>
                </div>
                
                <!-- Right Column -->
                <div class="col-md-6">
                    <div class="mb-2">
                        <label class="form-label d-flex justify-content-between align-items-center mb-2">
                            <span>Tasks</span>
                            <div>
                                <button type="button" class="btn btn-sm btn-success py-1 px-2 me-1" onclick="addCustomTask()" style="font-size: 0.75rem;">
                                    <i class="fas fa-plus"></i> Add Custom
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary py-1 px-2" onclick="loadDefaultStages()" style="font-size: 0.75rem;">
                                    <i class="fas fa-redo"></i> Reset
                                </button>
                            </div>
                        </label>
                        <div id="stagesContainer" style="max-height: 50vh; overflow-y: auto; padding-right: 5px;"></div>
                    </div>
                </div>
            </div>
             <div class="mt-3">
            <button type="submit" class="btn btn-primary-custom w-100">Create Job</button>
        </div>
    </form>
 </div>       
 </div>
</div>
</div>
<!-- Task Popup Modal (ADD THIS IF YOU DON'T HAVE IT) -->
     <div id="taskPopup" style="display: none;">
        <div class="popup-overlay" onclick="closePopup()"></div>
        <div class="popup-container">
            <div id="popupContent"></div>
        </div>
    </div>
<div class="modal fade calendar-modal" id="calendarModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title mb-1" id="calendarProjectTitle">Job Calendar View</h5>
                    <small class="text-white-50" id="calendarProjectDates"></small>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <div class="row g-2">
                    <!-- Calendar Section - Full Width -->
                    <div class="col-12">
                        <div style="background: white; padding: 10px; border-radius: 10px;">
                            <div id="calendar"></div>
                        </div>
                    </div>
                    
                    <!-- Compact Legend Below Calendar -->
                    <div class="col-12">
                        <div class="d-flex gap-2 flex-wrap">
                            <!-- Stages Legend - Compact Horizontal -->
                            <div class="flex-grow-1" style="background: white; padding: 10px; border-radius: 10px;">
                                <h6 style="font-size: 0.8rem; margin-bottom: 8px; font-weight: 700;">
                                    <i class="fas fa-palette me-1"></i>Stages
                                </h6>
                                <div id="calendarLegend" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 6px; max-height: 150px; overflow-y: auto;"></div>
                            </div>
                            
                            <!-- Status Indicators - Compact -->
                            <div style="background: white; padding: 10px; border-radius: 10px; min-width: 200px;">
                                <h6 style="font-size: 0.8rem; margin-bottom: 8px; font-weight: 700;">
                                    <i class="fas fa-info-circle me-1"></i>Legend
                                </h6>
                                <div style="font-size: 0.7rem; line-height: 1.5;">
                                    <div style="margin-bottom: 4px;">
                                        <span style="display: inline-block; width: 8px; height: 8px; background: #dc3545; border-radius: 2px; margin-right: 4px;"></span>
                                        Parallel
                                    </div>
                                    <div style="margin-bottom: 4px;">
                                        <span style="display: inline-block; width: 8px; height: 8px; background: #ffc107; border-radius: 2px; margin-right: 4px;"></span>
                                        Active
                                    </div>
                                    <div style="margin-bottom: 4px;">
                                        <span style="display: inline-block; width: 8px; height: 8px; background: #28a745; border-radius: 2px; margin-right: 4px;"></span>
                                        Done
                                    </div>
                                    <div>
                                        <span style="display: inline-block; width: 8px; height: 8px; background: #ff9800; border-radius: 2px; margin-right: 4px;"></span>
                                        Moved
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Mini Reschedule Popup -->
<div class="mini-reschedule-popup" id="miniReschedulePopup">
    <h6>
        <span><i class="fas fa-calendar-alt me-2"></i>Stages on <span id="popupDate"></span></span>
        <button class="close-popup" onclick="closeMiniPopup()">√É∆í√¢‚Ç¨‚Äù</button>
    </h6>
    <div id="popupStagesList"></div>
</div>
<!-- Compact Reschedule Modal -->
<div class="modal fade reschedule-modal-compact" id="rescheduleModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-white">
                    <i class="fas fa-calendar-plus me-2"></i>Reschedule Stage
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Stage Info Card -->
                <div class="card mb-3" style="background: linear-gradient(135deg, #f5f7fa 0%, #e8eef9 100%);">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-start">
                            <div class="flex-grow-1">
                                <div class="mb-2">
                                    <strong style="color: #667eea; font-size: 1.1rem;" id="rescheduleStageInfo"></strong>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted">Current:</small><br>
                                    <span id="rescheduleCurrentDates" class="badge bg-dark"></span>
                                </div>
                                <div id="rescheduleNewDatesPreview" style="display: none;">
                                    <small class="text-muted">New:</small><br>
                                    <span id="rescheduleNewDatesValue" class="badge bg-success"></span>
                                </div>
                            </div>
                            <div id="rescheduleStageColor" style="width: 40px; height: 40px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Reschedule Form -->
                <form id="rescheduleForm">
                    <div class="mb-3">
                        <label class="form-label fw-bold" style="font-size: 0.9rem;">
                            <i class="fas fa-arrows-alt-h me-2"></i>Shift by days
                        </label>
                        <div class="input-group">
                            <button class="btn btn-outline-secondary" type="button" onclick="adjustRescheduleDays(-1)">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" class="form-control text-center fw-bold" id="rescheduleDays" required 
                                   placeholder="0" style="font-size: 1.1rem;" oninput="updateReschedulePreview()">
                            <button class="btn btn-outline-secondary" type="button" onclick="adjustRescheduleDays(1)">
                                <i class="fas fa-plus"></i>
                            </button>
                            <span class="input-group-text">days</span>
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-lightbulb me-1"></i>
                            Positive = forward, Negative = backward
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold" style="font-size: 0.9rem;">
                            <i class="fas fa-comment-dots me-2"></i>Reason (optional)
                        </label>
                        <textarea class="form-control" id="rescheduleReason" rows="2" 
                                  placeholder="e.g., Resource availability..."></textarea>
                    </div>
                    
                    <!-- Impact Warning -->
                    <div class="alert alert-warning py-2" id="rescheduleImpactWarning" style="display: none; font-size: 0.85rem;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="rescheduleImpactText"></span>
                    </div>
                    
                    <input type="hidden" id="rescheduleProjectId">
                    <input type="hidden" id="rescheduleStageId">
                    <input type="hidden" id="rescheduleStageStartDate">
                    <input type="hidden" id="rescheduleStageEndDate">
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary-custom">
                            <i class="fas fa-check-circle me-2"></i>Confirm Reschedule
                        </button>
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Daily Task Management Modal -->
<div class="modal fade" id="dailyTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title text-white" id="dailyTaskModalTitle">Manage Daily Tasks</h5>
                    <small class="text-white-50" id="dailyTaskStageName"></small>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="dailyTasksList"></div>
            </div>
        </div>
    </div>
</div>

<!-- Reschedule Single Day Modal -->
<div class="modal fade" id="rescheduleDayModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-white">Reschedule Day</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" id="dayRescheduleInfo"></div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Shift by working days:</label>
                    <div class="input-group">
                        <button class="btn btn-outline-secondary" type="button" onclick="adjustDayShift(-1)">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" class="form-control text-center fw-bold" id="dayShiftAmount" value="0">
                        <button class="btn btn-outline-secondary" type="button" onclick="adjustDayShift(1)">
                            <i class="fas fa-plus"></i>
                        </button>
                        <span class="input-group-text">days</span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Reason:</label>
                    <textarea class="form-control" id="dayRescheduleReason" rows="2" placeholder="Why is this day being rescheduled?"></textarea>
                </div>
                
                <div id="dayReschedulePreview" style="display: none;" class="alert alert-success"></div>
                
                <input type="hidden" id="rescheduleTaskId">
                <input type="hidden" id="rescheduleTaskProjectId">
                <input type="hidden" id="rescheduleTaskStageId">
                
                <div class="d-grid gap-2">
                    <button class="btn btn-primary-custom" onclick="confirmDayReschedule()">
                        <i class="fas fa-check-circle me-2"></i>Confirm Reschedule
                    </button>
                    <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>  


<!-- Add this right before the opening <script> tag -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
<script>
    let projects = [];
    let employees = [];
    let projectModal;
    let stageCounter = 0;
    let selectedMembers = [];
    let defaultStages = [];
    let calendar;
    let calendarModal;
    let rescheduleModal;
    let currentProjectForCalendar = null;
    let currentProjectData = null;
    let includeSaturdayAsWorkingDay = false;
    let workingSaturdays = new Set();
    let dailyTaskModal;
    let rescheduleDayModal;
    let currentStageForDailyTasks = null; // Track individual working Saturdays
    
    const STAGE_COLORS = [
        '#667eea', '#764ba2', '#f093fb', '#4facfe', 
        '#43e97b', '#fa709a', '#fee140', '#30cfd0', 
        '#a8edea', '#ff6a88', '#feca57', '#48dbfb'
    ];

    // Add this near the top of your script section
    async function handleApiResponse(response) {
        if (response.status === 401) {
            alert('Your session has expired. Please log in again.');
            window.location.href = '/login';
            throw new Error('Session expired');
        }
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return response.json();
    }    

    document.addEventListener('DOMContentLoaded', function() {
        projectModal = new bootstrap.Modal(document.getElementById('projectModal'));
        calendarModal = new bootstrap.Modal(document.getElementById('calendarModal'));
        rescheduleModal = new bootstrap.Modal(document.getElementById('rescheduleModal'));
        
        document.getElementById('projectForm').addEventListener('submit', handleProjectSubmit);
        document.getElementById('rescheduleForm').addEventListener('submit', handleReschedule);
        
        // Add event listener for start date change
        document.getElementById('projectStartDate').addEventListener('change', checkStartDateWeekend);
        document.getElementById('projectStartDate').valueAsDate = new Date();
        dailyTaskModal = new bootstrap.Modal(document.getElementById('dailyTaskModal'));
        rescheduleDayModal = new bootstrap.Modal(document.getElementById('rescheduleDayModal'));
        
        const saturdayCheckbox = document.getElementById('includeSaturday');
        if (saturdayCheckbox) {
            saturdayCheckbox.addEventListener('change', (e) => {
                includeSaturdayAsWorkingDay = e.target.checked;
                updateProjectEndDate();
                if (currentProjectForCalendar && calendar) {
                    openCalendarView(currentProjectForCalendar);
                }
                loadProjects();
            });
        }
        
        init();
    });

    // NEW FUNCTION: Check if start date is weekend
    function checkStartDateWeekend() {
        const startDateInput = document.getElementById('projectStartDate');
        if (!startDateInput.value) return;
        
        const selectedDate = new Date(startDateInput.value);
        const dayOfWeek = selectedDate.getDay();
        
        // Check if Sunday (0)
                if (dayOfWeek === 0) {
            showPopup(
                '‚ö†Ô∏è Sunday is a Holiday',                       
                'The selected start date falls on Sunday, which is a holiday. Please select a working day (Monday-Friday).',
                        [
                            {
                                text: 'Choose Another Date',
                                className: 'btn-primary',
                                onClick: () => {
                                    startDateInput.value = '';
                                    startDateInput.focus();
                                    closePopup();
                                }
                            }
                        ]
                    );
                    return;
                }        
        // Check if Saturday (6)
        if (dayOfWeek === 6) {
            const dateStr = selectedDate.toISOString().split('T')[0];
            
        showPopup(
                'üìÖ Saturday Detected',
                `The selected start date is Saturday (${selectedDate.toLocaleDateString()}). Do you want to consider this Saturday as a working day?`,
                [
                    {
                        text: '\u2714 Yes, Working Day',
                        className: 'btn-success',
                        onClick: () => {
                            workingSaturdays.add(dateStr);
                            updateProjectEndDate();
                            closePopup();
                            showNotification('Saturday marked as working day', 'success');
                        }
                    },               
                       {
                        text: '\u274C No, Holiday',
                        className: 'btn-secondary',
                        onClick: () => {
                            workingSaturdays.delete(dateStr);
                            // Move to next Monday
                            const nextMonday = new Date(selectedDate);
                            nextMonday.setDate(nextMonday.getDate() + 2);
                            startDateInput.valueAsDate = nextMonday;
                            updateProjectEndDate();
                            closePopup();
                            showNotification('Start date moved to Monday', 'info');
                        }
                    }              
                ]
            );
        }
    }

    // NEW FUNCTION: Show popup dialog
    function showPopup(title, message, buttons) {
        const popup = document.getElementById('taskPopup');
        const content = document.getElementById('popupContent');
        
        const buttonsHtml = buttons.map((btn, index) => 
            `<button class="btn ${btn.className}" id="popupBtn${index}">${btn.text}</button>`
        ).join('');
        
        content.innerHTML = `
            <h5 style="margin-bottom: 15px; color: #667eea;">${title}</h5>
            <p style="margin-bottom: 20px; line-height: 1.6;">${message}</p>
            <div class="popup-buttons">
                ${buttonsHtml}
            </div>
        `;
        
        // Attach click handlers after rendering
        buttons.forEach((btn, index) => {
            document.getElementById(`popupBtn${index}`).onclick = btn.onClick;
        });
        
        popup.style.display = 'block';
    }

    // NEW FUNCTION: Close popup
    function closePopup() {
        document.getElementById('taskPopup').style.display = 'none';
    }

    // UPDATED FUNCTION: Calculate working days excluding weekends
    function addWorkingDays(startDate, days) {
        if (days === 0) return startDate;
        
        let currentDate = new Date(startDate);
        let direction = days > 0 ? 1 : -1;
        let daysRemaining = Math.abs(days);
        
        while (daysRemaining > 0) {
            currentDate.setDate(currentDate.getDate() + direction);
            
            const dayOfWeek = currentDate.getDay();
            const dateStr = currentDate.toISOString().split('T')[0];
            
            // Skip Sundays (0)
            if (dayOfWeek === 0) continue;
            
            // For Saturdays (6), check if it's a working Saturday
            if (dayOfWeek === 6) {
                if (workingSaturdays.has(dateStr) || includeSaturdayAsWorkingDay) {
                    daysRemaining--;
                }
                continue;
            }
            
            // Monday-Friday are working days
            daysRemaining--;
        }
        
        return currentDate;
    }

    // UPDATED FUNCTION: Get next working day
    function getNextWorkingDay(date) {
        let checkDate = new Date(date);
        
        while (true) {
            const dayOfWeek = checkDate.getDay();
            const dateStr = checkDate.toISOString().split('T')[0];
            
            // Sunday - skip
            if (dayOfWeek === 0) {
                checkDate.setDate(checkDate.getDate() + 1);
                continue;
            }
            
            // Saturday - check if working
            if (dayOfWeek === 6) {
                if (workingSaturdays.has(dateStr) || includeSaturdayAsWorkingDay) {
                    return checkDate;
                }
                checkDate.setDate(checkDate.getDate() + 1);
                continue;
            }
            
            // Monday-Friday
            return checkDate;
        }
    }

    async function init() {
        await loadDefaultStagesFromAPI();
        await loadEmployees();
        await loadStats();
        await loadProjects();
    }

    async function loadDefaultStagesFromAPI() {
        const response = await fetch('/api/default-stages');
        defaultStages = await response.json();
    }

    function loadDefaultStages() {
            document.getElementById('stagesContainer').innerHTML = '';
            stageCounter = 0;
            defaultStages.forEach(stage => addTaskCheckbox(stage.name, stage.duration_days, true));
            updateProjectEndDate();
        }

        function addTaskCheckbox(name, duration, isChecked = false, managerId = null) {
            stageCounter++;
            const html = `
                <div class="card mb-2" id="stage-${stageCounter}" style="background: #f8f9fa; border-left: 3px solid ${isChecked ? '#667eea' : '#dee2e6'};">
                    <div class="card-body p-2">
                        <div class="d-flex align-items-start gap-2">
                            <input type="checkbox" class="form-check-input mt-1" id="stageCheck-${stageCounter}" 
                                ${isChecked ? 'checked' : ''} onchange="toggleStageSelection(${stageCounter})" 
                                style="width: 18px; height: 18px; cursor: pointer;">
                            <div class="flex-grow-1" id="stageContent-${stageCounter}" style="opacity: ${isChecked ? '1' : '0.5'};">
                                <div class="mb-2">
                                    <strong style="color: #495057; font-size: 0.85rem;">${name}</strong>
                                    <input type="hidden" id="stageName-${stageCounter}" value="${name}">
                                </div>
                                <div class="row mb-2">
                                    <div class="col-4">
                                        <label class="form-label mb-1" style="font-size: 0.75rem;">Duration (days):</label>
                                        <input type="number" class="form-control form-control-sm" placeholder="Days" 
                                            id="stageDuration-${stageCounter}" min="1" value="${duration}" 
                                            onchange="updateProjectEndDate()" style="font-size: 0.85rem;" ${!isChecked ? 'disabled' : ''}>
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label mb-1" style="font-size: 0.75rem;">Manager:</label>
                                        <select class="form-select form-select-sm" id="stageManager-${stageCounter}" 
                                            style="font-size: 0.85rem;" ${!isChecked ? 'disabled' : ''}>
                                            <option value="">Select Manager...</option>
                                        </select>
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label mb-1" style="font-size: 0.75rem;">Custom Start:</label>
                                        <input type="date" class="form-control form-control-sm" 
                                            id="stageStartDate-${stageCounter}" 
                                            onchange="updateProjectEndDate()" style="font-size: 0.85rem;" ${!isChecked ? 'disabled' : ''}>
                                    </div>
                                </div>
                                <div>
                                    <small class="text-muted" style="font-size: 0.65rem;">
                                        <i class="fas fa-calendar me-1"></i>
                                        <span id="stagePreview-${stageCounter}">Calculating...</span>
                                    </small>
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger py-0 px-1" onclick="removeStage(${stageCounter})" 
                                    style="font-size: 0.7rem; ${isChecked ? 'display: none;' : ''}" id="deleteBtn-${stageCounter}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('stagesContainer').insertAdjacentHTML('beforeend', html);
            
            // Populate manager dropdown
            populateManagerDropdown(stageCounter, managerId);
        }

        function populateManagerDropdown(stageId, selectedManagerId = null) {
            const managerSelect = document.getElementById(`stageManager-${stageId}`);
            if (!managerSelect) return;
            
            managerSelect.innerHTML = '<option value="">Select Manager...</option>' + 
                employees.map(e => `<option value="${e.id}" ${e.id === selectedManagerId ? 'selected' : ''}>${e.username}</option>`).join('');
        }

        function toggleStageSelection(id) {
            const checkbox = document.getElementById(`stageCheck-${id}`);
            const content = document.getElementById(`stageContent-${id}`);
            const card = document.getElementById(`stage-${id}`);
            const durationInput = document.getElementById(`stageDuration-${id}`);
            const managerSelect = document.getElementById(`stageManager-${id}`);  // ADD THIS
            const startDateInput = document.getElementById(`stageStartDate-${id}`);
            const deleteBtn = document.getElementById(`deleteBtn-${id}`);
            
            if (checkbox.checked) {
                content.style.opacity = '1';
                card.style.borderLeftColor = '#667eea';
                durationInput.disabled = false;
                managerSelect.disabled = false;  // ADD THIS
                startDateInput.disabled = false;
                if (deleteBtn) deleteBtn.style.display = 'none';
            } else {
                content.style.opacity = '0.5';
                card.style.borderLeftColor = '#dee2e6';
                durationInput.disabled = true;
                managerSelect.disabled = true;  // ADD THIS
                startDateInput.disabled = true;
                if (deleteBtn) deleteBtn.style.display = 'block';
            }
            
            updateProjectEndDate();
        }

        function addCustomTask() {
            const taskName = prompt('Enter custom task name:');
            if (!taskName || taskName.trim() === '') return;
            
            const duration = prompt('Enter duration in days:', '1');
            if (!duration || isNaN(duration) || parseInt(duration) < 1) return;
            
            addTaskCheckbox(taskName.trim(), parseInt(duration), true);
            updateProjectEndDate();
            showNotification('Custom task added!', 'success');
        }

        function addStageWithData(name, duration) {
            addTaskCheckbox(name, duration, true);
        }
        function removeStage(id) {
            document.getElementById(`stage-${id}`)?.remove();
            updateProjectEndDate();
        }

    // UPDATED FUNCTION: Update project end date with working days calculation
    function updateProjectEndDate() {
        const startDateInput = document.getElementById('projectStartDate');
        if (!startDateInput.value) return;
        
        const projectStartDate = new Date(startDateInput.value);
        let currentDate = getNextWorkingDay(projectStartDate);
        const stageElements = document.querySelectorAll('[id^="stage-"]');
        
        const stageDates = [];
        
        stageElements.forEach((element, idx) => {
            const id = element.id.split('-')[1];
            const checkbox = document.getElementById(`stageCheck-${id}`);
            
            // Skip unchecked tasks
            if (!checkbox || !checkbox.checked) return;
            
            const duration = parseInt(document.getElementById(`stageDuration-${id}`)?.value) || 1;
            const customStartDateInput = document.getElementById(`stageStartDate-${id}`);
            const customStartDate = customStartDateInput?.value;
            
            let stageStart;
            if (customStartDate) {
                stageStart = getNextWorkingDay(new Date(customStartDate));
            } else {
                stageStart = new Date(currentDate);
            }
            
            // Calculate end date using working days
            const stageEnd = addWorkingDays(stageStart, duration - 1);
            
            stageDates.push({ 
                id: id,
                index: idx,
                start: stageStart, 
                end: stageEnd,
                hasCustomDate: !!customStartDate,
                duration: duration
            });
            
            if (!customStartDate) {
                currentDate = addWorkingDays(stageEnd, 1);
            }
        });
        
        // Detect overlapping stages
        const overlapGroups = [];
        stageDates.forEach((stage, idx) => {
            const overlappingIndices = [idx];
            
            stageDates.forEach((otherStage, otherIdx) => {
                if (idx === otherIdx) return;
                const hasOverlap = (stage.start <= otherStage.end && stage.end >= otherStage.start);
                if (hasOverlap && !overlappingIndices.includes(otherIdx)) {
                    overlappingIndices.push(otherIdx);
                }
            });
            
            if (overlappingIndices.length > 1) {
                overlappingIndices.sort((a, b) => a - b);
                const groupExists = overlapGroups.some(group => 
                    JSON.stringify(group.stages.sort()) === JSON.stringify(overlappingIndices.sort())
                );
                if (!groupExists) {
                    overlapGroups.push({ stages: overlappingIndices });
                }
            }
        });
    
    // Update previews
    stageDates.forEach((stageData, idx) => {
        const preview = document.getElementById(`stagePreview-${stageData.id}`);
        if (!preview) return;
        
        let previewHTML = `${stageData.start.toLocaleDateString()} - ${stageData.end.toLocaleDateString()}`;
        previewHTML += ` <span class="duration-badge">${stageData.duration} working days</span>`;
        
        if (stageData.hasCustomDate) {
            previewHTML += ' <span class="badge bg-primary" style="font-size: 0.65rem;">Custom</span>';
        }
        
        const overlapGroup = overlapGroups.find(group => group.stages.includes(idx));
        if (overlapGroup) {
            const position = overlapGroup.stages.indexOf(idx) + 1;
            const total = overlapGroup.stages.length;
            previewHTML += ` <span class="badge bg-warning" style="font-size: 0.65rem;">Overlap ${position}/${total}</span>`;
        }
        
        preview.innerHTML = previewHTML;
    });
    
    // Update projected end date with proper messaging
    if (stageDates.length > 0) {
        const latestEndDate = stageDates.reduce((latest, stage) => {
            return stage.end > latest ? stage.end : latest;
        }, stageDates[0].end);
        
        document.getElementById('projectedEndDate').textContent = latestEndDate.toLocaleDateString();
    } else {
        document.getElementById('projectedEndDate').textContent = 'No tasks selected';
    }
}
    function addMember() {
        const select = document.getElementById('memberSelect');
        const memberId = parseInt(select.value);
        if (!memberId || selectedMembers.includes(memberId)) return;
        selectedMembers.push(memberId);
        renderSelectedMembers();
        select.value = '';
    }

    function removeMember(memberId) {
        selectedMembers = selectedMembers.filter(id => id !== memberId);
        renderSelectedMembers();
    }

    function renderSelectedMembers() {
        const container = document.getElementById('selectedMembers');
        container.innerHTML = selectedMembers.map(memberId => {
            const member = employees.find(e => e.id === memberId);
            return `<div class="member-chip"><i class="fas fa-user-circle me-1"></i>${member.username}<i class="fas fa-times" onclick="removeMember(${memberId})"></i></div>`;
        }).join('');
    }

    async function loadStats() {
        const response = await fetch('/api/stats');
        const data = await response.json();
        document.getElementById('totalProjects').textContent = data.total_projects;
        document.getElementById('activeProjects').textContent = data.active_projects;
        document.getElementById('totalTasks').textContent = data.total_tasks;
        document.getElementById('totalEmployees').textContent = data.total_employees;
    }

async function loadProjects() {
    try {
        console.log('Loading projects...');
        const response = await fetch('/api/projects');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        projects = await response.json();
        console.log('Projects loaded:', projects.length);
        
        if (projects.length === 0) {
            const container = document.getElementById('allProjectsSection');
            container.innerHTML = '<p class="text-muted text-center py-4">No jobs yet. Create your first job!</p>';
            return;
        }
        
        // Fetch details for each project
        const projectsWithDetails = await Promise.all(
            projects.map(async (project) => {
                try {
                    console.log(`Fetching details for project ${project.id}...`);
                    const detailsResponse = await fetch(`/api/projects/${project.id}/details`);
                    
                    if (!detailsResponse.ok) {
                        console.error(`Failed to fetch details for project ${project.id}`);
                        return null;
                    }
                    
                    const details = await detailsResponse.json();
                    console.log(`Details loaded for project ${project.id}:`, details);
                    return details;
                } catch (error) {
                    console.error(`Error fetching project ${project.id}:`, error);
                    return null;
                }
            })
        );
        
        // Filter out null values
        const validProjects = projectsWithDetails.filter(p => p !== null);
        console.log('Valid projects:', validProjects.length);
        
        if (validProjects.length === 0) {
            const container = document.getElementById('allProjectsSection');
            container.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Jobs exist but couldn't load details. Please refresh the page.
                </div>
            `;
            return;
        }
        
        renderProjectsWithStages(validProjects);
    } catch (error) {
        console.error('Error loading projects:', error);
        const container = document.getElementById('allProjectsSection');
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error loading jobs: ${error.message}
                <button class="btn btn-sm btn-outline-danger ms-3" onclick="loadProjects()">
                    <i class="fas fa-redo me-1"></i> Retry
                </button>
            </div>
        `;
    }
}    

function renderProjectsWithStages(projectsData) {
        const container = document.getElementById('allProjectsSection');
        
        if (!projectsData.length) {
            container.innerHTML = '<p class="text-muted text-center py-4">No jobs yet. Create your first job!</p>';
            return;
        }
        
        container.innerHTML = projectsData.map(project => {
            const stages = project.stages || [];
            const totalStages = stages.length;
            const completedStages = stages.filter(s => s.status === 'completed').length;
            const progress = totalStages > 0 ? Math.round((completedStages / totalStages) * 100) : 0;
            
            const startDateGroups = new Map();
            
            stages.forEach((stage, idx) => {
                if (!stage.start_date) return;
                const startDateKey = stage.start_date;
                if (!startDateGroups.has(startDateKey)) {
                    startDateGroups.set(startDateKey, []);
                }
                startDateGroups.get(startDateKey).push(idx);
            });
            
            const stageGroupMap = new Map();
            startDateGroups.forEach((indices, startDate) => {
                if (indices.length > 1) {
                    indices.sort((a, b) => a - b);
                    indices.forEach(i => stageGroupMap.set(i, indices));
                }
            });
            
            const orderedStages = [];
            const processedIndices = new Set();
            
            stages.forEach((stage, idx) => {
                if (processedIndices.has(idx)) return;
                
                const sameStartGroup = stageGroupMap.get(idx);
                
                if (sameStartGroup && sameStartGroup.length > 1) {
                    sameStartGroup.forEach(groupIdx => {
                        if (!processedIndices.has(groupIdx)) {
                            orderedStages.push({ stage: stages[groupIdx], originalIndex: groupIdx, group: sameStartGroup });
                            processedIndices.add(groupIdx);
                        }
                    });
                } else {
                    orderedStages.push({ stage: stages[idx], originalIndex: idx, group: null });
                    processedIndices.add(idx);
                }
            });
            
            let stagesHTML = '';
            let previousGroup = null;
            let groupHTML = '';
            let isInGroup = false;
            
            orderedStages.forEach((stageData, displayIndex) => {
                const stage = stageData.stage;
                const index = stageData.originalIndex;
                const currentGroup = stageData.group;
                
                const isCompleted = stage.status === 'completed';
                const isActive = stage.status === 'in-progress';
                
                const hasSameStart = currentGroup && currentGroup.length > 1;
                const isFirstInGroup = hasSameStart && currentGroup.indexOf(index) === 0;
                const isLastInGroup = hasSameStart && currentGroup.indexOf(index) === currentGroup.length - 1;
                
                if (isFirstInGroup) {
                    isInGroup = true;
                    groupHTML = '<div class="stage-group-container">';
                }
                
                let spacingClass = 'normal-spacing';
                if (hasSameStart) {
                    spacingClass = currentGroup.length >= 3 ? 'tight-spacing' : 'medium-spacing';
                }
                
                let groupBadge = '';
                if (hasSameStart) {
                    const position = currentGroup.indexOf(index) + 1;
                    const total = currentGroup.length;
                    groupBadge = `<span class="parallel-badge">${position}/${total}</span>`;
                }
                
                let circleContent;
                if (isCompleted) {
                    circleContent = '<i class="fas fa-check"></i>';
                } else {
                    circleContent = index + 1;
                }
                
                const stageElement = `
                    <div class="progress-step ${spacingClass}" 
                        onclick="updateStageStatus(${project.id}, ${stage.id}, '${stage.status}')">
                        <div class="step-circle ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''}">
                            ${circleContent}
                        </div>
                        <div class="step-label ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''}">
                            ${stage.name}
                            <span class="duration-badge">${stage.duration_days}d</span>
                            ${groupBadge}
                        </div>
                        ${stage.start_date ? `
                            <div style="margin-top: 5px; text-align: center;">
                                <small class="text-muted" style="font-size: 0.7rem;">
                                    ${new Date(stage.start_date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}
                                    ${stage.end_date ? ' - ' + new Date(stage.end_date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'}) : ''}
                                </small>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                if (isInGroup) {
                    groupHTML += stageElement;
                } else {
                    stagesHTML += stageElement;
                }
                
                if (isLastInGroup) {
                    groupHTML += '</div>';
                    stagesHTML += groupHTML;
                    groupHTML = '';
                    isInGroup = false;
                }
                
                previousGroup = currentGroup;
            });
            
            const membersHTML = project.members && project.members.length > 0 
                ? project.members.slice(0, 3).map(m => `<span class="badge bg-info me-1"><i class="fas fa-user me-1"></i>${m.username}</span>`).join('') + 
                (project.members.length > 3 ? `<span class="badge bg-secondary">+${project.members.length - 3}</span>` : '')
                : '<span class="text-muted small">No members</span>';
            
            return `
                <div class="project-progress-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <h5 class="mb-0">${project.name}</h5>
                                <span class="project-status-badge status-${project.status}">
                                    ${project.status.charAt(0).toUpperCase() + project.status.slice(1)}
                                </span>
                            </div>
                            <div class="mt-1">${membersHTML}</div>
                        </div>
                        <div class="project-actions">
                            <button class="btn btn-outline-success" onclick="exportCurrentProject(${project.id})" 
                                    style="border-radius: 8px; font-weight: 600; padding: 8px 16px;">
                                <i class="fas fa-file-excel me-2"></i> Export to Excel
                            </button>
                            <button class="btn btn-outline-primary" onclick="openCalendarView(${project.id})" 
                                    style="border-radius: 8px; font-weight: 600; padding: 8px 16px;">
                                <i class="fas fa-calendar-alt me-2"></i> View Calendar
                            </button>
                            <button class="btn-delete-project" onclick="deleteProject(${project.id}, event)">
                                <i class="fas fa-trash-alt me-1"></i> Delete
                            </button>
                        </div>                        
                    </div>
                    
                    <p class="text-muted small">${project.description || 'No description'}</p>
                    
                    <div class="progress-steps">
                        <div class="progress-line">
                            <div class="progress-line-fill" style="width: ${progress}%"></div>
                        </div>
                        ${stagesHTML}
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <small class="text-muted">
                            <i class="fas fa-calendar-alt me-1"></i>
                            ${project.start_date ? new Date(project.start_date).toLocaleDateString() : 'Not set'} - 
                            ${project.end_date ? new Date(project.end_date).toLocaleDateString() : 'Not set'}
                        </small>
                        <strong style="color: #667eea; font-size: 1.1rem;">${progress}% Complete (${completedStages}/${totalStages})</strong>
                    </div>
                </div>
            `;
        }).join('');
    }

    async function loadEmployees() {
        const response = await fetch('/api/employees');
        employees = await response.json();
        const select = document.getElementById('memberSelect');
        select.innerHTML = '<option value="">Select member to add...</option>' + 
            employees.map(e => `<option value="${e.id}">${e.username} (${e.role})</option>`).join('');
    }

    // UPDATED FUNCTION: Handle project submit with working Saturdays
    async function handleProjectSubmit(e) {
        e.preventDefault();
        
        const stages = [];
        const stageElements = document.querySelectorAll('[id^="stage-"]');
        
        stageElements.forEach((element, index) => {
            const id = element.id.split('-')[1];
            const checkbox = document.getElementById(`stageCheck-${id}`);
            
            if (!checkbox || !checkbox.checked) return;
            
            const name = document.getElementById(`stageName-${id}`)?.value;
            const duration = parseInt(document.getElementById(`stageDuration-${id}`)?.value) || 1;
            const managerId = parseInt(document.getElementById(`stageManager-${id}`)?.value) || null;  // ADD THIS
            const customStartDate = document.getElementById(`stageStartDate-${id}`)?.value;
            
            if (name) {
                const stageData = { 
                    name, 
                    order: stages.length + 1,
                    duration_days: duration,
                    manager_id: managerId  // ADD THIS
                };
                
                if (customStartDate) {
                    stageData.start_date = customStartDate;
                }
                
                stages.push(stageData);
            }
        });

    if (stages.length === 0) {
        alert('Please select at least one task!');
        return;
    }        
    
    const data = {
        name: document.getElementById('projectName').value,
        // description removed - no longer needed in UI
        start_date: document.getElementById('projectStartDate').value,
        stages,
        members: selectedMembers,
        include_saturday: includeSaturdayAsWorkingDay,
        working_saturdays: Array.from(workingSaturdays)
    };        
        const response = await fetch('/api/projects', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            showNotification('Job created successfully!', 'success');
            projectModal.hide();
            document.getElementById('projectForm').reset();
            document.getElementById('stagesContainer').innerHTML = '';
            document.getElementById('selectedMembers').innerHTML = '';
            stageCounter = 0;
            selectedMembers = [];
            workingSaturdays.clear();
            await loadProjects();
            await loadStats();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to create job'));
        }
    }

    async function updateStageStatus(projectId, stageId, currentStatus) {
        const newStatus = currentStatus === 'pending' ? 'in-progress' : 
                         currentStatus === 'in-progress' ? 'completed' : 'pending';
        
        await fetch(`/api/projects/${projectId}/stages/${stageId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus })
        });
        
        await loadProjects();
        await loadStats();
    }

    function openProjectModal() {
        document.getElementById('projectForm').reset();
        document.getElementById('projectStartDate').valueAsDate = new Date();
        workingSaturdays.clear();
        loadDefaultStages();
        projectModal.show();
    }

    function toggleNotifications() {
        alert('Notifications feature');
    }

    async function deleteProject(projectId, event) {
        event.stopPropagation();
        
        if (!confirm('Are you sure you want to delete this job? This action cannot be undone.')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/projects/${projectId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                alert('Job deleted successfully!');
                await loadProjects();
                await loadStats();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.error || 'Failed to delete job'));
            }
        } catch (error) {
            alert('Error deleting job: ' + error.message);
        }
    }

    function getStageColor(index) {
        return STAGE_COLORS[index % STAGE_COLORS.length];
    }

    let miniPopupData = null;

async function openCalendarView(projectId) {
    currentProjectForCalendar = projectId;
    
try {
        // Fetch project details
        const response = await fetch(`/api/projects/${projectId}/details`);
        currentProjectData = await response.json();
        
        // ‚úÖ CRITICAL: ALWAYS fetch complete reschedule history (including daily tasks)
        const timestamp = Date.now();
        const historyResponse = await fetch(`/api/projects/${projectId}/complete-reschedule-history?_t=${timestamp}`);
        if (historyResponse.ok) {
            const historyData = await historyResponse.json();
            currentProjectData.rescheduleHistory = historyData;
            console.log('\u2705 Loaded complete reschedule history:', historyData.length, 'records');
            console.log('History details:', historyData);
        } else {
            console.warn(' Failed to load reschedule history');
            currentProjectData.rescheduleHistory = [];
        }  
              
        // Initialize saturdayWorkingDays
        if (!currentProjectData.saturdayWorkingDays) {
            currentProjectData.saturdayWorkingDays = new Set();
        } else if (Array.isArray(currentProjectData.saturdayWorkingDays)) {
            currentProjectData.saturdayWorkingDays = new Set(currentProjectData.saturdayWorkingDays);
        }
        
        console.log('Working Saturdays loaded:', Array.from(currentProjectData.saturdayWorkingDays));
        console.log('Reschedule History loaded:', currentProjectData.rescheduleHistory);
        
        document.getElementById('calendarProjectTitle').textContent = `${currentProjectData.name}`;
        document.getElementById('calendarProjectDates').textContent = 
            `${new Date(currentProjectData.start_date).toLocaleDateString()} - ${new Date(currentProjectData.end_date).toLocaleDateString()}`;
        
        // Show modal first
        calendarModal.show();
        
        // Wait for modal to be fully shown
        setTimeout(async () => {
            const calendarEl = document.getElementById('calendar');
            
            // Clear any existing calendar
            if (calendar) {
                calendar.destroy();
            }
            
            // ‚úÖ Generate events with ghost events
            const calendarEvents = await generateEnhancedCalendarEvents(currentProjectData.stages);
            
            console.log('üìä Total calendar events generated:', calendarEvents.length);
            console.log('\uD83D\uDC7B Ghost events:', calendarEvents.filter(e => e.classNames?.includes('ghost-event')).length);
            
            // Create new calendar
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                initialDate: currentProjectData.start_date,
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,listMonth'
                },                
                height: 'auto',
                contentHeight: 500,
                events: calendarEvents,
                eventClick: function(info) {
                    // ‚úÖ Don't allow clicking ghost events
                    if (info.event.extendedProps.isGhost) {
                        const props = info.event.extendedProps;
                        let message = `Original Location\n\n`;
                        
                        if (props.type === 'daily_task') {
                            message += `Stage: ${props.stageName}\n`;
                            message += `Day: ${props.dayNumber}\n`;
                        } else {
                            message += `Stage: ${props.stageName}\n`;
                        }
                        
                        message += `Moved ${props.daysShifted} day(s) ${props.direction}\n`;
                        message += `New location: ${new Date(props.movedTo).toLocaleDateString()}`;
                        
                        alert(message);
                        return;
                    }
                    handleStageClickReschedule(info, currentProjectData);
                },
                dayCellDidMount: function(info) {
                    addDayRescheduleButton(info, currentProjectData);
                },
                eventDisplay: 'block',
                displayEventTime: false,
                eventDidMount: function(info) {
                    enhanceEventDisplay(info);
                },
                datesSet: function() {
                    // When month changes, refresh badges
                    setTimeout(() => {
                        refreshParallelBadges();
                    }, 100);
                }
            });
            
            calendar.render();
            
            // Apply enhancements after render
            setTimeout(() => {
                enhanceCalendarWithWeekends();
                generateEnhancedLegend(currentProjectData.stages);
            }, 300);            
        }, 300);
        
    } catch (error) {
        console.error('Error loading calendar:', error);
        alert('Error loading calendar: ' + error.message);
    }
}


async function generateEnhancedCalendarEvents(stages) {
    const events = [];
    const dateStageMap = new Map();
    
    // Ensure saturdayWorkingDays is always a Set
    if (!currentProjectData.saturdayWorkingDays) {
        currentProjectData.saturdayWorkingDays = new Set();
    } else if (Array.isArray(currentProjectData.saturdayWorkingDays)) {
        currentProjectData.saturdayWorkingDays = new Set(currentProjectData.saturdayWorkingDays);
    } else if (!(currentProjectData.saturdayWorkingDays instanceof Set)) {
        try {
            currentProjectData.saturdayWorkingDays = new Set(JSON.parse(currentProjectData.saturdayWorkingDays));
        } catch (e) {
            currentProjectData.saturdayWorkingDays = new Set();
        }
    }
    
    
        console.log('=== Generating Calendar Events ===');
        console.log('Working Saturdays:', Array.from(currentProjectData.saturdayWorkingDays));
        console.log('Reschedule History:', currentProjectData.rescheduleHistory?.length || 0, 'records');    
    // Helper function to check if date is working day
    function isWorkingDay(date) {
        const day = date.getDay();
        const dateStr = date.toISOString().split('T')[0];
        
        if (day === 0) return false;
        if (day === 6) {
            const isWorking = currentProjectData.saturdayWorkingDays.has(dateStr);
            return isWorking;
        }
        return true;
    }
    
if (currentProjectData.rescheduleHistory && currentProjectData.rescheduleHistory.length > 0) {
    console.log('\n=== Adding Ghost Events ===');
    console.log('Total history records:', currentProjectData.rescheduleHistory.length);
    
try {
        currentProjectData.rescheduleHistory.forEach(history => {
            const stage = stages.find(s => s.id === history.stage_id);
            if (!stage) {
                console.warn('\u26A0 Stage not found for history:', history);
                return;
            }
            
            const index = stages.indexOf(stage);
            const color = getStageColor(index);
            
            // ‚úÖ Determine ghost event title based on type
            let ghostTitle = '';
            let tooltipText = '';
            
            if (history.type === 'daily_task') {
                // For daily tasks, show "Stage Name - Day X"
                ghostTitle = `\u21E2 ${history.stage_name} - Day ${history.day_number}`;
                
                tooltipText = `\uD83D\uDCCD Original Location\n`;
                tooltipText += `\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n`;
                tooltipText += `Stage: ${history.stage_name}\n`;
                tooltipText += `Day: ${history.day_number}\n`;
                tooltipText += `Moved ${history.days_shifted} day(s) ${history.direction}\n`;
                tooltipText += ` ‚û°Ô∏è New date: ${new Date(history.new_date).toLocaleDateString()}`;
                if (history.reason) {
                    tooltipText += `\n\uD83D\uDCAC Reason: ${history.reason}`;
                }
                
                console.log(`  \u2714 Daily task ghost: ${history.stage_name} Day ${history.day_number} at ${history.original_date} \u2192 ${history.new_date}`);
            } else {
                // For stage-level reschedules
                ghostTitle = `\u21E2 ${history.stage_name}`;
                
                tooltipText = `\uD83D\uDCCD Original Location\n`;
                tooltipText += `\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n`;
                tooltipText += `Stage: ${history.stage_name}\n`;
                tooltipText += `Moved ${history.days_shifted} day(s) ${history.direction}\n`;
                tooltipText += ` ‚û°Ô∏è New date: ${new Date(history.new_date).toLocaleDateString()}`;
                if (history.reason) {
                    tooltipText += `\n\uD83D\uDCAC Reason: ${history.reason}`;
                }
                
                console.log(`  \u2714 Stage ghost: ${history.stage_name} at ${history.original_date} \u2192 ${history.new_date}`);
            }            
            // √¢≈ì‚Ä¶ Create ghost event at ORIGINAL location
            const ghostEvent = {
                title: ghostTitle,
                start: history.original_date,
                end: history.original_date, // Single day indicator
                backgroundColor: color,
                borderColor: color,
                classNames: ['ghost-event'],
                extendedProps: {
                    isGhost: true,
                    type: history.type,
                    stageId: history.stage_id,
                    stageName: history.stage_name,
                    dayNumber: history.day_number || null,
                    movedTo: history.new_date,
                    daysShifted: history.days_shifted,
                    direction: history.direction,
                    reason: history.reason,
                    rescheduledBy: history.rescheduled_by,
                    rescheduledAt: history.rescheduled_at,
                    tooltip: tooltipText
                }
            };
            
            events.push(ghostEvent);
        });
        
console.log(`=== Total ghost events created: ${currentProjectData.rescheduleHistory.length} ===\n`);
    } catch (error) {
        console.error('üí¨ Error creating ghost events:', error);
        // Continue anyway - don't let ghost event errors break the whole calendar
    }
}
    // ‚úÖ STEP 2 - Process actual stage events (with daily tasks if available)
    for (const stage of stages) {
        const index = stages.indexOf(stage);
        
        try {
            const response = await fetch(`/api/projects/${currentProjectData.id}/stages/${stage.id}/daily-tasks`);
            
            if (response.ok) {
                const dailyTasks = await response.json();
                
                if (dailyTasks && dailyTasks.length > 0) {
                    console.log(`\n\u2714 Using daily tasks for stage: "${stage.name}" (${dailyTasks.length} tasks)`);
                    
                    const color = getStageColor(index);
                    let segmentStart = null;
                    let lastDate = null;
                    let segmentTasks = [];
                    
                    dailyTasks.sort((a, b) => new Date(a.scheduled_date) - new Date(b.scheduled_date));
                    
                    const hasAnyRescheduled = dailyTasks.some(t => t.is_rescheduled);
                    
                    // ‚úÖ Check if THIS stage was rescheduled (entire stage)
                    const stageRescheduleHistory = currentProjectData.rescheduleHistory?.find(h => h.stage_id === stage.id);
                    
                    dailyTasks.forEach((task, taskIdx) => {
                        const taskDate = new Date(task.scheduled_date + 'T12:00:00');
                        
                        const dateKey = taskDate.toISOString().split('T')[0];
                        if (!dateStageMap.has(dateKey)) {
                            dateStageMap.set(dateKey, []);
                        }
                        dateStageMap.get(dateKey).push({ stage, index });
                        
                        if (!segmentStart) {
                            segmentStart = new Date(taskDate);
                            lastDate = new Date(taskDate);
                            segmentTasks = [task];
                        } else {
                            const nextDay = new Date(lastDate);
                            nextDay.setDate(nextDay.getDate() + 1);
                            
                            if (taskDate.getTime() !== nextDay.getTime()) {
                                const segmentEnd = new Date(lastDate);
                                segmentEnd.setDate(segmentEnd.getDate() + 1);
                                
                                console.log(`  \u2714 Daily task segment: ${segmentStart.toISOString().split('T')[0]} to ${segmentEnd.toISOString().split('T')[0]}`);
                                
                                events.push(createStageEventWithStatus(
                                    stage, 
                                    index, 
                                    segmentStart, 
                                    segmentEnd, 
                                    color, 
                                    dateStageMap,
                                    segmentTasks,
                                    hasAnyRescheduled,
                                    stageRescheduleHistory // ‚úÖ Pass reschedule info
                                ));
                                
                                segmentStart = new Date(taskDate);
                                segmentTasks = [task];
                            } else {
                                segmentTasks.push(task);
                            }
                            lastDate = new Date(taskDate);
                        }
                        
                        if (taskIdx === dailyTasks.length - 1 && segmentStart) {
                            const segmentEnd = new Date(lastDate);
                            segmentEnd.setDate(segmentEnd.getDate() + 1);
                            console.log(`  \u2714 Final daily task segment: ${segmentStart.toISOString().split('T')[0]} to ${segmentEnd.toISOString().split('T')[0]}`);
                            
                            events.push(createStageEventWithStatus(
                                stage, 
                                index, 
                                segmentStart, 
                                segmentEnd, 
                                color, 
                                dateStageMap,
                                segmentTasks,
                                hasAnyRescheduled,
                                stageRescheduleHistory // ‚úÖ Pass reschedule info
                            ));
                        }
                    });
                    
                    continue;
                }
            }
        } catch (error) {
            console.log(`  \u2139 No daily tasks for stage "${stage.name}", using default dates`);
        }
        
        // Fallback: Use original logic if no daily tasks
        if (!stage.start_date || !stage.end_date) {
            console.warn(`Stage "${stage.name}" missing dates`);
            continue;
        }
        
        const stageStart = new Date(stage.start_date);
        const stageEnd = new Date(stage.end_date);
        const color = getStageColor(index);
        
        // ‚úÖ Check if THIS stage was rescheduled
        const stageRescheduleHistory = currentProjectData.rescheduleHistory?.find(h => h.stage_id === stage.id);
        
        console.log(`\nProcessing Stage: "${stage.name}" (using default dates)`);
        
        for (let d = new Date(stageStart); d <= stageEnd; d.setDate(d.getDate() + 1)) {
            const dateKey = d.toISOString().split('T')[0];
            if (!dateStageMap.has(dateKey)) {
                dateStageMap.set(dateKey, []);
            }
            dateStageMap.get(dateKey).push({ stage, index });
        }
        
        let segmentStart = null;
        let lastWorkingDate = null;
        
        for (let d = new Date(stageStart); d <= stageEnd; d.setDate(d.getDate() + 1)) {
            const currentDate = new Date(d);
            const isWorking = isWorkingDay(currentDate);
            
            if (isWorking) {
                if (!segmentStart) {
                    segmentStart = new Date(currentDate);
                }
                lastWorkingDate = new Date(currentDate);
            } else {
                if (segmentStart && lastWorkingDate) {
                    const segmentEnd = new Date(lastWorkingDate);
                    segmentEnd.setDate(segmentEnd.getDate() + 1);
                    
                    events.push(createStageEvent(
                        stage, 
                        index, 
                        segmentStart, 
                        segmentEnd, 
                        color, 
                        dateStageMap,
                        stageRescheduleHistory // ‚úÖ Pass reschedule info
                    ));
                    
                    segmentStart = null;
                    lastWorkingDate = null;
                }
            }
        }
        
        if (segmentStart && lastWorkingDate) {
            const segmentEnd = new Date(lastWorkingDate);
            segmentEnd.setDate(segmentEnd.getDate() + 1);
            events.push(createStageEvent(
                stage, 
                index, 
                segmentStart, 
                segmentEnd, 
                color, 
                dateStageMap,
                stageRescheduleHistory // ‚úÖ Pass reschedule info
            ));
        }
    }
    
    console.log(`\nGenerated ${events.length} total calendar events (including ghosts)`);
    console.log('=== Event Generation Complete ===\n');
    return events;
}


function createStageEvent(stage, index, start, end, color, dateStageMap, stageRescheduleHistory = null) {
    // Check for parallel stages
    let hasParallel = false;
    let parallelCount = 0;
    
    for (let d = new Date(start); d < end; d.setDate(d.getDate() + 1)) {
        const dateKey = d.toISOString().split('T')[0];
        const stagesOnDate = dateStageMap.get(dateKey) || [];
        if (stagesOnDate.length > 1) {
            hasParallel = true;
            parallelCount = Math.max(parallelCount, stagesOnDate.length);
        }
    }
    
    // Check entire project for overlaps
    if (currentProjectData && currentProjectData.stages) {
        const stageStart = new Date(stage.start_date);
        const stageEnd = new Date(stage.end_date);
        
        let overlapCount = 1;
        
        currentProjectData.stages.forEach((otherStage, otherIdx) => {
            if (otherStage.id === stage.id || !otherStage.start_date || !otherStage.end_date) return;
            
            const otherStart = new Date(otherStage.start_date);
            const otherEnd = new Date(otherStage.end_date);
            
            if (stageStart <= otherEnd && stageEnd >= otherStart) {
                hasParallel = true;
                overlapCount++;
            }
        });
        
        parallelCount = Math.max(parallelCount, overlapCount);
    }
    
    if (hasParallel) {
        title = `‚ö° ${stage.name}`;
    }      
    const classNames = [];
    if (stage.status === 'completed') classNames.push('stage-event-completed');
    if (stage.status === 'in-progress') classNames.push('stage-event-active');
    
    // √¢≈ì‚Ä¶ Build extended props with reschedule info
    const extendedProps = {
        stageId: stage.id,
        stageIndex: index,
        duration: stage.duration_days,
        status: stage.status,
        hasParallel: hasParallel,
        parallelCount: parallelCount,
        startDate: stage.start_date,
        endDate: stage.end_date,
        stageName: stage.name
    };
    
    // √¢≈ì‚Ä¶ Add reschedule information if available
    if (stageRescheduleHistory) {
        extendedProps.wasRescheduled = true;
        extendedProps.daysShifted = stageRescheduleHistory.days_shifted || 
            Math.abs(Math.round((new Date(stageRescheduleHistory.new_date) - new Date(stageRescheduleHistory.original_date)) / (1000 * 60 * 60 * 24)));
        extendedProps.rescheduleDirection = stageRescheduleHistory.direction || 
            (new Date(stageRescheduleHistory.new_date) > new Date(stageRescheduleHistory.original_date) ? 'forward' : 'backward');
        extendedProps.rescheduleBadge = `${extendedProps.rescheduleDirection === 'forward' ? '+' : '-'}${extendedProps.daysShifted}d`;
        extendedProps.originalDate = stageRescheduleHistory.original_date;
    }

    return {
        title: title,
        start: start.toISOString().split('T')[0],
        end: end.toISOString().split('T')[0],
        backgroundColor: color,
        borderColor: color,
        extendedProps: extendedProps,
        classNames: classNames
    };
}
// Create tooltip element once (add this BEFORE enhanceEventDisplay function)
let tooltipElement = null;

function createTooltipElement() {
    if (!tooltipElement) {
        tooltipElement = document.createElement('div');
        tooltipElement.className = 'event-tooltip';
        tooltipElement.style.cssText = `
            position: fixed;
            background: rgba(44, 62, 80, 0.98);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            white-space: pre-line;
            font-size: 11.5px;
            line-height: 1.6;
            z-index: 999999;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            min-width: 180px;
            max-width: 300px;
            pointer-events: none;
            border: 1px solid rgba(255,255,255,0.1);
            display: none;
        `;
        document.body.appendChild(tooltipElement);
    }
    return tooltipElement;
}

function enhanceEventDisplay(info) {
    const props = info.event.extendedProps;
    
    info.el.style.setProperty('--event-color', info.event.backgroundColor);
    
    // Build tooltip content
    let tooltipText = '';
    let isGhost = false;
    
    // Ghost event handling
    if (props.isGhost) {
        isGhost = true;
        
        // √¢≈ì‚Ä¶ Use pre-built tooltip if available, otherwise construct
        if (props.tooltip) {
            tooltipText = props.tooltip;
        } else {
                    tooltipText = `üìç Original Location\n`;
                    tooltipText += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                    
                    // ‚úÖ Check if it's a daily task or stage-level reschedule
                    if (props.type === 'daily_task' && props.dayNumber) {
                        tooltipText += `Stage: ${props.stageName}\n`;
                        tooltipText += `Day: ${props.dayNumber}\n`;
                    } else {
                        tooltipText += `Stage: ${props.stageName}\n`;
                    }
                    
                    tooltipText += `Moved ${props.daysShifted} day(s) ${props.direction}\n`;
                    tooltipText += `\u27A1 New date: ${new Date(props.movedTo).toLocaleDateString()}`;
                    
                    if (props.reason) {
                        tooltipText += `\n\uD83D\uDCAC Reason: ${props.reason}`;
                    }
                }        
        info.el.style.cursor = 'help';
    } else {
        // Build tooltip for real events
        tooltipText = `${props.stageName}\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n`;
                tooltipText += `üìÖ${props.duration} days\n`;
                
                if (props.completedCount > 0) {
                    tooltipText += `‚úÖ ${props.completedCount}/${props.totalTasks} completed\n`;
                }
                
                if (props.rescheduledCount > 0) {
                    tooltipText += `üîÑ ${props.rescheduledCount} day(s) rescheduled\n`;
                }
                
                // ‚úÖ ADD: Show if entire stage was rescheduled
                if (props.wasRescheduled) {
                    tooltipText += `üîÑ Stage shifted ${props.rescheduleBadge}\n`;
                }
                
                tooltipText += `üìä ${props.status}`;
            }    
    // Add hover events to show tooltip
    info.el.addEventListener('mouseenter', function(e) {
        const tooltip = createTooltipElement();
        tooltip.textContent = tooltipText;
        
        // Set background color based on type
        if (isGhost) {
            tooltip.style.background = 'rgba(255, 152, 0, 0.98)';
        } else {
            tooltip.style.background = 'rgba(44, 62, 80, 0.98)';
        }
        
        // Calculate position
        const rect = info.el.getBoundingClientRect();
        const tooltipX = rect.left + (rect.width / 2);
        
        // Show tooltip immediately
        tooltip.style.display = 'block';
        tooltip.style.left = tooltipX + 'px';
        tooltip.style.transform = 'translateX(-50%)';
        
        // Wait for next frame to position vertically
        setTimeout(() => {
            const tooltipHeight = tooltip.offsetHeight;
            let tooltipY;
            
            // Check if tooltip would go off top of screen
            if (rect.top - tooltipHeight - 20 < 10) {
                // Position below the event
                tooltipY = rect.bottom + 12;
            } else {
                // Position above the event
                tooltipY = rect.top - tooltipHeight - 12;
            }
            
            tooltip.style.top = tooltipY + 'px';
        }, 10);
    });
    
    // Hide tooltip on mouse leave
    info.el.addEventListener('mouseleave', function(e) {
        const tooltip = createTooltipElement();
        tooltip.style.display = 'none';
    });
    
    // Add duration badge (only for non-ghost events)
    if (!isGhost && props.duration) {
        const durationBadge = document.createElement('span');
        durationBadge.className = 'parallel-stage-indicator';
        durationBadge.textContent = `${props.duration}d`;
        info.el.appendChild(durationBadge);
    }
}

function addDayRescheduleButton(info, projectData) {
    const dateStr = info.date.toISOString().split('T')[0];
    const checkDate = new Date(dateStr + 'T12:00:00');
    const dayOfWeek = checkDate.getDay();
    
    // Don't show anything on Sundays (always holiday)
    if (dayOfWeek === 0) {
        return;
    }
    
    // Don't show anything on Saturdays that are holidays
    if (dayOfWeek === 6) {
        const isWorkingDay = projectData.saturdayWorkingDays && 
                            projectData.saturdayWorkingDays.has(dateStr);
        if (!isWorkingDay) {
            return;
        }
    }
    
    const stagesOnDay = projectData.stages.filter(stage => {
        if (!stage.start_date || !stage.end_date) return false;
        
        const stageStart = new Date(stage.start_date + 'T12:00:00');
        const stageEnd = new Date(stage.end_date + 'T12:00:00');
        
        return checkDate >= stageStart && checkDate <= stageEnd;
    });
    
    const dayFrame = info.el.querySelector('.fc-daygrid-day-frame');
    
    if (!dayFrame) {
        return;
    }
    
    // Add reschedule button only if there are stages
    if (stagesOnDay.length > 0) {
        const existingBtn = dayFrame.querySelector('.day-reschedule-btn');
        if (!existingBtn) {
            const btn = document.createElement('button');
            btn.className = 'day-reschedule-btn';
            btn.innerHTML = '<i class="fas fa-pencil-alt"></i>';
            btn.title = 'Reschedule stages on this day';
            btn.onclick = (e) => {
                e.stopPropagation();
                showMiniReschedulePopup(info.date, stagesOnDay, projectData, e);
            };
            
            dayFrame.appendChild(btn);
        }
    }
}

function showMiniReschedulePopup(date, stages, projectData, event) {
        const popup = document.getElementById('miniReschedulePopup');
        const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        
        document.getElementById('popupDate').textContent = dateStr;
        
        const stagesList = document.getElementById('popupStagesList');
        stagesList.innerHTML = stages.map((stage, idx) => {
            const color = getStageColor(projectData.stages.indexOf(stage));
            const isCompleted = stage.status === 'completed';
            const statusIcon = isCompleted ? '<i class="fas fa-check-circle text-success"></i>' : 
                              stage.status === 'in-progress' ? '<i class="fas fa-spinner text-warning"></i>' : '';
            
            return `
                <div class="stage-chip ${isCompleted ? 'opacity-50' : ''}" 
                     ${!isCompleted ? `onclick="handleStageRescheduleFromPopup(${projectData.id}, ${stage.id}, '${stage.name.replace(/'/g, "\\'")}', '${stage.start_date}', '${stage.end_date}')"` : ''}>
                    <div class="stage-chip-color" style="background: ${color};"></div>
                    <div class="stage-chip-name">${stage.name} ${statusIcon}</div>
                    ${!isCompleted ? `<button class="stage-chip-btn" onclick="event.stopPropagation(); handleStageRescheduleFromPopup(${projectData.id}, ${stage.id}, '${stage.name.replace(/'/g, "\\'")}', '${stage.start_date}', '${stage.end_date}');">Reschedule</button>` : ''}
                </div>
            `;
        }).join('');
        
        const rect = event.target.getBoundingClientRect();
        popup.style.left = `${Math.min(rect.left, window.innerWidth - 320)}px`;
        popup.style.top = `${rect.bottom + 10}px`;
        
        setTimeout(() => {
            const popupRect = popup.getBoundingClientRect();
            if (popupRect.bottom > window.innerHeight) {
                popup.style.top = `${rect.top - popupRect.height - 10}px`;
            }
        }, 10);
        
        popup.classList.add('active');
        
        setTimeout(() => {
            document.addEventListener('click', closeMiniPopupOutside);
        }, 100);
    }

    function closeMiniPopup() {
        const popup = document.getElementById('miniReschedulePopup');
        popup.classList.remove('active');
        document.removeEventListener('click', closeMiniPopupOutside);
    }

    function closeMiniPopupOutside(e) {
        const popup = document.getElementById('miniReschedulePopup');
        if (!popup.contains(e.target)) {
            closeMiniPopup();
        }
    }

    function handleStageRescheduleFromPopup(projectId, stageId, stageName, startDate, endDate) {
        closeMiniPopup();
        
        const color = getStageColor(currentProjectData.stages.findIndex(s => s.id === stageId));
        
        document.getElementById('rescheduleStageInfo').textContent = stageName;
        document.getElementById('rescheduleCurrentDates').textContent = 
            `${new Date(startDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})} - ${new Date(endDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}`;
        document.getElementById('rescheduleStageColor').style.background = color;
        document.getElementById('rescheduleProjectId').value = projectId;
        document.getElementById('rescheduleStageId').value = stageId;
        document.getElementById('rescheduleStageStartDate').value = startDate;
        document.getElementById('rescheduleStageEndDate').value = endDate;
        document.getElementById('rescheduleDays').value = '';
        document.getElementById('rescheduleReason').value = '';
        document.getElementById('rescheduleNewDatesPreview').style.display = 'none';
        document.getElementById('rescheduleImpactWarning').style.display = 'none';
        
        rescheduleModal.show();
    }


function handleStageClickReschedule(info, project) {
    const stage = project.stages.find(s => s.id === info.event.extendedProps.stageId);
    
    if (!stage) return;
    
    // Show options: Reschedule entire stage OR manage daily tasks
    const choice = confirm(
        `Stage: ${stage.name}\n\n` +
        `Click OK to manage individual days\n` +
        `Click Cancel to reschedule entire stage`
    );
    
    if (choice) {
        // Open daily task manager
        openDailyTaskManager(project.id, stage.id, stage.name);
    } else {
        // Original behavior - reschedule entire stage
        if (stage.status === 'completed') {
            alert('Cannot reschedule a completed stage. Update its status first.');
            return;
        }
        
        handleStageRescheduleFromPopup(
            project.id, 
            stage.id, 
            stage.name, 
            stage.start_date, 
            stage.end_date
        );
    }
}

function generateEnhancedLegend(stages) {
    const legendContainer = document.getElementById('calendarLegend');
    
    const legendHTML = stages.map((stage, index) => {
        const color = getStageColor(index);
        
        let statusBadge = '';
        if (stage.status === 'completed') {
            statusBadge = '<span class="badge bg-success" style="font-size: 0.6rem; padding: 2px 4px;">√¢≈ì‚Äú</span>';
        } else if (stage.status === 'in-progress') {
            statusBadge = '<span class="badge bg-warning" style="font-size: 0.6rem; padding: 2px 4px;">√¢≈°¬°</span>';
        }
        
        return `
            <div class="legend-item" style="border-left-color: ${color};">
                <div style="display: flex; align-items: center; justify-content: space-between; gap: 4px;">
                    <div style="flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        <strong style="font-size: 0.75rem;">${stage.name}</strong>
                    </div>
                    ${statusBadge}
                </div>
                <small style="font-size: 0.65rem; color: #6c757d;">
                    ${stage.duration_days}d √¢‚Ç¨¬¢ ${new Date(stage.start_date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}
                </small>
            </div>
        `;
    }).join('');
    
    legendContainer.innerHTML = legendHTML;
}

// ‚úÖ UPDATED: handleReschedule - Add forced refresh
async function handleReschedule(e) {
    e.preventDefault();
    
    const projectId = document.getElementById('rescheduleProjectId').value;
    const stageId = parseInt(document.getElementById('rescheduleStageId').value);
    const days = parseInt(document.getElementById('rescheduleDays').value);
    const reason = document.getElementById('rescheduleReason').value;
    
    if (!days || days === 0) {
        alert('Please enter a valid number of days (not zero)');
        return;
    }
    
    const startDate = new Date(document.getElementById('rescheduleStageStartDate').value);
    const testDate = addWorkingDays(startDate, days);
    const testDay = testDate.getDay();
    
    if (testDay === 0) {
        alert('‚ö†Ô∏è Cannot reschedule to Sunday (holiday)');
        return;
    }
    
    if (testDay === 6 && !includeSaturdayAsWorkingDay) {
        alert('‚ö†Ô∏è Cannot reschedule to Saturday (holiday).\n\nEnable "Include Saturday as Working Day" if needed.');
        return;
    }
    
    const stageIndex = currentProjectData.stages.findIndex(s => s.id === stageId);
    const hasCompletedBefore = currentProjectData.stages
        .slice(0, stageIndex)
        .some(s => s.status === 'completed');
    
    let confirmMsg = `Are you sure you want to shift this stage by ${days} working days?\n\n`;
    
    if (hasCompletedBefore) {
        confirmMsg += '\u2705 Completed stages will remain unchanged\n';
    }
    confirmMsg += '\u2705 This stage and subsequent stages will be shifted\n';
    confirmMsg += '\u2705 Weekends will be excluded from calculation';
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/projects/${projectId}/reschedule`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                stage_id: stageId,
                days: days,
                reason: reason,
                include_saturday: includeSaturdayAsWorkingDay,
                working_saturdays: Array.from(currentProjectData.saturdayWorkingDays || [])
            })
        });
        
        if (response.ok) {
            showNotification('Stage rescheduled successfully!', 'success');
            rescheduleModal.hide();
            
            // ‚úÖ CRITICAL: Wait for database transaction to fully commit
            console.log('\u23F3 Waiting for database commit (3 seconds)...');
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            // ‚úÖ Force complete calendar rebuild with verified data
            console.log('\uD83D\uDD28 Starting COMPLETE calendar rebuild...');
            await forceCompleteCalendarRebuild(parseInt(projectId));
            
            // ‚úÖ Refresh main project view
            await loadProjects();
            await loadStats();
            
            showNotification('\u2705 Calendar updated successfully!', 'success');
            
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to reschedule'));
        }
    } catch (error) {
        console.error('\u274C Reschedule error:', error);
        alert('Error rescheduling: ' + error.message);
    }
}
// ‚úÖ NEW FUNCTION: Complete calendar rebuild with verification
async function forceCompleteCalendarRebuild(projectId) {
    console.log('üî® Starting COMPLETE calendar rebuild...');
    
    // Step 1: Clear ALL badges
    document.querySelectorAll('.parallel-jobs-badge').forEach(badge => badge.remove());
    console.log('üßπ Cleared all badges');
    
    // Step 2: Wait for database
    await new Promise(resolve => setTimeout(resolve, 2000));
    console.log('‚úÖ Database wait complete');
    
    // Step 3: Fetch FRESH data - MULTIPLE ATTEMPTS
    let freshData = null;
    let attempts = 0;
    const maxAttempts = 3;
    
    while (attempts < maxAttempts && !freshData) {
        attempts++;
        console.log(`üì° Fetch attempt ${attempts}/${maxAttempts}...`);
        
        try {
            const timestamp = Date.now();
            const response = await fetch(`/api/projects/${projectId}/details?_bust=${timestamp}`, {
                method: 'GET',
                cache: 'no-store',
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache'
                }
            });
            
            if (response.ok) {
                freshData = await response.json();
                console.log(`‚úÖ Got fresh data (attempt ${attempts})`);
                break;
            }
        } catch (error) {
            console.error(`‚ùå Fetch attempt ${attempts} failed:`, error);
        }
        
        if (attempts < maxAttempts) {
            await new Promise(resolve => setTimeout(resolve, 500));
        }
    }
    
    if (!freshData) {
        alert('Failed to refresh calendar data');
        return;
    }
    
    // Step 4: Log what we received
    console.log('üìä Fresh stage dates from backend:');
    freshData.stages.forEach((s, idx) => {
        console.log(`  ${idx + 1}. ${s.name}: ${s.start_date} ‚Üí ${s.end_date}`);
    });
    
    // Step 5: Fetch COMPLETE reschedule history (both stage and daily task)
    try {
        const historyResponse = await fetch(`/api/projects/${projectId}/complete-reschedule-history?_t=${timestamp}`);
        if (historyResponse.ok) {
            freshData.rescheduleHistory = await historyResponse.json();
            console.log(`‚úÖ Loaded ${freshData.rescheduleHistory.length} history records`);
        } else {
            freshData.rescheduleHistory = [];
        }
    } catch (error) {
        console.error('Failed to load history:', error);
        freshData.rescheduleHistory = [];
    }    
    // Step 6: Process saturdayWorkingDays
    if (Array.isArray(freshData.saturdayWorkingDays)) {
        freshData.saturdayWorkingDays = new Set(freshData.saturdayWorkingDays);
    } else {
        freshData.saturdayWorkingDays = new Set();
    }
    
    // Step 7: ‚úÖ CRITICAL - Completely replace currentProjectData
    if (!currentProjectData.rescheduleHistory || currentProjectData.rescheduleHistory.length === 0) {
        console.warn('‚ö†Ô∏è WARNING: No reschedule history in currentProjectData!');
        console.log('Attempting to reload history...');
        
        try {
            const historyResponse = await fetch(`/api/projects/${projectId}/complete-reschedule-history?_t=${Date.now()}`);
            if (historyResponse.ok) {
                currentProjectData.rescheduleHistory = await historyResponse.json();
                console.log(`‚úÖ Reloaded ${currentProjectData.rescheduleHistory.length} history records`);
            }
        } catch (e) {
            console.error('‚ùå Failed to reload history:', e);
        }
    } else {
        console.log(`‚úÖ History verified: ${currentProjectData.rescheduleHistory.length} records`);
    }    
    // Step 8: Regenerate calendar events
    console.log('üé® Generating new calendar events...');
    const newEvents = await generateEnhancedCalendarEvents(currentProjectData.stages);
    console.log(`‚úÖ Generated ${newEvents.length} events`);
    
    // Step 9: Destroy old calendar
    if (calendar) {
        calendar.destroy();
        console.log('üóëÔ∏è Old calendar destroyed');
    }
    
    await new Promise(resolve => setTimeout(resolve, 300));
    
    // Step 10: Create NEW calendar
    const calendarEl = document.getElementById('calendar');
    
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        initialDate: currentProjectData.start_date,
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listMonth'
        },
        height: 'auto',
        contentHeight: 600,
        events: newEvents,
        eventClick: function(info) {
            if (info.event.extendedProps.isGhost) {
                const props = info.event.extendedProps;
                alert(
                    `Original Location\n\n` +
                    `Stage: ${props.stageName}\n` +
                    `Moved ${props.daysShifted} day(s) ${props.direction}\n` +
                    `New location: ${new Date(props.movedTo).toLocaleDateString()}`
                );
                return;
            }
            handleStageClickReschedule(info, currentProjectData);
        },
        dayCellDidMount: function(info) {
            addDayRescheduleButton(info, currentProjectData);
        },
        eventDisplay: 'block',
        displayEventTime: false,
        eventDidMount: function(info) {
            enhanceEventDisplay(info);
        }
    });
    
    calendar.render();
    console.log('üé¨ New calendar rendered');
    
    // Step 11: Apply enhancements
    setTimeout(() => {
        enhanceCalendarWithWeekends();
        generateEnhancedLegend(currentProjectData.stages);
    }, 200);
    
    // Step 12: Wait for DOM
    await new Promise(resolve => setTimeout(resolve, 1000));

    console.log('üéâ Calendar rebuild COMPLETE!');
}

function adjustRescheduleDays(delta) {
        const input = document.getElementById('rescheduleDays');
        const currentValue = parseInt(input.value) || 0;
        input.value = currentValue + delta;
        updateReschedulePreview();
    }

    function updateReschedulePreview() {
        const days = parseInt(document.getElementById('rescheduleDays').value);
        
        if (!days || days === 0) {
            document.getElementById('rescheduleNewDatesPreview').style.display = 'none';
            document.getElementById('rescheduleImpactWarning').style.display = 'none';
            return;
        }
        
        const startDate = new Date(document.getElementById('rescheduleStageStartDate').value);
        const endDate = new Date(document.getElementById('rescheduleStageEndDate').value);
        
        const newStart = addWorkingDays(startDate, days);
        const newEnd = addWorkingDays(endDate, days);
        
        document.getElementById('rescheduleNewDatesValue').textContent = 
            `${newStart.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})} - ${newEnd.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}`;
        document.getElementById('rescheduleNewDatesPreview').style.display = 'block';
        
        const impactText = days > 0 
            ? `All subsequent stages will be pushed forward by ${days} working day(s)`
            : `All subsequent stages will be pulled backward by ${Math.abs(days)} working day(s)`;
        document.getElementById('rescheduleImpactText').textContent = impactText;
        document.getElementById('rescheduleImpactWarning').style.display = 'block';
    }

function enhanceCalendarWithWeekends() {
    if (!calendar) return;
    
    // Ensure working Saturdays is initialized
    if (!currentProjectData.saturdayWorkingDays) {
        currentProjectData.saturdayWorkingDays = new Set();
    }
    
    // Get the current dayCellDidMount handler
    const oldDayCellDidMount = calendar.getOption('dayCellDidMount');
    
    // Override with enhanced version
    calendar.setOption('dayCellDidMount', function(info) {
        const day = info.date.getDay();
        const dateKey = info.date.toISOString().split('T')[0];
        
        // Handle Sundays (day 0)
        if (day === 0) {
            info.el.style.background = 'linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%)';
            info.el.style.opacity = '0.7';
            info.el.title = 'Sunday - Holiday';
        }
        
        // Handle Saturdays (day 6) - always holiday, no toggle
        if (day === 6) {
            info.el.style.background = 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)';
            info.el.style.opacity = '0.7';
            info.el.title = 'Saturday - Holiday';
        }
        
        // Call original handler if it exists
        if (oldDayCellDidMount) {
            oldDayCellDidMount(info);
        }
        
        // Add reschedule button
        addDayRescheduleButton(info, currentProjectData);
    });
    
    // Force calendar to re-render with new dayCellDidMount
    calendar.render();
}
    // UPDATED FUNCTION: Toggle Saturday working status with recalculation
async function recalculateProjectWithSaturdays() {
    if (!currentProjectData) return;
    
    try {
        // Send update to backend
        const response = await fetch(`/api/projects/${currentProjectData.id}/update-saturdays`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                working_saturdays: Array.from(currentProjectData.saturdayWorkingDays || [])
            })
        });
        
        if (response.ok) {
            // Wait for DB to update
            await new Promise(resolve => setTimeout(resolve, 200));
            
            // Fetch fresh data
            const detailsResponse = await fetch(`/api/projects/${currentProjectData.id}/details`);
            const freshData = await detailsResponse.json();
            
            // Update current data
            currentProjectData = freshData;
            
            // Ensure Set conversion
            if (Array.isArray(freshData.saturdayWorkingDays)) {
                currentProjectData.saturdayWorkingDays = new Set(freshData.saturdayWorkingDays);
            }
            
            // COMPLETE calendar regeneration
            const calendarEl = document.getElementById('calendar');
            calendarEl.innerHTML = '';
            
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                initialDate: currentProjectData.start_date,
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,listMonth'
                },
                events: generateEnhancedCalendarEvents(currentProjectData.stages),
                eventClick: function(info) {
                    handleStageClickReschedule(info, currentProjectData);
                },
                dayCellDidMount: function(info) {
                    addDayRescheduleButton(info, currentProjectData);
                },
                height: 'auto',
                eventDisplay: 'block',
                displayEventTime: false,
                eventDidMount: function(info) {
                    enhanceEventDisplay(info);
                }
            });
            
            calendar.render();
            enhanceCalendarWithWeekends(); // CRITICAL: Call after render
            generateEnhancedLegend(currentProjectData.stages);
            
            await loadProjects(); // Refresh main view
            
            showNotification('Schedule recalculated!', 'success');
        }
    } catch (error) {
        console.error('Recalculation error:', error);
        showNotification('Failed to update: ' + error.message, 'error');
    }
}

// Helper function to show notifications
    function showNotification(message, type = 'success') {
        const bgColors = {
            success: '#28a745',
            info: '#17a2b8',
            warning: '#ffc107',
            error: '#dc3545'
        };
        
        const bgColor = bgColors[type] || bgColors.success;
        
        const notification = document.createElement('div');
        notification.className = 'alert alert-dismissible fade show position-fixed';
        notification.style.cssText = `top: 20px; right: 20px; z-index: 9999; min-width: 300px; background: ${bgColor}; color: white; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3);`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }

async function openDailyTaskManager(projectId, stageId, stageName) {
    currentStageForDailyTasks = { projectId, stageId };
    
    document.getElementById('dailyTaskModalTitle').textContent = 'Manage Daily Tasks';
    document.getElementById('dailyTaskStageName').textContent = `Stage: ${stageName}`;
    
    try {
        const response = await fetch(`/api/projects/${projectId}/stages/${stageId}/daily-tasks`);
        const tasks = await handleApiResponse(response);  // √¢≈ì‚Ä¶ CHANGED THIS LINE
        
        if (tasks.length === 0) {
            console.log('No tasks found, generating...');
            await generateDailyTasks(projectId);
            
            const retryResponse = await fetch(`/api/projects/${projectId}/stages/${stageId}/daily-tasks`);
            const retryTasks = await handleApiResponse(retryResponse);  // √¢≈ì‚Ä¶ CHANGED THIS LINE
            renderDailyTasks(retryTasks);
        } else {
            renderDailyTasks(tasks);
        }
        
        dailyTaskModal.show();
    } catch (error) {
        console.error('Error loading daily tasks:', error);
        if (error.message !== 'Session expired') {
            alert(`Error loading daily tasks: ${error.message}`);
        }
    }
}
// Generate daily tasks for project
async function generateDailyTasks(projectId) {
    const response = await fetch(`/api/projects/${projectId}/generate-daily-tasks`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    });
    
    if (!response.ok) {
        throw new Error('Failed to generate daily tasks');
    }
}

// Render daily tasks
function renderDailyTasks(tasks) {
    const container = document.getElementById('dailyTasksList');
    
    if (tasks.length === 0) {
        container.innerHTML = '<p class="text-center text-muted">No daily tasks available</p>';
        return;
    }
    
    container.innerHTML = tasks.map(task => {
        const statusClass = task.status === 'completed' ? 'completed' : task.is_rescheduled ? 'rescheduled' : '';
        const statusBadge = task.status === 'completed' ? 'badge-completed' : 
                           task.status === 'rescheduled' ? 'badge-rescheduled' : 'badge-pending';
        
        let dateDisplay = new Date(task.scheduled_date).toLocaleDateString('en-US', {
            weekday: 'short',
            month: 'short',
            day: 'numeric',
            year: 'numeric'
        });
        
        let rescheduleInfo = '';
        if (task.is_rescheduled) {
            const originalDate = new Date(task.original_date).toLocaleDateString('en-US', { 
                weekday: 'short',
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            });
            const currentDate = new Date(task.scheduled_date);
            const origDate = new Date(task.original_date);
            const daysDiff = Math.round((currentDate - origDate) / (1000 * 60 * 60 * 24));
            const direction = daysDiff > 0 ? 'forward' : 'backward';
            
            rescheduleInfo = `
                <div class="reschedule-indicator mt-2 p-2" style="background: #fff3cd; border-left: 4px solid #ff9800; border-radius: 6px;">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-exchange-alt me-2 mt-1" style="color: #ff9800;"></i>
                        <div style="flex: 1;">
                            <div class="mb-1">
                                <strong style="color: #ff6b00;">Rescheduled</strong>
                                <span class="badge bg-warning text-dark ms-2">${Math.abs(daysDiff)} day(s) ${direction}</span>
                            </div>
                            <small class="text-muted d-block">Original: ${originalDate}</small>
                            ${task.rescheduled_reason ? `
                                <small class="d-block mt-1" style="color: #495057;">
                                    <i class="fas fa-comment-dots me-1"></i>
                                    <strong>Reason:</strong> ${task.rescheduled_reason}
                                </small>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        return `
            <div class="daily-task-item ${statusClass}">
                <div class="task-day-number ${task.status === 'completed' ? 'completed' : ''}">
                    ${task.status === 'completed' ? '<i class="fas fa-check"></i>' : `Day ${task.day_number}`}
                </div>
                <div class="task-info flex-grow-1">
                    <div class="d-flex align-items-center justify-content-between mb-1">
                        <div class="task-date-display fw-bold">${dateDisplay}</div>
                        <span class="task-status-badge ${statusBadge}">${task.status.toUpperCase()}</span>
                    </div>
                    ${rescheduleInfo}
                </div>
                <div class="d-flex gap-2 align-items-start">
                    ${task.status !== 'completed' ? `
                        <button class="btn btn-sm btn-success" onclick="completeDailyTask(${task.id}, ${currentStageForDailyTasks.projectId}, ${currentStageForDailyTasks.stageId})" title="Mark as complete">
                            <i class="fas fa-check me-1"></i>Complete
                        </button>
                        <button class="btn btn-sm btn-primary-custom" onclick="openRescheduleDayModal(${task.id}, ${task.day_number}, '${task.scheduled_date}')" title="Change schedule">
                            <i class="fas fa-calendar-alt me-1"></i>Reschedule
                        </button>
                    ` : `
                        <div class="text-center">
                            <span class="text-success d-block">
                                <i class="fas fa-check-circle me-1"></i>
                                Completed
                            </span>
                            ${task.completed_at ? `
                                <small class="text-muted">${new Date(task.completed_at).toLocaleDateString('en-US', {month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'})}</small>
                            ` : ''}
                        </div>
                    `}
                </div>
            </div>
        `;
    }).join('');
}
// Complete a daily task
async function completeDailyTask(taskId, projectId, stageId) {
    if (!confirm('Mark this day as completed?')) return;
    
    try {
        const response = await fetch(`/api/projects/${projectId}/stages/${stageId}/daily-tasks/${taskId}/complete`, {
            method: 'PUT'
        });
        
        if (response.ok) {
            showNotification('Day marked as completed!', 'success');
            
            // √¢≈ì‚Ä¶ Wait for database commit
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Reload tasks in modal
            const tasksResponse = await fetch(`/api/projects/${projectId}/stages/${stageId}/daily-tasks`);
            const tasks = await tasksResponse.json();
            renderDailyTasks(tasks);
            
            // √¢≈ì‚Ä¶ Refresh calendar in background
            if (calendar && currentProjectForCalendar === projectId) {
                await refreshCalendarEvents();
            }
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
// Open reschedule day modal
function openRescheduleDayModal(taskId, dayNumber, currentDate) {
    document.getElementById('rescheduleTaskId').value = taskId;
    document.getElementById('rescheduleTaskProjectId').value = currentStageForDailyTasks.projectId;
    document.getElementById('rescheduleTaskStageId').value = currentStageForDailyTasks.stageId;
    document.getElementById('dayShiftAmount').value = 0;
    document.getElementById('dayRescheduleReason').value = '';
    document.getElementById('dayReschedulePreview').style.display = 'none';
    
    const dateStr = new Date(currentDate).toLocaleDateString('en-US', {
        weekday: 'long',
        month: 'long',
        day: 'numeric',
        year: 'numeric'
    });
    
    document.getElementById('dayRescheduleInfo').innerHTML = `
        <strong>Day ${dayNumber}</strong><br>
        Current date: ${dateStr}
    `;
    
    rescheduleDayModal.show();
}

// Adjust day shift
function adjustDayShift(delta) {
    const input = document.getElementById('dayShiftAmount');
    input.value = parseInt(input.value || 0) + delta;
    updateDayReschedulePreview();
}

// Update preview
function updateDayReschedulePreview() {
    const days = parseInt(document.getElementById('dayShiftAmount').value || 0);
    const preview = document.getElementById('dayReschedulePreview');
    
    if (days === 0) {
        preview.style.display = 'none';
        return;
    }
    
    preview.style.display = 'block';
    preview.textContent = `This day will be shifted ${Math.abs(days)} working day(s) ${days > 0 ? 'forward' : 'backward'}`;
}


// Confirm day reschedule
async function confirmDayReschedule() {
    const taskId = document.getElementById('rescheduleTaskId').value;
    const projectId = document.getElementById('rescheduleTaskProjectId').value;
    const stageId = document.getElementById('rescheduleTaskStageId').value;
    const days = parseInt(document.getElementById('dayShiftAmount').value || 0);
    const reason = document.getElementById('dayRescheduleReason').value;
    
    if (days === 0) {
        alert('Please enter a number of days to shift');
        return;
    }
    
    try {
        console.log('üîÑ Rescheduling daily task...');
        
        const response = await fetch(`/api/projects/${projectId}/stages/${stageId}/daily-tasks/${taskId}/reschedule`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                days: days,
                reason: reason,
                working_saturdays: Array.from(currentProjectData?.saturdayWorkingDays || [])
            })
        });
        
        if (response.ok) {
            showNotification('‚úÖ Day rescheduled successfully!', 'success');
            
            // Close the reschedule day modal
            rescheduleDayModal.hide();
            
            // ‚úÖ CRITICAL: Wait LONGER for database transaction to FULLY commit
            console.log('‚è≥ Waiting for database commit (4 seconds)...');
            await new Promise(resolve => setTimeout(resolve, 4000));
            
            console.log('üî• Fetching updated task list...');
            
            // Reload tasks in the daily task modal
            const tasksResponse = await fetch(`/api/projects/${projectId}/stages/${stageId}/daily-tasks?_t=${Date.now()}`, {
                cache: 'no-store',
                headers: { 'Cache-Control': 'no-cache' }
            });
            const tasks = await tasksResponse.json();
            renderDailyTasks(tasks);
            
            console.log('‚úÖ Task list updated');
            
            // ‚úÖ Close the daily task modal so user can see the calendar
            console.log('üìä Closing daily task modal...');
            dailyTaskModal.hide();
            
            // ‚úÖ Additional wait before calendar rebuild
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // ‚úÖ Force COMPLETE calendar rebuild with ALL history
            if (calendar && currentProjectForCalendar === parseInt(projectId)) {
                showNotification('üîÑ Rebuilding calendar with ghost events...', 'info');
                
                console.log('üî® Starting calendar rebuild...');
                
                // ‚úÖ CRITICAL: Fetch history FIRST before rebuild
                try {
                    const timestamp = Date.now();
                    const historyResponse = await fetch(`/api/projects/${projectId}/complete-reschedule-history?_t=${timestamp}`, {
                        cache: 'no-store',
                        headers: { 
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache'
                        }
                    });
                    
                    if (historyResponse.ok) {
                        const historyData = await historyResponse.json();
                        console.log(`üìú Loaded ${historyData.length} history records (including daily tasks)`);
                        
                        // Update currentProjectData with fresh history
                        if (!currentProjectData) {
                            console.error('‚ùå currentProjectData is null!');
                        } else {
                            currentProjectData.rescheduleHistory = historyData;
                            console.log('‚úÖ Updated currentProjectData.rescheduleHistory');
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Failed to fetch history:', historyResponse.status);
                    }
                } catch (error) {
                    console.error('‚ùå Error fetching history:', error);
                }
                
                // Now rebuild calendar with updated history
                await forceCompleteCalendarRebuild(parseInt(projectId));
                
                showNotification('‚úÖ Calendar updated! Ghost event shows original location.', 'success');
            } else {
                console.warn('‚ö†Ô∏è Calendar not available for rebuild');
            }
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (error) {
        console.error('‚ùå Reschedule error:', error);
        alert('Error: ' + error.message);
    }
}

// ‚úÖ NEW FUNCTION: Refresh calendar events without closing/reopening modal
async function refreshCalendarEvents() {
    if (!calendar || !currentProjectData) {
        console.log('‚ö†Ô∏è Cannot refresh calendar: calendar or data missing');
        return;
    }
    
    try {
        console.log('üîÑ Refreshing calendar events...');
        
        // ‚úÖ CRITICAL: Fetch COMPLETE reschedule history
        const timestamp = Date.now();
        const historyResponse = await fetch(`/api/projects/${currentProjectData.id}/complete-reschedule-history?_t=${timestamp}`, {
            cache: 'no-store',
            headers: { 'Cache-Control': 'no-cache', 'Pragma': 'no-cache' }
        });
        
        if (historyResponse.ok) {
            currentProjectData.rescheduleHistory = await historyResponse.json();
            console.log('‚úÖ Loaded reschedule history:', currentProjectData.rescheduleHistory.length, 'records');
        } else {
            console.warn('‚ö†Ô∏è Failed to load history');
            currentProjectData.rescheduleHistory = [];
        }
        
        // Fetch fresh project data
        const response = await fetch(`/api/projects/${currentProjectData.id}/details?_t=${timestamp}`, {
            cache: 'no-store',
            headers: { 'Cache-Control': 'no-cache', 'Pragma': 'no-cache' }
        });
        const freshData = await response.json();
        
        // Update saturdayWorkingDays
        if (Array.isArray(freshData.saturdayWorkingDays)) {
            freshData.saturdayWorkingDays = new Set(freshData.saturdayWorkingDays);
        }
        
        // ‚úÖ PRESERVE reschedule history
        freshData.rescheduleHistory = currentProjectData.rescheduleHistory;
        
        currentProjectData = freshData;
        
        // Generate new events from fresh data (including ghost events)
        const newEvents = await generateEnhancedCalendarEvents(freshData.stages);
        
        console.log('üìä Generated events:', newEvents.length, 'total');
        console.log('üëª Ghost events:', newEvents.filter(e => e.classNames?.includes('ghost-event')).length);
        
        // Remove all old events
        calendar.removeAllEvents();
        
        // Wait a tick
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Add new events
        newEvents.forEach(event => {
            calendar.addEvent(event);
        });
        
        // Refresh display
        calendar.render();
                
        console.log('‚úÖ Calendar refreshed successfully');
        
    } catch (error) {
        console.error('Error refreshing calendar:', error);
    }
}

// Complete calendar refresh with FORCED data reload
async function refreshCalendarWithBadges() {
    if (!calendar || !currentProjectData) {
        console.log('‚ö†Ô∏è Cannot refresh calendar: calendar or data missing');
        return;
    }
    
    try {
        console.log('üîÑ Starting calendar refresh...');
        
        const projectId = currentProjectData.id;
        
        // ‚úÖ Wait for database commit
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // ‚úÖ Fetch fresh data with cache busting
        const timestamp = Date.now();
        const detailsUrl = `/api/projects/${projectId}/details?_t=${timestamp}&_bustCache=${Math.random()}`;
        
        const response = await fetch(detailsUrl, {
            cache: 'no-store',
            headers: {
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to fetch: ${response.status}`);
        }
        
        const freshData = await response.json();
        console.log('‚úÖ Fresh data received:', freshData.stages.length, 'stages');
        
        // Fetch reschedule history
        const historyUrl = `/api/projects/${projectId}/reschedule-history?_t=${timestamp}`;
        const historyResponse = await fetch(historyUrl, {
            cache: 'no-store',
            headers: { 'Cache-Control': 'no-cache', 'Pragma': 'no-cache' }
        });
        
        if (historyResponse.ok) {
            freshData.rescheduleHistory = await historyResponse.json();
        } else {
            freshData.rescheduleHistory = [];
        }
        
        // Convert saturdayWorkingDays
        if (Array.isArray(freshData.saturdayWorkingDays)) {
            freshData.saturdayWorkingDays = new Set(freshData.saturdayWorkingDays);
        } else {
            freshData.saturdayWorkingDays = new Set();
        }
        
        // ‚úÖ Update currentProjectData
        currentProjectData = freshData;
        
        // ‚úÖ CRITICAL FIX: Clear ALL badges BEFORE any calendar operations
        document.querySelectorAll('.parallel-jobs-badge').forEach(badge => badge.remove());
        
        // ‚úÖ Regenerate events
        const newEvents = await generateEnhancedCalendarEvents(currentProjectData.stages);
        console.log('üéØ Generated', newEvents.length, 'events');
        
        // ‚úÖ Remove old events
        calendar.removeAllEvents();
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // ‚úÖ Add new events
        newEvents.forEach(event => calendar.addEvent(event));
        
        // ‚úÖ CRITICAL: Force calendar to fully re-render
        calendar.render();
        
        // ‚úÖ Wait for render to complete
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // ‚úÖ NOW recalculate badges with fresh DOM
        console.log('üè∑Ô∏è Recalculating badges with updated stage positions...');
        
        // Clear again just to be safe
        document.querySelectorAll('.parallel-jobs-badge').forEach(badge => badge.remove());
        
        // ‚úÖ IMPROVED: Recalculate badges with the UPDATED stage data
        recalculateBadgesWithFreshData();
        
        // ‚úÖ Do additional refreshes to ensure accuracy
        
        console.log('‚úÖ Calendar refresh complete');
        
    } catch (error) {
        console.error('‚ùå Error:', error);
        showNotification('Failed to refresh: ' + error.message, 'error');
    }
}

// √¢≈ì‚Ä¶ NEW FUNCTION: Use fresh currentProjectData for badge calculation
function recalculateBadgesWithFreshData() {
    if (!currentProjectData || !currentProjectData.stages) {
        console.log('√¢≈° √Ø¬∏¬è No project data for badge calculation');
        return;
    }
    
    console.log('√∞≈∏‚Äú≈† Calculating badges with', currentProjectData.stages.length, 'stages');
    
    // Log current stage dates
    currentProjectData.stages.forEach((stage, idx) => {
        console.log(`  ${idx + 1}. ${stage.name}: ${stage.start_date} √¢‚Ä†‚Äô ${stage.end_date}`);
    });
    
    const dayCells = document.querySelectorAll('.fc-daygrid-day');
    let badgesAdded = 0;
    
    dayCells.forEach(dayCell => {
        const dateStr = dayCell.getAttribute('data-date');
        if (!dateStr) return;
        
        const checkDate = new Date(dateStr + 'T12:00:00');
        const dayOfWeek = checkDate.getDay();
        
        // Skip Sundays
        if (dayOfWeek === 0) return;
        
        // Skip non-working Saturdays
        if (dayOfWeek === 6) {
            const isWorking = currentProjectData.saturdayWorkingDays?.has(dateStr);
            if (!isWorking) return;
        }
        
        // √¢≈ì‚Ä¶ Count stages using FRESH data from currentProjectData
        const stagesOnThisDay = currentProjectData.stages.filter(stage => {
            if (!stage.start_date || !stage.end_date) return false;
            
            const stageStart = new Date(stage.start_date + 'T12:00:00');
            const stageEnd = new Date(stage.end_date + 'T12:00:00');
            
            return checkDate >= stageStart && checkDate <= stageEnd;
        });
        
        // Only add badge if 2+ stages
        if (stagesOnThisDay.length >= 2) {
            const dayFrame = dayCell.querySelector('.fc-daygrid-day-frame');
            if (!dayFrame) return;
            
            // Don't add if badge already exists
            if (dayFrame.querySelector('.parallel-jobs-badge')) return;
            
            const badge = document.createElement('div');
            badge.className = 'parallel-jobs-badge';
            badge.textContent = `${stagesOnThisDay.length} jobs`;
            badge.title = `${stagesOnThisDay.length} stages: ${stagesOnThisDay.map(s => s.name).join(', ')}`;
            
            badge.setAttribute('style', 
                'position: absolute !important; ' +
                'top: 5px !important; ' +
                'right: 35px !important; ' +
                'background: #dc3545 !important; ' +
                'color: white !important; ' +
                'border-radius: 12px !important; ' +
                'padding: 3px 10px !important; ' +
                'font-size: 0.7rem !important; ' +
                'font-weight: 700 !important; ' +
                'z-index: 200 !important; ' +
                'pointer-events: none !important; ' +
                'display: block !important;'
            );
            
            dayFrame.appendChild(badge);
            badgesAdded++;
            
            console.log(`  √¢≈ì‚Ä¶ ${dateStr}: ${stagesOnThisDay.length} jobs - ${stagesOnThisDay.map(s => s.name).join(', ')}`);
        }
    });
    
    console.log(`√¢≈ì‚Ä¶ Added ${badgesAdded} badges`);
}

// ‚úÖ NEW FUNCTION: Use fresh currentProjectData for badge calculation
function recalculateBadgesWithFreshData() {
    if (!currentProjectData || !currentProjectData.stages) {
        console.log('‚ö†Ô∏è No project data for badge calculation');
        return;
    }
    
    console.log('üìä Calculating badges with', currentProjectData.stages.length, 'stages');
    
    // Log current stage dates
    currentProjectData.stages.forEach((stage, idx) => {
        console.log(`  ${idx + 1}. ${stage.name}: ${stage.start_date} ‚Üí ${stage.end_date}`);
    });
    
    const dayCells = document.querySelectorAll('.fc-daygrid-day');
    let badgesAdded = 0;
    
    dayCells.forEach(dayCell => {
        const dateStr = dayCell.getAttribute('data-date');
        if (!dateStr) return;
        
        const checkDate = new Date(dateStr + 'T12:00:00');
        const dayOfWeek = checkDate.getDay();
        
        // Skip Sundays
        if (dayOfWeek === 0) return;
        
        // Skip non-working Saturdays
        if (dayOfWeek === 6) {
            const isWorking = currentProjectData.saturdayWorkingDays?.has(dateStr);
            if (!isWorking) return;
        }
        
        // ‚úÖ Count stages using FRESH data from currentProjectData
        const stagesOnThisDay = currentProjectData.stages.filter(stage => {
            if (!stage.start_date || !stage.end_date) return false;
            
            const stageStart = new Date(stage.start_date + 'T12:00:00');
            const stageEnd = new Date(stage.end_date + 'T12:00:00');
            
            return checkDate >= stageStart && checkDate <= stageEnd;
        });
        
        // Only add badge if 2+ stages
        if (stagesOnThisDay.length >= 2) {
            const dayFrame = dayCell.querySelector('.fc-daygrid-day-frame');
            if (!dayFrame) return;
            
            // Don't add if badge already exists
            if (dayFrame.querySelector('.parallel-jobs-badge')) return;
            
            const badge = document.createElement('div');
            badge.className = 'parallel-jobs-badge';
            badge.textContent = `${stagesOnThisDay.length} jobs`;
            badge.title = `${stagesOnThisDay.length} stages: ${stagesOnThisDay.map(s => s.name).join(', ')}`;
            
            badge.setAttribute('style', 
                'position: absolute !important; ' +
                'top: 5px !important; ' +
                'right: 35px !important; ' +
                'background: #dc3545 !important; ' +
                'color: white !important; ' +
                'border-radius: 12px !important; ' +
                'padding: 3px 10px !important; ' +
                'font-size: 0.7rem !important; ' +
                'font-weight: 700 !important; ' +
                'z-index: 200 !important; ' +
                'pointer-events: none !important; ' +
                'display: block !important;'
            );
            
            dayFrame.appendChild(badge);
            badgesAdded++;
            
            console.log(`  ‚úÖ ${dateStr}: ${stagesOnThisDay.length} jobs - ${stagesOnThisDay.map(s => s.name).join(', ')}`);
        }
    });
    
    console.log(`‚úÖ Added ${badgesAdded} badges`);
}
// √¢≈ì‚Ä¶ NEW FUNCTION: Create stage event with daily task status
function createStageEventWithStatus(stage, index, start, end, color, dateStageMap, tasks, stageHasRescheduled, stageRescheduleHistory = null) {
    // Check for parallel stages
    let hasParallel = false;
    let parallelCount = 0;
    
    for (let d = new Date(start); d < end; d.setDate(d.getDate() + 1)) {
        const dateKey = d.toISOString().split('T')[0];
        const stagesOnDate = dateStageMap.get(dateKey) || [];
        if (stagesOnDate.length > 1) {
            hasParallel = true;
            parallelCount = Math.max(parallelCount, stagesOnDate.length);
        }
    }
    
    // Analyze task statuses
    const allCompleted = tasks.every(t => t.status === 'completed');
    const someCompleted = tasks.some(t => t.status === 'completed');
    const hasRescheduled = tasks.some(t => t.is_rescheduled);
    const completedCount = tasks.filter(t => t.status === 'completed').length;
    const rescheduledCount = tasks.filter(t => t.is_rescheduled).length;
    
    let title = stage.name;
    
    // Build clean tooltip
    let tooltip = `${stage.name}\n`;
    tooltip += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    tooltip += `üìÖ Duration: ${stage.duration_days} days\n`;
    tooltip += `üìä Status: ${stage.status}\n`;    

    if (completedCount > 0) {
        tooltip += `√¢≈ì‚Ä¶ Completed: ${completedCount}/${tasks.length} days\n`;
    }
    
    if (rescheduledCount > 0) {
        tooltip += `√∞≈∏‚Äú¬ù Rescheduled: ${rescheduledCount} day(s)\n`;
    }
    
    if (hasParallel) {
        tooltip += `√¢≈° √Ø¬∏¬è Parallel with ${parallelCount - 1} other stage(s)`;
    }
    
    const classNames = [];
    
    if (allCompleted) {
        classNames.push('event-completed');
    } else if (hasRescheduled) {
        classNames.push('event-rescheduled');
    }
    
    if (stageHasRescheduled) {
        classNames.push('stage-rescheduled');
    }
    
    if (stage.status === 'in-progress') {
        classNames.push('stage-event-active');
    }
    
    // √¢≈ì‚Ä¶ Build extended props with reschedule info
    const extendedProps = {
        stageId: stage.id,
        stageIndex: index,
        duration: stage.duration_days,
        status: stage.status,
        hasParallel: hasParallel,
        parallelCount: parallelCount,
        stageName: stage.name,
        allCompleted: allCompleted,
        hasRescheduled: hasRescheduled,
        completedCount: completedCount,
        rescheduledCount: rescheduledCount,
        totalTasks: tasks.length
    };
    
    // √¢≈ì‚Ä¶ Add reschedule information if available
    if (stageRescheduleHistory) {
        extendedProps.wasRescheduled = true;
        extendedProps.daysShifted = stageRescheduleHistory.days_shifted || 
            Math.abs(Math.round((new Date(stageRescheduleHistory.new_date) - new Date(stageRescheduleHistory.original_date)) / (1000 * 60 * 60 * 24)));
        extendedProps.rescheduleDirection = stageRescheduleHistory.direction || 
            (new Date(stageRescheduleHistory.new_date) > new Date(stageRescheduleHistory.original_date) ? 'forward' : 'backward');
        extendedProps.rescheduleBadge = `${extendedProps.rescheduleDirection === 'forward' ? '+' : '-'}${extendedProps.daysShifted}d`;
        extendedProps.originalDate = stageRescheduleHistory.original_date;
    }
    
    return {
        title: title,
        start: start.toISOString().split('T')[0],
        end: end.toISOString().split('T')[0],
        backgroundColor: color,
        borderColor: color,
        extendedProps: extendedProps,
        classNames: classNames
    };
}

// Add this function to the <script> section in index.html

async function exportCurrentProject(projectId) {
    try {
        showNotification('üìä Preparing Excel export...', 'info');
        
        // Use fetch to download the file
        const response = await fetch(`/api/projects/${projectId}/export-excel`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // Get the blob
        const blob = await response.blob();
        
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `Project_${projectId}_Tracker_${new Date().toISOString().split('T')[0]}.xlsx`;
        
        // Trigger download
        document.body.appendChild(link);
        link.click();
        
        // Cleanup
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
        
        showNotification('‚úÖ Excel file downloaded successfully!', 'success');
        
    } catch (error) {
        console.error('‚ùå Export failed:', error);
        showNotification('Failed to export: ' + error.message, 'error');
        alert('Export Error: ' + error.message + '\n\nPlease check the browser console for more details.');
    }
}
</script>
</body>
</html>

