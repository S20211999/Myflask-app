
# --- CRITICAL FIX: SET QT_API ---
import os
os.environ['QT_API'] = 'pyside6'

import sys
import qtawesome
import json
import requests
import struct
from decimal import Decimal, getcontext


from PySide6.QtCore import (Qt, QSize, Signal, QPoint, QTimer)
from PySide6.QtWidgets import (
    QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout, QComboBox, QGroupBox, QCheckBox,
    QPushButton, QStackedWidget, QLabel, QLineEdit, QGridLayout, QTabWidget,
    QFrame, QScrollArea, QSizePolicy, QFileDialog, QMessageBox, QFormLayout,
    QTextEdit, QButtonGroup, QDialog, QSpinBox, QDoubleSpinBox
)
from PySide6.QtGui import QPixmap, QIcon, QMouseEvent, QClipboard, QFontDatabase, QIntValidator, QFont, QMovie
from PySide6.QtSvgWidgets import QSvgWidget


SETTINGS_FILE = os.path.join(os.path.expanduser("~"), ".my_altium_settings.json")
# --- Constants ---
FLASK_BASE_URL = "http://localhost:5000"  # Configure your Flask server URL

# Default settings
DEFAULT_SETTINGS = {
    "decimal_precision": 4
}

ALTIUM_SETTINGS = {
    "assmbly_layout_line_width": 0.1,
    "courtyard_expansion": 0.25,
    "BGA_TH_courtyard_expansion": 1.27,
    "courtyard_line_width": 0.05,
    "silkscreen_expansion": 0.15,
    "silkscreen_line_width": 0.15
}

# Default settings
ALLEGRO_SETTINGS = {
    "assembly_layout_line_width": 0.1,
    "courtyard_expansion": 0.25,
    "BGA_TH_courtyard_expansion": 1.27,
    "courtyard_line_width": 0.05,
    "silkscreen_expansion": 0.15,
    "silkscreen_line_width": 0.15
}

PADS_SETTINGS = {
    "assembly_layout_line_width": 0.1,
    "courtyard_expansion": 0.25,
    "BGA_TH_courtyard_expansion": 1.27,
    "courtyard_line_width": 0.05,
    "silkscreen_expansion": 0.15,
    "silkscreen_line_width": 0.15
}
XPEDITION_SETTINGS = {
    "assembly_layout_line_width": 0.1,
    "courtyard_expansion": 0.25,
    "BGA_TH_courtyard_expansion": 1.27,
    "courtyard_line_width": 0.05,
    "silkscreen_expansion": 0.15,
    "silkscreen_line_width": 0.15
}


class ScaledMovieLabel(QLabel):
    def __init__(self, gif_path, parent=None):
        super().__init__(parent)
        self.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.movie = QMovie(gif_path)
        self.setMovie(self.movie)
        self.movie.start()

    def resizeEvent(self, event):
        frame_size = event.size()
        movie_size = self.movie.currentPixmap().size()
        if movie_size.isEmpty():
            return

        # Calculate aspect-ratio-constrained size
        ratio = min(
            frame_size.width() / movie_size.width(),
            frame_size.height() / movie_size.height()
        )
        scaled_size = movie_size * ratio  # This is already a QSizeF
        self.movie.setScaledSize(scaled_size)  # Remove .toSize()
        super().resizeEvent(event)

# --- License Verification Dialog ---
class LicenseVerificationDialog(QDialog):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("License Verification")
        self.setFixedSize(450, 350)
        self.setModal(True)
        
        layout = QVBoxLayout(self)
        
        # Username
        layout.addWidget(QLabel("Username:"))
        self.username_edit = QLineEdit()
        layout.addWidget(self.username_edit)
        
        # password
        layout.addWidget(QLabel("Password:"))
        self.password_edit = QLineEdit()
        layout.addWidget(self.password_edit)
        
        # License Number
        # Server URL
        layout.addWidget(QLabel("Server URL:"))
        self.server_edit = QLineEdit(FLASK_BASE_URL)
        layout.addWidget(self.server_edit)
        
        # Buttons
        button_layout = QHBoxLayout()
        self.verify_button = QPushButton("Login")
        self.cancel_button = QPushButton("Cancel")
        
        self.verify_button.clicked.connect(self.attempt_verification)
        self.cancel_button.clicked.connect(self.reject)
        
        button_layout.addWidget(self.verify_button)
        button_layout.addWidget(self.cancel_button)
        layout.addLayout(button_layout)
        
        self.verification_data = None

    def attempt_verification(self):
        username = self.username_edit.text()
        password = self.password_edit.text()
        license_number = "BISA123636"
        server_url = self.server_edit.text()
        
        if not username or not password or not license_number:
            QMessageBox.warning(self, "Error", "Please enter all required fields")
            return
        
        try:
            # Attempt license verification
            response = requests.post(f"{server_url}/api/verify_license", 
                                   json={
                                       "username": username, 
                                       "password": password,
                                       "license_number": license_number
                                   },
                                   timeout=10)
            
            if response.status_code == 200:
                data = response.json()
                if data.get('status') == 'approved':
                    self.verification_data = {
                        'username': username,
                        'password': password,
                        'license_number': license_number,
                        'server_url': server_url
                    }
                    global FLASK_BASE_URL
                    FLASK_BASE_URL = server_url
                    QMessageBox.information(self, "Success", "License verified successfully!")
                    self.accept()
                else:
                    QMessageBox.warning(self, "Verification Failed", data.get('message', 'License verification failed'))
            else:
                data = response.json() if response.headers.get('content-type') == 'application/json' else {}
                QMessageBox.warning(self, "Verification Failed", data.get('message', 'License verification failed'))
                
        except requests.exceptions.RequestException as e:
            QMessageBox.critical(self, "Connection Error", f"Could not connect to server:\n{str(e)}")

# --- Custom Widgets ---
class ToggleSwitch(QCheckBox):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setCursor(Qt.CursorShape.PointingHandCursor)

class ClickableLabel(QLabel):
    doubleClicked = Signal()
    singleClicked = Signal()

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.setAlignment(Qt.AlignCenter)
        self.setCursor(Qt.PointingHandCursor)
        self.setProperty("class", "ClickableLabel")

    def mousePressEvent(self, event: QMouseEvent):
        self._mouse_press_pos = event.pos()

    def mouseReleaseEvent(self, event: QMouseEvent):
        if self._mouse_press_pos == event.pos() and event.button() == Qt.LeftButton:
            self.singleClicked.emit()

    def mouseDoubleClickEvent(self, event: QMouseEvent):
        if event.button() == Qt.LeftButton:
            self.doubleClicked.emit()

# --- Generator Page Base Class ---
class BaseGeneratorPage(QWidget):
    generationFinalized = Signal(dict)
    
    def __init__(self, table_name, parent=None):
        super().__init__(parent)
        self.table_name = table_name
        self.parent_window = parent

        # Initialize paths for all 4 script types
        self.script_paths = {
            'altium': os.path.join(os.path.expanduser("~"), "altium_scripts"),
            'allegro': os.path.join(os.path.expanduser("~"), "allegro_scripts"),
            'pads': os.path.join(os.path.expanduser("~"), "pads_scripts"),
            'xpedition': os.path.join(os.path.expanduser("~"), "xpedition_scripts")
        }
        
        self.setObjectName("GeneratorPage")
        layout = QGridLayout(self)
        layout.setContentsMargins(25, 25, 25, 25)
        layout.setSpacing(20)
        
        self.title_label = QLabel()
        layout.addWidget(self.title_label, 0, 0)
        
        input_frame = QFrame()
        self.form_layout = QFormLayout(input_frame)
        self.form_layout.setSpacing(12)
        self.form_layout.setLabelAlignment(Qt.AlignRight)
        self.input_fields = {}
        layout.addWidget(input_frame, 0, 0)
        
        right_panel_layout = QVBoxLayout()
        self.image_label = QSvgWidget()
        self.image_label.setMinimumSize(250, 300)
        self.image_label.setStyleSheet("background-color: #232730; border-radius: 8px;")
        right_panel_layout.addWidget(self.image_label)
        layout.addLayout(right_panel_layout, 0, 1)
        layout.setColumnStretch(1, 1)
        
        button_layout = QHBoxLayout()
        self.generate_button = QPushButton("Generate All Scripts")
        self.generate_button.setObjectName("GenerateButton")
        self.generate_button.setCursor(Qt.PointingHandCursor)
        self.generate_button.clicked.connect(self._on_generate_clicked)
        button_layout.addWidget(self.generate_button)
        button_layout.addStretch()
        layout.addLayout(button_layout, 2, 0, 1, 2)

    def _on_generate_clicked(self):
        """Generate scripts and submit data to Flask server"""
        data = self.collect_data()
        if not data.get("part_number") or not data.get("footprint_name"):
            QMessageBox.warning(self, "Input Error", "Part Number and Footprint Name are required.")
            return
        
        # Check license verification
        main_window = self.get_main_window()
        if not main_window or not main_window.verification_data:
            QMessageBox.warning(self, "License Error", "Please verify your license first from Settings > Account.\nScript generation is not allowed without valid license.")
            return
        
        try:
            generated_files = []
            errors = []
            
            # Generate scripts for all 4 tools
            for script_type in ['altium', 'allegro', 'pads', 'xpedition']:
                try:
                    script_content, filename = self.generate_script_for_tool(data, script_type)
                    self._write_script_to_file(script_type, filename, script_content)
                    generated_files.append(f"{script_type.title()}: {filename}")
                except Exception as e:
                    errors.append(f"{script_type.title()}: {str(e)}")
            
            # Try to submit data to Flask server (but don't block script generation)
            server_success = self._submit_to_flask_server(data)
            
            # Show results
            if generated_files:
                success_msg = "Successfully generated scripts:\n\n" + "\n".join(generated_files)
                if errors:
                    success_msg += f"\n\nErrors encountered:\n" + "\n".join(errors)
                if server_success:
                    success_msg += "\n\nData successfully saved to server."
                else:
                    success_msg += "\n\nWarning: Could not save data to server (scripts still generated locally)."
                QMessageBox.information(self, "Scripts Generated", success_msg)
                
                self.generationFinalized.emit({"data": data, "table_name": self.table_name})
            else:
                QMessageBox.critical(self, "Generation Failed", "Failed to generate any scripts:\n\n" + "\n".join(errors))
                
        except Exception as e:
            QMessageBox.critical(self, "Error", f"An error occurred during the process:\n\n{e}")

    def _submit_to_flask_server(self, data):
        """Submit footprint data to Flask server (non-blocking)"""
        try:
            main_window = self.get_main_window()
            if not main_window or not main_window.verification_data:
                return False
                
            # Prepare data for submission
            submission_data = {
                "package_type": self.table_name,
                "part_number": data.get('part_number', ''),
                "footprint_name": data.get('footprint_name', ''),
                "specifications": data,
                "user_created": main_window.verification_data.get('username', 'Unknown'),
                "license_verification": main_window.verification_data
            }
            
            response = requests.post(
                f"{FLASK_BASE_URL}/api/footprint/add",
                json=submission_data,
                timeout=10
            )
            
            if response.status_code == 200:
                result = response.json()
                return result.get('status') == 'success'
            else:
                print(f"Server error: {response.status_code}")
                return False
                
        except requests.exceptions.RequestException as e:
            print(f"Network error: {e}")
            return False
        except Exception as e:
            print(f"Submission error: {e}")
            return False

    def get_main_window(self):
        """Get the main window instance"""
        widget = self
        while widget:
            if isinstance(widget, MainWindow):
                return widget
            widget = widget.parent()
        return None

    def _write_script_to_file(self, script_type, filename, script_content):
        """Write script file to the appropriate output path"""
        output_path = self.script_paths.get(script_type)
        if not output_path:
            raise ValueError(f"Output path for {script_type} has not been set.")
        
        os.makedirs(output_path, exist_ok=True)
        output_filepath = os.path.join(output_path, filename)
        with open(output_filepath, "w") as f:
            f.write(script_content)

    def generate_script_for_tool(self, data, tool_type):
        """Generate script for specific tool - must be implemented by subclasses"""
        raise NotImplementedError("Each generator page must implement generate_script_for_tool")

    def set_script_paths(self, paths_dict):
        """Update all script output paths"""
        self.script_paths.update(paths_dict)
        
    def set_output_path(self, path):
        """Legacy method for backward compatibility"""
        self.script_paths['altium'] = path

    def collect_data(self):
        """Collect data from input fields"""
        data = {}
        for k, v in self.input_fields.items():
            key = k.replace(" ", "_").lower().replace("(mm)", "").strip()
            value = v.text().strip()
            data[key] = value
        return data

# --- Specific Generator Page Implementation ---
class DiscreteN(BaseGeneratorPage):
    """Generator page for discrete normal packages"""
    
    def __init__(self, parent=None):
        super().__init__("DiscreteN", parent)
        self.input_fields = {
            "Part Number": QLineEdit(),
            "Footprint Name": QLineEdit(),
            "Body Length (mm)": QLineEdit(),
            "Body Width (mm)": QLineEdit(),
            "Body Height (mm)": QLineEdit(),
            "Pad Length (mm)": QLineEdit(),
            "Pad Width (mm)": QLineEdit(),
            "Mask Expansion (mm)": QLineEdit(),
            "Paste Expansion (mm)": QLineEdit(),
            "Airgap (mm)": QLineEdit(),
        }
        for label, field in self.input_fields.items():
            self.form_layout.addRow(label, field)
        
        try:
            self.image_label.load("images/Discrete/generator_resistor_chip.svg")
        except:
            pass

    def generate_script_for_tool(self, data, tool_type):
        """Generate script for specific tool type"""
        if tool_type == 'altium':
            return self._generate_altium_script(data)
        elif tool_type == 'allegro':
            return self._generate_allegro_script(data)
        elif tool_type == 'pads':
            return self._generate_pads_script(data)
        elif tool_type == 'xpedition':
            return self._generate_xpedition_script(data)
        else:
            raise ValueError(f"Unsupported tool type: {tool_type}")

    def _generate_altium_script(self, data):
        """Generate Altium Designer script"""
        try:
            part_number = data.get('part_number', '')
            footprint_name = data.get('footprint_name', '')
            refdes = data.get('refdesignator', '').strip()
            
            # Convert to Decimal for precise calculations
            body_length_max = Decimal(data.get('body_length', '0'))
            body_width_max = Decimal(data.get('body_width', '0'))
            body_height_max = Decimal(data.get('body_height', '0'))
            pad_length = Decimal(data.get('pad_length', '0'))
            pad_width = Decimal(data.get('pad_width', '0'))
            mask_expansion = Decimal(data.get('mask_expansion', '0'))
            paste_expansion = Decimal(data.get('paste_expansion', '0'))
            air_gap = Decimal(data.get('airgap', '0'))
        except Exception as e:
            raise ValueError(f"All dimensions must be valid numbers: {e}")

        # Get settings from main window
        main_window = self.get_main_window()
        settings = main_window.altium_settings if main_window else DEFAULT_SETTINGS

        body_lw = Decimal(str(settings.get('assmbly_layout_line_width', '0.1')))
        courtyard_exp = Decimal(str(settings.get('courtyard_expansion', '0.25')))
        courtyard_lw = Decimal(str(settings.get('courtyard_line_width', '0.05')))
        silk_exp = Decimal(str(settings.get('silkscreen_expansion', '0.15')))
        silk_lw = Decimal(str(settings.get('silkscreen_line_width', '0.15')))
        precision = settings.get('decimal_precision', 3)

        # Set decimal precision
        getcontext().prec = precision + 10  # Extra precision for calculations

        def mm_to_mils(val):
            return int(val / Decimal('0.000254'))

        # Calculate positions
        mm_to_mil = Decimal("39.37")  # 1 mm = mm_to_mil mils
        d0_25 = Decimal("0.25")  # 0.25 mm keepout
        d0_025 = Decimal("0.025")
        bd_cty = courtyard_exp + (courtyard_lw/2) (body_lw/2)
        pad_cty = courtyard_exp + (courtyard_lw/2)
        d0_225 = Decimal("0.22")  # d0_225 mm
        two = Decimal("2")


        script = f"""# Created by Footprint Generator - Altium Designer
# Part Number: {part_number}
# Footprint: {footprint_name}
# Generated with precision: {precision} decimal places
Footprint (Name "{footprint_name}") (Height {body_height_max * mm_to_mil})
Line (Width 1.9685) (Start -{(body_length_max/two) * mm_to_mil}, -{(body_width_max/two) * mm_to_mil}) (End {(body_length_max/two) * mm_to_mil}, -{(body_width_max/two) * mm_to_mil}) (Layer Mechanical13)
Line (Width 1.9685) (Start {(body_length_max/two) * mm_to_mil}, -{(body_width_max/two) * mm_to_mil}) (End {(body_length_max/two) * mm_to_mil}, {(body_width_max/two) * mm_to_mil}) (Layer Mechanical13)
Line (Width 1.9685) (Start {(body_length_max/two) * mm_to_mil}, {(body_width_max/two) * mm_to_mil}) (End -{(body_length_max/two) * mm_to_mil}, {(body_width_max/two) * mm_to_mil}) (Layer Mechanical13)
Line (Width 1.9685) (Start -{(body_length_max/two) * mm_to_mil}, {(body_width_max/two) * mm_to_mil}) (End -{(body_length_max/two) * mm_to_mil}, -{(body_width_max/two) * mm_to_mil}) (Layer Mechanical13)
Line (Width 1.9685) (Start -{max(((body_length_max/two) + bd_cty) * mm_to_mil,(((two*pad_length+air_gap)/two+pad_cty)* mm_to_mil))}, -{max(((body_width_max/two) + bd_cty) * mm_to_mil,((pad_width/two)+pad_cty) * mm_to_mil)}) (End {max(((body_length_max/two) + bd_cty) * mm_to_mil,(((two*pad_length+air_gap)/two+pad_cty)* mm_to_mil))}, -{max(((body_width_max/two) + bd_cty) * mm_to_mil,((pad_width/two)+pad_cty) * mm_to_mil)}) (Layer Mechanical15)
Line (Width 1.9685) (Start {max(((body_length_max/two) + bd_cty) * mm_to_mil,(((two*pad_length+air_gap)/two+pad_cty)* mm_to_mil))}, -{max(((body_width_max/two) + bd_cty) * mm_to_mil,((pad_width/two)+pad_cty) * mm_to_mil)}) (End {max(((body_length_max/two) + bd_cty) * mm_to_mil,(((two*pad_length+air_gap)/two+pad_cty)* mm_to_mil))}, {max(((body_width_max/two) + bd_cty) * mm_to_mil,((pad_width/two)+pad_cty) * mm_to_mil)}) (Layer Mechanical15)
Line (Width 1.9685) (Start {max(((body_length_max/two) + bd_cty) * mm_to_mil,(((two*pad_length+air_gap)/two+pad_cty)* mm_to_mil))}, {max(((body_width_max/two) + bd_cty) * mm_to_mil,((pad_width/two)+pad_cty) * mm_to_mil)}) (End -{max(((body_length_max/two) + bd_cty) * mm_to_mil,(((two*pad_length+air_gap)/two+pad_cty)* mm_to_mil))}, {max(((body_width_max/two) + bd_cty) * mm_to_mil,((pad_width/two)+pad_cty) * mm_to_mil)}) (Layer Mechanical15)
Line (Width 1.9685) (Start -{max(((body_length_max/two) + bd_cty) * mm_to_mil,(((two*pad_length+air_gap)/two+pad_cty)* mm_to_mil))}, {max(((body_width_max/two) + bd_cty) * mm_to_mil,((pad_width/two)+pad_cty) * mm_to_mil)}) (End -{max(((body_length_max/two) + bd_cty) * mm_to_mil,(((two*pad_length+air_gap)/two+pad_cty)* mm_to_mil))}, -{max(((body_width_max/two) + bd_cty) * mm_to_mil,((pad_width/two)+pad_cty) * mm_to_mil)}) (Layer Mechanical15)
Line (Width 5.9055) (Start -{(body_length_max/two) * mm_to_mil}, -{max(((body_width_max/two) * mm_to_mil),((pad_width/two)+d0_225)*mm_to_mil)}) (End {(body_length_max/two) * mm_to_mil}, -{max(((body_width_max/two) * mm_to_mil),((pad_width/two)+d0_225)*mm_to_mil)}) (Layer TopOverlay)
Line (Width 5.9055) (Start {(body_length_max/two) * mm_to_mil}, {max(((body_width_max/two) * mm_to_mil),((pad_width/two)+d0_225)*mm_to_mil)}) (End -{(body_length_max/two) * mm_to_mil}, {max(((body_width_max/two) * mm_to_mil),((pad_width/two)+d0_225)*mm_to_mil)}) (Layer TopOverlay)
Polygon (PointCount 4) (Type KeepOut) (Layer TopLayer) 
Point (-{(air_gap-d0_25)/two * mm_to_mil}, {(body_width_max/two - d0_025) *mm_to_mil})
Point ({(air_gap-d0_25)/two * mm_to_mil}, {(body_width_max/two -d0_025) *mm_to_mil})
Point ({(air_gap-d0_25)/two * mm_to_mil}, -{(body_width_max/two -d0_025) *mm_to_mil})
Point (-{(air_gap-d0_25)/two * mm_to_mil}, -{(body_width_max/two -d0_025) *mm_to_mil})
EndPolygon
Text (Location -126, -11.063) (Layer Mechanical13) (Height 25) (Width 1.968) (Mirrored False) (Rotation 0) (Value ".Designator")
Pad (Name "1") (Location -{((pad_length+air_gap)/two) * mm_to_mil}, 0) (Surface True) (Plated True) (Plated True) (Rotation 0) (ExpandMask {mask_expansion * mm_to_mil}) (ExpandPaste -{paste_expansion * mm_to_mil})
PadShape (Size {pad_length * mm_to_mil}, {pad_width * mm_to_mil}) (Shape Rectangular) (Layer Top)
EndPad
Pad (Name "2") (Location {((pad_length+air_gap)/two) * mm_to_mil}, 0) (Surface True) (Plated True) (Plated True) (Rotation 0) (ExpandMask {mask_expansion * mm_to_mil}) (ExpandPaste -{paste_expansion * mm_to_mil})
PadShape (Size {pad_length * mm_to_mil}, {pad_width * mm_to_mil}) (Shape Rectangular) (Layer Top)
EndPad
EndFootprint
EndFootprints
"""
        return script, f"{part_number}_altium.txt"

    def _generate_allegro_script(self, data):
        """Generate Cadence Allegro script"""
        part_number = data.get('part_number', '')
        footprint_name = data.get('footprint_name', '')
        
        # Get numeric values with proper error handling
        try:
            body_l = Decimal(data.get('body_length', '0'))
            body_w = Decimal(data.get('body_width', '0'))
            pad_l = Decimal(data.get('pad_length', '0'))
            pad_w = Decimal(data.get('pad_width', '0'))
            airgap = Decimal(data.get('airgap', '0'))
        except Exception:
            raise ValueError("All dimensions must be valid numbers")

        main_window = self.get_main_window()
        settings = main_window.altium_settings if main_window else DEFAULT_SETTINGS
        precision = settings.get('decimal_precision', 3)
        
        pad_spacing = body_l + airgap
        pad_x_pos = pad_spacing / 2
        
        script = f"""# Allegro PCB Editor Script
# Part Number: {part_number}
# Footprint: {footprint_name}

create footprint {footprint_name}
shape add rect {pad_l} {pad_w}
pad add {pad_x_pos} 0 1 rect
pad add {-pad_x_pos} 0 2 rect
line add assembly {body_l/2} {body_w/2}
line add assembly {-body_l/2} {body_w/2}
line add assembly {-body_l/2} {-body_w/2}
line add assembly {body_l/2} {-body_w/2}
text add refdes 0 {body_w/2+Decimal('0.5')} \\$REFDES
done

# Design values used:
# Body Length: {body_l} mm
# Body Width: {body_w} mm
# Pad Length: {pad_l} mm
# Pad Width: {pad_w} mm
# Pad Spacing: {pad_spacing} mm
"""
        return script, f"{part_number}_allegro.scr"

    def _generate_pads_script(self, data):
        """Generate Mentor Graphics PADS script"""
        part_number = data.get('part_number', '')
        footprint_name = data.get('footprint_name', '')
        
        try:
            body_l = Decimal(data.get('body_length', '0'))
            body_w = Decimal(data.get('body_width', '0'))
            pad_l = Decimal(data.get('pad_length', '0'))
            pad_w = Decimal(data.get('pad_width', '0'))
            airgap = Decimal(data.get('airgap', '0'))
        except Exception:
            raise ValueError("All dimensions must be valid numbers")

        main_window = self.get_main_window()
        settings = main_window.altium_settings if main_window else DEFAULT_SETTINGS
        precision = settings.get('decimal_precision', 3)
        
        pad_spacing = body_l + airgap
        pad_x_pos = pad_spacing / 2
        
        script = f"""! PADS PowerPCB Script
! Part Number: {part_number}
! Footprint: {footprint_name}

*PART*
{footprint_name}

*PAD*
P1 {pad_l} {pad_w} R 0 0 {pad_x_pos} 0
P2 {pad_l} {pad_w} R 0 0 {-pad_x_pos} 0

*LINE*
15 0 {body_l/2} {body_w/2}
15 0 {-body_l/2} {body_w/2}
15 0 {-body_l/2} {-body_w/2}
15 0 {body_l/2} {-body_w/2}

*TEXT*
0 0 {body_w/2+Decimal('1')} 0 \\$REFDES

*END*

! Design values used:
! Body Length: {body_l} mm
! Body Width: {body_w} mm
! Pad Length: {pad_l} mm
! Pad Width: {pad_w} mm
! Pad Spacing: {pad_spacing} mm
"""
        return script, f"{part_number}_pads.asc"

    def _generate_xpedition_script(self, data):
        """Generate Mentor Graphics Xpedition script"""
        part_number = data.get('part_number', '')
        footprint_name = data.get('footprint_name', '')
        
        try:
            body_l = Decimal(data.get('body_length', '0'))
            body_w = Decimal(data.get('body_width', '0'))
            pad_l = Decimal(data.get('pad_length', '0'))
            pad_w = Decimal(data.get('pad_width', '0'))
            airgap = Decimal(data.get('airgap', '0'))
        except Exception:
            raise ValueError("All dimensions must be valid numbers")

        main_window = self.get_main_window()
        settings = main_window.altium_settings if main_window else DEFAULT_SETTINGS
        precision = settings.get('decimal_precision', 3)
        
        pad_spacing = body_l + airgap
        pad_x_pos = pad_spacing / 2
        
        script = f"""# Xpedition PCB Script
# Part Number: {part_number}
# Footprint: {footprint_name}

cell new {footprint_name}
padstack new rect_{pad_l}x{pad_w}
layer TOP copper rectangle {pad_l} {pad_w}
padstack end
pin new 1 {pad_x_pos} 0 rect_{pad_l}x{pad_w}
pin new 2 {-pad_x_pos} 0 rect_{pad_l}x{pad_w}
text new SILKSCREEN_TOP 0 {body_w/2+Decimal('0.5')} \\$REFDES
cell save
cell end

# Design values used:
# Body Length: {body_l} mm
# Body Width: {body_w} mm
# Pad Length: {pad_l} mm
# Pad Width: {pad_w} mm
# Pad Spacing: {pad_spacing} mm
"""
        return script, f"{part_number}_xpedition.scr"

# Placeholder classes for other generator pages (implement as needed)
class DiscreteF(BaseGeneratorPage):
    def __init__(self, parent=None):
        super().__init__("DiscreteF", parent)
        # Add your input fields and implementation here

# ... Add other generator classes as needed

# --- Main Application Window ---
class MainWindow(QMainWindow):
    DEFAULT_CATEGORY_IMAGE_MAP = {
        "Discrete": "images/DISCRETE.svg",
        "Sot-23": "images/SOT-PACKAGE.svg",
        "Sot-143": "images/SOT143.svg",
        "TO Package": "images/TO-PACKAGE.svg",
        "Dual Side": "images/DUAL-SIDE-PACKAGE.svg",
        "Dual with thermal": "images/DUAL-SIDE-PACKAGE.svg",
        "QF Package": "images/PQFP.svg",
        "QF Package with thermal": "images/QFN.svg",
        "QFN TWO ROW": "images/QFN2ROW.svg",
        "Connectors": "images/CONNECTORS.svg",
        "Crystals": "images/PrecisionWireWound.svg",
        "BGA Package": "images/BGA.svg",
    }

    def __init__(self):
        super().__init__()
        self.setWindowTitle("Modern UI Footprint Generator")
        self.resize(1200, 800)
        
        self.system_fonts = QFontDatabase.families()
        self.stroke_fonts = ["Default", "Sans Serif", "Serif"]
        
        # Initialize application settings with defaults
        self.decimal_precision = DEFAULT_SETTINGS.copy()
        self.altium_settings = ALTIUM_SETTINGS.copy()
        self.allegro_settings = ALLEGRO_SETTINGS.copy()
        self.pads_settings = PADS_SETTINGS.copy()
        self.xpedition_settings = XPEDITION_SETTINGS.copy()


        
        # License verification data
        self.script_paths = {
            'altium': '',
            'allegro': '',
            'pads': '',
            'xpedition': ''
        }

        self.verification_data = None

        self.load_settings()
        
        self.current_script_path = ''
        
        central_container = QWidget()
        self.main_layout = QHBoxLayout(central_container)
        self.main_layout.setContentsMargins(0, 0, 0, 0)
        self.main_layout.setSpacing(0)
        
        self.setCentralWidget(central_container)
        
        self.create_sidebar()
        self.create_main_content()
        self.load_stylesheet("style.qss")

    def load_stylesheet(self, filename):
        try:
            with open(filename, "r") as f:
                self.setStyleSheet(f.read())
        except FileNotFoundError:
            print(f"Stylesheet '{filename}' not found. Using default styles.")

    def create_sidebar(self):
        sidebar_container = QWidget()
        sidebar_container.setObjectName("Sidebar")
        sidebar_layout = QVBoxLayout(sidebar_container)
        sidebar_layout.setContentsMargins(0, 10, 0, 10)
        sidebar_layout.setSpacing(5)
        sidebar_layout.setAlignment(Qt.AlignTop)
        
        self.button_group = []
        for text, icon in self.get_sidebar_options().items():
            button = QPushButton(f"  {text}")
            button.setIcon(qtawesome.icon(icon, color='#d0d0d0'))
            button.setIconSize(QSize(20, 20))
            button.setCheckable(True)
            sidebar_layout.addWidget(button)
            self.button_group.append(button)

        self.button_group[0].setChecked(True)
        for button in self.button_group:
            button.clicked.connect(self.handle_sidebar_click)

        scroll_area = QScrollArea()
        scroll_area.setWidgetResizable(True)
        scroll_area.setWidget(sidebar_container)
        scroll_area.setFixedWidth(250)
        scroll_area.setHorizontalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
        self.main_layout.addWidget(scroll_area)

    def handle_sidebar_click(self):
        clicked_button = self.sender()
        for button in self.button_group:
            button.setChecked(button == clicked_button)
        self.stacked_widget.setCurrentIndex(self.button_group.index(clicked_button))

    def create_main_content(self):
        self.stacked_widget = QStackedWidget()
        self.main_layout.addWidget(self.stacked_widget)
        self.stacked_widget.addWidget(self.create_home_page())
        
        for page_title in list(self.get_sidebar_options().keys())[1:]:
            self.stacked_widget.addWidget(self.create_component_page(page_title))
        
        self.settings_page = self.create_settings_page()
        self.settings_page_index = self.stacked_widget.addWidget(self.settings_page)

        self.generator_pages = {}
        page_map = {
            ("Discrete", "Discrete Narmal"): DiscreteN,
            ("Discrete", "Discrete Fillet-Shape"): DiscreteF,
            # Add more mappings as needed
        }

        for (comp_type, opt_name), PageClass in page_map.items():
            page_instance = PageClass(self)
            page_instance.generationFinalized.connect(self.on_generation_finalized)
            page_instance.set_script_paths(self.script_paths)
            self.stacked_widget.addWidget(page_instance)
            self.generator_pages[(comp_type, opt_name)] = page_instance

    def on_generation_finalized(self, payload):
        """Handle generation completion"""
        print(f"Generated footprint: {payload['data']['footprint_name']} for {payload['table_name']}")

    def get_sidebar_options(self):
        return {
            "Home": "fa5s.home",
            "Discrete": "fa5s.sliders-h",
            "Sot-23": "fa5s.microchip",
            "Sot-143": "fa5s.satellite",
            "TO Package": "fa5s.battery-half",
            "Dual Side": "fa5s.clone",
            "Dual with thermal": "fa5s.fire",
            "QF Package": "fa5s.shapes",
            "QF with thermal": "fa5s.thermometer-half",
            "QFN TWO ROW": "fa5s.border-style",
            "Connectors": "fa5s.plug",
            "Crystals": "fa5s.icicles",
            "BGA Package": "fa5s.th",
        }

    def create_home_page(self):
        page = QWidget()
        layout = QGridLayout(page)
        layout.setContentsMargins(25, 25, 25, 25)
        
        top_bar_layout = QHBoxLayout()
        title = QLabel("Dashboard")
        title.setObjectName("HomePageTitle")
        top_bar_layout.addWidget(title)
        top_bar_layout.addStretch()
        
        settings_button = QPushButton()
        settings_button.setIcon(qtawesome.icon('fa5s.cog', color='#d0d0d0'))
        settings_button.setIconSize(QSize(24, 24))
        settings_button.setFixedSize(40, 40)
        settings_button.setCursor(Qt.PointingHandCursor)
        settings_button.clicked.connect(self.go_to_settings)
        top_bar_layout.addWidget(settings_button)
        
        layout.addLayout(top_bar_layout, 0, 0, 1, 4)
        
        # License status card
        license_status = "Verified" if self.verification_data else "Not Verified"
        license_icon = "fa5s.check-circle" if self.verification_data else "fa5s.times-circle"
        card1 = self.create_dashboard_card("License Status", license_status, license_icon)
        
        # Settings status card
        precision = self.decimal_precision.get('decimal_precision', 4)
        card2 = self.create_dashboard_card("Decimal Precision", f"{precision} places", "fa5s.calculator")
        
        card3 = self.create_dashboard_card("Server Status", "Flask Integration", "fa5s.server")

        # Add animated logo and graphic animation section
        # --- Animated Frame Below Dashboard Cards ---
        animation_frame = QFrame()
        animation_frame.setObjectName("AnimationFrame")
        animation_frame.setStyleSheet("""
            #AnimationFrame {
                border-radius: 10px;
            }
        """)
        animation_layout = QVBoxLayout(animation_frame)
        animation_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)

        # Animated Logo (GIF) - must exist in your project

        self.logo_label = ScaledMovieLabel("assets/7V7.gif")  # Replace with actual path



        animation_layout.addWidget(self.logo_label)

     
        layout.addWidget(card1, 1, 0)
        layout.addWidget(card2, 1, 1)
        layout.addWidget(card3, 1, 2)
        layout.addWidget(animation_frame, 2, 0, 1, 3)
        layout.setRowStretch(2, 1)
        
        return page
    


    def create_dashboard_card(self, title_text, value_text, icon_name):
        card = QFrame()
        card.setObjectName("DashboardCard")
        card_layout = QVBoxLayout(card)
        
        title_label = QLabel(title_text)
        title_label.setStyleSheet("font-size: 11pt; color: #a0a0a0;")
        
        value_layout = QHBoxLayout()
        icon_label = QLabel()
        icon_color = '#5d9afc' if 'check' in icon_name else '#ff6b6b' if 'times' in icon_name else '#5d9afc'
        icon_label.setPixmap(qtawesome.icon(icon_name, color=icon_color).pixmap(QSize(32, 32)))
        
        value_label = QLabel(value_text)
        value_label.setStyleSheet("font-size: 20pt; font-weight: bold;")
        
        value_layout.addWidget(icon_label)
        value_layout.addWidget(value_label)
        value_layout.addStretch()
        
        card_layout.addWidget(title_label)
        card_layout.addLayout(value_layout)
        
        return card

    def create_component_page(self, component_type):
        page = QWidget()
        layout = QGridLayout(page)
        layout.setContentsMargins(25, 25, 25, 25)

        title = QLabel(f"{component_type} Footprint")
        title.setObjectName("PageTitle")
        font = title.font()
        font.setPointSize(36)
        font.setBold(True)
        title.setFont(font)
        layout.addWidget(title, 0, 0, 1, 2)
        
        image_label = QSvgWidget()
        image_label.setMinimumSize(400, 400)
        image_label.setStyleSheet("background-color:#232730; border-radius:8px;")

        default_svg = self.DEFAULT_CATEGORY_IMAGE_MAP.get(component_type)
        if default_svg:
            try:
                image_label.load(default_svg)
            except:
                pass
        
        layout.addWidget(image_label, 1, 1, 2, 1)
        layout.setColumnStretch(1, 1)
        
        options_layout = QVBoxLayout()
        options_layout.setSpacing(15)

        options = {
            "Discrete": ["Discrete Narmal", "Discrete Fillet-Shape"],
            "Sot-23": ["Narmal", "Narmal with MP Expantion", "Fillet-Shape", "Fillet with MP Expantion"],
            # Add more options as needed
        }

        component_options = options.get(component_type, ["Option A", "Option B"])
                
        for option_text in component_options:
            option_label = ClickableLabel(option_text)
            option_label.setFixedWidth(300)
            option_label.singleClicked.connect(lambda checked=True, p=default_svg: image_label.load(default_svg) if default_svg else None)
            option_label.doubleClicked.connect(lambda checked=True, c=component_type, o=option_text: self.go_to_generator(c, o))
            options_layout.addWidget(option_label)
        
        options_layout.addStretch()
        layout.addLayout(options_layout, 1, 0)
        return page
    
    def save_settings(self):
        settings_data = {
            "script_paths": self.script_paths,
            "verification_data": self.verification_data,
            "server_url": getattr(self, 'server_url_edit', QLineEdit(FLASK_BASE_URL)).text(),
            "altium_settings": self.altium_settings,
            "allegro_settings": self.allegro_settings,
            "pads_settings": self.pads_settings,
            "xpedition_settings": self.xpedition_settings
        }

        try:
            with open(SETTINGS_FILE, "w") as f:
                json.dump(settings_data, f, indent=4)
            print("Settings saved.")
        except Exception as e:
            QMessageBox.critical(self, "Save Error", f"Failed to save settings:\n{str(e)}")

    def load_settings(self):
        if os.path.exists(SETTINGS_FILE):
            try:
                with open(SETTINGS_FILE, "r") as f:
                    settings_data = json.load(f)

                # Load script paths
                if "script_paths" in settings_data and isinstance(settings_data["script_paths"], dict):
                    self.script_paths.update(settings_data["script_paths"])
                else:
                    print("No valid 'script_paths' found in settings. Using defaults.")

                # Load verification data
                self.verification_data = settings_data.get("verification_data", None)

                # Load app settings
                if "altium_settings" in settings_data and isinstance(settings_data["altium_settings"], dict):
                    self.altium_settings.update(settings_data["altium_settings"])
                else:
                    print("No valid 'altium_settings' found in settings. Using defaults.")

                if "allegro_settings" in settings_data and isinstance(settings_data["allegro_settings"], dict):
                    self.allegro_settings.update(settings_data["allegro_settings"])
                else:
                    print("No valid 'allegro_settings' found in settings. Using defaults.")

                if "pads_settings" in settings_data and isinstance(settings_data["pads_settings"], dict):
                    self.pads_settings.update(settings_data["pads_settings"])
                else:
                    print("No valid 'pads_settings' found in settings. Using defaults.")

                if "xpedition_settings" in settings_data and isinstance(settings_data["xpedition_settings"], dict):
                    self.xpedition_settings.update(settings_data["xpedition_settings"])
                else:
                    print("No valid 'xpedition_settings' found in settings. Using defaults.")

                print("Settings loaded.")
            except Exception as e:
                QMessageBox.warning(self, "Load Error", f"Failed to load settings:\n{str(e)}")
        else:
            print("Settings file not found. Using default settings.")

    def closeEvent(self, event):
        self.save_settings()
        event.accept()

    def create_settings_page(self):
        page_widget = QWidget()
        page_layout = QVBoxLayout(page_widget)
        page_layout.setContentsMargins(0, 0, 0, 0)

        scroll_area = QScrollArea()
        scroll_area.setWidgetResizable(True)
        scroll_area.setObjectName("SettingsScrollArea")
        page_layout.addWidget(scroll_area)

        container_widget = QWidget()
        scroll_area.setWidget(container_widget)
        container_layout = QVBoxLayout(container_widget)
        container_layout.setContentsMargins(25, 25, 25, 25)
        container_layout.setAlignment(Qt.AlignmentFlag.AlignTop)
        container_layout.setSpacing(20)

        title = QLabel("Settings")
        title.setObjectName("PageTitle")
        container_layout.addWidget(title)

        tab_widget = QTabWidget()
        tab_widget.addTab(self._create_default_settings_tab(), "Default")
        tab_widget.addTab(self._create_Altium_settings_tab(), "Altium")
        tab_widget.addTab(self._create_Allegro_settings_tab(), "Allegro")
        tab_widget.addTab(self._create_PADS_settings_tab(), "PADS")
        tab_widget.addTab(self._create_Xpedition_settings_tab(), "Xpedition")
        tab_widget.addTab(self._create_account_tab(), "Account")

        container_layout.addWidget(tab_widget)

        return page_widget

    def _create_default_settings_tab(self):
        tab_widget = QWidget()
        main_layout = QVBoxLayout(tab_widget)
        main_layout.setAlignment(Qt.AlignmentFlag.AlignTop)
        main_layout.setSpacing(15)
        # Decimal Precision Group
        precision_group = QGroupBox("Decimal Precision")
        precision_layout = QFormLayout(precision_group)

        self.precision_lineedit = QLineEdit()
        self.precision_lineedit.setMaxLength(1)  # Only one digit allowed
        self.precision_lineedit.setText(str(self.decimal_precision.get('decimal_precision', 3)))
        # Set validator to accept only integers from 0 to 6
        self.precision_lineedit.setValidator(QIntValidator(0, 6))

        self.precision_lineedit.textChanged.connect(self.on_precision_changed)
        precision_layout.addRow("Decimal Places:", self.precision_lineedit)

        main_layout.addWidget(precision_group)

        # Script Output Paths Group
        paths_group = QGroupBox("Script Output Paths")
        paths_layout = QGridLayout(paths_group)
        
        # Add path settings for each tool
        tool_names = ['Altium', 'Allegro', 'PADS', 'Xpedition']
        self.path_edits = {}
        
        for i, tool in enumerate(tool_names):
            tool_key = tool.lower()
            paths_layout.addWidget(QLabel(f"{tool} Script Path:"), i, 0)
            path_edit = QLineEdit(self.script_paths[tool_key])
            path_edit.setReadOnly(True)
            self.path_edits[tool_key] = path_edit
            
            browse_btn = QPushButton("Browse")
            browse_btn.clicked.connect(lambda checked, t=tool_key: self.browse_for_script_path(t))
            
            paths_layout.addWidget(path_edit, i, 1)
            paths_layout.addWidget(browse_btn, i, 2)
        
        main_layout.addWidget(paths_group)
        return tab_widget

    def _create_Altium_settings_tab(self):
        """Create Altium Designer settings tab with precision and other parameters."""
        tab_widget = QWidget()
        main_layout = QVBoxLayout(tab_widget)
        main_layout.setAlignment(Qt.AlignmentFlag.AlignTop)
        main_layout.setSpacing(15)

        header = QLabel("Altium Designer Settings")
        header.setFont(QFont("Arial", 16, QFont.Weight.Bold))
        main_layout.addWidget(header)

        # ========== Assmbly Settings ==========
        assmbly_group = QGroupBox("Assmbly Settings")
        assmbly_layout = QFormLayout(assmbly_group)

        self.altium_assmbly_lw_lineedit = QLineEdit()
        assmbly_lw_value = self.altium_settings.get('assmbly_layout_line_width', 0.1)
        self.altium_assmbly_lw_lineedit.setText(f"{assmbly_lw_value}")
        self.altium_assmbly_lw_lineedit.textEdited.connect(self.on_altiumassmbly_lw_changed)

        assmbly_layout.addRow("Assmbly Line Width:", self.altium_assmbly_lw_lineedit)
        main_layout.addWidget(assmbly_group)

        # ========== Courtyard Settings ==========
        courtyard_group = QGroupBox("Courtyard Settings")
        courtyard_layout = QFormLayout(courtyard_group)

        courtyard_exp_layout = QHBoxLayout()

        # Courtyard Expansion
        self.altium_courtyard_exp_lineedit = QLineEdit()
        courtyard_exp_value = self.altium_settings.get('courtyard_expansion', 0.25)
        self.altium_courtyard_exp_lineedit.setText(f"{courtyard_exp_value}")
        self.altium_courtyard_exp_lineedit.textEdited.connect(self.on_altiumcourtyard_exp_changed)

        courtyard_exp_layout.addWidget(QLabel("Courtyard Expansion:"))
        courtyard_exp_layout.addWidget(self.altium_courtyard_exp_lineedit)

        # Courtyard Line Width
        self.altium_courtyard_lw_lineedit = QLineEdit()
        courtyard_lw_value = self.altium_settings.get('courtyard_line_width', 0.05)
        self.altium_courtyard_lw_lineedit.setText(f"{courtyard_lw_value}")
        self.altium_courtyard_lw_lineedit.textEdited.connect(self.on_altiumcourtyard_lw_changed)

        courtyard_exp_layout.addWidget(QLabel("Courtyard Line Width (mm):"))
        courtyard_exp_layout.addWidget(self.altium_courtyard_lw_lineedit)

        # Add combined row
        courtyard_layout.addRow(courtyard_exp_layout)

        # BGA, TH Courtyard Expansion
        self.altium_BGA_TH_courtyard_exp_lineedit = QLineEdit()
        BGA_TH_exp_value = self.altium_settings.get('BGA_TH_courtyard_expansion', 0.25)
        self.altium_BGA_TH_courtyard_exp_lineedit.setText(f"{BGA_TH_exp_value}")
        self.altium_BGA_TH_courtyard_exp_lineedit.textEdited.connect(self.on_altiumBGA_THcourtyard_exp_changed)

        courtyard_layout.addRow("BGA,TH Courtyard Expansion (mm):", self.altium_BGA_TH_courtyard_exp_lineedit)

        main_layout.addWidget(courtyard_group)

        # ========== Silkscreen Settings ==========
        silkscreen_group = QGroupBox("Silkscreen Settings")
        silkscreen_layout = QHBoxLayout(silkscreen_group)

        # Silkscreen Expansion
        self.altium_silkscreen_exp_lineedit = QLineEdit()
        silkscreen_exp_value = self.altium_settings.get('silkscreen_expansion', 0.15)
        self.altium_silkscreen_exp_lineedit.setText(f"{silkscreen_exp_value}")
        self.altium_silkscreen_exp_lineedit.textEdited.connect(self.on_altiumilkscreen_exp_changed)

        silkscreen_layout.addWidget(QLabel("Silkscreen Expansion:"))
        silkscreen_layout.addWidget(self.altium_silkscreen_exp_lineedit)

        # Silkscreen Line Width
        self.altium_silkscreen_lw_lineedit = QLineEdit()
        silkscreen_lw_value = self.altium_settings.get('silkscreen_line_width', 0.15)
        self.altium_silkscreen_lw_lineedit.setText(f"{silkscreen_lw_value}")
        self.altium_silkscreen_lw_lineedit.textEdited.connect(self.on_altiumilkscreen_lw_changed)

        silkscreen_layout.addWidget(QLabel("Silkscreen Line Width (mm):"))
        silkscreen_layout.addWidget(self.altium_silkscreen_lw_lineedit)

        main_layout.addWidget(silkscreen_group)

        # ========== Reset Button ==========
        reset_button = QPushButton("Reset to Defaults")
        reset_button.clicked.connect(self.reset_altiumgeneration_settings)
        main_layout.addWidget(reset_button)

        return tab_widget



    def _create_Allegro_settings_tab(self):
        """Create Allegro settings tab with precision and other parameters."""
        tab_widget = QWidget()
        main_layout = QVBoxLayout(tab_widget)
        main_layout.setAlignment(Qt.AlignmentFlag.AlignTop)
        main_layout.setSpacing(15)

        header = QLabel("Allegro Settings")
        header.setFont(QFont("Arial", 16, QFont.Weight.Bold))
        main_layout.addWidget(header)

        # ========== Assmbly Settings ==========
        assmbly_group = QGroupBox("Assmbly Settings")
        assmbly_layout = QFormLayout(assmbly_group)

        self.allegro_assmbly_lw_lineedit = QLineEdit()
        assmbly_lw_value = self.allegro_settings.get('assmbly_layout_line_width', 0.1)
        self.allegro_assmbly_lw_lineedit.setText(f"{assmbly_lw_value}")
        self.allegro_assmbly_lw_lineedit.textEdited.connect(self.on_allegroassmbly_lw_changed)

        assmbly_layout.addRow("Assmbly Line Width:", self.allegro_assmbly_lw_lineedit)
        main_layout.addWidget(assmbly_group)

        # ========== Courtyard Settings ==========
        courtyard_group = QGroupBox("Courtyard Settings")
        courtyard_layout = QFormLayout(courtyard_group)

        courtyard_exp_layout = QHBoxLayout()

        # Courtyard Expansion
        self.allegro_courtyard_exp_lineedit = QLineEdit()
        exp_value = self.allegro_settings.get('courtyard_expansion', 0.25)
        self.allegro_courtyard_exp_lineedit.setText(f"{exp_value}")
        self.allegro_courtyard_exp_lineedit.textEdited.connect(self.on_allegrocourtyard_exp_changed)

        courtyard_exp_layout.addWidget(QLabel("Courtyard Expansion:"))
        courtyard_exp_layout.addWidget(self.allegro_courtyard_exp_lineedit)

        # Courtyard Line Width
        self.allegro_courtyard_lw_lineedit = QLineEdit()
        lw_value = self.allegro_settings.get('courtyard_line_width', 0.05)
        self.allegro_courtyard_lw_lineedit.setText(f"{lw_value}")
        self.allegro_courtyard_lw_lineedit.textEdited.connect(self.on_allegrocourtyard_lw_changed)

        courtyard_exp_layout.addWidget(QLabel("Courtyard Line Width (mm):"))
        courtyard_exp_layout.addWidget(self.allegro_courtyard_lw_lineedit)

        courtyard_layout.addRow(courtyard_exp_layout)

        # BGA, TH Courtyard Expansion
        self.allegro_BGA_TH_courtyard_exp_lineedit = QLineEdit()
        bga_th_value = self.allegro_settings.get('BGA_TH_courtyard_expansion', 0.25)
        self.allegro_BGA_TH_courtyard_exp_lineedit.setText(f"{bga_th_value}")
        self.allegro_BGA_TH_courtyard_exp_lineedit.textEdited.connect(self.on_allegroBGA_THcourtyard_exp_changed)

        courtyard_layout.addRow("BGA,TH Courtyard Expansion (mm):", self.allegro_BGA_TH_courtyard_exp_lineedit)

        main_layout.addWidget(courtyard_group)

        # ========== Silkscreen Settings ==========
        silkscreen_group = QGroupBox("Silkscreen Settings")
        silkscreen_layout = QHBoxLayout(silkscreen_group)

        self.allegro_silkscreen_exp_lineedit = QLineEdit()
        exp_val = self.allegro_settings.get('silkscreen_expansion', 0.15)
        self.allegro_silkscreen_exp_lineedit.setText(f"{exp_val}")
        self.allegro_silkscreen_exp_lineedit.textEdited.connect(self.on_allegrosilkscreen_exp_changed)

        silkscreen_layout.addWidget(QLabel("Silkscreen Expansion:"))
        silkscreen_layout.addWidget(self.allegro_silkscreen_exp_lineedit)

        self.allegro_silkscreen_lw_lineedit = QLineEdit()
        lw_val = self.allegro_settings.get('silkscreen_line_width', 0.12)
        self.allegro_silkscreen_lw_lineedit.setText(f"{lw_val}")
        self.allegro_silkscreen_lw_lineedit.textEdited.connect(self.on_allegrosilkscreen_lw_changed)

        silkscreen_layout.addWidget(QLabel("Silkscreen Line Width (mm):"))
        silkscreen_layout.addWidget(self.allegro_silkscreen_lw_lineedit)

        main_layout.addWidget(silkscreen_group)

        # ========== Reset Button ==========
        reset_button = QPushButton("Reset to Defaults")
        reset_button.clicked.connect(self.reset_allegrogeneration_settings)
        main_layout.addWidget(reset_button)

        return tab_widget

    def _create_PADS_settings_tab(self):
        """Create PADS settings tab with precision and other parameters."""
        tab_widget = QWidget()
        main_layout = QVBoxLayout(tab_widget)
        main_layout.setAlignment(Qt.AlignmentFlag.AlignTop)
        main_layout.setSpacing(15)

        header = QLabel("PADS Settings")
        header.setFont(QFont("Arial", 16, QFont.Weight.Bold))
        main_layout.addWidget(header)

        # ========== Assembly Settings ==========
        assmbly_group = QGroupBox("Assembly Settings")
        assmbly_layout = QFormLayout(assmbly_group)

        self.pads_assmbly_lw_lineedit = QLineEdit()
        assmbly_lw_value = self.pads_settings.get('assmbly_layout_line_width', 0.12)
        self.pads_assmbly_lw_lineedit.setText(f"{assmbly_lw_value}")
        self.pads_assmbly_lw_lineedit.textEdited.connect(self.on_padsassmbly_lw_changed)

        assmbly_layout.addRow("Assembly Line Width:", self.pads_assmbly_lw_lineedit)
        main_layout.addWidget(assmbly_group)

        # ========== Courtyard Settings ==========
        courtyard_group = QGroupBox("Courtyard Settings")
        courtyard_layout = QFormLayout(courtyard_group)

        courtyard_exp_layout = QHBoxLayout()

        # Courtyard Expansion
        self.pads_courtyard_exp_lineedit = QLineEdit()
        exp_value = self.pads_settings.get('courtyard_expansion', 0.25)
        self.pads_courtyard_exp_lineedit.setText(f"{exp_value}")
        self.pads_courtyard_exp_lineedit.textEdited.connect(self.on_padscourtyard_exp_changed)

        courtyard_exp_layout.addWidget(QLabel("Courtyard Expansion:"))
        courtyard_exp_layout.addWidget(self.pads_courtyard_exp_lineedit)

        # Courtyard Line Width
        self.pads_courtyard_lw_lineedit = QLineEdit()
        lw_value = self.pads_settings.get('courtyard_line_width', 0.05)
        self.pads_courtyard_lw_lineedit.setText(f"{lw_value}")
        self.pads_courtyard_lw_lineedit.textEdited.connect(self.on_padscourtyard_lw_changed)

        courtyard_exp_layout.addWidget(QLabel("Courtyard Line Width (mm):"))
        courtyard_exp_layout.addWidget(self.pads_courtyard_lw_lineedit)

        courtyard_layout.addRow(courtyard_exp_layout)

        # BGA, TH Courtyard Expansion
        self.pads_BGA_TH_courtyard_exp_lineedit = QLineEdit()
        bga_th_value = self.pads_settings.get('BGA_TH_courtyard_expansion', 0.25)
        self.pads_BGA_TH_courtyard_exp_lineedit.setText(f"{bga_th_value}")
        self.pads_BGA_TH_courtyard_exp_lineedit.textEdited.connect(self.on_padBGA_THcourtyard_exp_changed)

        courtyard_layout.addRow("BGA,TH Courtyard Expansion (mm):", self.pads_BGA_TH_courtyard_exp_lineedit)
        main_layout.addWidget(courtyard_group)

        # ========== Silkscreen Settings ==========
        silkscreen_group = QGroupBox("Silkscreen Settings")
        silkscreen_layout = QHBoxLayout(silkscreen_group)

        self.pads_silkscreen_exp_lineedit = QLineEdit()
        exp_val = self.pads_settings.get('silkscreen_expansion', 0.15)
        self.pads_silkscreen_exp_lineedit.setText(f"{exp_val}")
        self.pads_silkscreen_exp_lineedit.textEdited.connect(self.on_padssilkscreen_exp_changed)

        silkscreen_layout.addWidget(QLabel("Silkscreen Expansion:"))
        silkscreen_layout.addWidget(self.pads_silkscreen_exp_lineedit)

        self.pads_silkscreen_lw_lineedit = QLineEdit()
        lw_val = self.pads_settings.get('silkscreen_line_width', 0.12)
        self.pads_silkscreen_lw_lineedit.setText(f"{lw_val}")
        self.pads_silkscreen_lw_lineedit.textEdited.connect(self.on_padssilkscreen_lw_changed)

        silkscreen_layout.addWidget(QLabel("Silkscreen Line Width (mm):"))
        silkscreen_layout.addWidget(self.pads_silkscreen_lw_lineedit)

        main_layout.addWidget(silkscreen_group)

        # ========== Reset Button ==========
        reset_button = QPushButton("Reset to Defaults")
        reset_button.clicked.connect(self.reset_padsgeneration_settings)
        main_layout.addWidget(reset_button)

        return tab_widget

    def _create_Xpedition_settings_tab(self):
        """Create generation settings tab with precision and other parameters"""
        tab_widget = QWidget()
        main_layout = QVBoxLayout(tab_widget)
        main_layout.setAlignment(Qt.AlignmentFlag.AlignTop)
        main_layout.setSpacing(15)

        header = QLabel("Xpedition Settings")
        header.setFont(QFont("Arial", 16, QFont.Weight.Bold))
        main_layout.addWidget(header)

        # Assembly Settings Group
        assmbly_group = QGroupBox("Assembly Settings")
        assmbly_layout = QFormLayout(assmbly_group)

        self.xpedition_assmbly_lw_lineedit = QLineEdit()
        assmbly_lw_value = self.xpedition_settings.get('assmbly_layout_line_width', 0.12)
        self.xpedition_assmbly_lw_lineedit.setText(f"{assmbly_lw_value}")
        self.xpedition_assmbly_lw_lineedit.textEdited.connect(self.on_xpeditionassmbly_lw_changed)
        assmbly_layout.addRow("Assembly Line Width:", self.xpedition_assmbly_lw_lineedit)

        main_layout.addWidget(assmbly_group)

        # Courtyard Settings Group
        courtyard_group = QGroupBox("Courtyard Settings")
        courtyard_layout = QFormLayout(courtyard_group)

        courtyard_exp_layout = QHBoxLayout()

        # Courtyard Expansion
        self.xpedition_courtyard_exp_lineedit = QLineEdit()
        courtyard_exp_value = self.xpedition_settings.get('courtyard_expansion', 0.25)
        self.xpedition_courtyard_exp_lineedit.setText(f"{courtyard_exp_value}")
        self.xpedition_courtyard_exp_lineedit.textEdited.connect(self.on_xpeditioncourtyard_exp_changed)

        courtyard_exp_layout.addWidget(QLabel("Courtyard Expansion:"))
        courtyard_exp_layout.addWidget(self.xpedition_courtyard_exp_lineedit)

        # Courtyard Line Width
        self.xpedition_courtyard_lw_lineedit = QLineEdit()
        courtyard_lw_value = self.xpedition_settings.get('courtyard_line_width', 0.05)
        self.xpedition_courtyard_lw_lineedit.setText(f"{courtyard_lw_value}")
        self.xpedition_courtyard_lw_lineedit.textEdited.connect(self.on_xpeditioncourtyard_lw_changed)

        courtyard_exp_layout.addWidget(QLabel("Courtyard Line Width (mm):"))
        courtyard_exp_layout.addWidget(self.xpedition_courtyard_lw_lineedit)

        courtyard_layout.addRow(courtyard_exp_layout)

        # BGA, TH Courtyard Expansion
        self.xpedition_BGA_TH_courtyard_exp_lineedit = QLineEdit()
        bga_th_value = self.xpedition_settings.get('BGA_TH_courtyard_expansion', 0.25)
        self.xpedition_BGA_TH_courtyard_exp_lineedit.setText(f"{bga_th_value}")
        self.xpedition_BGA_TH_courtyard_exp_lineedit.textEdited.connect(self.on_xpeditionBGA_THcourtyard_exp_changed)
        courtyard_layout.addRow("BGA,TH Courtyard Expansion (mm):", self.xpedition_BGA_TH_courtyard_exp_lineedit)

        main_layout.addWidget(courtyard_group)

        # Silkscreen Settings Group
        silkscreen_group = QGroupBox("Silkscreen Settings")
        silkscreen_layout = QHBoxLayout(silkscreen_group)

        self.xpedition_silkscreen_exp_lineedit = QLineEdit()
        silkscreen_exp_value = self.xpedition_settings.get('silkscreen_expansion', 0.15)
        self.xpedition_silkscreen_exp_lineedit.setText(f"{silkscreen_exp_value}")
        self.xpedition_silkscreen_exp_lineedit.textEdited.connect(self.on_xpeditionsilkscreen_exp_changed)

        silkscreen_layout.addWidget(QLabel("Silkscreen Expansion:"))
        silkscreen_layout.addWidget(self.xpedition_silkscreen_exp_lineedit)

        self.xpedition_silkscreen_lw_lineedit = QLineEdit()
        silkscreen_lw_value = self.xpedition_settings.get('silkscreen_line_width', 0.12)
        self.xpedition_silkscreen_lw_lineedit.setText(f"{silkscreen_lw_value}")
        self.xpedition_silkscreen_lw_lineedit.textEdited.connect(self.on_xpeditionsilkscreen_lw_changed)

        silkscreen_layout.addWidget(QLabel("Silkscreen Line Width (mm):"))
        silkscreen_layout.addWidget(self.xpedition_silkscreen_lw_lineedit)

        main_layout.addWidget(silkscreen_group)

        # Reset to Defaults Button
        reset_button = QPushButton("Reset to Defaults")
        reset_button.clicked.connect(self.reset_xpeditiongeneration_settings)
        main_layout.addWidget(reset_button)

        return tab_widget

    def on_precision_changed(self, value):
        """Handle decimal precision change"""
        self.decimal_precision['decimal_precision'] = value

    def on_altiumassmbly_lw_changed(self, value):
        """Handle assmbly line width change"""
        self.altium_settings['assmbly_layout_line_width'] = value
        
    def on_altiumcourtyard_exp_changed(self, value):
        """Handle courtyard expansion change"""
        self.altium_settings['courtyard_expansion'] = value

    def on_altiumBGA_THcourtyard_exp_changed(self, value):
        """Handle courtyard expansion change"""
        self.altium_settings['BGA_TH_courtyard_expansion'] = value

    def on_altiumcourtyard_lw_changed(self, value):
        """Handle courtyard line width change"""
        self.altium_settings['courtyard_line_width'] = value

    def on_altiumilkscreen_exp_changed(self, value):
        """Handle silkscreen expansion change"""
        self.altium_settings['silkscreen_expansion'] = value
    def on_altiumilkscreen_lw_changed(self, value):
        """Handle silkscreen line width change"""
        self.altium_settings['silkscreen_line_width'] = value


    def on_allegroassmbly_lw_changed(self, value):
        """Handle assmbly line width change"""
        self.allegro_settings['assmbly_layout_line_width'] = value
    def on_allegrocourtyard_exp_changed(self, value):
        """Handle courtyard expansion change"""
        self.allegro_settings['courtyard_expansion'] = value
    def on_allegroBGA_THcourtyard_exp_changed(self, value):
        """Handle courtyard expansion change"""
        self.allegro_settings['BGA_TH_courtyard_expansion'] = value
    def on_allegrocourtyard_lw_changed(self, value):
        """Handle courtyard line width change"""
        self.allegro_settings['courtyard_line_width'] = value
    def on_allegrosilkscreen_exp_changed(self, value):
        """Handle silkscreen expansion change"""
        self.allegro_settings['silkscreen_expansion'] = value
    def on_allegrosilkscreen_lw_changed(self, value):
        """Handle silkscreen line width change"""
        self.allegro_settings['silkscreen_line_width'] = value


    def on_padsassmbly_lw_changed(self, value):
        """Handle assmbly line width change"""
        self.pads_settings['assmbly_layout_line_width'] = value
    def on_padscourtyard_exp_changed(self, value):
        """Handle courtyard expansion change"""
        self.pads_settings['courtyard_expansion'] = value
    def on_padBGA_THcourtyard_exp_changed(self, value):
        """Handle courtyard expansion change"""
        self.pads_settings['BGA_TH_courtyard_expansion'] = value
    def on_padscourtyard_lw_changed(self, value):
        """Handle courtyard line width change"""
        self.pads_settings['courtyard_line_width'] = value
    def on_padssilkscreen_exp_changed(self, value):
        """Handle silkscreen expansion change"""
        self.pads_settings['silkscreen_expansion'] = value
    def on_padssilkscreen_lw_changed(self, value):
        """Handle silkscreen line width change"""
        self.pads_settings['silkscreen_line_width'] = value


    def on_xpeditionassmbly_lw_changed(self, value):
        """Handle assmbly line width change"""
        self.xpedition_settings['assmbly_layout_line_width'] = value
    def on_xpeditioncourtyard_exp_changed(self, value):
        """Handle courtyard expansion change"""
        self.xpedition_settings['courtyard_expansion'] = value
    def on_xpeditionBGA_THcourtyard_exp_changed(self, value):
        """Handle courtyard expansion change"""
        self.xpedition_settings['BGA_TH_courtyard_expansion'] = value
    def on_xpeditioncourtyard_lw_changed(self, value):
        """Handle courtyard line width change"""
        self.xpedition_settings['courtyard_line_width'] = value
    def on_xpeditionsilkscreen_exp_changed(self, value):
        """Handle silkscreen expansion change"""
        self.xpedition_settings['silkscreen_expansion'] = value
    def on_xpeditionsilkscreen_lw_changed(self, value):
        """Handle silkscreen line width change"""
        self.xpedition_settings['silkscreen_line_width'] = value


    def reset_altiumgeneration_settings(self):
        """Reset all generation settings to defaults"""
        self.altium_settings.update(ALTIUM_SETTINGS)

    def reset_allegrogeneration_settings(self):
        """Reset allegro generation settings to defaults"""
        self.allegro_settings.update(ALLEGRO_SETTINGS)

    def reset_padsgeneration_settings(self):
        """Reset pads generation settings to defaults"""
        self.pads_settings.update(PADS_SETTINGS)

    def reset_xpeditiongeneration_settings(self):
        """Reset xpedition generation settings to defaults"""
        self.xpedition_settings.update(XPEDITION_SETTINGS)


        
        # Update UI controls
        # Decimal Precision
        self.precision_lineedit.setText(str(self.decimal_precision['decimal_precision']))

        # === Altium Settings ===
        self.altium_assmbly_lw_lineedit.setText(str(self.altium_settings['assmbly_layout_line_width']))
        self.altium_courtyard_exp_lineedit.setText(str(self.altium_settings['courtyard_expansion']))
        self.altium_courtyard_lw_lineedit.setText(str(self.altium_settings['courtyard_line_width']))
        self.altium_BGA_TH_courtyard_exp_lineedit.setText(str(self.altium_settings['BGA_TH_courtyard_expansion']))
        self.altium_silkscreen_exp_lineedit.setText(str(self.altium_settings['silkscreen_expansion']))
        self.altium_silkscreen_lw_lineedit.setText(str(self.altium_settings['silkscreen_line_width']))

        # === Allegro Settings ===
        self.allegro_assmbly_lw_lineedit.setText(str(self.allegro_settings['assmbly_layout_line_width']))
        self.allegro_courtyard_exp_lineedit.setText(str(self.allegro_settings['courtyard_expansion']))
        self.allegro_courtyard_lw_lineedit.setText(str(self.allegro_settings['courtyard_line_width']))
        self.allegro_BGA_TH_courtyard_exp_lineedit.setText(str(self.allegro_settings['BGA_TH_courtyard_expansion']))
        self.allegro_silkscreen_exp_lineedit.setText(str(self.allegro_settings['silkscreen_expansion']))
        self.allegro_silkscreen_lw_lineedit.setText(str(self.allegro_settings['silkscreen_line_width']))

        # === PADS Settings ===
        self.pads_assmbly_lw_lineedit.setText(str(self.pads_settings['assmbly_layout_line_width']))
        self.pads_courtyard_exp_lineedit.setText(str(self.pads_settings['courtyard_expansion']))
        self.pads_courtyard_lw_lineedit.setText(str(self.pads_settings['courtyard_line_width']))
        self.pads_BGA_TH_courtyard_exp_lineedit.setText(str(self.pads_settings['BGA_TH_courtyard_expansion']))
        self.pads_silkscreen_exp_lineedit.setText(str(self.pads_settings['silkscreen_expansion']))
        self.pads_silkscreen_lw_lineedit.setText(str(self.pads_settings['silkscreen_line_width']))

        # === Xpedition Settings ===
        self.xpedition_assmbly_lw_lineedit.setText(str(self.xpedition_settings['assmbly_layout_line_width']))
        self.xpedition_courtyard_exp_lineedit.setText(str(self.xpedition_settings['courtyard_expansion']))
        self.xpedition_courtyard_lw_lineedit.setText(str(self.xpedition_settings['courtyard_line_width']))
        self.xpedition_BGA_TH_courtyard_exp_lineedit.setText(str(self.xpedition_settings['BGA_TH_courtyard_expansion']))
        self.xpedition_silkscreen_exp_lineedit.setText(str(self.xpedition_settings['silkscreen_expansion']))
        self.xpedition_silkscreen_lw_lineedit.setText(str(self.xpedition_settings['silkscreen_line_width']))

        # Show success message
        QMessageBox.information(self, "Settings Reset", "All generation settings have been reset to defaults.")

    def _create_account_tab(self):
        """Create account/license verification tab"""
        tab_widget = QWidget()
        main_layout = QVBoxLayout(tab_widget)
        main_layout.setAlignment(Qt.AlignmentFlag.AlignTop)
        main_layout.setSpacing(15)

        # License Verification Group
        license_group = QGroupBox("License Verification")
        license_layout = QGridLayout(license_group)
        
        # Status
        license_layout.addWidget(QLabel("Status:"), 0, 0)
        self.license_status_label = QLabel("Not Verified")
        if self.verification_data:
            self.license_status_label.setText("Verified")
            self.license_status_label.setStyleSheet("color: green; font-weight: bold;")
        else:
            self.license_status_label.setStyleSheet("color: red; font-weight: bold;")
        license_layout.addWidget(self.license_status_label, 0, 1)
        
        # User info
        if self.verification_data:
            license_layout.addWidget(QLabel("Username:"), 1, 0)
            license_layout.addWidget(QLabel(self.verification_data.get('username', 'Unknown')), 1, 1)
            
            license_layout.addWidget(QLabel("Email:"), 2, 0)
            license_layout.addWidget(QLabel(self.verification_data.get('email', 'Unknown')), 2, 1)
            
            license_layout.addWidget(QLabel("License:"), 3, 0)
            license_layout.addWidget(QLabel(self.verification_data.get('license_number', 'Unknown')), 3, 1)
        
        # Verify/Clear buttons
        button_layout = QHBoxLayout()
        
        self.verify_button = QPushButton("Verify License")
        self.verify_button.clicked.connect(self.show_license_verification_dialog)
        button_layout.addWidget(self.verify_button)
        
        self.clear_button = QPushButton("Clear License")
        self.clear_button.clicked.connect(self.clear_license)
        self.clear_button.setEnabled(bool(self.verification_data))
        button_layout.addWidget(self.clear_button)
        
        button_layout.addStretch()
        license_layout.addLayout(button_layout, 4, 0, 1, 2)
        
        main_layout.addWidget(license_group)
        
        # Server Settings Group
        server_group = QGroupBox("Server Settings")
        server_layout = QFormLayout(server_group)
        
        self.server_url_edit = QLineEdit(FLASK_BASE_URL)
        server_layout.addRow("Flask Server URL:", self.server_url_edit)
        
        test_button = QPushButton("Test Connection")
        test_button.clicked.connect(self.test_server_connection)
        server_layout.addRow("", test_button)
        
        main_layout.addWidget(server_group)
        
        return tab_widget

    def show_license_verification_dialog(self):
        """Show license verification dialog"""
        dialog = LicenseVerificationDialog(self)
        if dialog.exec() == QDialog.Accepted:
            self.verification_data = dialog.verification_data
            self.update_license_ui()

    def clear_license(self):
        """Clear license verification"""
        self.verification_data = None
        self.update_license_ui()
        QMessageBox.information(self, "License Cleared", "License verification cleared")

    def update_license_ui(self):
        """Update license UI elements"""
        if hasattr(self, 'license_status_label'):
            if self.verification_data:
                self.license_status_label.setText("Verified")
                self.license_status_label.setStyleSheet("color: green; font-weight: bold;")
                self.verify_button.setText("Re-verify License")
                self.clear_button.setEnabled(True)
            else:
                self.license_status_label.setText("Not Verified")
                self.license_status_label.setStyleSheet("color: red; font-weight: bold;")
                self.verify_button.setText("Verify License")
                self.clear_button.setEnabled(False)

    def test_server_connection(self):
        """Test connection to Flask server"""
        server_url = self.server_url_edit.text()
        try:
            response = requests.get(f"{server_url}/api/health", timeout=5)
            if response.status_code == 200:
                QMessageBox.information(self, "Connection Test", "Successfully connected to server!")
            else:
                QMessageBox.warning(self, "Connection Test", f"Server responded with status code: {response.status_code}")
        except requests.exceptions.RequestException as e:
            QMessageBox.critical(self, "Connection Test", f"Failed to connect to server:\n{str(e)}")
        
    def go_to_generator(self, component_type, option_name):
        page_widget = self.generator_pages.get((component_type, option_name))
        if page_widget:
            page_widget.set_output_path(self.current_script_path)
            self.stacked_widget.setCurrentWidget(page_widget)
        else:
            QMessageBox.information(self, "Not Implemented", f"The generator for '{option_name}' is not yet available.")

    def go_to_settings(self):
        self.stacked_widget.setCurrentIndex(self.settings_page_index)
        for button in self.button_group:
            button.setChecked(False)

    def browse_for_script_path(self, script_type):
        """Browse for script output path for specific tool type"""
        current_path = self.script_paths.get(script_type, os.path.expanduser("~"))
        directory = QFileDialog.getExistingDirectory(
            self, f"Select {script_type.title()} Script Output Folder", current_path
        )
        if directory:
            self.script_paths[script_type] = directory
            self.path_edits[script_type].setText(directory)
            
            if script_type == 'altium':
                self.current_script_path = directory
            
            for page in self.generator_pages.values():
                page.set_script_paths(self.script_paths)
            
            QMessageBox.information(
                self, "Path Set", 
                f"{script_type.title()} script output path has been set to:\n{directory}"
            )

# --- Application Entry Point ---
if __name__ == "__main__":
    if not os.path.exists("images"):
        os.makedirs("images")
        print("Created 'images' directory. Please add placeholder SVG images for the best experience.")
    
    app = QApplication(sys.argv)
    window = MainWindow()
    window.show()
    sys.exit(app.exec())
