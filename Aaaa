


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Management Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
    <!-- Add this in the <head> section of index.html -->
    <style>
:root {
    --primary-color: #667eea;
    --secondary-color: #764ba2;
}

body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px;
}

.stat-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: transform 0.3s;
    height: 100%;
}

.stat-card:hover { 
    transform: translateY(-5px);
}

.stat-card .icon {
    width: 60px;
    height: 60px;
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    margin-bottom: 15px;
}

.stat-card h3 { 
    font-size: 2rem; font-weight: 700; margin: 10px 0; 
}

.card-custom {
    background: white;
    border-radius: 15px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.card-custom .card-header {
    background: transparent;
    border-bottom: 2px solid #f1f3f5;
    padding: 20px;
    font-weight: 600;
    font-size: 1.2rem;
}

.btn-primary-custom {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    border: none;
    border-radius: 10px;
    padding: 10px 20px;
    color: white;
    font-weight: 600;
}

.btn-primary-custom:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(95, 116, 206, 0.4);
    color: white;
}

/* Delete Button Styling - Modern & Attractive */
.btn-delete-project {
    background: white;
    border: 2px solid #dc3545;
    color: #dc3545;
    border-radius: 8px;
    font-weight: 600;
    padding: 8px 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.btn-delete-project:hover {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    color: white;
    border-color: #dc3545;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
}

.btn-delete-project:active {
    transform: translateY(0);
    box-shadow: 0 2px 6px rgba(220, 53, 69, 0.2);
}

.top-bar-custom {
    background: white;
    padding: 15px 30px;
    border-radius: 15px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #dc3545;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
}

.modal-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    border-bottom: none;
}

.modal-content {
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.modal-body {
    padding: 25px 30px;
    background: white;
}

/* Main container with top padding to accommodate parallel badge */
.progress-steps {
    position: relative;
    display: flex;
    flex-direction: row;
    margin: 30px 0;
    align-items: flex-start;
    overflow-x: auto;
    padding-bottom: 10px;
    padding-top: 40px; /* Push all content down to make room for parallel badge */
}

/* Progress line positioned at exact circle center - ENHANCED */
.progress-line {
    position: absolute;
    top: 65px; /* Align with circle centers after adjustment */
    left: 20px;
    right: 20px;
    height: 3px;
    background: linear-gradient(to right, #e9ecef 0%, #dee2e6 100%);
    z-index: 1;
    min-width: calc(100% - 40px);
    border-radius: 10px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.progress-line-fill {
    position: absolute;
    height: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    position: relative;
}

/* Add animated shimmer effect */
.progress-line-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255, 255, 255, 0.3) 50%, 
        transparent 100%);
    animation: shimmer 2s infinite;
    border-radius: 10px;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}
/* All progress steps have consistent structure */
.progress-step {
    position: relative;
    z-index: 2;
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    transition: all 0.3s;
}

.progress-step.normal-spacing {
    flex: 1;
    padding: 0 15px;
}

.progress-step.tight-spacing {
    flex: 0 0 140px;
    margin: 0 5px;
}

.progress-step.medium-spacing {
    flex: 0 0 140px;
    margin: 0 5px;
}

/* Parallel container using grid for perfect alignment */
.stage-group-container {
    display: grid;
    grid-auto-flow: column;
    grid-auto-columns: 180px;
    gap: 30px;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.12) 0%, rgba(118, 75, 162, 0.12) 100%);
    border: 2px solid #667eea;
    border-radius: 15px;
    padding: 20px 30px 40px 30px;
     margin: 0 10px;
    position: relative;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
    align-items: start;
    margin-top: 0;
}

/* Parallel badge above container */
.stage-group-container::before {
    content: 'âš¡ Parallel';
    position: absolute;
    top: -25px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 4px 16px;
    font-size: 0.7rem;
    font-weight: 700;
    border-radius: 20px;
    box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
    z-index: 10;
    white-space: nowrap;
    margin-top: 0;
    padding-top: 0;

}

/* Enhanced circle styling with status colors */
.step-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: white;
    border: 4px solid #dee2e6;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1rem;
    color: #495057;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    z-index: 3;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    flex-shrink: 0;
}

/* Status-based circle colors */
.step-circle.not-started {
    background: white;
    border-color: #dee2e6;
    color: #6c757d;
}

.step-circle.in-progress {
    background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
    border-color: #FFD700;
    color: white;
    animation: pulse 2s infinite;
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
}

.step-circle.completed {
    background: linear-gradient(135deg, #006400 0%, #228B22 100%);
    border-color: #006400;
    color: white;
    box-shadow: 0 4px 12px rgba(0, 100, 0, 0.3);
}

.step-circle.completed-rescheduled {
    background: linear-gradient(135deg, #90EE90 0%, #98FB98 100%);
    border-color: #90EE90;
    color: #006400;
    box-shadow: 0 4px 12px rgba(144, 238, 144, 0.3);
}

.step-circle.overdue {
    background: linear-gradient(135deg, #FF6B6B 0%, #EE5A6F 100%);
    border-color: #FF6B6B;
    color: white;
    animation: shake 0.5s infinite;
    box-shadow: 0 0 20px rgba(255, 107, 107, 0.5);
}

/* Legacy active class for backward compatibility */
.step-circle.active {
    background: #17a2b8;
    border-color: #17a2b8;
    color: white;
    box-shadow: 0 0 0 4px rgba(23,162,184,0.2);
}

/* Hover effect for circles - shows they're interactive */
.step-circle[style*="cursor: pointer"]:hover {
    transform: scale(1.1);
    transition: transform 0.2s ease;
    filter: brightness(1.1);
}

/* Pulse animation for in-progress */
@keyframes pulse {
    0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
    }
    50% {
        transform: scale(1.05);
        box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
    }
}

/* Shake animation for overdue */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-2px); }
    75% { transform: translateX(2px); }
}

/* Status badge on circle */
.step-circle::after {
    content: '';
    position: absolute;
    top: -5px;
    right: -5px;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    border: 2px solid white;
    display: none;
}

.step-circle.completed::after,
.step-circle.completed-rescheduled::after {
    content: 'âœ“';
    display: flex;
    align-items: center;
    justify-content: center;
    background: #28a745;
    color: white;
    font-size: 10px;
    font-weight: bold;
}

.step-circle.completed-rescheduled::after {
    content: 'â†»';
    background: #90EE90;
    color: #006400;
}


/* Label styling with consistent spacing */
.step-label {
    margin-top: 10px;
    padding: 8px 12px;
    background: white;
    border-radius: 8px;
    font-size: 0.75rem;
    font-weight: 600;
    text-align: center;
    max-width: 140px;
    min-width: 100px;
    word-wrap: break-word;
    line-height: 1.3;
    display: flex;
    flex-direction: column; /* Stack name and badge vertically */
    gap: 4px;
}

.step-label.completed {
    background: linear-gradient(135deg, #e8eef9 0%, #f0e8f5 100%);
    color: #667eea;
}

.step-label.active {
    background: #17a2b8;
    color: white;
}

.duration-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2px 6px;
    border-radius: 8px;
    font-size: 0.6rem;
    font-weight: 600;
    align-self: center; /* Center the badge */
    margin: 0; /* Remove margin */
}

/* Date text styling */
.progress-step small {
    display: block;
    margin-top: 8px;
    font-size: 0.65rem;
    line-height: 1.4;
    text-align: center;
    white-space: normal;
    max-width: 120px;
    color: #6c757d;
    background: rgba(255, 255, 255, 0.9);
    padding: 3px 6px;
    border-radius: 4px;
}

/* Parallel stage specific styling */
.stage-group-container .progress-step {
    display: grid;
    grid-template-rows: auto auto auto; /* circle, label, dates in exact rows */
    justify-items: center;
    gap: 10px;
}

.stage-group-container .step-circle {
    grid-row: 1; /* Force circle to first row */
    margin: 0;
}

.stage-group-container .step-label {
    grid-row: 2; /* Force label to second row */
    margin: 0;
}

.stage-group-container small {
    grid-row: 3; /* Force dates to third row */
    font-size: 0.65rem;
    padding: 3px 6px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 4px;
}
    /* ===== CALENDAR MODAL ===== */
    .calendar-modal .modal-dialog {
        max-width: 1200px;
        width: 95%;
        margin: 1.75rem auto;
    }

    .calendar-modal .modal-content {
        border-radius: 15px;
    }

    #calendar {
        width: 100%;
        min-height: 450px;
    }

    .fc {
        font-family: inherit !important;
        font-size: 0.75rem;
        background: white;
        border-radius: 10px;
        padding: 10px;
    }

    .fc-toolbar-title {
        font-size: 1rem !important;
        font-weight: 700 !important;
    }

    .fc-button {
        padding: 5px 10px !important;
        font-size: 0.75rem !important;
        border-radius: 6px !important;
    }

    .fc-event {
        padding: 2px 4px;
        margin: 1px;
        font-size: 0.7rem;
        border-radius: 4px;
    }

    /* ===== LEGEND ===== */
    .calendar-legend {
        background: transparent;
        padding: 0;
    }

    .legend-item {
        padding: 6px 8px;
        margin-bottom: 4px;
        background: #f8f9fa;
        border-radius: 6px;
        font-size: 0.7rem;
        border-left: 3px solid;
        transition: all 0.2s;
    }

    .legend-item:hover {
        background: #e9ecef;
        transform: translateX(2px);
    }

/* ================================================
   CLEAN PROFESSIONAL CALENDAR DESIGN
   Optimized for Clarity and Readability
   
   âœ… IMPROVEMENTS APPLIED (v2.1 - Final Optimization):
   - Day cell height: 110px (optimal for 7-8 stages)
   - Event height: 24px for clearer text
   - Font size: 0.74rem with better line-height
   - Hover tooltip: Full stage names visible on hover
   - Better spacing: Optimized margins between stages
   - Duration badges: Larger and better positioned
   - Event limit: Shows up to 8 events before "+more" link
   - Text overflow: Smart ellipsis with full text on hover
   - Enhanced shadows and borders for better depth
   - Improved mobile responsiveness (80px cells)
   ================================================ */

/* ===== CALENDAR CONTAINER ===== */
#calendar {
    background: white;
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    max-width: 100%;
}

/* ===== CALENDAR HEADER ===== */
.fc-header-toolbar {
    padding-bottom: 12px !important;
    margin-bottom: 12px !important;
    border-bottom: 2px solid #f0f0f0 !important;
}

.fc-toolbar-title {
    font-size: 1.2rem !important;
    font-weight: 700 !important;
    color: #2c3e50 !important;
    letter-spacing: -0.5px !important;
}

/* ===== CALENDAR BUTTONS ===== */
.fc-button {
    padding: 8px 16px !important;
    font-size: 0.85rem !important;
    font-weight: 600 !important;
    border-radius: 8px !important;
    border: none !important;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
    transition: all 0.3s ease !important;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3) !important;
}

.fc-button:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 16px rgba(102, 126, 234, 0.5) !important;
}

.fc-button:active,
.fc-button:focus {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%) !important;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4) !important;
}

.fc-button-active {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%) !important;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.2) !important;
}

.fc-prev-button,
.fc-next-button {
    padding: 8px 12px !important;
    font-size: 1.1rem !important;
}

.fc-today-button {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
}

.fc-today-button:hover {
    background: linear-gradient(135deg, #218838 0%, #1ba881 100%) !important;
}

/* ===== DAY HEADERS ===== */
.fc-col-header-cell {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
    border-color: #dee2e6 !important;
    padding: 8px 4px !important;
}

.fc-col-header-cell-cushion {
    color: #495057 !important;
    font-weight: 700 !important;
    font-size: 0.75rem !important;
    text-transform: uppercase !important;
    letter-spacing: 0.5px !important;
}

/* ===== CALENDAR GRID ===== */
.fc-daygrid-day {
    border-color: #e9ecef !important;
    transition: background 0.2s ease !important;
}

.fc-daygrid-day:hover {
    background: rgba(102, 126, 234, 0.02) !important;
}

.fc-daygrid-day-number {
    color: #495057 !important;
    font-weight: 600 !important;
    font-size: 0.8rem !important;
    padding: 4px !important;
}

.fc-day-today {
    background: rgba(102, 126, 234, 0.05) !important;
}

.fc-day-today .fc-daygrid-day-number {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
    border-radius: 50% !important;
    width: 26px !important;
    height: 26px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-weight: 700 !important;
}

/* ===== WEEKEND STYLING ===== */
.fc-day-sun {
    background: linear-gradient(135deg, #fff5f5 0%, #ffe9e9 100%) !important;
}

.fc-day-sat {
    background: linear-gradient(135deg, #fffbf0 0%, #fff3d9 100%) !important;
}

/* ===== DAY CELLS - OPTIMIZED VERTICAL SPACE ===== */
.fc-daygrid-day-frame {
    min-height: 180px !important; /* Increased from 110px to accommodate more parallel events */
    padding: 2px !important;
}

/* Force events to render within their start date's cell */
.fc-daygrid-event {
    position: relative !important;
}

/* Prevent FullCalendar from pushing events to wrong week rows */
.fc-daygrid-body {
    position: relative !important;
}

.fc-daygrid-body .fc-row {
    position: relative !important;
    overflow: visible !important;
    min-height: 180px !important;
}

/* Ensure event stacking happens within the correct day cell */
.fc-daygrid-day-events {
    margin-top: 2px !important;
    position: relative !important;
    min-height: 150px !important; /* Room for all parallel events */
}

.fc-daygrid-event-harness {
    margin-bottom: 1px !important;
}

/* ================================================
   EVENT STYLING - CLEAN & COMPACT
   ================================================ */

.fc-event {
    padding: 3px 8px !important;
    margin: 1px 0px !important;
    font-size: 0.74rem !important;
    font-weight: 600 !important;
    border-radius: 5px !important;
    border: none !important;
    border-left: 3px solid rgba(0,0,0,0.3) !important;
    line-height: 1.5 !important;
    min-height: 24px !important;
    max-height: 24px !important;
    overflow: hidden !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12) !important;
    background: linear-gradient(135deg, var(--event-color) 0%, var(--event-color) 100%) !important;
    position: relative !important;
}

.fc-event:hover {
    transform: translateY(-1px) !important;
    box-shadow: 0 3px 8px rgba(0,0,0,0.15) !important;
    z-index: 100 !important;
    max-height: auto !important;
    min-height: 24px !important;
    overflow: visible !important;
}

/* Better text handling - NO CUTOFF */
.fc-event-main {
    overflow: hidden !important;
    padding-right: 22px !important;
}

.fc-event-title {
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    white-space: nowrap !important;
    display: block !important;
    font-weight: 700 !important;
    color: white !important;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3) !important;
    font-size: 0.74rem !important;
    padding-right: 2px !important;
}

/* Show full text on hover */
.fc-event:hover .fc-event-title {
    white-space: normal !important;
    overflow: visible !important;
}

.fc-event-title-container {
    overflow: hidden !important;
}

/* ===== TOOLTIP EFFECT FOR FULL TEXT ===== */
.fc-event:hover {
    z-index: 1000 !important;
    white-space: normal !important;
}

.fc-event:hover .fc-event-main {
    overflow: visible !important;
    background: inherit !important;
    padding-right: 22px !important;
}

.fc-event:hover .fc-event-title-container {
    overflow: visible !important;
    background: inherit !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2) !important;
    border-radius: 5px !important;
    padding: 2px !important;
}

/* ===== DURATION BADGE - COMPACT ===== */
.parallel-stage-indicator {
    position: absolute !important;
    top: 3px !important;
    right: 4px !important;
    background: rgba(255, 255, 255, 0.95) !important;
    color: #333 !important;
    border-radius: 10px !important;
    padding: 1px 5px !important;
    font-size: 0.64rem !important;
    font-weight: 700 !important;
    z-index: 10 !important;
    border: 1px solid rgba(0,0,0,0.15) !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12) !important;
    line-height: 1.4 !important;
    letter-spacing: 0.2px !important;
}

.fc-event.event-completed .parallel-stage-indicator {
    right: auto !important;
    left: 3px !important;
}

/* ===== COMPLETION INDICATOR - COMPACT ===== */
.fc-event.event-completed::after {
    content: 'âœ“';
    position: absolute !important;
    top: 2px !important;
    right: 3px !important;
    width: 15px !important;
    height: 15px !important;
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
    color: white !important;
    border-radius: 50% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-size: 9px !important;
    font-weight: 700 !important;
    z-index: 15 !important;
    box-shadow: 0 1px 4px rgba(40, 167, 69, 0.4) !important;
    border: 1.5px solid white !important;
}

.fc-event.event-completed {
    opacity: 0.92 !important;
    border-left-color: #28a745 !important;
}

/* ===== RESCHEDULE INDICATOR - COMPACT ===== */
.fc-event.event-rescheduled::before {
    content: 'â†»';
    position: absolute;
    top: 2px;
    left: 3px;
    width: 15px;
    height: 15px;
    background: linear-gradient(135deg, #ff9800 0%, #ff6f00 100%);
    border-radius: 50%;
    z-index: 15;
    box-shadow: 0 1px 4px rgba(255, 152, 0, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 10px;
    font-weight: 700;
    border: 1.5px solid white;
    animation: gentle-pulse 2.5s infinite;
}

@keyframes gentle-pulse {
    0%, 100% {
        transform: scale(1);
        box-shadow: 0 1px 4px rgba(255, 152, 0, 0.4);
    }
    50% {
        transform: scale(1.06);
        box-shadow: 0 2px 6px rgba(255, 152, 0, 0.5);
    }
}

.fc-event.event-rescheduled {
    border-left-color: #ff9800 !important;
    padding-left: 24px !important;
}

/* ===== STAGE RESCHEDULED - SUBTLE ===== */
.fc-event.stage-rescheduled {
    border-left-width: 3px !important;
    border-left-color: #17a2b8 !important;
}

.fc-event.stage-rescheduled::after {
    content: 'âŸ²';
    position: absolute;
    bottom: 2px;
    right: 3px;
    font-size: 10px;
    color: rgba(255,255,255,0.9);
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    z-index: 5;
}

.fc-event.event-completed.stage-rescheduled::after {
    content: 'âœ“';
    bottom: auto;
    top: 2px;
    right: 3px;
}

/* ===== PARALLEL JOBS COUNTER - COMPACT ===== */
.parallel-jobs-badge {
    position: absolute !important;
    top: 2px !important;
    right: 3px !important;
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
    color: white !important;
    border-radius: 8px !important;
    padding: 0px 5px !important;
    font-size: 0.62rem !important;
    font-weight: 700 !important;
    z-index: 999 !important;
    border: 1.5px solid white !important;
    box-shadow: 0 1px 4px rgba(220, 53, 69, 0.4) !important;
    pointer-events: none !important;
    display: block !important;
    line-height: 1.3 !important;
    letter-spacing: 0.2px !important;
}

/* ===== ACTIVE STAGE ===== */
.fc-event.stage-event-active {
    box-shadow: 0 0 0 2px #ffc107, 0 2px 8px rgba(255, 193, 7, 0.3) !important;
    animation: active-glow 2s infinite !important;
}

@keyframes active-glow {
    0%, 100% {
        box-shadow: 0 0 0 2px #ffc107, 0 2px 8px rgba(255, 193, 7, 0.3);
    }
    50% {
        box-shadow: 0 0 0 3px #ffc107, 0 3px 12px rgba(255, 193, 7, 0.5);
    }
}

/* ===== GHOST EVENTS ===== */
/* Ghost Event - striped and transparent */
.ghost-event {
    opacity: 0.55 !important;
    background-image: repeating-linear-gradient(
        45deg,
        rgba(255,255,255,0.2),
        rgba(255,255,255,0.2) 10px,
        transparent 10px,
        transparent 20px
    ) !important;
    border: 2px dashed rgba(0,0,0,0.3) !important;
    color: #333 !important;
}

/* Hold Event - Bright Red */
.event-hold {
    background-color: #dc3545 !important;
    border-color: #bd2130 !important;
    opacity: 0.9 !important;
    box-shadow: 0 2px 5px rgba(220, 53, 69, 0.4) !important;
}

/* Ensure Parallel Badges don't block clicks */
.parallel-badge-container {
    pointer-events: none;
}



.fc-event.ghost-event:hover {
    opacity: 0.7 !important;
}

/* ================================================
   TOOLTIPS - PROFESSIONAL
   ================================================ */

.fc-event {
    position: relative !important;
}

.fc-event[data-tooltip]:hover::after {
    content: attr(data-tooltip);
    position: fixed !important;
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    color: white;
    padding: 12px 16px;
    border-radius: 8px;
    white-space: pre-line;
    font-size: 0.75rem;
    line-height: 1.6;
    z-index: 999999 !important;
    box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    min-width: 180px;
    max-width: 300px;
    pointer-events: none;
    display: block !important;
    animation: tooltipSlideIn 0.2s ease-out;
    border: 2px solid rgba(255,255,255,0.1);
    font-weight: 500;
}

@keyframes tooltipSlideIn {
    from {
        opacity: 0;
        transform: translate(-50%, -90%) scale(0.96);
    }
    to {
        opacity: 1;
        transform: translate(-50%, -100%) scale(1);
    }
}

.fc-event.ghost-event[data-tooltip]:hover::after {
    background: linear-gradient(135deg, #ff9800 0%, #ff6f00 100%) !important;
}

/* Ensure calendar containers don't clip tooltips */
.calendar-modal .modal-body,
#calendar, 
.fc, 
.fc-view-harness,
.fc-daygrid-body, 
.fc-scrollgrid,
.fc-scrollgrid-sync-table {
    overflow: visible !important;
}

/* ===== MORE EVENTS LINK STYLING ===== */
.fc-daygrid-more-link {
    color: #667eea !important;
    font-weight: 600 !important;
    font-size: 0.7rem !important;
    padding: 2px 6px !important;
    background: rgba(102, 126, 234, 0.1) !important;
    border-radius: 4px !important;
    margin-top: 2px !important;
    display: inline-block !important;
}

.fc-daygrid-more-link:hover {
    background: rgba(102, 126, 234, 0.2) !important;
    text-decoration: none !important;
}

/* Ensure popover shows all events properly */
.fc-more-popover {
    z-index: 10000 !important;
    box-shadow: 0 4px 16px rgba(0,0,0,0.15) !important;
    border-radius: 8px !important;
}

.fc-more-popover .fc-popover-body {
    max-height: 400px !important;
    overflow-y: auto !important;
}

/* ================================================
   LEGEND - CLEAN & ORGANIZED
   ================================================ */

.calendar-legend {
    background: #f8f9fa;
    padding: 14px;
    border-radius: 10px;
    max-height: 500px;
    overflow-y: auto;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.calendar-legend h6 {
    font-size: 0.85rem;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.legend-item {
    padding: 8px 10px;
    margin-bottom: 5px;
    background: white;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 500;
    border-left: 3px solid;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.legend-item:hover {
    background: #fff;
    transform: translateX(3px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

/* ===== SCROLLBAR ===== */
.calendar-legend::-webkit-scrollbar {
    width: 6px;
}

.calendar-legend::-webkit-scrollbar-track {
    background: #e9ecef;
    border-radius: 10px;
}

.calendar-legend::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 10px;
}

.calendar-legend::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
}

/* ================================================
   RESPONSIVE DESIGN
   ================================================ */

@media (max-width: 768px) {
    .fc-toolbar-title {
        font-size: 1rem !important;
    }
    
    .fc-button {
        padding: 5px 10px !important;
        font-size: 0.7rem !important;
    }
    
    .fc-daygrid-day-frame {
        min-height: 80px !important;
    }
    
    .fc-event {
        font-size: 0.68rem !important;
        padding: 2px 6px !important;
        min-height: 20px !important;
        max-height: 20px !important;
    }
    
    .fc-event-title {
        font-size: 0.68rem !important;
    }
    
    .parallel-stage-indicator {
        font-size: 0.55rem !important;
        padding: 0px 3px !important;
    }
    
    .fc-daygrid-day-number {
        font-size: 0.7rem !important;
        padding: 3px !important;
    }
    
    #calendar {
        padding: 8px;
    }
}

/* ================================================
   END OF CLEAN PROFESSIONAL CALENDAR DESIGN
   ================================================ */


/* ===== DAY RESCHEDULE BUTTON ===== */
.day-reschedule-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 0.65rem;
    cursor: pointer;
    z-index: 150;
    transition: all 0.3s;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

.fc-daygrid-day:hover .day-reschedule-btn {
    display: flex;
}

.day-reschedule-btn:hover {
    transform: scale(1.15);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
}

/* ===== MINI RESCHEDULE POPUP ===== */
.mini-reschedule-popup {
    position: fixed;
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    padding: 15px;
    z-index: 9999;
    min-width: 280px;
    display: none;
    border: 2px solid #667eea;
}

.mini-reschedule-popup.active {
    display: block;
    animation: popIn 0.3s ease-out;
}

@keyframes popIn {
    from {
        opacity: 0;
        transform: scale(0.8) translateY(-20px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.mini-reschedule-popup h6 {
    margin: 0 0 10px 0;
    color: #667eea;
    font-weight: 700;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.mini-reschedule-popup .stage-chip {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 6px 10px;
    margin: 4px 0;
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: all 0.2s;
    border: 2px solid transparent;
}

.mini-reschedule-popup .stage-chip:hover {
    border-color: #667eea;
    background: #e8eef9;
}

/* ===== DAILY TASK MODAL ===== */
.daily-task-item {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 15px;
    transition: all 0.3s;
    border: 2px solid transparent;
}

.daily-task-item:hover {
    border-color: #667eea;
    background: #e8eef9;
}

.daily-task-item.completed {
    opacity: 0.7;
    background: #e8f5e9;
    border-left: 4px solid #10b981;
}

.daily-task-item.rescheduled {
    border-left: 4px solid #f59e0b;
    background: #fffbeb;
}

.task-day-number {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.1rem;
}

.task-day-number.completed {
    background: #28a745;
}

.task-status-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

.badge-pending {
    background: #6c757d;
    color: white;
}

.badge-completed {
    background: #28a745;
    color: white;
}

.badge-rescheduled {
    background: #ffc107;
    color: #000;
}

/* ===== ANIMATIONS ===== */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ===== RESPONSIVE ===== */
@media (max-width: 992px) {
    .calendar-legend {
        max-height: 250px;  /* Changed from 300px */
    }
    
    .fc {
        font-size: 0.7rem;
        padding: 8px;
    }
    
    #calendar {
        min-height: 400px;
    }
}

/* ===== SCROLLBAR ===== */
.calendar-legend::-webkit-scrollbar {
    width: 6px;
}

.calendar-legend::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.calendar-legend::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 10px;
}
/* Ghost Events - Show original locations */
/* Unified Ghost Event Styling */
.fc-event.ghost-event {
    opacity: 0.6 !important;
    background-image: repeating-linear-gradient(
        45deg,
        rgba(255, 255, 255, 0.8),
        rgba(255, 255, 255, 0.8) 8px,
        rgba(220, 53, 69, 0.15) 8px,
        rgba(220, 53, 69, 0.15) 16px
    ) !important;
    border: 2px dashed #ff9800 !important;
    color: #333 !important;
    cursor: help !important;
}

/* Ensure the text inside ghost events is readable */
.fc-event.ghost-event .fc-event-title {
    color: #d35400 !important; 
    font-style: italic;
    text-decoration: line-through;
}
.fc-event.ghost-event .fc-event-main {
    color: #ff9800 !important;
    font-weight: 600 !important;
    text-decoration: line-through !important;
}
.fc-event.ghost-event::before {
    display: none !important;
}
/* Date cell reschedule indicator */
.date-reschedule-badge {
    position: absolute;
    bottom: 3px;
    left: 3px;
    background: #ff9800;
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: bold;
    z-index: 100;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* Enhanced tooltip for ghost events */


.fc-event.ghost-event::after {
    content: 'MOVED';
    position: absolute !important;
    top: 2px !important;
    right: 2px !important;
    background: #ff9800 !important;
    color: white !important;
    border-radius: 4px !important;
    padding: 2px 5px !important;
    font-size: 8px !important;
    font-weight: bold !important;
    z-index: 999 !important;
    display: block !important;
}


/* Enhanced reschedule indicator */
.reschedule-indicator {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-10px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.daily-task-item.rescheduled {
    border-left: 4px solid #ff9800 !important;
    background: linear-gradient(135deg, #fffbf0 0%, #fff8e8 100%) !important;
}

.daily-task-item {
    transition: all 0.3s ease;
}

.task-info {
    min-width: 0; /* Allow flex shrinking */
}

.card.mb-2 {
    border-radius: 12px !important;
    border: 2px solid #e9ecef !important;
    transition: all 0.3s ease;
    background: white !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.card.mb-2:hover {
    border-color: #667eea !important;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    transform: translateY(-2px);
}
.card.mb-2[style*="border-left: 3px solid rgb(102, 126, 234)"] {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.03) 0%, rgba(118, 75, 162, 0.03) 100%) !important;
}
/* ===== FORM CONTROLS - BETTER STYLING ===== */
.modal-body .form-control,
.modal-body .form-select {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    transition: all 0.3s ease;
    background: white;
}

.modal-body .form-control:focus,
.modal-body .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.modal-body .form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
}

/* ===== STAGE CONTAINER - BETTER SCROLLBAR ===== */
#stagesContainer {
    background: white;
    border-radius: 12px;
    padding: 15px;
    max-height: 50vh;
    overflow-y: auto;
}

#stagesContainer::-webkit-scrollbar {
    width: 8px;
}

#stagesContainer::-webkit-scrollbar-track {
    background: #f1f3f5;
    border-radius: 10px;
}

#stagesContainer::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 10px;
}

/* ===== CHECKBOX STYLING ===== */
.form-check-input {
    width: 20px;
    height: 20px;
    border: 2px solid #dee2e6;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.form-check-input:checked {
    background-color: #667eea;
    border-color: #667eea;
}

.form-check-input:focus {
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.25);
}

/* ===== PROJECTED END DATE - ENHANCED ===== */
.alert-info {
    background: linear-gradient(135deg, #e8f4fd 0%, #f3e8fd 100%) !important;
    border: 2px solid #667eea !important;
    border-radius: 12px !important;
    color: #495057 !important;
}

/* ===== MANAGER DROPDOWN - BETTER VISIBILITY ===== */
.form-select {
    font-weight: 500;
    color: #495057;
}

.form-select option {
    padding: 10px;
}

/* ===== DELETE BUTTON - SUBTLE ===== */
.btn-outline-danger {
    border-radius: 8px !important;
    opacity: 0.7;
    transition: all 0.2s ease;
}

.btn-outline-danger:hover {
    opacity: 1;
    transform: scale(1.05);
}

/* ===== ADD CUSTOM / RESET BUTTONS ===== */
.btn-success, .btn-outline-secondary {
    border-radius: 8px !important;
    font-weight: 600 !important;
    transition: all 0.2s ease !important;
}

.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
}

/* ===== CREATE JOB BUTTON - ENHANCED ===== */
.btn-primary-custom.w-100 {
    padding: 15px !important;
    font-size: 1.1rem !important;
    border-radius: 12px !important;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.btn-primary-custom.w-100:hover {
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    transform: translateY(-2px);
}

/* ===== MODAL BACKDROP - BETTER BLUR ===== */
.modal-backdrop {
    backdrop-filter: blur(3px);
}

/* ===== RESPONSIVE ADJUSTMENTS ===== */
@media (max-width: 768px) {
    .modal-body {
        padding: 15px;
    }
    
    .card.mb-2 .card-body {
        padding: 12px !important;
    }
}

/* ===== STAGE CONTENT OPACITY FIX ===== */
#stageContent-1, #stageContent-2, #stageContent-3,
#stageContent-4, #stageContent-5, #stageContent-6,
#stageContent-7, #stageContent-8, #stageContent-9,
#stageContent-10, #stageContent-11, #stageContent-12,
#stageContent-13, #stageContent-14 {
    transition: opacity 0.3s ease;
}

/* Small, subtle duration badges */
.duration-badge {
    background: #667eea;
    color: white;
    padding: 1px 5px; /* Smaller padding */
    border-radius: 6px; /* Smaller radius */
    font-size: 0.55rem; /* Smaller font */
    margin-left: 4px;
    font-weight: 600;
    vertical-align: middle;
    display: inline-block;
}

/* For parallel stages - even smaller */
.stage-group-container .duration-badge {
    font-size: 0.5rem;
    padding: 1px 4px;
    
}/* ===== WORKING DAYS BADGE ===== */
span[style*="background: rgb(102, 126, 234)"] {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    border-radius: 8px !important;
    padding: 4px 10px !important;
    font-size: 0.7rem !important;
    font-weight: 700 !important;
}
/* Hide ALL number badges in calendar */
.fc-daygrid-day-bottom {
    display: none !important;
}

.date-reschedule-badge,
.parallel-jobs-badge {
    display: none !important;
}
/* Search and Filter Bar */
.search-filter-bar {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 10px;
}

.search-box {
    position: relative;
    margin-bottom: 12px;
}

.search-icon {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
    font-size: 1rem;
    z-index: 1;
}

.search-input {
    width: 100%;
    padding: 12px 45px 12px 45px;
    border: 2px solid #dee2e6;
    border-radius: 10px;
    font-size: 0.95rem;
    transition: all 0.3s;
}

.search-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.clear-search {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    border: none;
    color: #6c757d;
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 5px;
    transition: all 0.2s;
}

.clear-search:hover {
    background: #e9ecef;
    color: #dc3545;
}

.filter-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}

.filter-select {
    padding: 8px 12px;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    font-size: 0.85rem;
    background: white;
    cursor: pointer;
    transition: all 0.3s;
}

.filter-select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.results-count {
    margin-left: auto;
    font-size: 0.85rem;
    color: #6c757d;
    font-weight: 600;
}

/* Pagination */
.pagination-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-top: 20px;
    padding: 15px;
}

.pagination-btn {
    padding: 8px 16px;
    border: 2px solid #667eea;
    background: white;
    color: #667eea;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.pagination-btn:hover:not(:disabled) {
    background: #667eea;
    color: white;
    transform: translateY(-2px);
}

.pagination-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

.pagination-info {
    font-size: 0.9rem;
    color: #495057;
    font-weight: 600;
}

/* Loading Spinner */
.loading-spinner {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 40px;
}

.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* No Results */
.no-results {
    text-align: center;
    padding: 60px 20px;
}

.no-results i {
    font-size: 4rem;
    color: #dee2e6;
    margin-bottom: 20px;
}

.no-results h5 {
    color: #6c757d;
    margin-bottom: 10px;
}

.no-results p {
    color: #adb5bd;
    font-size: 0.9rem;
}
/* Fix projects section scroll */
#allProjectsSection {
    overflow: visible !important;
    max-height: none !important;
}

/* Improve card layout */
.project-progress-container {
    margin-bottom: 30px;
    padding: 25px;
    background: #f8f9fa;
    border-radius: 15px;
    overflow: visible !important;
}

/* Better spacing for the entire projects card */
.card-custom .card-body {
    padding: 20px;
    overflow: visible !important;
}
/* HOLD Event Styling */
.fc-event.event-hold {
    background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%) !important;
    border-left: 4px solid #990000 !important;
    opacity: 0.85;
}

.fc-event.event-hold::before {
    content: 'ðŸ”’';
    position: absolute;
    top: 2px;
    left: 2px;
    font-size: 14px;
    z-index: 10;
}

.fc-event.event-hold .fc-event-title {
    font-weight: bold;
    text-decoration: line-through;
}
</style>
</head>
<body>
    <div class="container-fluid" style="max-width: 1400px;">
        <div class="top-bar-custom d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-0">Welcome, {{ current_user.username }}!</h4>
                <small class="text-muted">Have a productive day</small>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="position-relative">
                    <button class="btn btn-link text-dark" onclick="toggleNotifications()">
                        <i class="fas fa-bell fa-lg"></i>
                        <span class="notification-badge" id="notifBadge">0</span>
                    </button>
                </div>
                <a href="/logout" class="btn btn-outline-danger">
                    <i class="fas fa-sign-out-alt me-2"></i> Logout
                </a>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <i class="fas fa-briefcase"></i>
                    </div>
                    <p>Total Jobs</p>
                    <h3 id="totalProjects">0</h3>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="icon" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <p>Active Jobs</p>
                    <h3 id="activeProjects">0</h3>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="icon" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: white;">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <p>Total Tasks</p>
                    <h3 id="totalTasks">0</h3>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="icon" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white;">
                        <i class="fas fa-users"></i>
                    </div>
                    <p>Team Members</p>
                    <h3 id="totalEmployees">0</h3>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card-custom">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>All Jobs</span>
                        <button class="btn btn-sm btn-primary-custom" onclick="openProjectModal()">
                            <i class="fas fa-plus me-1"></i> New Job
                        </button>
                    </div>
                    
                    <!-- Search and Filter Bar -->
                    <div class="search-filter-bar">
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" 
                                id="projectSearchInput" 
                                class="search-input" 
                                placeholder="Search by job number, name, or date..."
                                oninput="handleProjectSearch()">
                            <button class="clear-search" id="clearSearchBtn" onclick="clearProjectSearch()" style="display: none;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="filter-controls">
                            <select id="statusFilter" class="filter-select" onchange="handleProjectSearch()">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="completed">Completed</option>
                            </select>
                            
                            <select id="sortBy" class="filter-select" onchange="handleProjectSearch()">
                                <option value="newest">Newest First</option>
                                <option value="oldest">Oldest First</option>
                                <option value="name">Name (A-Z)</option>
                                <option value="progress">Progress</option>
                            </select>
                            
                            <span class="results-count" id="resultsCount">Showing 0 jobs</span>
                        </div>
                    </div>
                </div>                   
                 <div class="card-body">
                        <!-- Helpful Hint Banner -->
                        <div id="allProjectsSection"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<div class="modal fade" id="projectModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
    <div class="modal-content">            
    <div class="modal-header">                
    <h5 class="modal-title">Create New Job</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
             <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">            
                <form id="projectForm">
            <div class="row">
                <!-- Left Column -->
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Job Number</label>
                        <input type="text" class="form-control form-control-sm" id="projectName" required placeholder="Enter job number">
                    </div>
                    <!-- REMOVED DESCRIPTION FIELD -->
                    <div class="mb-3">
                        <label class="form-label">Start Date</label>
                        <input type="date" class="form-control form-control-sm" id="projectStartDate" required onchange="updateProjectEndDate()">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Team Members</label>
                        <select class="form-select form-select-sm" id="memberSelect" onchange="addMember()">
                            <option value="">Select member to add...</option>
                        </select>
                        <div id="selectedMembers" class="mt-2"></div>
                    </div>
                    <div class="alert alert-info py-2 mb-0">
                        <small>
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>Projected End Date:</strong> <span id="projectedEndDate">Not calculated</span>
                        </small>
                    </div>
                </div>
                
                <!-- Right Column -->
                <div class="col-md-6">
                    <div class="mb-2">
                        <label class="form-label d-flex justify-content-between align-items-center mb-2">
                            <span>Tasks</span>
                            <div>
                                <button type="button" class="btn btn-sm btn-success py-1 px-2 me-1" onclick="addCustomTask()" style="font-size: 0.75rem;">
                                    <i class="fas fa-plus"></i> Add Custom
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary py-1 px-2" onclick="loadDefaultStages()" style="font-size: 0.75rem;">
                                    <i class="fas fa-redo"></i> Reset
                                </button>
                            </div>
                        </label>
                        <div id="stagesContainer" style="max-height: 50vh; overflow-y: auto; padding-right: 5px;"></div>
                    </div>
                </div>
            </div>
             <div class="mt-3">
            <button type="submit" class="btn btn-primary-custom w-100">Create Job</button>
        </div>
    </form>
 </div>       
 </div>
</div>
</div>
<!-- Task Popup Modal (ADD THIS IF YOU DON'T HAVE IT) -->
     <div id="taskPopup" style="display: none;">
        <div class="popup-overlay" onclick="closePopup()"></div>
        <div class="popup-container">
            <div id="popupContent"></div>
        </div>
    </div>
<div class="modal fade calendar-modal" id="calendarModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title mb-1" id="calendarProjectTitle">Job Calendar View</h5>
                    <small class="text-white-50" id="calendarProjectDates"></small>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <div class="row g-2">
                    <!-- Calendar Section - Full Width -->
                    <div class="col-12">
                        <div style="background: white; padding: 10px; border-radius: 10px;">
                            <div id="calendar"></div>
                        </div>
                    </div>
                    
                    <!-- Compact Legend Below Calendar -->
                    <div class="col-12">
                        <div class="d-flex gap-2 flex-wrap">
                            <!-- Stages Legend - Compact Horizontal -->
                            <div class="flex-grow-1" style="background: white; padding: 10px; border-radius: 10px;">
                                <h6 style="font-size: 0.8rem; margin-bottom: 8px; font-weight: 700;">
                                    <i class="fas fa-palette me-1"></i>Stages
                                </h6>
                                <div id="calendarLegend" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 6px; max-height: 150px; overflow-y: auto;"></div>
                            </div>
                            
                            <!-- Status Indicators - Compact -->
                            <div style="background: white; padding: 10px; border-radius: 10px; min-width: 200px;">
                                <h6 style="font-size: 0.8rem; margin-bottom: 8px; font-weight: 700;">
                                    <i class="fas fa-info-circle me-1"></i>Legend
                                </h6>
                                <div style="font-size: 0.7rem; line-height: 1.5;">
                                    <div style="margin-bottom: 4px;">
                                        <span style="display: inline-block; width: 8px; height: 8px; background: #dc3545; border-radius: 2px; margin-right: 4px;"></span>
                                        Parallel
                                    </div>
                                    <div style="margin-bottom: 4px;">
                                        <span style="display: inline-block; width: 8px; height: 8px; background: #ffc107; border-radius: 2px; margin-right: 4px;"></span>
                                        Active
                                    </div>
                                    <div style="margin-bottom: 4px;">
                                        <span style="display: inline-block; width: 8px; height: 8px; background: #28a745; border-radius: 2px; margin-right: 4px;"></span>
                                        Done
                                    </div>
                                    <div>
                                        <span style="display: inline-block; width: 8px; height: 8px; background: #ff9800; border-radius: 2px; margin-right: 4px;"></span>
                                        Moved
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Mini Reschedule Popup -->
<div class="mini-reschedule-popup" id="miniReschedulePopup">
    <h6>
        <span><i class="fas fa-calendar-alt me-2"></i>Stages on <span id="popupDate"></span></span>
        <button class="close-popup" onclick="closeMiniPopup()">âœ–</button>
    </h6>
    <div id="popupStagesList"></div>
</div>
<!-- Compact Reschedule Modal -->
<div class="modal fade reschedule-modal-compact" id="rescheduleModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-white">
                    <i class="fas fa-calendar-plus me-2"></i>Reschedule Stage
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Stage Info Card -->
                <div class="card mb-3" style="background: linear-gradient(135deg, #f5f7fa 0%, #e8eef9 100%);">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-start">
                            <div class="flex-grow-1">
                                <div class="mb-2">
                                    <strong style="color: #667eea; font-size: 1.1rem;" id="rescheduleStageInfo"></strong>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted">Current:</small><br>
                                    <span id="rescheduleCurrentDates" class="badge bg-dark"></span>
                                </div>
                                <div id="rescheduleNewDatesPreview" style="display: none;">
                                    <small class="text-muted">New:</small><br>
                                    <span id="rescheduleNewDatesValue" class="badge bg-success"></span>
                                </div>
                            </div>
                            <div id="rescheduleStageColor" style="width: 40px; height: 40px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Reschedule Form -->
                <form id="rescheduleForm">
                    <div class="mb-3">
                        <label class="form-label fw-bold" style="font-size: 0.9rem;">
                            <i class="fas fa-arrows-alt-h me-2"></i>Shift by days
                        </label>
                        <div class="input-group">
                            <button class="btn btn-outline-secondary" type="button" onclick="adjustRescheduleDays(-1)">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" class="form-control text-center fw-bold" id="rescheduleDays" required 
                                   placeholder="0" style="font-size: 1.1rem;" oninput="updateReschedulePreview()">
                            <button class="btn btn-outline-secondary" type="button" onclick="adjustRescheduleDays(1)">
                                <i class="fas fa-plus"></i>
                            </button>
                            <span class="input-group-text">days</span>
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-lightbulb me-1"></i>
                            Positive = forward, Negative = backward
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold" style="font-size: 0.9rem;">
                            <i class="fas fa-comment-dots me-2"></i>Reason (optional)
                        </label>
                        <textarea class="form-control" id="rescheduleReason" rows="2" 
                                  placeholder="e.g., Resource availability..."></textarea>
                    </div>
                    
                    <!-- Impact Warning -->
                    <div class="alert alert-warning py-2" id="rescheduleImpactWarning" style="display: none; font-size: 0.85rem;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="rescheduleImpactText"></span>
                    </div>
                    
                    <input type="hidden" id="rescheduleProjectId">
                    <input type="hidden" id="rescheduleStageId">
                    <input type="hidden" id="rescheduleStageStartDate">
                    <input type="hidden" id="rescheduleStageEndDate">
                    
                <div class="d-grid gap-2">
                    <button class="btn btn-primary-custom" onclick="confirmDayReschedule()">
                        <i class="fas fa-check-circle me-2"></i>Confirm Reschedule
                    </button>
                    <button class="btn btn-warning" onclick="holdDayTask()">
                        <i class="fas fa-lock me-2"></i>Put on Hold
                    </button>
                    <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>               
            </div>
        </div>
    </div>
</div>
<!-- Daily Task Management Modal -->
<div class="modal fade" id="dailyTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title text-white" id="dailyTaskModalTitle">Manage Daily Tasks</h5>
                    <small class="text-white-50" id="dailyTaskStageName"></small>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="dailyTasksList"></div>
            </div>
        </div>
    </div>
</div>

<!-- Reschedule Single Day Modal -->
<div class="modal fade" id="rescheduleDayModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-white">Reschedule Day</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" id="dayRescheduleInfo"></div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Shift by working days:</label>
                    <div class="input-group">
                        <button class="btn btn-outline-secondary" type="button" onclick="adjustDayShift(-1)">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" class="form-control text-center fw-bold" id="dayShiftAmount" value="0">
                        <button class="btn btn-outline-secondary" type="button" onclick="adjustDayShift(1)">
                            <i class="fas fa-plus"></i>
                        </button>
                        <span class="input-group-text">days</span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Reason:</label>
                    <textarea class="form-control" id="dayRescheduleReason" rows="2" placeholder="Why is this day being rescheduled?"></textarea>
                </div>
                
                <div id="dayReschedulePreview" style="display: none;" class="alert alert-success"></div>
                
                <input type="hidden" id="rescheduleTaskId">
                <input type="hidden" id="rescheduleTaskProjectId">
                <input type="hidden" id="rescheduleTaskStageId">
                
                <div class="d-grid gap-2">
                    <button class="btn btn-primary-custom" onclick="confirmDayReschedule()">
                        <i class="fas fa-check-circle me-2"></i>Confirm Reschedule
                    </button>
                    <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>  


<!-- Add this right before the opening <script> tag -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
<script>
    let projects = [];
    let employees = [];
    let projectModal;
    let stageCounter = 0;
    let selectedMembers = [];
    let defaultStages = [];
    let calendar;
    let calendarModal;
    let rescheduleModal;
    let currentProjectForCalendar = null;
    let currentProjectData = null;
    let includeSaturdayAsWorkingDay = false;
    let workingSaturdays = new Set();
    let dailyTaskModal;
    
    // âœ… ADD DEBOUNCE TO PREVENT DOUBLE-CLICK ISSUES
    let lastClickTime = 0;
    const CLICK_DEBOUNCE = 300; // milliseconds
    let rescheduleDayModal;
    let currentStageForDailyTasks = null; // Track individual working Saturdays
    let allProjectsCache = [];
    let filteredProjects = [];
    let currentPage = 1;
    const projectsPerPage = 10;
    let searchTimeout = null;    
    const STAGE_COLORS = [
        '#667eea', '#764ba2', '#f093fb', '#4facfe', 
        '#43e97b', '#fa709a', '#fee140', '#30cfd0', 
        '#a8edea', '#ff6a88', '#feca57', '#48dbfb'
    ];

    // Add this near the top of your script section
    async function handleApiResponse(response) {
        if (response.status === 401) {
            alert('Your session has expired. Please log in again.');
            window.location.href = '/login';
            throw new Error('Session expired');
        }
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return response.json();
    }    

    document.addEventListener('DOMContentLoaded', function() {
        projectModal = new bootstrap.Modal(document.getElementById('projectModal'));
        calendarModal = new bootstrap.Modal(document.getElementById('calendarModal'));
        rescheduleModal = new bootstrap.Modal(document.getElementById('rescheduleModal'));
        
        // Reset form when modal is hidden
        document.getElementById('projectModal').addEventListener('hidden.bs.modal', function() {
            console.log('Modal hidden - resetting form');
            resetProjectForm();
            
            // âœ… ADD THIS - Extra cleanup
            setTimeout(() => {
                window.originalProjectData = null;
                currentProjectData = null;
                isEditMode = false;
                editingProjectId = null;
            }, 100);
        });        
        // Clean up calendar when calendar modal is closed
        document.getElementById('calendarModal').addEventListener('hidden.bs.modal', function() {
            console.log('Calendar modal hidden - cleaning up');
            if (calendar) {
                calendar.destroy();
                calendar = null;
                console.log('âœ… Calendar destroyed on modal close');
            }
            // Clear current project data
            currentProjectData = null;
            currentProjectForCalendar = null;
            // Stop auto-refresh
            stopAllProgressLineAutoRefresh();
        });
        
        document.getElementById('projectForm').addEventListener('submit', handleProjectSubmit);
        document.getElementById('rescheduleForm').addEventListener('submit', handleReschedule);
        
        // Add event listener for start date change
        document.getElementById('projectStartDate').addEventListener('change', checkStartDateWeekend);
        document.getElementById('projectStartDate').valueAsDate = new Date();
        dailyTaskModal = new bootstrap.Modal(document.getElementById('dailyTaskModal'));
        rescheduleDayModal = new bootstrap.Modal(document.getElementById('rescheduleDayModal'));
        
        const saturdayCheckbox = document.getElementById('includeSaturday');
        if (saturdayCheckbox) {
            saturdayCheckbox.addEventListener('change', (e) => {
                includeSaturdayAsWorkingDay = e.target.checked;
                updateProjectEndDate();
                if (currentProjectForCalendar && calendar) {
                    openCalendarView(currentProjectForCalendar);
                }
                loadProjects();
            });
        }
        
        // âœ… ADD EVENT DELEGATION FOR CIRCLE CLICKS (LEFT AND RIGHT CLICK)
            document.addEventListener('click', function(e) {
                const circle = e.target.closest('.step-circle');
                if (circle) {
                    e.stopPropagation();
                    
                    const now = Date.now();
                    const timeSinceLastClick = now - lastClickTime;
                    
                    // Detect double-click (within 400ms)
                    if (timeSinceLastClick < 400) {
                        console.log('ðŸ”„ Double-click detected - undoing last action');
                        const step = circle.closest('.progress-step');
                        if (step) {
                            const projectId = step.dataset.projectId;
                            const stageId = step.dataset.stageId;
                            const currentStatus = step.dataset.stageStatus;
                            
                            if (projectId && stageId && currentStatus !== 'pending') {
                                const prevStatus = currentStatus === 'completed' ? 'in-progress' : 'pending';
                                undoStageStatus(parseInt(projectId), parseInt(stageId), prevStatus);
                            }
                        }
                        lastClickTime = 0; // Reset to prevent triple-click issues
                        return;
                    }
                    
                    lastClickTime = now;
                    
                    const step = circle.closest('.progress-step');
                    if (step) {
                        const projectId = step.dataset.projectId;
                        const stageId = step.dataset.stageId;
                        const currentStatus = step.dataset.stageStatus;
                        
                        if (projectId && stageId && currentStatus) {
                            updateStageStatus(parseInt(projectId), parseInt(stageId), currentStatus);
                        }
                    }
                }
            });        
        // âœ… ADD EVENT DELEGATION FOR RIGHT-CLICK (UNDO)
        document.addEventListener('contextmenu', function(e) {
            const circle = e.target.closest('.step-circle');
            if (circle) {
                e.preventDefault();
                e.stopPropagation();
                
                const step = circle.closest('.progress-step');
                if (step) {
                    const projectId = step.dataset.projectId;
                    const stageId = step.dataset.stageId;
                    const currentStatus = step.dataset.stageStatus;
                    
                    if (projectId && stageId && currentStatus) {
                        if (currentStatus !== 'pending') {
                            const prevStatus = currentStatus === 'completed' ? 'in-progress' : 'pending';
                            undoStageStatus(parseInt(projectId), parseInt(stageId), prevStatus);
                        } else {
                            showNotification('Already at initial status', 'info');
                        }
                    }
                }
            }
        });
        
        init();
    });

    // NEW FUNCTION: Check if start date is weekend
    function checkStartDateWeekend() {
        const startDateInput = document.getElementById('projectStartDate');
        if (!startDateInput.value) return;
        
        const selectedDate = new Date(startDateInput.value);
        const dayOfWeek = selectedDate.getDay();
        
        // Check if Sunday (0)
                if (dayOfWeek === 0) {
            showPopup(
                'Ã¢Å¡ Ã¯Â¸Â Sunday is a Holiday',                       
                'The selected start date falls on Sunday, which is a holiday. Please select a working day (Monday-Friday).',
                        [
                            {
                                text: 'Choose Another Date',
                                className: 'btn-primary',
                                onClick: () => {
                                    startDateInput.value = '';
                                    startDateInput.focus();
                                    closePopup();
                                }
                            }
                        ]
                    );
                    return;
                }        
        // Check if Saturday (6)
        if (dayOfWeek === 6) {
            const dateStr = selectedDate.toISOString().split('T')[0];
            
        showPopup(
                'Ã°Å¸â€œâ€¦ Saturday Detected',
                `The selected start date is Saturday (${selectedDate.toLocaleDateString()}). Do you want to consider this Saturday as a working day?`,
                [
                    {
                        text: '\u2714 Yes, Working Day',
                        className: 'btn-success',
                        onClick: () => {
                            workingSaturdays.add(dateStr);
                            updateProjectEndDate();
                            closePopup();
                            showNotification('Saturday marked as working day', 'success');
                        }
                    },               
                       {
                        text: '\u274C No, Holiday',
                        className: 'btn-secondary',
                        onClick: () => {
                            workingSaturdays.delete(dateStr);
                            // Move to next Monday
                            const nextMonday = new Date(selectedDate);
                            nextMonday.setDate(nextMonday.getDate() + 2);
                            startDateInput.valueAsDate = nextMonday;
                            updateProjectEndDate();
                            closePopup();
                            showNotification('Start date moved to Monday', 'info');
                        }
                    }              
                ]
            );
        }
    }

    // NEW FUNCTION: Show popup dialog
    function showPopup(title, message, buttons) {
        const popup = document.getElementById('taskPopup');
        const content = document.getElementById('popupContent');
        
        const buttonsHtml = buttons.map((btn, index) => 
            `<button class="btn ${btn.className}" id="popupBtn${index}">${btn.text}</button>`
        ).join('');
        
        content.innerHTML = `
            <h5 style="margin-bottom: 15px; color: #667eea;">${title}</h5>
            <p style="margin-bottom: 20px; line-height: 1.6;">${message}</p>
            <div class="popup-buttons">
                ${buttonsHtml}
            </div>
        `;
        
        // Attach click handlers after rendering
        buttons.forEach((btn, index) => {
            document.getElementById(`popupBtn${index}`).onclick = btn.onClick;
        });
        
        popup.style.display = 'block';
    }

    // NEW FUNCTION: Close popup
    function closePopup() {
        document.getElementById('taskPopup').style.display = 'none';
    }

    // UPDATED FUNCTION: Calculate working days excluding weekends
    function addWorkingDays(startDate, days) {
        if (days === 0) return startDate;
        
        let currentDate = new Date(startDate);
        let direction = days > 0 ? 1 : -1;
        let daysRemaining = Math.abs(days);
        
        while (daysRemaining > 0) {
            currentDate.setDate(currentDate.getDate() + direction);
            
            const dayOfWeek = currentDate.getDay();
            const dateStr = currentDate.toISOString().split('T')[0];
            
            // Skip Sundays (0)
            if (dayOfWeek === 0) continue;
            
            // For Saturdays (6), check if it's a working Saturday
            if (dayOfWeek === 6) {
                if (workingSaturdays.has(dateStr) || includeSaturdayAsWorkingDay) {
                    daysRemaining--;
                }
                continue;
            }
            
            // Monday-Friday are working days
            daysRemaining--;
        }
        
        return currentDate;
    }

    // UPDATED FUNCTION: Get next working day
    function getNextWorkingDay(date) {
        let checkDate = new Date(date);
        
        while (true) {
            const dayOfWeek = checkDate.getDay();
            const dateStr = checkDate.toISOString().split('T')[0];
            
            // Sunday - skip
            if (dayOfWeek === 0) {
                checkDate.setDate(checkDate.getDate() + 1);
                continue;
            }
            
            // Saturday - check if working
            if (dayOfWeek === 6) {
                if (workingSaturdays.has(dateStr) || includeSaturdayAsWorkingDay) {
                    return checkDate;
                }
                checkDate.setDate(checkDate.getDate() + 1);
                continue;
            }
            
            // Monday-Friday
            return checkDate;
        }
    }

    async function init() {
        await loadDefaultStagesFromAPI();
        await loadEmployees();
        await loadStats();
        await loadProjects();
    }

    async function loadDefaultStagesFromAPI() {
        const response = await fetch('/api/default-stages');
        defaultStages = await response.json();
    }

    function loadDefaultStages() {
            document.getElementById('stagesContainer').innerHTML = '';
            stageCounter = 0;
            defaultStages.forEach(stage => addTaskCheckbox(stage.name, stage.duration_days, true));
            updateProjectEndDate();
        }

        function addTaskCheckbox(name, duration, isChecked = false, managerId = null) {
            stageCounter++;
            const html = `
                <div class="card mb-2" id="stage-${stageCounter}" style="background: #f8f9fa; border-left: 3px solid ${isChecked ? '#667eea' : '#dee2e6'};">
                    <div class="card-body p-2">
                        <div class="d-flex align-items-start gap-2">
                            <input type="checkbox" class="form-check-input mt-1" id="stageCheck-${stageCounter}" 
                                ${isChecked ? 'checked' : ''} onchange="toggleStageSelection(${stageCounter})" 
                                style="width: 18px; height: 18px; cursor: pointer;">
                            <div class="flex-grow-1" id="stageContent-${stageCounter}" style="opacity: ${isChecked ? '1' : '0.5'};">
                                <div class="mb-2">
                                    <strong style="color: #495057; font-size: 0.85rem;">${name}</strong>
                                    <input type="hidden" id="stageName-${stageCounter}" value="${name}">
                                </div>
                                <div class="row mb-2">
                                    <div class="col-4">
                                        <label class="form-label mb-1" style="font-size: 0.75rem;">Duration (days):</label>
                                        <input type="number" class="form-control form-control-sm" placeholder="Days" 
                                            id="stageDuration-${stageCounter}" min="1" value="${duration}" 
                                            onchange="updateProjectEndDate()" style="font-size: 0.85rem;" ${!isChecked ? 'disabled' : ''}>
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label mb-1" style="font-size: 0.75rem;">Manager:</label>
                                        <select class="form-select form-select-sm" id="stageManager-${stageCounter}" 
                                            style="font-size: 0.85rem;" ${!isChecked ? 'disabled' : ''}>
                                            <option value="">Select Manager...</option>
                                        </select>
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label mb-1" style="font-size: 0.75rem;">Custom Start:</label>
                                        <input type="date" class="form-control form-control-sm" 
                                            id="stageStartDate-${stageCounter}" 
                                            data-is-custom="false"
                                            onchange="this.setAttribute('data-is-custom','true'); updateProjectEndDate();" style="font-size: 0.85rem;" ${!isChecked ? 'disabled' : ''}>
                                    </div>
                                </div>
                                <div>
                                    <small class="text-muted" style="font-size: 0.65rem;">
                                        <i class="fas fa-calendar me-1"></i>
                                        <span id="stagePreview-${stageCounter}">Calculating...</span>
                                    </small>
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger py-0 px-1" onclick="removeStage(${stageCounter})" 
                                    style="font-size: 0.7rem; ${isChecked ? 'display: none;' : ''}" id="deleteBtn-${stageCounter}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('stagesContainer').insertAdjacentHTML('beforeend', html);
            
            // Populate manager dropdown
            populateManagerDropdown(stageCounter, managerId);
        }

        function populateManagerDropdown(stageId, selectedManagerId = null) {
            const managerSelect = document.getElementById(`stageManager-${stageId}`);
            if (!managerSelect) return;
            
            managerSelect.innerHTML = '<option value="">Select Manager...</option>' + 
                employees.map(e => `<option value="${e.id}" ${e.id === selectedManagerId ? 'selected' : ''}>${e.username}</option>`).join('');
        }

        function toggleStageSelection(id) {
            const checkbox = document.getElementById(`stageCheck-${id}`);
            const content = document.getElementById(`stageContent-${id}`);
            const card = document.getElementById(`stage-${id}`);
            const durationInput = document.getElementById(`stageDuration-${id}`);
            const managerSelect = document.getElementById(`stageManager-${id}`);  // ADD THIS
            const startDateInput = document.getElementById(`stageStartDate-${id}`);
            const deleteBtn = document.getElementById(`deleteBtn-${id}`);
            
            if (checkbox.checked) {
                content.style.opacity = '1';
                card.style.borderLeftColor = '#667eea';
                durationInput.disabled = false;
                managerSelect.disabled = false;  // ADD THIS
                startDateInput.disabled = false;
                if (deleteBtn) deleteBtn.style.display = 'none';
            } else {
                content.style.opacity = '0.5';
                card.style.borderLeftColor = '#dee2e6';
                durationInput.disabled = true;
                managerSelect.disabled = true;  // ADD THIS
                startDateInput.disabled = true;
                if (deleteBtn) deleteBtn.style.display = 'block';
            }
            
            updateProjectEndDate();
        }

        function addCustomTask() {
            const taskName = prompt('Enter custom task name:');
            if (!taskName || taskName.trim() === '') return;
            
            const duration = prompt('Enter duration in days:', '1');
            if (!duration || isNaN(duration) || parseInt(duration) < 1) return;
            
            addTaskCheckbox(taskName.trim(), parseInt(duration), true);
            updateProjectEndDate();
            showNotification('Custom task added!', 'success');
        }

        function addStageWithData(name, duration) {
            addTaskCheckbox(name, duration, true);
        }
        function removeStage(id) {
            document.getElementById(`stage-${id}`)?.remove();
            updateProjectEndDate();
        }

    // UPDATED FUNCTION: Update project end date with working days calculation
    function updateProjectEndDate() {
        const startDateInput = document.getElementById('projectStartDate');
        if (!startDateInput.value) return;
        
        const projectStartDate = new Date(startDateInput.value);
        let currentDate = getNextWorkingDay(projectStartDate);
        const stageElements = document.querySelectorAll('[id^="stage-"]');
        
        const stageDates = [];
        
        stageElements.forEach((element, idx) => {
            const id = element.id.split('-')[1];
            const checkbox = document.getElementById(`stageCheck-${id}`);
            
            // Skip unchecked tasks
            if (!checkbox || !checkbox.checked) return;
            
            const duration = parseInt(document.getElementById(`stageDuration-${id}`)?.value) || 1;
            const customStartDateInput = document.getElementById(`stageStartDate-${id}`);
            const customStartDate = customStartDateInput?.value;
            const isCustom = customStartDateInput?.getAttribute('data-is-custom') === 'true';
            
            let stageStart;
            if (customStartDate && isCustom) {
                stageStart = getNextWorkingDay(new Date(customStartDate));
            } else {
                stageStart = new Date(currentDate);
            }
            
            // Calculate end date using working days
            const stageEnd = addWorkingDays(stageStart, duration - 1);
            
            stageDates.push({ 
                id: id,
                index: idx,
                start: stageStart, 
                end: stageEnd,
                hasCustomDate: !!(customStartDate && isCustom),
                duration: duration
            });
            
            // Always advance so subsequent sequential stages chain correctly
            currentDate = addWorkingDays(stageEnd, 1);
        });
        
        // Detect overlapping stages
        const overlapGroups = [];
        stageDates.forEach((stage, idx) => {
            const overlappingIndices = [idx];
            
            stageDates.forEach((otherStage, otherIdx) => {
                if (idx === otherIdx) return;
                const hasOverlap = (stage.start <= otherStage.end && stage.end >= otherStage.start);
                if (hasOverlap && !overlappingIndices.includes(otherIdx)) {
                    overlappingIndices.push(otherIdx);
                }
            });
            
            if (overlappingIndices.length > 1) {
                overlappingIndices.sort((a, b) => a - b);
                const groupExists = overlapGroups.some(group => 
                    JSON.stringify(group.stages.sort()) === JSON.stringify(overlappingIndices.sort())
                );
                if (!groupExists) {
                    overlapGroups.push({ stages: overlappingIndices });
                }
            }
        });
    
    // Update previews
    stageDates.forEach((stageData, idx) => {
        const preview = document.getElementById(`stagePreview-${stageData.id}`);
        if (!preview) return;
        
        let previewHTML = `${stageData.start.toLocaleDateString()} - ${stageData.end.toLocaleDateString()}`;
        previewHTML += ` <span class="duration-badge">${stageData.duration} working days</span>`;
        
        if (stageData.hasCustomDate) {
            previewHTML += ' <span class="badge bg-primary" style="font-size: 0.65rem;">Custom</span>';
        }
        
        const overlapGroup = overlapGroups.find(group => group.stages.includes(idx));
        if (overlapGroup) {
            const position = overlapGroup.stages.indexOf(idx) + 1;
            const total = overlapGroup.stages.length;
            previewHTML += ` <span class="badge bg-warning" style="font-size: 0.65rem;">Overlap ${position}/${total}</span>`;
        }
        
        preview.innerHTML = previewHTML;
    });
    
    // Update projected end date with proper messaging
    if (stageDates.length > 0) {
        const latestEndDate = stageDates.reduce((latest, stage) => {
            return stage.end > latest ? stage.end : latest;
        }, stageDates[0].end);
        
        document.getElementById('projectedEndDate').textContent = latestEndDate.toLocaleDateString();
    } else {
        document.getElementById('projectedEndDate').textContent = 'No tasks selected';
    }
}
    function addMember() {
        const select = document.getElementById('memberSelect');
        const memberId = parseInt(select.value);
        if (!memberId || selectedMembers.includes(memberId)) return;
        selectedMembers.push(memberId);
        renderSelectedMembers();
        select.value = '';
    }

    function removeMember(memberId) {
        selectedMembers = selectedMembers.filter(id => id !== memberId);
        renderSelectedMembers();
    }

    function renderSelectedMembers() {
        const container = document.getElementById('selectedMembers');
        container.innerHTML = selectedMembers.map(memberId => {
            const member = employees.find(e => e.id === memberId);
            return `<div class="member-chip"><i class="fas fa-user-circle me-1"></i>${member.username}<i class="fas fa-times" onclick="removeMember(${memberId})"></i></div>`;
        }).join('');
    }

    async function loadStats() {
        const response = await fetch('/api/stats');
        const data = await response.json();
        document.getElementById('totalProjects').textContent = data.total_projects;
        document.getElementById('activeProjects').textContent = data.active_projects;
        document.getElementById('totalTasks').textContent = data.total_tasks;
        document.getElementById('totalEmployees').textContent = data.total_employees;
    }

async function loadProjects() {
    try {
        console.log('ðŸ“¦ Loading projects...');
        const response = await fetch(`/api/projects?_t=${Date.now()}`, {
            cache: 'no-store',
            headers: {'Cache-Control': 'no-cache'}
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        projects = await response.json();
        console.log('ðŸ“¦ Projects loaded:', projects.length, projects);
        
        if (projects.length === 0) {
            const container = document.getElementById('allProjectsSection');
            container.innerHTML = '<p class="text-muted text-center py-4">No jobs yet. Create your first job!</p>';
            return;
        }
        
        // Fetch details for each project
        const projectsWithDetails = await Promise.all(
            projects.map(async (project) => {
                try {
                    console.log(`ðŸ“‹ Fetching details for project ${project.id}: "${project.name}"...`);
                    const detailsResponse = await fetch(`/api/projects/${project.id}/details?_t=${Date.now()}`, {
                        cache: 'no-store',
                        headers: {'Cache-Control': 'no-cache'}
                    });
                    
                    if (!detailsResponse.ok) {
                        console.error(`âŒ Failed to fetch details for project ${project.id}`);
                        return null;
                    }
                    
                    const details = await detailsResponse.json();
                    console.log(`âœ… Details loaded for project ${project.id}:`, {
                        name: details.name,
                        stages: details.stages.length,
                        stagesData: details.stages
                    });
                    return details;
                } catch (error) {
                    console.error(`âŒ Error fetching project ${project.id}:`, error);
                    return null;
                }
            })
        );
        
        // Filter out null values
        const validProjects = projectsWithDetails.filter(p => p !== null);
        console.log('âœ… Valid projects to render:', validProjects.length);
        
        if (validProjects.length === 0) {
            const container = document.getElementById('allProjectsSection');
            container.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Jobs exist but couldn't load details. Please refresh the page.
                </div>
            `;
            return;
        }
        
        // Force clear and re-render
        const container = document.getElementById('allProjectsSection');
        container.innerHTML = '';
        renderProjectsWithStages(validProjects);
    } catch (error) {
        console.error('Error loading projects:', error);
        const container = document.getElementById('allProjectsSection');
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error loading jobs: ${error.message}
                <button class="btn btn-sm btn-outline-danger ms-3" onclick="loadProjects()">
                    <i class="fas fa-redo me-1"></i> Retry
                </button>
            </div>
        `;
    }
}    

function renderProjectsWithStages(projectsData) {
        const container = document.getElementById('allProjectsSection');
        
        if (!projectsData.length) {
            container.innerHTML = '<p class="text-muted text-center py-4">No jobs yet. Create your first job!</p>';
            return;
        }
            
        container.innerHTML = '';
        
        container.innerHTML = projectsData.map(project => {
            const stages = project.stages || [];
            const totalStages = stages.length;
            const completedStages = stages.filter(s => s.status === 'completed').length;
            const progress = totalStages > 0 ? Math.round((completedStages / totalStages) * 100) : 0;
            
            console.log(`ðŸŽ¨ Rendering project "${project.name}" with ${stages.length} stages`);
            
            // ==========================================
            // âœ… Group stages by parallel_group_id (from database) with fallback to start dates
            // ==========================================
            const stageGroupMap = new Map();
            const parallelGroups = new Map();
            
            // First, try to use parallel_group_id from database
            let hasParallelGroupIds = false;
            stages.forEach((stage, idx) => {
                if (stage.parallel_group_id) {
                    hasParallelGroupIds = true;
                    if (!parallelGroups.has(stage.parallel_group_id)) {
                        parallelGroups.set(stage.parallel_group_id, []);
                    }
                    parallelGroups.get(stage.parallel_group_id).push(idx);
                    console.log(`  âœ… Stage ${idx} "${stage.name}" parallel_group_id: ${stage.parallel_group_id}`);
                }
            });
            
            // If no parallel_group_id found, fall back to start_date grouping
            if (!hasParallelGroupIds) {
                console.log(`  âš ï¸ No parallel_group_id found, falling back to start_date grouping`);
                const startDateGroups = new Map();
                stages.forEach((stage, idx) => {
                    if (stage.start_date) {
                        const startDateKey = stage.start_date;
                        if (!startDateGroups.has(startDateKey)) {
                            startDateGroups.set(startDateKey, []);
                        }
                        startDateGroups.get(startDateKey).push(idx);
                    }
                });
                
                startDateGroups.forEach((indices, startDate) => {
                    if (indices.length > 1) {
                        parallelGroups.set(startDate, indices);
                        console.log(`    ðŸ”µ PARALLEL GROUP on ${startDate}: ${indices.length} stages`, indices);
                    }
                });
            }
            
            console.log(`  ðŸ“Š Parallel groups found:`, parallelGroups.size);
            parallelGroups.forEach((indices, groupId) => {
                console.log(`    ðŸ”µ GROUP "${groupId}": ${indices.length} stages`, indices);
            });
            
            // Build the stageGroupMap
            parallelGroups.forEach((indices, groupId) => {
                if (indices.length > 1) {
                    indices.sort((a, b) => a - b);
                    indices.forEach(i => stageGroupMap.set(i, indices));
                }
            });
            
            const orderedStages = [];
            const processedIndices = new Set();
            
            stages.forEach((stage, idx) => {
                if (processedIndices.has(idx)) return;
                
                const sameStartGroup = stageGroupMap.get(idx);
                
                if (sameStartGroup && sameStartGroup.length > 1) {
                    sameStartGroup.forEach(groupIdx => {
                        if (!processedIndices.has(groupIdx)) {
                            orderedStages.push({ stage: stages[groupIdx], originalIndex: groupIdx, group: sameStartGroup });
                            processedIndices.add(groupIdx);
                        }
                    });
                } else {
                    orderedStages.push({ stage: stages[idx], originalIndex: idx, group: null });
                    processedIndices.add(idx);
                }
            });
            
            let stagesHTML = '';
            let previousGroup = null;
            let groupHTML = '';
            let isInGroup = false;
            
            orderedStages.forEach((stageData, displayIndex) => {
                const stage = stageData.stage;
                const index = stageData.originalIndex;
                const currentGroup = stageData.group;
                
                const isCompleted = stage.status === 'completed';
                const isActive = stage.status === 'in-progress';
                
                const hasSameStart = currentGroup && currentGroup.length > 1;
                const isFirstInGroup = hasSameStart && currentGroup.indexOf(index) === 0;
                const isLastInGroup = hasSameStart && currentGroup.indexOf(index) === currentGroup.length - 1;
                
                if (isFirstInGroup) {
                    isInGroup = true;
                    groupHTML = '<div class="stage-group-container">';
                }
                
                let spacingClass = 'normal-spacing';
                if (hasSameStart) {
                    spacingClass = currentGroup.length >= 3 ? 'tight-spacing' : 'medium-spacing';
                }

                let groupBadge = '';
                if (hasSameStart) {
                    const position = currentGroup.indexOf(index) + 1;
                    const total = currentGroup.length;
                    // groupBadge = `<span class="parallel-badge">${position}/${total}</span>`;  // â† COMMENTED OUT
                }
                                
                    let circleContent;
                    if (isCompleted) {
                        circleContent = '<i class="fas fa-check"></i>';
                    } else {
                    circleContent = '';                    
                    }                
                    const stageElement = `
                        <div class="progress-step ${spacingClass}" data-stage-id="${stage.id}" 
                            data-project-id="${project.id}" 
                            data-in-parallel="${hasSameStart ? 'true' : 'false'}"
                            data-stage-status="${stage.status}">
                            <div class="step-circle ${isCompleted ? 'completed' : ''} ${isActive ? 'in-progress' : ''}" 
                                 style="cursor: pointer;"
                                 title="Left-click: Advance status | Right-click: Undo status">
                                ${circleContent}
                            </div>
                        <div class="step-label ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''}">
                            ${stage.name}
                            <span class="duration-badge">${stage.duration_days}d</span>
                            ${groupBadge}
                        </div>
                ${stage.start_date ? `
                    <div style="margin-top: 5px; text-align: center;">
                        <small class="text-muted" style="font-size: 0.7rem; display: block; line-height: 1.4;">
                            ${new Date(stage.start_date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}
                            ${stage.end_date ? '<br>' + new Date(stage.end_date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'}) : ''}
                        </small>
                    </div>
                ` : ''}                   
                </div>
                `;
                
                if (isInGroup) {
                    groupHTML += stageElement;
                } else {
                    stagesHTML += stageElement;
                }
                
                if (isLastInGroup) {
                    groupHTML += '</div>';
                    stagesHTML += groupHTML;
                    groupHTML = '';
                    isInGroup = false;
                }
                
                previousGroup = currentGroup;
            });
            
            const membersHTML = project.members && project.members.length > 0 
                ? project.members.slice(0, 3).map(m => `<span class="badge bg-info me-1"><i class="fas fa-user me-1"></i>${m.username}</span>`).join('') + 
                (project.members.length > 3 ? `<span class="badge bg-secondary">+${project.members.length - 3}</span>` : '')
                : '<span class="text-muted small">No members</span>';
            
            return `
                <div class="project-progress-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <h5 class="mb-0">${project.name}</h5>
                                <span class="project-status-badge status-${project.status}">
                                    ${project.status.charAt(0).toUpperCase() + project.status.slice(1)}
                                </span>
                            </div>
                            <div class="mt-1">${membersHTML}</div>
                        </div>
                        <div class="project-actions">
                            <button class="btn btn-outline-success" onclick="showExcelPreview(${project.id})"                                   
                            style="border-radius: 8px; font-weight: 600; padding: 8px 16px;">
                                <i class="fas fa-file-excel me-2"></i> Export to Excel
                            </button>                            
                            <button class="btn btn-outline-primary" onclick="openCalendarView(${project.id})" 
                                    style="border-radius: 8px; font-weight: 600; padding: 8px 16px;">
                                <i class="fas fa-calendar-alt me-2"></i> View Calendar
                            </button>
                            <button class="btn btn-outline-warning" onclick="openEditProjectModal(${project.id}, event)" 
                                    style="border-radius: 8px; font-weight: 600; padding: 8px 16px;">
                                <i class="fas fa-edit me-2"></i> Edit
                            </button>
                            <button class="btn-delete-project" onclick="deleteProject(${project.id}, event)">
                                <i class="fas fa-trash-alt me-2"></i> Delete
                            </button>
                        </div>                        
                    </div>
                    
                    <p class="text-muted small">${project.description || 'No description'}</p>
                    
                    <div class="progress-steps">
                        <div class="progress-line">
                            <div class="progress-line-fill" style="width: ${progress}%"></div>
                        </div>
                        ${stagesHTML}
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <small class="text-muted">
                            <i class="fas fa-calendar-alt me-1"></i>
                            ${project.start_date ? new Date(project.start_date).toLocaleDateString() : 'Not set'} - 
                            ${project.end_date ? new Date(project.end_date).toLocaleDateString() : 'Not set'}
                        </small>
                        <strong style="color: #667eea; font-size: 1.1rem;">${progress}% Complete (${completedStages}/${totalStages})</strong>
                    </div>
                </div>
            `;
        }).join('');
        
setTimeout(() => {
    document.querySelectorAll('.progress-steps').forEach(progressContainer => {
        const line = progressContainer.querySelector('.progress-line');
        
        // Get all top-level steps (including group containers)
        const directChildren = Array.from(progressContainer.children).filter(
            child => child.classList.contains('progress-step') || 
                     child.classList.contains('stage-group-container')
        );
        
        if (line && directChildren.length > 0) {
            const firstChild = directChildren[0];
            const lastChild = directChildren[directChildren.length - 1];
            
            // For group containers, get the first circle inside
            const firstCircle = firstChild.classList.contains('stage-group-container') 
                ? firstChild.querySelector('.step-circle')
                : firstChild.querySelector('.step-circle');
                
            const lastCircle = lastChild.classList.contains('stage-group-container')
                ? lastChild.querySelector('.step-circle')
                : lastChild.querySelector('.step-circle');
            
            if (firstCircle && lastCircle) {
                const firstRect = firstCircle.getBoundingClientRect();
                const lastRect = lastCircle.getBoundingClientRect();
                const containerRect = progressContainer.getBoundingClientRect();
                
                const lineLeft = firstRect.left - containerRect.left + 25;
                const lineRight = lastRect.left - containerRect.left + 25;
                const lineWidth = lineRight - lineLeft;
                
                line.style.left = `${lineLeft}px`;
                line.style.width = `${lineWidth}px`;
                line.style.right = 'auto';
            }
        }
    });
}, 100);
    
    // Update progress line status for each project
// Update progress line status for each project
    projectsData.forEach(project => {
        startProgressLineAutoRefresh(project.id);
    });
    
    // âœ… Setup parallel stage click handlers - DISABLED (circles now have direct onclick)
    // setTimeout(() => {
    //     setupParallelStageClickHandlers();
    // }, 100);

}
    async function loadEmployees() {
        const response = await fetch('/api/employees');
        employees = await response.json();
        const select = document.getElementById('memberSelect');
        select.innerHTML = '<option value="">Select member to add...</option>' + 
            employees.map(e => `<option value="${e.id}">${e.username} (${e.role})</option>`).join('');
    }

    // UPDATED FUNCTION: Handle project submit with working Saturdays
async function handleProjectSubmit(e) {
    e.preventDefault();
    
    // âœ… STEP 1: Collect current form data
    const stages = [];
    const stageElements = document.querySelectorAll('[id^="stage-"]');
    
    stageElements.forEach((element, index) => {
        const id = element.id.split('-')[1];
        const checkbox = document.getElementById(`stageCheck-${id}`);
        
        if (!checkbox || !checkbox.checked) return;
        
        const name = document.getElementById(`stageName-${id}`)?.value;
        const duration = parseInt(document.getElementById(`stageDuration-${id}`)?.value) || 1;
        const managerId = parseInt(document.getElementById(`stageManager-${id}`)?.value) || null;
        const startDateInput = document.getElementById(`stageStartDate-${id}`);
        const customStartDate = startDateInput?.value || null;
        const isCustomDate = startDateInput?.getAttribute('data-is-custom') === 'true';
        
        if (name) {
            const stageData = { 
                name,  // This will REPLACE the old name
                order: stages.length + 1,
                duration_days: duration,  // This will REPLACE the old duration
                manager_id: managerId  // This will REPLACE the old manager
            };
            
            // âœ… Include custom start date if user set one
            if (isCustomDate && customStartDate) {
                stageData.start_date = customStartDate;
            }
            
            // âœ… Include the database ID so backend knows to UPDATE (not create new)
            const dbId = element.getAttribute('data-db-id');
            if (dbId) {
                stageData.id = parseInt(dbId);  // This tells backend "update this record"
            }
            
            // âœ… Retrieve and preserve parallel_group_id from element
            const parallelGroupId = element.getAttribute('data-parallel-group-id');
            if (parallelGroupId) {
                stageData.parallel_group_id = parallelGroupId;
                console.log(`  ðŸ“¤ Sending parallel_group_id: ${parallelGroupId} for stage "${name}"`);
            }
            
            stages.push(stageData);
        }
    });
    
    // âœ… NEW: Calculate parallel_group_id for stages with same start dates
    // Only calculate for stages that don't already have a parallel_group_id
    const startDateGroups = new Map();
    stages.forEach((stage, idx) => {
        // Only consider stages without an existing parallel_group_id
        if (stage.start_date && !stage.parallel_group_id) {
            const startKey = stage.start_date;
            if (!startDateGroups.has(startKey)) {
                startDateGroups.set(startKey, []);
            }
            startDateGroups.get(startKey).push(idx);
        }
    });
    
    // Assign parallel_group_id to stages in the same group
    startDateGroups.forEach((indices, startDate) => {
        if (indices.length > 1) {
            // Multiple stages with same start date = parallel group
            const groupId = `parallel_${startDate}`;
            indices.forEach(idx => {
                if (!stages[idx].parallel_group_id) {  // Only set if not already set
                    stages[idx].parallel_group_id = groupId;
                    console.log(`  âœ¨ Auto-assigned parallel_group_id: ${groupId} for stage "${stages[idx].name}"`);
                }
            });
        }
    });
    
    // âœ… STEP 2: Determine if editing or creating
    const wasEditMode = isEditMode;
    const projectIdBeingEdited = editingProjectId;
    
    // âœ… STEP 3: Prepare data to send
    const data = {
        name: document.getElementById('projectName').value,
        start_date: document.getElementById('projectStartDate').value,
        stages,  // This REPLACES all the old stages
        members: selectedMembers,
        include_saturday: includeSaturdayAsWorkingDay,
        working_saturdays: Array.from(workingSaturdays),
        is_direct_edit: wasEditMode
    };
    
    // âœ… STEP 4: Send to backend - PUT for update, POST for create
    const url = wasEditMode ? `/api/projects/${projectIdBeingEdited}` : '/api/projects';
    const method = wasEditMode ? 'PUT' : 'POST';  // PUT = update existing
    
    console.log('ðŸš€ Sending request:', { url, method, data });
    
    const response = await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)  // Send the new data
    });
    
    console.log('ðŸ“¡ Response status:', response.status);
    
    if (response.ok) {
        const result = await response.json();
        console.log('âœ… Server response:', result);
        
        // âœ… CLOSE THE MODAL
        projectModal.hide();
        
        // âœ… RESET THE FORM
        resetProjectForm();
        
        showNotification(wasEditMode ? 'âœ… Job updated successfully!' : 'âœ… Job created successfully!', 'success');
        
        // Check if calendar modal is open BEFORE clearing data
        const calendarModalEl = document.getElementById('calendarModal');
        const wasCalendarOpen = calendarModalEl && calendarModalEl.classList.contains('show');
        const projectIdForRefresh = wasCalendarOpen ? currentProjectForCalendar : null;
        
        // Wait for modal to close
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // Reload to show updated data
        await loadProjects();
        await loadStats();
        
        // âœ… REFRESH CALENDAR VIEW IF IT WAS OPEN - IMPROVED VERSION
        if (wasCalendarOpen && projectIdForRefresh) {
            console.log('ðŸ”„ Calendar was open - forcing complete refresh for project:', projectIdForRefresh);
            
            // Wait a bit more to ensure database is updated
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Force complete calendar rebuild
            currentProjectForCalendar = projectIdForRefresh;
            
            // Destroy existing calendar if it exists
            if (calendar) {
                try {
                    calendar.destroy();
                    calendar = null;
                    console.log('ðŸ—‘ï¸ Destroyed old calendar');
                } catch (e) {
                    console.warn('Could not destroy calendar:', e);
                }
            }
            
            // Clear the calendar container COMPLETELY
            const calendarEl = document.getElementById('calendar');
            if (calendarEl) {
                // Remove all content and classes
                calendarEl.innerHTML = '';
                calendarEl.className = '';
                // Force browser to recalculate layout
                calendarEl.offsetHeight; // Trigger reflow
                console.log('ðŸ§¹ Cleared calendar DOM');
            }
            
            // Extra wait to ensure DOM is clean
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Reopen calendar view with fresh data
            await openCalendarView(projectIdForRefresh);
            
            console.log('âœ… Calendar refreshed with updated data');
        }
        
        // Clear cached data AFTER calendar refresh
        window.originalProjectData = null;
        currentProjectData = null;
    } else {
        // âœ… SHOW ACTUAL ERROR
        const errorData = await response.json();
        console.error('âŒ Server error:', errorData);
        showNotification('âŒ Error: ' + (errorData.error || 'Failed to save changes'), 'error');
    }
}

async function updateStageStatus(projectId, stageId, currentStatus) {
    try {
        // Determine next status
        const newStatus = currentStatus === 'pending' ? 'in-progress' : 
                         currentStatus === 'in-progress' ? 'completed' : 'pending';
        
        // Update the status on the server
        const response = await fetch(`/api/projects/${projectId}/stages/${stageId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus })
        });
        
        if (!response.ok) {
            throw new Error('Failed to update stage status');
        }
        
        // âœ… FIX: Find and update the specific stage (works for both regular and parallel)
        const stageElement = document.querySelector(`[data-stage-id="${stageId}"]`);
        
        if (stageElement) {
            const circle = stageElement.querySelector('.step-circle');
            const label = stageElement.querySelector('.step-label');
            
            // âœ… UPDATE THE DATA ATTRIBUTE SO RIGHT-CLICK WORKS
            stageElement.setAttribute('data-stage-status', newStatus);
            
            // âœ… SAVE original content BEFORE any changes
            if (!circle.dataset.originalNumber) {
                const circleText = circle.textContent.trim();
                if (circleText && !isNaN(circleText)) {
                    circle.dataset.originalNumber = circleText;
                }
            }
            
            // Remove all status classes
            circle.classList.remove('completed', 'active', 'not-started', 'in-progress', 'overdue', 'completed-rescheduled');
            label.classList.remove('completed', 'active');
            
            // Apply new status
            if (newStatus === 'completed') {
                circle.classList.add('completed');
                label.classList.add('completed');
                circle.innerHTML = '<i class="fas fa-check"></i>';
            } else if (newStatus === 'in-progress') {
                circle.classList.add('in-progress');
                label.classList.add('active');
                // âœ… Restore from saved original number
                circle.textContent = circle.dataset.originalNumber || '';
            } else {
                // Reset to pending
                circle.classList.add('not-started');
                // âœ… Restore from saved original number
                circle.textContent = circle.dataset.originalNumber || '';
            }
        }
        
        // Update progress line and percentage
        updateProgressLineFill(projectId);
        
        // Refresh progress line status with new colors
        await updateProgressLineStatus(projectId);
        
        // Only update stats (lightweight)
        await loadStats();
        
    } catch (error) {
        console.error('Error updating stage status:', error);
        // Only reload if there's an error
        await loadProjects();
        await loadStats();
    }
}
// âœ… NEW FUNCTION: Undo stage status (right-click support)
async function undoStageStatus(projectId, stageId, previousStatus) {
    try {
        console.log(`Undoing stage ${stageId} to status: ${previousStatus}`);
        
        // Update the status on the server to previous state
        const response = await fetch(`/api/projects/${projectId}/stages/${stageId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: previousStatus })
        });
        
        if (!response.ok) {
            throw new Error('Failed to undo stage status');
        }
        
        // Find and update the specific stage
        const stageElement = document.querySelector(`[data-stage-id="${stageId}"]`);
        
        if (stageElement) {
            const circle = stageElement.querySelector('.step-circle');
            const label = stageElement.querySelector('.step-label');
            
            // âœ… UPDATE THE DATA ATTRIBUTE SO RIGHT-CLICK CONTINUES TO WORK
            stageElement.setAttribute('data-stage-status', previousStatus);
            
            // âœ… SAVE original content BEFORE any changes
            if (!circle.dataset.originalNumber) {
                const circleText = circle.textContent.trim();
                if (circleText && !isNaN(circleText)) {
                    circle.dataset.originalNumber = circleText;
                }
            }
            
            // Remove all status classes
            circle.classList.remove('completed', 'active', 'not-started', 'in-progress', 'overdue', 'completed-rescheduled');
            label.classList.remove('completed', 'active');
            
            // Apply previous status
            if (previousStatus === 'completed') {
                circle.classList.add('completed');
                label.classList.add('completed');
                circle.innerHTML = '<i class="fas fa-check"></i>';
            } else if (previousStatus === 'in-progress') {
                circle.classList.add('in-progress');
                label.classList.add('active');
                // âœ… Restore from saved original number
                circle.textContent = circle.dataset.originalNumber || '';
            } else {
                // Reset to pending
                circle.classList.add('not-started');
                // âœ… Restore from saved original number
                circle.textContent = circle.dataset.originalNumber || '';
            }
        }
        
        // Update progress line and percentage
        updateProgressLineFill(projectId);
        
        // Refresh progress line status with new colors
        await updateProgressLineStatus(projectId);
        
        // Update stats
        await loadStats();
        
        showNotification('Status reverted successfully', 'success');
        
    } catch (error) {
        console.error('Error undoing stage status:', error);
        showNotification('Error undoing status: ' + error.message, 'error');
        // Reload on error
        await loadProjects();
        await loadStats();
    }
}
// âœ… ADD THIS NEW HELPER FUNCTION (add it right after updateStageStatus)
function updateProgressLineFill(projectId) {
    const projectContainers = document.querySelectorAll('.project-progress-container');
    
    projectContainers.forEach(container => {
        const editBtn = container.querySelector(`[onclick*="openEditProjectModal(${projectId}"]`);
        if (editBtn) {
            const steps = container.querySelectorAll('.progress-step');
            const completedSteps = container.querySelectorAll('.step-circle.completed').length;
            const totalSteps = steps.length;
            const progress = totalSteps > 0 ? (completedSteps / totalSteps) * 100 : 0;
            
            // Update progress line fill
            const progressFill = container.querySelector('.progress-line-fill');
            if (progressFill) {
                progressFill.style.width = `${progress}%`;
            }
            
            // Update progress percentage text
            const progressText = container.querySelector('strong[style*="color: #667eea"]');
            if (progressText) {
                progressText.textContent = `${Math.round(progress)}% Complete (${completedSteps}/${totalSteps})`;
            }
        }
    });
}
function openProjectModal() {
    document.getElementById('projectForm').reset();
    document.getElementById('projectStartDate').valueAsDate = new Date();
    workingSaturdays.clear();
    loadDefaultStages();
    projectModal.show();
}

function toggleNotifications() {
    alert('Notifications feature');
}

async function deleteProject(projectId, event) {
    event.stopPropagation();
    
    if (!confirm('Are you sure you want to delete this job? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/projects/${projectId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showNotification('âœ… Job deleted successfully!', 'success');
            await loadProjects();
            await loadStats();
        } else {
            const error = await response.json();
            showNotification('âŒ Error: ' + (error.error || 'Failed to delete job'), 'error');
        }
    } catch (error) {
        console.error('Error deleting job:', error);
        showNotification('âŒ Error deleting job: ' + error.message, 'error');
    }
}

function getStageColor(index) {
    return STAGE_COLORS[index % STAGE_COLORS.length];
}

let miniPopupData = null;




// âœ… OPTIMIZED: Opens calendar and fetches data in parallel
async function openCalendarView(projectId) {
    currentProjectForCalendar = projectId;
    
    try {
        // 1. Show modal immediately with loading state
        document.getElementById('calendarProjectTitle').textContent = "Loading...";
        document.getElementById('calendarProjectDates').textContent = "";
        calendarModal.show();

        // 2. Fetch Project Details & History in Parallel
        const timestamp = Date.now();
        const [detailsResp, historyResp] = await Promise.all([
            fetch(`/api/projects/${projectId}/details?_t=${timestamp}`),
            fetch(`/api/projects/${projectId}/complete-reschedule-history?_t=${timestamp}`)
        ]);

        if (!detailsResp.ok) throw new Error("Failed to load project details");
        
        currentProjectData = await detailsResp.json();
        currentProjectData.rescheduleHistory = historyResp.ok ? await historyResp.json() : [];

        // 3. Process Data
        console.log('âœ… Data loaded:', currentProjectData.stages.length, 'stages', currentProjectData.rescheduleHistory.length, 'history records');

        // Ensure working days is a Set
        if (Array.isArray(currentProjectData.saturdayWorkingDays)) {
            currentProjectData.saturdayWorkingDays = new Set(currentProjectData.saturdayWorkingDays);
        } else {
            currentProjectData.saturdayWorkingDays = new Set();
        }

        // Update Header
        document.getElementById('calendarProjectTitle').textContent = currentProjectData.name;
        document.getElementById('calendarProjectDates').textContent = 
            `${new Date(currentProjectData.start_date).toLocaleDateString()} - ${new Date(currentProjectData.end_date).toLocaleDateString()}`;

        // 4. Initialize Calendar (Wait briefly for modal transition)
        setTimeout(async () => {
            const calendarEl = document.getElementById('calendar');
            if (calendar) calendar.destroy();

            // Generate events (optimized)
            const calendarEvents = await generateEnhancedCalendarEvents(currentProjectData.stages);

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                initialDate: currentProjectData.start_date,
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,listMonth'
                },
                height: 'auto',
                contentHeight: 'auto',
                dayMaxEvents: 5, // Show "more" link if > 5 events
                events: calendarEvents,
                eventDisplay: 'block',
                displayEventTime: false,
                
                // Event Render Handlers
                eventDidMount: function(info) {
                    enhanceEventDisplay(info);
                },
                eventClick: function(info) {
                    // Prevent clicking ghost events
                    if (info.event.extendedProps.isGhost) {
                        const p = info.event.extendedProps;
                        alert(`ðŸ‘» Original Location\n\nMoved ${p.daysShifted} days ${p.direction}.\nNew Date: ${new Date(p.movedTo).toLocaleDateString()}`);
                        return;
                    }
                    handleStageClickReschedule(info, currentProjectData);
                },
                dayCellDidMount: function(info) {
                    addDayRescheduleButton(info, currentProjectData);
                },
                datesSet: function() {
                    // Refresh badges when view changes (e.g. next month)
                    setTimeout(refreshParallelBadges, 100);
                }
            });

            calendar.render();

            // Post-render enhancements
            setTimeout(() => {
                enhanceCalendarWithWeekends();
                generateEnhancedLegend(currentProjectData.stages);
                refreshParallelBadges();
            }, 300);

        }, 300);

    } catch (error) {
        console.error('Error loading calendar:', error);
        alert('Error loading calendar: ' + error.message);
    }
}

// âœ… OPTIMIZED: Fetches daily tasks in PARALLEL (Much faster)
async function generateEnhancedCalendarEvents(stages) {
    console.log('âš¡ Generating events (Optimized)...');
    const events = [];
    const dateStageMap = new Map();

    // 1. Generate Ghost Events from History
    if (currentProjectData.rescheduleHistory) {
        currentProjectData.rescheduleHistory.forEach(h => {
            const stageIndex = stages.findIndex(s => s.id === h.stage_id);
            const color = stageIndex >= 0 ? getStageColor(stageIndex) : '#999';
            
            events.push({
                title: `â‡¢ ${h.stage_name} (Moved)`,
                start: h.original_date,
                end: h.original_date,
                backgroundColor: color,
                borderColor: color,
                classNames: ['ghost-event'],
                extendedProps: {
                    isGhost: true,
                    type: h.type,
                    stageName: h.stage_name,
                    daysShifted: h.days_shifted,
                    direction: h.direction,
                    movedTo: h.new_date,
                    reason: h.reason
                }
            });
        });
    }

    // 2. Fetch ALL daily tasks in parallel
    const dailyTaskPromises = stages.map(stage => 
        fetch(`/api/projects/${currentProjectData.id}/stages/${stage.id}/daily-tasks`)
            .then(res => res.ok ? res.json() : [])
            .then(tasks => ({ stage, tasks, index: stages.indexOf(stage) }))
            .catch(err => {
                console.warn(`Failed tasks fetch for ${stage.name}`, err);
                return { stage, tasks: [], index: stages.indexOf(stage) };
            })
    );

    const allStageData = await Promise.all(dailyTaskPromises);

    // 3. Process Stages
    for (const { stage, tasks, index } of allStageData) {
        const color = getStageColor(index);
        const stageRescheduleHistory = currentProjectData.rescheduleHistory?.find(h => h.stage_id === stage.id);

        if (tasks.length > 0) {
            // --- Strategy A: Use Daily Tasks ---
            tasks.sort((a, b) => new Date(a.scheduled_date) - new Date(b.scheduled_date));
            const hasAnyRescheduled = tasks.some(t => t.is_rescheduled);

            let segmentStart = null;
            let lastDate = null;
            let segmentTasks = [];

            tasks.forEach((task, i) => {
                const taskDate = new Date(task.scheduled_date + 'T12:00:00');
                const dateKey = taskDate.toISOString().split('T')[0];

                // Map for parallel detection
                if (!dateStageMap.has(dateKey)) dateStageMap.set(dateKey, []);
                dateStageMap.get(dateKey).push({ stage, index });

                // Handle HOLD explicitly
                if (task.status === 'hold') {
                    // If we have an active segment, close it first
                    if (segmentStart) {
                        const segmentEnd = new Date(lastDate);
                        segmentEnd.setDate(segmentEnd.getDate() + 1);
                        events.push(createStageEventWithStatus(stage, index, segmentStart, segmentEnd, color, dateStageMap, segmentTasks, hasAnyRescheduled, stageRescheduleHistory));
                        segmentStart = null;
                        segmentTasks = [];
                    }
                    
                    // Add Hold Event
                    events.push({
                        title: `ðŸ”’ ${stage.name}`,
                        start: dateKey,
                        allDay: true,
                        classNames: ['event-hold'],
                        extendedProps: { stageName: stage.name, status: 'hold', reason: task.rescheduled_reason }
                    });
                    return; 
                }

                // Segment Logic
                if (!segmentStart) {
                    segmentStart = new Date(taskDate);
                    lastDate = new Date(taskDate);
                    segmentTasks = [task];
                } else {
                    const nextDay = new Date(lastDate);
                    nextDay.setDate(nextDay.getDate() + 1);

                    if (taskDate.getTime() !== nextDay.getTime()) {
                        // Gap detected, close segment
                        const segmentEnd = new Date(lastDate);
                        segmentEnd.setDate(segmentEnd.getDate() + 1);
                        events.push(createStageEventWithStatus(stage, index, segmentStart, segmentEnd, color, dateStageMap, segmentTasks, hasAnyRescheduled, stageRescheduleHistory));
                        
                        segmentStart = new Date(taskDate);
                        segmentTasks = [task];
                    } else {
                        segmentTasks.push(task);
                    }
                    lastDate = new Date(taskDate);
                }

                // Final Segment
                if (i === tasks.length - 1 && segmentStart) {
                    const segmentEnd = new Date(lastDate);
                    segmentEnd.setDate(segmentEnd.getDate() + 1);
                    events.push(createStageEventWithStatus(stage, index, segmentStart, segmentEnd, color, dateStageMap, segmentTasks, hasAnyRescheduled, stageRescheduleHistory));
                }
            });

        } else if (stage.start_date && stage.end_date) {
            // --- Strategy B: Fallback to Start/End dates ---
            
            // âœ… FIX: Populate map so parallel detection works for these stages too
            let d = new Date(stage.start_date);
            const e = new Date(stage.end_date);
            while (d <= e) {
                const dateKey = d.toISOString().split('T')[0];
                if (!dateStageMap.has(dateKey)) dateStageMap.set(dateKey, []);
                dateStageMap.get(dateKey).push({ stage, index });
                d.setDate(d.getDate() + 1);
            }

            events.push({
                title: stage.name,
                start: stage.start_date,
                end: addDays(new Date(stage.end_date), 1).toISOString().split('T')[0],
                backgroundColor: color,
                extendedProps: { 
                    stageId: stage.id, 
                    status: stage.status, 
                    stageName: stage.name,
                    duration: stage.duration_days,
                    // Add generic tooltip for fallback
                    tooltip: `${stage.name}\nDuration: ${stage.duration_days} days` 
                }
            });
        }
    }

    return events;
}

// âœ… NEW FUNCTION: Adds visual badges to days with multiple events
function refreshParallelBadges() {
    // Remove existing badges
    document.querySelectorAll('.parallel-badge-container').forEach(el => el.remove());

    const days = document.querySelectorAll('.fc-daygrid-day');
    
    days.forEach(dayCell => {
        // Count events inside this day cell
        const events = dayCell.querySelectorAll('.fc-event:not(.ghost-event)');
        
        if (events.length > 1) {
            // Create a badge container
            const badge = document.createElement('div');
            badge.className = 'parallel-badge-container';
            badge.style.cssText = `
                position: absolute;
                bottom: 2px;       /* âœ… CHANGE from top to bottom */
                right: 2px;        /* Keep right */
                z-index: 10;
                background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                color: white;
                border-radius: 4px;
                padding: 1px 4px;
                font-size: 0.65rem;
                font-weight: bold;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                pointer-events: none; /* Ensure clicks pass through */
            `;
            badge.innerHTML = `âš¡ ${events.length}`;
            
            // Append to the day frame (content area)
            const frame = dayCell.querySelector('.fc-daygrid-day-frame');
            if (frame) {
                frame.style.position = 'relative'; // Ensure positioning context
                frame.appendChild(badge);
            }
        }
    });
}

// Helper to add days safely
function addDays(date, days) {
    const result = new Date(date);
    result.setDate(result.getDate() + days);
    return result;
}

function createStageEvent(stage, index, start, end, color, dateStageMap, stageRescheduleHistory = null) {
    // Check for parallel stages
    let hasParallel = false;
    let parallelCount = 0;
    
    for (let d = new Date(start); d < end; d.setDate(d.getDate() + 1)) {
        const dateKey = d.toISOString().split('T')[0];
        const stagesOnDate = dateStageMap.get(dateKey) || [];
        if (stagesOnDate.length > 1) {
            hasParallel = true;
            parallelCount = Math.max(parallelCount, stagesOnDate.length);
        }
    }
    
    // Check entire project for overlaps
    if (currentProjectData && currentProjectData.stages) {
        const stageStart = new Date(stage.start_date);
        const stageEnd = new Date(stage.end_date);
        
        let overlapCount = 1;
        
        currentProjectData.stages.forEach((otherStage, otherIdx) => {
            if (otherStage.id === stage.id || !otherStage.start_date || !otherStage.end_date) return;
            
            const otherStart = new Date(otherStage.start_date);
            const otherEnd = new Date(otherStage.end_date);
            
            if (stageStart <= otherEnd && stageEnd >= otherStart) {
                hasParallel = true;
                overlapCount++;
            }
        });
        
        parallelCount = Math.max(parallelCount, overlapCount);
    }
    
    let title = stage.name;
    
    if (hasParallel) {
        title = `âš¡ ${stage.name}`;
    }      
    const classNames = [];
    if (stage.status === 'completed') classNames.push('stage-event-completed');
    if (stage.status === 'in-progress') classNames.push('stage-event-active');
    

    // âœ… Build extended props with reschedule info
    const extendedProps = {
        stageId: stage.id,
        stageIndex: index,
        duration: stage.duration_days,
        status: stage.status,
        hasParallel: hasParallel,
        parallelCount: parallelCount,
        stageName: stage.name,
        allCompleted: allCompleted,
        hasRescheduled: hasRescheduled,
        completedCount: completedCount,
        rescheduledCount: rescheduledCount,
        totalTasks: tasks.length,
        tooltip: tooltip // <--- âœ… ADD THIS LINE to save your detailed tooltip
    };
    
    // âœ… Add reschedule information if available
    if (stageRescheduleHistory) {
        extendedProps.wasRescheduled = true;
        extendedProps.daysShifted = stageRescheduleHistory.days_shifted || 
            Math.abs(Math.round((new Date(stageRescheduleHistory.new_date) - new Date(stageRescheduleHistory.original_date)) / (1000 * 60 * 60 * 24)));
        extendedProps.rescheduleDirection = stageRescheduleHistory.direction || 
            (new Date(stageRescheduleHistory.new_date) > new Date(stageRescheduleHistory.original_date) ? 'forward' : 'backward');
        extendedProps.rescheduleBadge = `${extendedProps.rescheduleDirection === 'forward' ? '+' : '-'}${extendedProps.daysShifted}d`;
        extendedProps.originalDate = stageRescheduleHistory.original_date;
    }

    return {
        title: title,
        start: start.toISOString().split('T')[0],
        end: end.toISOString().split('T')[0],
        backgroundColor: color,
        borderColor: color,
        extendedProps: extendedProps,
        classNames: classNames
    };
}
// Create tooltip element once (add this BEFORE enhanceEventDisplay function)
let tooltipElement = null;

function createTooltipElement() {
    if (!tooltipElement) {
        tooltipElement = document.createElement('div');
        tooltipElement.className = 'event-tooltip';
        tooltipElement.style.cssText = `
            position: fixed;
            background: rgba(44, 62, 80, 0.98);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            white-space: pre-line;
            font-size: 11.5px;
            line-height: 1.6;
            z-index: 999999;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            min-width: 180px;
            max-width: 300px;
            pointer-events: none;
            border: 1px solid rgba(255,255,255,0.1);
            display: none;
        `;
        document.body.appendChild(tooltipElement);
    }
    return tooltipElement;
}


function enhanceEventDisplay(info) {
    const props = info.event.extendedProps;
    
    info.el.style.setProperty('--event-color', info.event.backgroundColor);
    
    // Build tooltip content
    let tooltipText = '';
    let isGhost = false;
    
    // Ghost event handling
    if (props.isGhost) {
        isGhost = true;
        
        // âœ… Use pre-built tooltip if available, otherwise construct
        if (props.tooltip) {
            tooltipText = props.tooltip;
        } else {
                    tooltipText = `ðŸ‘» Original Location\n`;
                    tooltipText += `â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                    
                    // âœ… Check if it's a daily task or stage-level reschedule
                    if (props.type === 'daily_task' && props.dayNumber) {
                        tooltipText += `Stage: ${props.stageName}\n`;
                        tooltipText += `Day: ${props.dayNumber}\n`;
                    } else {
                        tooltipText += `Stage: ${props.stageName}\n`;
                    }
                    
                    tooltipText += `Moved ${props.daysShifted} day(s) ${props.direction}\n`;
                    tooltipText += `âž¡ï¸ New date: ${new Date(props.movedTo).toLocaleDateString()}`;
                    
                    if (props.reason) {
                        tooltipText += `\nðŸ’¬ Reason: ${props.reason}`;
                    }
                }        
        info.el.style.cursor = 'help';
    } else {
        // Build tooltip for real events
        tooltipText = `${props.stageName}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                tooltipText += `ðŸ“… ${props.duration} days\n`;
                
                if (props.completedCount > 0) {
                    tooltipText += `âœ… ${props.completedCount}/${props.totalTasks} completed\n`;
                }
                
                if (props.rescheduledCount > 0) {
                    tooltipText += `ðŸ”„ ${props.rescheduledCount} day(s) rescheduled\n`;
                }
                
                // âœ… ADD: Show if entire stage was rescheduled
                if (props.wasRescheduled) {
                    tooltipText += `ðŸ”„ Stage shifted ${props.rescheduleBadge}\n`;
                }
                
                tooltipText += `ðŸ“Š ${props.status}`;
            }    
    // Add hover events to show tooltip
    info.el.addEventListener('mouseenter', function(e) {
        const tooltip = createTooltipElement();
        tooltip.textContent = tooltipText;
        
        // Set background color based on type
        if (isGhost) {
            tooltip.style.background = 'rgba(255, 152, 0, 0.98)';
        } else {
            tooltip.style.background = 'rgba(44, 62, 80, 0.98)';
        }
        
        // Calculate position
        const rect = info.el.getBoundingClientRect();
        const tooltipX = rect.left + (rect.width / 2);
        
        // Show tooltip immediately
        tooltip.style.display = 'block';
        tooltip.style.left = tooltipX + 'px';
        tooltip.style.transform = 'translateX(-50%)';
        
        // Wait for next frame to position vertically
        setTimeout(() => {
            const tooltipHeight = tooltip.offsetHeight;
            let tooltipY;
            
            // Check if tooltip would go off top of screen
            if (rect.top - tooltipHeight - 20 < 10) {
                // Position below the event
                tooltipY = rect.bottom + 12;
            } else {
                // Position above the event
                tooltipY = rect.top - tooltipHeight - 12;
            }
            
            tooltip.style.top = tooltipY + 'px';
        }, 10);
    });
    
    // Hide tooltip on mouse leave
    info.el.addEventListener('mouseleave', function(e) {
        const tooltip = createTooltipElement();
        tooltip.style.display = 'none';
    });
    
    // Add duration badge (only for non-ghost events)
    if (!isGhost && props.duration) {
        const durationBadge = document.createElement('span');
        durationBadge.className = 'parallel-stage-indicator';
        durationBadge.textContent = `${props.duration}d`;
        info.el.appendChild(durationBadge);
    }
}

function addDayRescheduleButton(info, projectData) {
    const dateStr = info.date.toISOString().split('T')[0];
    const checkDate = new Date(dateStr + 'T12:00:00');
    const dayOfWeek = checkDate.getDay();
    
    // Don't show anything on Sundays (always holiday)
    if (dayOfWeek === 0) {
        return;
    }
    
    // Don't show anything on Saturdays that are holidays
    if (dayOfWeek === 6) {
        const isWorkingDay = projectData.saturdayWorkingDays && 
                            projectData.saturdayWorkingDays.has(dateStr);
        if (!isWorkingDay) {
            return;
        }
    }
    
    const stagesOnDay = projectData.stages.filter(stage => {
        if (!stage.start_date || !stage.end_date) return false;
        
        const stageStart = new Date(stage.start_date + 'T12:00:00');
        const stageEnd = new Date(stage.end_date + 'T12:00:00');
        
        return checkDate >= stageStart && checkDate <= stageEnd;
    });
    
    const dayFrame = info.el.querySelector('.fc-daygrid-day-frame');
    
    if (!dayFrame) {
        return;
    }
    
    // Add reschedule button only if there are stages
}

function showMiniReschedulePopup(date, stages, projectData, event) {
        const popup = document.getElementById('miniReschedulePopup');
        const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        
        document.getElementById('popupDate').textContent = dateStr;
        
        const stagesList = document.getElementById('popupStagesList');
        stagesList.innerHTML = stages.map((stage, idx) => {
            const color = getStageColor(projectData.stages.indexOf(stage));
            const isCompleted = stage.status === 'completed';
            const statusIcon = isCompleted ? '<i class="fas fa-check-circle text-success"></i>' : 
                              stage.status === 'in-progress' ? '<i class="fas fa-spinner text-warning"></i>' : '';
            
            return `
                <div class="stage-chip ${isCompleted ? 'opacity-50' : ''}" 
                     ${!isCompleted ? `onclick="handleStageRescheduleFromPopup(${projectData.id}, ${stage.id}, '${stage.name.replace(/'/g, "\\'")}', '${stage.start_date}', '${stage.end_date}')"` : ''}>
                    <div class="stage-chip-color" style="background: ${color};"></div>
                    <div class="stage-chip-name">${stage.name} ${statusIcon}</div>
                    ${!isCompleted ? `<button class="stage-chip-btn" onclick="event.stopPropagation(); handleStageRescheduleFromPopup(${projectData.id}, ${stage.id}, '${stage.name.replace(/'/g, "\\'")}', '${stage.start_date}', '${stage.end_date}');">Reschedule</button>` : ''}
                </div>
            `;
        }).join('');
        
        const rect = event.target.getBoundingClientRect();
        popup.style.left = `${Math.min(rect.left, window.innerWidth - 320)}px`;
        popup.style.top = `${rect.bottom + 10}px`;
        
        setTimeout(() => {
            const popupRect = popup.getBoundingClientRect();
            if (popupRect.bottom > window.innerHeight) {
                popup.style.top = `${rect.top - popupRect.height - 10}px`;
            }
        }, 10);
        
        popup.classList.add('active');
        
        setTimeout(() => {
            document.addEventListener('click', closeMiniPopupOutside);
        }, 100);
    }

    function closeMiniPopup() {
        const popup = document.getElementById('miniReschedulePopup');
        popup.classList.remove('active');
        document.removeEventListener('click', closeMiniPopupOutside);
    }

    function closeMiniPopupOutside(e) {
        const popup = document.getElementById('miniReschedulePopup');
        if (!popup.contains(e.target)) {
            closeMiniPopup();
        }
    }

    function handleStageRescheduleFromPopup(projectId, stageId, stageName, startDate, endDate) {
        closeMiniPopup();
        
        const color = getStageColor(currentProjectData.stages.findIndex(s => s.id === stageId));
        
        document.getElementById('rescheduleStageInfo').textContent = stageName;
        document.getElementById('rescheduleCurrentDates').textContent = 
            `${new Date(startDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})} - ${new Date(endDate).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}`;
        document.getElementById('rescheduleStageColor').style.background = color;
        document.getElementById('rescheduleProjectId').value = projectId;
        document.getElementById('rescheduleStageId').value = stageId;
        document.getElementById('rescheduleStageStartDate').value = startDate;
        document.getElementById('rescheduleStageEndDate').value = endDate;
        document.getElementById('rescheduleDays').value = '';
        document.getElementById('rescheduleReason').value = '';
        document.getElementById('rescheduleNewDatesPreview').style.display = 'none';
        document.getElementById('rescheduleImpactWarning').style.display = 'none';
        
        rescheduleModal.show();
    }


function handleStageClickReschedule(info, project) {
    const stage = project.stages.find(s => s.id === info.event.extendedProps.stageId);
    
    if (!stage) return;
    
    // Show options: Reschedule entire stage OR manage daily tasks
    const choice = confirm(
        `Stage: ${stage.name}\n\n` +
        `Click OK to manage individual days\n` +
        `Click Cancel to reschedule entire stage`
    );
    
    if (choice) {
        // Open daily task manager
        openDailyTaskManager(project.id, stage.id, stage.name);
    } else {
        // Original behavior - reschedule entire stage
        if (stage.status === 'completed') {
            alert('Cannot reschedule a completed stage. Update its status first.');
            return;
        }
        
        handleStageRescheduleFromPopup(
            project.id, 
            stage.id, 
            stage.name, 
            stage.start_date, 
            stage.end_date
        );
    }
}

function generateEnhancedLegend(stages) {
    const legendContainer = document.getElementById('calendarLegend');
    
    const legendHTML = stages.map((stage, index) => {
        const color = getStageColor(index);
        
        let statusBadge = '';
        if (stage.status === 'completed') {
            statusBadge = '<span class="badge bg-success" style="font-size: 0.6rem; padding: 2px 4px;">ÃƒÂ¢Ã…â€œÃ¢â‚¬Å“</span>';
        } else if (stage.status === 'in-progress') {
            statusBadge = '<span class="badge bg-warning" style="font-size: 0.6rem; padding: 2px 4px;">ÃƒÂ¢Ã…Â¡Ã‚Â¡</span>';
        }
        
        return `
            <div class="legend-item" style="border-left-color: ${color};">
                <div style="display: flex; align-items: center; justify-content: space-between; gap: 4px;">
                    <div style="flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        <strong style="font-size: 0.75rem;">${stage.name}</strong>
                    </div>
                    ${statusBadge}
                </div>
                   <small style="font-size: 0.65rem; color: #6c757d;">
                    ${stage.duration_days}d â€¢ ${new Date(stage.start_date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}
                   </small>            
                </div>
        `;
    }).join('');
    
    legendContainer.innerHTML = legendHTML;
}

// âœ… UPDATED: handleReschedule - Add forced refresh
async function handleReschedule(e) {
    e.preventDefault();
    
    const projectId = document.getElementById('rescheduleProjectId').value;
    const stageId = parseInt(document.getElementById('rescheduleStageId').value);
    const days = parseInt(document.getElementById('rescheduleDays').value);
    const reason = document.getElementById('rescheduleReason').value;
    
    if (!days || days === 0) {
        alert('Please enter a valid number of days (not zero)');
        return;
    }
    
    const startDate = new Date(document.getElementById('rescheduleStageStartDate').value);
    const testDate = addWorkingDays(startDate, days);
    const testDay = testDate.getDay();
    
    if (testDay === 0) {
        alert('âš ï¸ Cannot reschedule to Sunday (holiday)');
        return;
    }
    
    if (testDay === 6 && !includeSaturdayAsWorkingDay) {
        alert('âš ï¸ Cannot reschedule to Saturday (holiday).\n\nEnable "Include Saturday as Working Day" if needed.');
        return;
    }
    
    const stageIndex = currentProjectData.stages.findIndex(s => s.id === stageId);
    const hasCompletedBefore = currentProjectData.stages
        .slice(0, stageIndex)
        .some(s => s.status === 'completed');
    
    let confirmMsg = `Are you sure you want to shift this stage by ${days} working days?\n\n`;
    
    if (hasCompletedBefore) {
        confirmMsg += 'âœ… Completed stages will remain unchanged\n';
    }
    confirmMsg += 'âœ… This stage and subsequent stages will be shifted\n';
    confirmMsg += 'âœ… Weekends will be excluded from calculation';
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/projects/${projectId}/reschedule`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                stage_id: stageId,
                days: days,
                reason: reason,
                include_saturday: includeSaturdayAsWorkingDay,
                working_saturdays: Array.from(currentProjectData.saturdayWorkingDays || [])
            })
        });
        
        if (response.ok) {
            showNotification('Stage rescheduled successfully!', 'success');
            rescheduleModal.hide();
            
            // âœ… CRITICAL: Wait for database transaction to fully commit
            console.log('â³ Waiting for database commit (3 seconds)...');
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            // âœ… Force complete calendar rebuild with verified data
            console.log('ðŸ”¨ Starting COMPLETE calendar rebuild...');
            await forceCompleteCalendarRebuild(parseInt(projectId));
            
            // âœ… Refresh main project view
            await loadProjects();
            await loadStats();
            
            // âœ… FORCE CALENDAR REFRESH TO FIX LAYOUT
            console.log('ðŸ”„ Forcing calendar refresh after reschedule...');
            if (calendar) {
                try {
                    calendar.destroy();
                    calendar = null;
                    const calendarEl = document.getElementById('calendar');
                    if (calendarEl) {
                        calendarEl.innerHTML = '';
                        calendarEl.className = '';
                        calendarEl.offsetHeight; // Force reflow
                    }
                    await new Promise(resolve => setTimeout(resolve, 150));
                    await openCalendarView(parseInt(projectId));
                    console.log('âœ… Calendar rebuilt successfully');
                } catch (e) {
                    console.error('Error rebuilding calendar:', e);
                }
            }
            
            showNotification('âœ… Calendar updated successfully!', 'success');
            
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to reschedule'));
        }
    } catch (error) {
        console.error('âŒ Reschedule error:', error);
        alert('Error rescheduling: ' + error.message);
    }
}
// âœ… NEW FUNCTION: Complete calendar rebuild with verification
async function forceCompleteCalendarRebuild(projectId) {
    console.log('ðŸ”¨ Starting COMPLETE calendar rebuild...');
    
    // Step 1: Clear ALL badges
    document.querySelectorAll('.parallel-jobs-badge').forEach(badge => badge.remove());
    console.log('ðŸ§¹ Cleared all badges');
    
    // Step 2: Wait for database
    await new Promise(resolve => setTimeout(resolve, 2000));
    console.log('âœ… Database wait complete');
    
    // Step 3: Fetch FRESH data - MULTIPLE ATTEMPTS
    let freshData = null;
    let attempts = 0;
    const maxAttempts = 3;
    
    while (attempts < maxAttempts && !freshData) {
        attempts++;
        console.log(`ðŸ“¡ Fetch attempt ${attempts}/${maxAttempts}...`);
        
        try {
            const timestamp = Date.now();
            const response = await fetch(`/api/projects/${projectId}/details?_bust=${timestamp}`, {
                method: 'GET',
                cache: 'no-store',
                headers: {
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache'
                }
            });
            
            if (response.ok) {
                freshData = await response.json();
                console.log(`âœ… Got fresh data (attempt ${attempts})`);
                break;
            }
        } catch (error) {
            console.error(`âŒ Fetch attempt ${attempts} failed:`, error);
        }
        
        if (attempts < maxAttempts) {
            await new Promise(resolve => setTimeout(resolve, 500));
        }
    }
    
    if (!freshData) {
        alert('Failed to refresh calendar data');
        return;
    }
    
    // Step 4: Log what we received
    console.log('ðŸ“Š Fresh stage dates from backend:');
    freshData.stages.forEach((s, idx) => {
        console.log(`  ${idx + 1}. ${s.name}: ${s.start_date} â†’ ${s.end_date}`);
    });
    
    // Step 5: Fetch COMPLETE reschedule history (both stage and daily task)
    try {
        const historyResponse = await fetch(`/api/projects/${projectId}/complete-reschedule-history?_t=${timestamp}`);
        if (historyResponse.ok) {
            freshData.rescheduleHistory = await historyResponse.json();
            console.log(`âœ… Loaded ${freshData.rescheduleHistory.length} history records`);
        } else {
            freshData.rescheduleHistory = [];
        }
    } catch (error) {
        console.error('Failed to load history:', error);
        freshData.rescheduleHistory = [];
    }    
    // Step 6: Process saturdayWorkingDays
    if (Array.isArray(freshData.saturdayWorkingDays)) {
        freshData.saturdayWorkingDays = new Set(freshData.saturdayWorkingDays);
    } else {
        freshData.saturdayWorkingDays = new Set();
    }
    
    // Step 7: âœ… CRITICAL - Completely replace currentProjectData
    if (!currentProjectData.rescheduleHistory || currentProjectData.rescheduleHistory.length === 0) {
        console.warn('âš ï¸ WARNING: No reschedule history in currentProjectData!');
        console.log('Attempting to reload history...');
        
        try {
            const historyResponse = await fetch(`/api/projects/${projectId}/complete-reschedule-history?_t=${Date.now()}`);
            if (historyResponse.ok) {
                currentProjectData.rescheduleHistory = await historyResponse.json();
                console.log(`âœ… Reloaded ${currentProjectData.rescheduleHistory.length} history records`);
            }
        } catch (e) {
            console.error('âŒ Failed to reload history:', e);
        }
    } else {
        console.log(`âœ… History verified: ${currentProjectData.rescheduleHistory.length} records`);
    }    
    
    // âœ… NEW: RECALCULATE LAYOUT with fresh data
    console.log('ðŸ“ Recalculating layout with fresh data...');
    const layoutInfo = calculateOptimalCalendarLayout(freshData.stages);
    applyDynamicCalendarStyles(layoutInfo);
    console.log('âœ… Recalculated and applied new layout');
    
    // Step 8: Regenerate calendar events
    console.log('ðŸŽ¨ Generating new calendar events...');
    const newEvents = await generateEnhancedCalendarEvents(currentProjectData.stages);
    console.log(`âœ… Generated ${newEvents.length} events`);
    
    // Step 9: Destroy old calendar
    if (calendar) {
        calendar.destroy();
        console.log('ðŸ—‘ï¸ Old calendar destroyed');
    }
    
    await new Promise(resolve => setTimeout(resolve, 300));
    
    // Step 10: Create NEW calendar
    const calendarEl = document.getElementById('calendar');
    
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        initialDate: currentProjectData.start_date,
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listMonth'
        },
        height: 'auto',
        contentHeight: 'auto',
        eventMaxStack: layoutInfo.maxStagesPerDay + 2,  // âœ… DYNAMIC: Adjust based on layout complexity
        dayMaxEvents: false,
        dayMaxEventRows: false,
        // âœ… CRITICAL FIX: Use function instead of static array so refetchEvents() works
        events: async function(fetchInfo, successCallback, failureCallback) {
            try {
                console.log('ðŸ”„ Fetching fresh calendar events...');
                const freshEvents = await generateEnhancedCalendarEvents(currentProjectData.stages);
                console.log('âœ… Generated', freshEvents.length, 'events');
                successCallback(freshEvents);
            } catch (error) {
                console.error('âŒ Error generating events:', error);
                failureCallback(error);
            }
        },
        editable: true,  // Enable drag and drop editing
        eventClick: function(info) {
            if (info.event.extendedProps.isGhost) {
                const props = info.event.extendedProps;
                alert(
                    `Original Location\n\n` +
                    `Stage: ${props.stageName}\n` +
                    `Moved ${props.daysShifted} day(s) ${props.direction}\n` +
                    `New location: ${new Date(props.movedTo).toLocaleDateString()}`
                );
                return;
            }
            handleStageClickReschedule(info, currentProjectData);
        },
        // âœ… FIX: Handle event drag/drop - refresh calendar layout
        eventDrop: async function(info) {
            console.log('ðŸ“Œ Event dropped, updating layout...');
            try {
                // âœ… Reload fresh project data
                const response = await fetch(`/api/projects/${currentProjectData.id}/details?_t=${Date.now()}`, {
                    cache: 'no-store',
                    headers: {'Cache-Control': 'no-cache'}
                });
                if (response.ok) {
                    const freshData = await response.json();
                    currentProjectData.stages = freshData.stages;
                    
                    // âœ… RECALCULATE AND REAPPLY LAYOUT
                    const newLayoutInfo = calculateOptimalCalendarLayout(freshData.stages);
                    applyDynamicCalendarStyles(newLayoutInfo);
                    
                    console.log('âœ… Loaded fresh project data');
                }
                
                // âœ… CRITICAL: Refresh the calendar to fix layout
                setTimeout(() => {
                    if (calendar) {
                        calendar.refetchEvents();
                        calendar.updateSize();
                        calendar.render();
                        console.log('âœ… Calendar layout refreshed after drop');
                    }
                }, 100);
            } catch (error) {
                console.error('Error updating event:', error);
                info.revert();
            }
        },
        // âœ… FIX: Handle event resize - refresh calendar layout
        eventResize: async function(info) {
            console.log('ðŸ“ Event resized, updating layout...');
            try {
                // âœ… Reload fresh project data
                const response = await fetch(`/api/projects/${currentProjectData.id}/details?_t=${Date.now()}`, {
                    cache: 'no-store',
                    headers: {'Cache-Control': 'no-cache'}
                });
                if (response.ok) {
                    const freshData = await response.json();
                    currentProjectData.stages = freshData.stages;
                    
                    // âœ… RECALCULATE AND REAPPLY LAYOUT
                    const newLayoutInfo = calculateOptimalCalendarLayout(freshData.stages);
                    applyDynamicCalendarStyles(newLayoutInfo);
                    
                    console.log('âœ… Loaded fresh project data');
                }
                
                // âœ… CRITICAL: Refresh the calendar to fix layout
                setTimeout(() => {
                    if (calendar) {
                        calendar.refetchEvents();
                        calendar.updateSize();
                        calendar.render();
                        console.log('âœ… Calendar layout refreshed after resize');
                    }
                }, 100);
            } catch (error) {
                console.error('Error updating event:', error);
                info.revert();
            }
        },
        dayCellDidMount: function(info) {
            addDayRescheduleButton(info, currentProjectData);
        },
        eventDisplay: 'block',
        displayEventTime: false,
        eventDidMount: function(info) {
            enhanceEventDisplay(info);
        }
    });
    
    calendar.render();
    console.log('ðŸŽ¬ New calendar rendered');
    
    // Step 12: Wait for DOM
    await new Promise(resolve => setTimeout(resolve, 1000));

    console.log('ðŸŽ‰ Calendar rebuild COMPLETE!');
}

function adjustRescheduleDays(delta) {
        const input = document.getElementById('rescheduleDays');
        const currentValue = parseInt(input.value) || 0;
        input.value = currentValue + delta;
        updateReschedulePreview();
    }

    function updateReschedulePreview() {
        const days = parseInt(document.getElementById('rescheduleDays').value);
        
        if (!days || days === 0) {
            document.getElementById('rescheduleNewDatesPreview').style.display = 'none';
            document.getElementById('rescheduleImpactWarning').style.display = 'none';
            return;
        }
        
        const startDate = new Date(document.getElementById('rescheduleStageStartDate').value);
        const endDate = new Date(document.getElementById('rescheduleStageEndDate').value);
        
        const newStart = addWorkingDays(startDate, days);
        const newEnd = addWorkingDays(endDate, days);
        
        document.getElementById('rescheduleNewDatesValue').textContent = 
            `${newStart.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})} - ${newEnd.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}`;
        document.getElementById('rescheduleNewDatesPreview').style.display = 'block';
        
        const impactText = days > 0 
            ? `All subsequent stages will be pushed forward by ${days} working day(s)`
            : `All subsequent stages will be pulled backward by ${Math.abs(days)} working day(s)`;
        document.getElementById('rescheduleImpactText').textContent = impactText;
        document.getElementById('rescheduleImpactWarning').style.display = 'block';
    }

function enhanceCalendarWithWeekends() {
    if (!calendar) return;
    
    // Ensure working Saturdays is initialized
    if (!currentProjectData.saturdayWorkingDays) {
        currentProjectData.saturdayWorkingDays = new Set();
    }
    
    // Get the current dayCellDidMount handler
    const oldDayCellDidMount = calendar.getOption('dayCellDidMount');
    
    // Override with enhanced version
    calendar.setOption('dayCellDidMount', function(info) {
        const day = info.date.getDay();
        const dateKey = info.date.toISOString().split('T')[0];
        
        // Handle Sundays (day 0)
        if (day === 0) {
            info.el.style.background = 'linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%)';
            info.el.style.opacity = '0.7';
            info.el.title = 'Sunday - Holiday';
        }
        
        // Handle Saturdays (day 6) - always holiday, no toggle
        if (day === 6) {
            info.el.style.background = 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)';
            info.el.style.opacity = '0.7';
            info.el.title = 'Saturday - Holiday';
        }
        
        // Call original handler if it exists
        if (oldDayCellDidMount) {
            oldDayCellDidMount(info);
        }
        
        // Add reschedule button
        addDayRescheduleButton(info, currentProjectData);
    });
    
    // Force calendar to re-render with new dayCellDidMount
    calendar.render();
}
    // UPDATED FUNCTION: Toggle Saturday working status with recalculation
async function recalculateProjectWithSaturdays() {
    if (!currentProjectData) return;
    
    try {
        // Send update to backend
        const response = await fetch(`/api/projects/${currentProjectData.id}/update-saturdays`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                working_saturdays: Array.from(currentProjectData.saturdayWorkingDays || [])
            })
        });
        
        if (response.ok) {
            // Wait for DB to update
            await new Promise(resolve => setTimeout(resolve, 200));
            
            // Fetch fresh data
            const detailsResponse = await fetch(`/api/projects/${currentProjectData.id}/details?_t=${Date.now()}`, {
                cache: 'no-store',
                headers: {'Cache-Control': 'no-cache'}
            });
            const freshData = await detailsResponse.json();
            
            // Update current data
            currentProjectData = freshData;
            
            // Ensure Set conversion
            if (Array.isArray(freshData.saturdayWorkingDays)) {
                currentProjectData.saturdayWorkingDays = new Set(freshData.saturdayWorkingDays);
            }
            
            // COMPLETE calendar regeneration
            const calendarEl = document.getElementById('calendar');
            calendarEl.innerHTML = '';
            
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                initialDate: currentProjectData.start_date,
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,listMonth'
                },
                events: generateEnhancedCalendarEvents(currentProjectData.stages),
                eventClick: function(info) {
                    handleStageClickReschedule(info, currentProjectData);
                },
                dayCellDidMount: function(info) {
                    addDayRescheduleButton(info, currentProjectData);
                },
                height: 'auto',
                eventDisplay: 'block',
                displayEventTime: false,
                eventDidMount: function(info) {
                    enhanceEventDisplay(info);
                }
            });
            
            calendar.render();
            enhanceCalendarWithWeekends(); // CRITICAL: Call after render
            generateEnhancedLegend(currentProjectData.stages);
            
            await loadProjects(); // Refresh main view
            
            showNotification('Schedule recalculated!', 'success');
        }
    } catch (error) {
        console.error('Recalculation error:', error);
        showNotification('Failed to update: ' + error.message, 'error');
    }
}

// Helper function to show notifications
    function showNotification(message, type = 'success') {
        const bgColors = {
            success: '#28a745',
            info: '#17a2b8',
            warning: '#ffc107',
            error: '#dc3545'
        };
        
        const bgColor = bgColors[type] || bgColors.success;
        
        const notification = document.createElement('div');
        notification.className = 'alert alert-dismissible fade show position-fixed';
        notification.style.cssText = `top: 20px; right: 20px; z-index: 9999; min-width: 300px; background: ${bgColor}; color: white; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3);`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }

async function openDailyTaskManager(projectId, stageId, stageName) {
    currentStageForDailyTasks = { projectId, stageId };
    
    document.getElementById('dailyTaskModalTitle').textContent = 'Manage Daily Tasks';
    document.getElementById('dailyTaskStageName').textContent = `Stage: ${stageName}`;
    
    try {
        const response = await fetch(`/api/projects/${projectId}/stages/${stageId}/daily-tasks`);
        const tasks = await handleApiResponse(response);  // âœ… CHANGED THIS LINE
        
        if (tasks.length === 0) {
            console.log('No tasks found, generating...');
            await generateDailyTasks(projectId);
            
            const retryResponse = await fetch(`/api/projects/${projectId}/stages/${stageId}/daily-tasks`);
            const retryTasks = await handleApiResponse(retryResponse);  // âœ… CHANGED THIS LINE
            renderDailyTasks(retryTasks);
        } else {
            renderDailyTasks(tasks);
        }
        
        dailyTaskModal.show();
    } catch (error) {
        console.error('Error loading daily tasks:', error);
        if (error.message !== 'Session expired') {
            alert(`Error loading daily tasks: ${error.message}`);
        }
    }
}
// Generate daily tasks for project
async function generateDailyTasks(projectId) {
    const response = await fetch(`/api/projects/${projectId}/generate-daily-tasks`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    });
    
    if (!response.ok) {
        throw new Error('Failed to generate daily tasks');
    }
}


// Helper function to check if task date is today or in the past
function isTaskDateInPast(scheduledDate) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const taskDate = new Date(scheduledDate);
    taskDate.setHours(0, 0, 0, 0);
    
    return taskDate <= today;
}

// Render daily tasks
function renderDailyTasks(tasks) {
    const container = document.getElementById('dailyTasksList');
    
    if (tasks.length === 0) {
        container.innerHTML = '<p class="text-center text-muted">No daily tasks available</p>';
        return;
    }
    
    container.innerHTML = tasks.map(task => {
        const statusClass = task.status === 'completed' ? 'completed' : task.is_rescheduled ? 'rescheduled' : '';
        const statusBadge = task.status === 'completed' ? 'badge-completed' : 
                           task.status === 'rescheduled' ? 'badge-rescheduled' : 'badge-pending';
        
        let dateDisplay = new Date(task.scheduled_date).toLocaleDateString('en-US', {
            weekday: 'short',
            month: 'short',
            day: 'numeric',
            year: 'numeric'
        });
        
        let rescheduleInfo = '';
        if (task.is_rescheduled) {
            const originalDate = new Date(task.original_date).toLocaleDateString('en-US', { 
                weekday: 'short',
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            });
            const currentDate = new Date(task.scheduled_date);
            const origDate = new Date(task.original_date);
            const daysDiff = Math.round((currentDate - origDate) / (1000 * 60 * 60 * 24));
            const direction = daysDiff > 0 ? 'forward' : 'backward';
            
            rescheduleInfo = `
                <div class="reschedule-indicator mt-2 p-2" style="background: #fff3cd; border-left: 4px solid #ff9800; border-radius: 6px;">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-exchange-alt me-2 mt-1" style="color: #ff9800;"></i>
                        <div style="flex: 1;">
                            <div class="mb-1">
                                <strong style="color: #ff6b00;">Rescheduled</strong>
                                <span class="badge bg-warning text-dark ms-2">${Math.abs(daysDiff)} day(s) ${direction}</span>
                            </div>
                            <small class="text-muted d-block">Original: ${originalDate}</small>
                            ${task.rescheduled_reason ? `
                                <small class="d-block mt-1" style="color: #495057;">
                                    <i class="fas fa-comment-dots me-1"></i>
                                    <strong>Reason:</strong> ${task.rescheduled_reason}
                                </small>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        return `
            <div class="daily-task-item ${statusClass}">
                <div class="task-day-number ${task.status === 'completed' ? 'completed' : ''}">
                    ${task.status === 'completed' ? '<i class="fas fa-check"></i>' : `Day ${task.day_number}`}
                </div>
                <div class="task-info flex-grow-1">
                    <div class="d-flex align-items-center justify-content-between mb-1">
                        <div class="task-date-display fw-bold">${dateDisplay}</div>
                        <span class="task-status-badge ${statusBadge}">${task.status.toUpperCase()}</span>
                    </div>
                    ${rescheduleInfo}
                </div>
            <div class="d-flex gap-2 align-items-start">
                    ${task.status !== 'completed' && task.status !== 'hold' ? `
                        ${isTaskDateInPast(task.scheduled_date) ? `
                            <button class="btn btn-sm btn-success" onclick="completeDailyTask(${task.id}, ${currentStageForDailyTasks.projectId}, ${currentStageForDailyTasks.stageId})" title="Mark as complete">
                                <i class="fas fa-check me-1"></i>Complete
                            </button>
                        ` : `
                            <button class="btn btn-sm btn-secondary" disabled title="Cannot complete future tasks">
                                <i class="fas fa-lock me-1"></i>Future Task
                            </button>
                        `}
                        <button class="btn btn-sm btn-primary-custom" onclick="openRescheduleDayModal(${task.id}, ${task.day_number}, '${task.scheduled_date}')" title="Change schedule">
                            <i class="fas fa-calendar-alt me-1"></i>Reschedule
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="holdDailyTask(${task.id}, ${currentStageForDailyTasks.projectId}, ${currentStageForDailyTasks.stageId})" title="Put on hold">
                            <i class="fas fa-lock me-1"></i>Hold
                        </button>
                    ` : task.status === 'hold' ? `
                        <div class="text-center">
                            <span class="text-warning d-block">
                                <i class="fas fa-lock me-1"></i>
                                ON HOLD
                            </span>
                        </div>
                    ` : `
                        <div class="text-center">
                            <span class="text-success d-block">
                                <i class="fas fa-check-circle me-1"></i>
                                Completed
                            </span>
                            ${task.completed_at ? `
                                <small class="text-muted">${new Date(task.completed_at).toLocaleDateString('en-US', {month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'})}</small>
                            ` : ''}
                        </div>
                    `}
                </div>            
             </div>
        `;
    }).join('');
}
// Complete a daily task
async function completeDailyTask(taskId, projectId, stageId) {
    if (!confirm('Mark this day as completed?')) return;
    
    try {
        const response = await fetch(`/api/projects/${projectId}/stages/${stageId}/daily-tasks/${taskId}/complete`, {
            method: 'PUT'
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            showNotification('Day marked as completed!', 'success');
            
            // Show if stage was automatically completed
            if (data.stage_completed) {
                showNotification(`ðŸŽ‰ All daily tasks completed! Stage marked as complete (${data.completed_tasks}/${data.total_tasks})`, 'success');
            }
            
            // âœ… Wait for database commit
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Reload tasks in modal
            const tasksResponse = await fetch(`/api/projects/${projectId}/stages/${stageId}/daily-tasks`);
            const tasks = await tasksResponse.json();
            renderDailyTasks(tasks);
            
            // âœ… Refresh calendar in background
            if (calendar && currentProjectForCalendar === projectId) {
                await refreshCalendarEvents();
            }
            
            // âœ… Update progress line status
            await updateProgressLineStatus(projectId);
        } else {
            // Show error message from server
            showNotification(data.error || 'Failed to complete task', 'error');
        }
    } catch (error) {
        console.error('Error completing task:', error);
        showNotification('Error: ' + error.message, 'error');
    }
}
// Open reschedule day modal
function openRescheduleDayModal(taskId, dayNumber, currentDate) {
    document.getElementById('rescheduleTaskId').value = taskId;
    document.getElementById('rescheduleTaskProjectId').value = currentStageForDailyTasks.projectId;
    document.getElementById('rescheduleTaskStageId').value = currentStageForDailyTasks.stageId;
    document.getElementById('dayShiftAmount').value = 0;
    document.getElementById('dayRescheduleReason').value = '';
    document.getElementById('dayReschedulePreview').style.display = 'none';
    
    const dateStr = new Date(currentDate).toLocaleDateString('en-US', {
        weekday: 'long',
        month: 'long',
        day: 'numeric',
        year: 'numeric'
    });
    
    document.getElementById('dayRescheduleInfo').innerHTML = `
        <strong>Day ${dayNumber}</strong><br>
        Current date: ${dateStr}
    `;
    
    rescheduleDayModal.show();
}

// Adjust day shift
function adjustDayShift(delta) {
    const input = document.getElementById('dayShiftAmount');
    input.value = parseInt(input.value || 0) + delta;
    updateDayReschedulePreview();
}

// Update preview
function updateDayReschedulePreview() {
    const days = parseInt(document.getElementById('dayShiftAmount').value || 0);
    const preview = document.getElementById('dayReschedulePreview');
    
    if (days === 0) {
        preview.style.display = 'none';
        return;
    }
    
    preview.style.display = 'block';
    preview.textContent = `This day will be shifted ${Math.abs(days)} working day(s) ${days > 0 ? 'forward' : 'backward'}`;
}


// Confirm day reschedule
async function confirmDayReschedule() {
    const taskId = document.getElementById('rescheduleTaskId').value;
    const projectId = document.getElementById('rescheduleTaskProjectId').value;
    const stageId = document.getElementById('rescheduleTaskStageId').value;
    const days = parseInt(document.getElementById('dayShiftAmount').value || 0);
    const reason = document.getElementById('dayRescheduleReason').value;
    
    if (days === 0) {
        alert('Please enter a number of days to shift');
        return;
    }
    
    try {
        console.log('ðŸ”„ Rescheduling daily task...');
        
        const response = await fetch(`/api/projects/${projectId}/stages/${stageId}/daily-tasks/${taskId}/reschedule`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                days: days,
                reason: reason,
                working_saturdays: Array.from(currentProjectData?.saturdayWorkingDays || [])
            })
        });
        
        if (response.ok) {
            showNotification('âœ… Day rescheduled successfully!', 'success');
            
            // Close the reschedule day modal
            rescheduleDayModal.hide();
            
            // âœ… CRITICAL: Wait LONGER for database transaction to FULLY commit
            console.log('â³ Waiting for database commit (4 seconds)...');
            await new Promise(resolve => setTimeout(resolve, 4000));
            
            console.log('ðŸ”¥ Fetching updated task list...');
            
            // Reload tasks in the daily task modal
            const tasksResponse = await fetch(`/api/projects/${projectId}/stages/${stageId}/daily-tasks?_t=${Date.now()}`, {
                cache: 'no-store',
                headers: { 'Cache-Control': 'no-cache' }
            });
            const tasks = await tasksResponse.json();
            renderDailyTasks(tasks);
            
            console.log('âœ… Task list updated');
            
            // âœ… Close the daily task modal so user can see the calendar
            console.log('ðŸ“Š Closing daily task modal...');
            dailyTaskModal.hide();
            
            // âœ… Additional wait before calendar rebuild
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // âœ… Force COMPLETE calendar rebuild with ALL history
            if (calendar && currentProjectForCalendar === parseInt(projectId)) {
                showNotification('ðŸ”„ Rebuilding calendar with ghost events...', 'info');
                
                console.log('ðŸ”¨ Starting calendar rebuild...');
                
                // âœ… CRITICAL: Fetch history FIRST before rebuild
                try {
                    const timestamp = Date.now();
                    const historyResponse = await fetch(`/api/projects/${projectId}/complete-reschedule-history?_t=${timestamp}`, {
                        cache: 'no-store',
                        headers: { 
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache'
                        }
                    });
                    
                    if (historyResponse.ok) {
                        const historyData = await historyResponse.json();
                        console.log(`ðŸ“œ Loaded ${historyData.length} history records (including daily tasks)`);
                        
                        // Update currentProjectData with fresh history
                        if (!currentProjectData) {
                            console.error('âŒ currentProjectData is null!');
                        } else {
                            currentProjectData.rescheduleHistory = historyData;
                            console.log('âœ… Updated currentProjectData.rescheduleHistory');
                        }
                    } else {
                        console.warn('âš ï¸ Failed to fetch history:', historyResponse.status);
                    }
                } catch (error) {
                    console.error('âŒ Error fetching history:', error);
                }
                
                // Now rebuild calendar with updated history
                await forceCompleteCalendarRebuild(parseInt(projectId));
                
                // âœ… FORCE CALENDAR REFRESH TO FIX LAYOUT
                console.log('ðŸ”„ Forcing calendar refresh after day reschedule...');
                if (calendar) {
                    try {
                        calendar.destroy();
                        calendar = null;
                        const calendarEl = document.getElementById('calendar');
                        if (calendarEl) {
                            calendarEl.innerHTML = '';
                            calendarEl.className = '';
                            calendarEl.offsetHeight; // Force reflow
                        }
                        await new Promise(resolve => setTimeout(resolve, 150));
                        await openCalendarView(parseInt(projectId));
                        console.log('âœ… Calendar rebuilt successfully');
                    } catch (e) {
                        console.error('Error rebuilding calendar:', e);
                    }
                }
                
                showNotification('âœ… Calendar updated! Ghost event shows original location.', 'success');
            } else {
                console.warn('âš ï¸ Calendar not available for rebuild');
            }
        } else {
            const error = await response.json();
            alert('Error: ' + error.error);
        }
    } catch (error) {
        console.error('âŒ Reschedule error:', error);
        alert('Error: ' + error.message);
    }
}


// Hold a daily task
async function holdDailyTask(taskId, projectId, stageId) {
    const reason = prompt('Reason for putting this day on hold:');
    if (reason === null) return; // User cancelled
    
    if (!confirm('Are you sure you want to put this day on HOLD? Other days will continue as scheduled.')) {
        return;
    }
    
    try {
        console.log('ðŸ”’ Putting daily task on HOLD...');
        
        const response = await fetch(`/api/projects/${projectId}/stages/${stageId}/daily-tasks/${taskId}/hold`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                reason: reason || 'Put on hold',
                working_saturdays: Array.from(currentProjectData?.saturdayWorkingDays || [])
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('âœ… Day marked as HOLD successfully', 'success');
            
            // Wait for database commit
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Reload tasks in the daily task modal
            const tasksResponse = await fetch(`/api/projects/${projectId}/stages/${stageId}/daily-tasks?_t=${Date.now()}`, {
                cache: 'no-store',
                headers: { 'Cache-Control': 'no-cache' }
            });
            const tasks = await tasksResponse.json();
            renderDailyTasks(tasks);
            
            // Rebuild calendar
            if (calendar && currentProjectForCalendar === projectId) {
                showNotification('ðŸ”„ Updating calendar...', 'info');
                await refreshCalendarEvents();
                showNotification('âœ… Calendar updated!', 'success');
            }
        } else {
            alert('Error: ' + (result.error || 'Failed to hold day'));
        }
    } catch (error) {
        console.error('âŒ Hold error:', error);
        alert('Error: ' + error.message);
    }
}

// âœ… NEW FUNCTION: Refresh calendar events without closing/reopening modal
async function refreshCalendarEvents() {
    if (!calendar || !currentProjectData) {
        console.log('âš ï¸ Cannot refresh calendar: calendar or data missing');
        return;
    }
    
    try {
        console.log('ðŸ”„ Refreshing calendar events...');
        
        // âœ… CRITICAL: Fetch COMPLETE reschedule history
        const timestamp = Date.now();
        const historyResponse = await fetch(`/api/projects/${currentProjectData.id}/complete-reschedule-history?_t=${timestamp}`, {
            cache: 'no-store',
            headers: { 'Cache-Control': 'no-cache', 'Pragma': 'no-cache' }
        });
        
        if (historyResponse.ok) {
            currentProjectData.rescheduleHistory = await historyResponse.json();
            console.log('âœ… Loaded reschedule history:', currentProjectData.rescheduleHistory.length, 'records');
        } else {
            console.warn('âš ï¸ Failed to load history');
            currentProjectData.rescheduleHistory = [];
        }
        
        // Fetch fresh project data
        const response = await fetch(`/api/projects/${currentProjectData.id}/details?_t=${timestamp}`, {
            cache: 'no-store',
            headers: { 'Cache-Control': 'no-cache', 'Pragma': 'no-cache' }
        });
        const freshData = await response.json();
        
        // Update saturdayWorkingDays
        if (Array.isArray(freshData.saturdayWorkingDays)) {
            freshData.saturdayWorkingDays = new Set(freshData.saturdayWorkingDays);
        }
        
        // âœ… PRESERVE reschedule history
        freshData.rescheduleHistory = currentProjectData.rescheduleHistory;
        
        currentProjectData = freshData;
        
        // Generate new events from fresh data (including ghost events)
        const newEvents = await generateEnhancedCalendarEvents(freshData.stages);
        
        console.log('ðŸ“Š Generated events:', newEvents.length, 'total');
        console.log('ðŸ‘» Ghost events:', newEvents.filter(e => e.classNames?.includes('ghost-event')).length);
        
        // Remove all old events
        calendar.removeAllEvents();
        
        // Wait a tick
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Add new events
        newEvents.forEach(event => {
            calendar.addEvent(event);
        });
        
        // Refresh display
        calendar.render();
                
        console.log('âœ… Calendar refreshed successfully');
        
    } catch (error) {
        console.error('Error refreshing calendar:', error);
    }
}

// Complete calendar refresh with FORCED data reload
async function refreshCalendarWithBadges() {
    if (!calendar || !currentProjectData) {
        console.log('âš ï¸ Cannot refresh calendar: calendar or data missing');
        return;
    }
    
    try {
        console.log('ðŸ”„ Starting calendar refresh...');
        
        const projectId = currentProjectData.id;
        
        // âœ… Wait for database commit
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // âœ… Fetch fresh data with cache busting
        const timestamp = Date.now();
        const detailsUrl = `/api/projects/${projectId}/details?_t=${timestamp}&_bustCache=${Math.random()}`;
        
        const response = await fetch(detailsUrl, {
            cache: 'no-store',
            headers: {
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to fetch: ${response.status}`);
        }
        
        const freshData = await response.json();
        console.log('âœ… Fresh data received:', freshData.stages.length, 'stages');
        
        // Fetch reschedule history
        const historyUrl = `/api/projects/${projectId}/reschedule-history?_t=${timestamp}`;
        const historyResponse = await fetch(historyUrl, {
            cache: 'no-store',
            headers: { 'Cache-Control': 'no-cache', 'Pragma': 'no-cache' }
        });
        
        if (historyResponse.ok) {
            freshData.rescheduleHistory = await historyResponse.json();
        } else {
            freshData.rescheduleHistory = [];
        }
        
        // Convert saturdayWorkingDays
        if (Array.isArray(freshData.saturdayWorkingDays)) {
            freshData.saturdayWorkingDays = new Set(freshData.saturdayWorkingDays);
        } else {
            freshData.saturdayWorkingDays = new Set();
        }
        
        // âœ… Update currentProjectData
        currentProjectData = freshData;
        
        // âœ… CRITICAL FIX: Clear ALL badges BEFORE any calendar operations
        document.querySelectorAll('.parallel-jobs-badge').forEach(badge => badge.remove());
        
        // âœ… Regenerate events
        const newEvents = await generateEnhancedCalendarEvents(currentProjectData.stages);
        console.log('ðŸŽ¯ Generated', newEvents.length, 'events');
        
        // âœ… Remove old events
        calendar.removeAllEvents();
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // âœ… Add new events
        newEvents.forEach(event => calendar.addEvent(event));
        
        // âœ… CRITICAL: Force calendar to fully re-render
        calendar.render();
        
        // âœ… Wait for render to complete
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // âœ… NOW recalculate badges with fresh DOM
        console.log('ðŸ·ï¸ Recalculating badges with updated stage positions...');
        
        // Clear again just to be safe
        document.querySelectorAll('.parallel-jobs-badge').forEach(badge => badge.remove());
        
        // âœ… IMPROVED: Recalculate badges with the UPDATED stage data
        recalculateBadgesWithFreshData();
        
        // âœ… Do additional refreshes to ensure accuracy
        
        console.log('âœ… Calendar refresh complete');
        
    } catch (error) {
        console.error('âŒ Error:', error);
        showNotification('Failed to refresh: ' + error.message, 'error');
    }
}

function createStageEventWithStatus(stage, index, start, end, color, dateStageMap, tasks, stageHasRescheduled, stageRescheduleHistory = null) {
    // Check for parallel stages
    let hasParallel = false;
    let parallelCount = 0;
    
    for (let d = new Date(start); d < end; d.setDate(d.getDate() + 1)) {
        const dateKey = d.toISOString().split('T')[0];
        const stagesOnDate = dateStageMap.get(dateKey) || [];
        if (stagesOnDate.length > 1) {
            hasParallel = true;
            parallelCount = Math.max(parallelCount, stagesOnDate.length);
        }
    }
    
    // Analyze task statuses
    const allCompleted = tasks.every(t => t.status === 'completed');
    const someCompleted = tasks.some(t => t.status === 'completed');
    const hasRescheduled = tasks.some(t => t.reschedule_count && t.reschedule_count > 0);
    const completedCount = tasks.filter(t => t.status === 'completed').length;
    const rescheduledCount = tasks.filter(t => t.reschedule_count && t.reschedule_count > 0).length;
    
    let title = stage.name;
    
    // Build clean tooltip
    let tooltip = `${stage.name}\n`;
    tooltip += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    tooltip += `ðŸ“… Duration: ${stage.duration_days} days\n`;
    tooltip += `ðŸ“Š Status: ${stage.status}\n`;    

    if (completedCount > 0) {
        tooltip += `âœ… Completed: ${completedCount}/${tasks.length} days\n`;
    }
    
    if (rescheduledCount > 0) {
        tooltip += `ðŸ”„ Rescheduled: ${rescheduledCount} day(s)\n`;
    }
    
    if (hasParallel) {
        tooltip += `âš¡ï¸ Parallel with ${parallelCount - 1} other stage(s)`;
    }
    
    const classNames = [];
    
    if (allCompleted) {
        classNames.push('event-completed');
    } else if (hasRescheduled) {
        classNames.push('event-rescheduled');
    }
    
    if (stageHasRescheduled) {
        classNames.push('stage-rescheduled');
    }
    
    if (stage.status === 'in-progress') {
        classNames.push('stage-event-active');
    }
    // âœ… Check if any task in this stage is on HOLD
    const hasHoldTask = tasks.some(t => t.status === 'hold');
    if (hasHoldTask) {
        classNames.push('event-hold');
    }

    
    // âœ… Build extended props with reschedule info
    const extendedProps = {
        stageId: stage.id,
        stageIndex: index,
        duration: stage.duration_days,
        status: stage.status,
        hasParallel: hasParallel,
        parallelCount: parallelCount,
        stageName: stage.name,
        allCompleted: allCompleted,
        hasRescheduled: hasRescheduled,
        completedCount: completedCount,
        rescheduledCount: rescheduledCount,
        totalTasks: tasks.length
    };
    
    // âœ… Add reschedule information if available
    if (stageRescheduleHistory) {
        extendedProps.wasRescheduled = true;
        extendedProps.daysShifted = stageRescheduleHistory.days_shifted || 
            Math.abs(Math.round((new Date(stageRescheduleHistory.new_date) - new Date(stageRescheduleHistory.original_date)) / (1000 * 60 * 60 * 24)));
        extendedProps.rescheduleDirection = stageRescheduleHistory.direction || 
            (new Date(stageRescheduleHistory.new_date) > new Date(stageRescheduleHistory.original_date) ? 'forward' : 'backward');
        extendedProps.rescheduleBadge = `${extendedProps.rescheduleDirection === 'forward' ? '+' : '-'}${extendedProps.daysShifted}d`;
        extendedProps.originalDate = stageRescheduleHistory.original_date;
    }
    
    return {
        title: title,
        start: start.toISOString().split('T')[0],
        end: end.toISOString().split('T')[0],
        backgroundColor: color,
        borderColor: color,
        extendedProps: extendedProps,
        classNames: classNames
    };
}

// UPDATED showExcelPreview function - EXACTLY matches Excel export
async function showExcelPreview(projectId) {
    try {
        showNotification('Loading Excel preview...', 'info');
        
        // âœ… Fetch project details which includes stages
        const projResponse = await fetch(`/api/projects/${projectId}/details`);
        const projData = await projResponse.json();
        
        if (!projData || !projData.id) {
            throw new Error('Project not found');
        }
        
        console.log('âœ… Project data loaded:', projData);
        console.log('âœ… Stages found:', projData.stages?.length || 0);
        
        // âœ… Fetch reschedule history
        let rescheduleHistory = [];
        try {
            const historyResponse = await fetch(`/api/projects/${projectId}/complete-reschedule-history`);
            rescheduleHistory = historyResponse.ok ? await historyResponse.json() : [];
            console.log('âœ… Reschedule history loaded:', rescheduleHistory.length, 'records');
        } catch (error) {
            console.warn('âš ï¸ Could not load reschedule history:', error);
        }
        
        // âœ… Fetch daily tasks (for actual completion data) - MATCHING BACKEND
        let dailyTasks = [];
        try {
            const dailyTasksResponse = await fetch(`/api/projects/${projectId}/daily-tasks`);
            dailyTasks = dailyTasksResponse.ok ? await dailyTasksResponse.json() : [];
            console.log('âœ… Daily tasks loaded:', dailyTasks.length, 'tasks');
        } catch (error) {
            console.warn('âš ï¸ Could not load daily tasks:', error);
        }
        
        const startDate = new Date(projData.start_date);
        const endDate = new Date(projData.end_date);
        const allDates = [];
        
        let currentDate = new Date(startDate);
        while (currentDate <= endDate) {
            allDates.push(new Date(currentDate));
            currentDate.setDate(currentDate.getDate() + 1);
        }
        
        const stages = projData.stages || [];
        const workingSaturdays = new Set(projData.saturdayWorkingDays || []);
        console.log('Working Saturdays:', workingSaturdays);
        
        // Build Excel-like preview
        let html = '<div style="overflow: auto; max-height: 75vh; background: white; padding: 15px; font-family: Calibri, Arial, sans-serif;">';
        html += '<table style="border-collapse: collapse; font-size: 11px; table-layout: auto;">';
        
        // ==========================================
        // STAGE DETAILS SECTION (5-column table at top)
        // ==========================================
        if (stages.length > 0) {
            const stageNames = stages.map(s => {
                const parts = s.name.split('-');
                if (parts.length >= 2) {
                    const category = parts.slice(0, -1).join('-').trim();
                    const abbr = parts[parts.length - 1].trim();
                    return `${category} -${abbr}`;
                }
                return s.name;
            });
            
            let stageIdx = 0;
            while (stageIdx < stageNames.length) {
                html += '<tr>';
                for (let col = 0; col < 5; col++) {
                    if (stageIdx < stageNames.length) {
                        html += `<td style="border: 1px solid #000; padding: 8px; background: white; font-weight: bold; font-size: 10px; min-width: 180px;">${stageNames[stageIdx]}</td>`;
                        stageIdx++;
                    } else {
                        html += '<td style="border: 1px solid #000; padding: 8px; background: white; min-width: 180px;"></td>';
                    }
                }
                html += '</tr>';
            }
            
            html += '<tr><td colspan="5" style="border: none; height: 20px;"></td></tr>';
        }
        
        // ==========================================
        // MAIN SCHEDULE TABLE
        // ==========================================
        
        // Headers
        html += '<tr>';
        html += `<td rowspan="2" style="border: 1px solid #000; padding: 8px; background: #B4C7E7; font-weight: bold; font-size: 12px; text-align: center; vertical-align: middle; min-width: 180px;">${projData.name}</td>`;
        html += '<td rowspan="2" style="border: 1px solid #000; padding: 8px; background: #B4C7E7; font-weight: bold; font-size: 11px; text-align: center; vertical-align: middle; min-width: 150px;">Date</td>';
        
        const monthYear = startDate.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
        html += `<td colspan="${allDates.length}" style="border: 1px solid #000; padding: 8px; background: #FFA500; font-weight: bold; font-size: 11px; text-align: center;">${monthYear}</td>`;
        html += '</tr>';
        
        // Day numbers
        html += '<tr>';
        allDates.forEach(date => {
            html += `<td style="border: 1px solid #000; padding: 6px; background: #B4C7E7; font-weight: bold; font-size: 11px; text-align: center; min-width: 50px;">${date.getDate()}</td>`;
        });
        html += '</tr>';
        
        // ==========================================
        // PLANNED ROW - Build from stage dates
        // ==========================================
        html += '<tr style="height: 40px;">';
        html += '<td style="border: 1px solid #000; padding: 8px;"></td>';
        html += '<td style="border: 1px solid #000; padding: 8px; font-weight: bold; text-align: center;">Planned</td>';
        
        const plannedMap = {};
        
        stages.forEach(stage => {
            if (stage.start_date && stage.end_date) {
                const parts = stage.name.split('-');
                const abbr = parts.length > 1 ? parts[parts.length - 1].trim() : stage.name.substring(0, 6);
                
                let d = new Date(stage.start_date);
                const endD = new Date(stage.end_date);
                
                while (d <= endD) {
                    const dayOfWeek = d.getDay();
                    const dateStr = d.toISOString().split('T')[0];
                    const isSaturday = dayOfWeek === 6;
                    const isWorkingSaturday = isSaturday && workingSaturdays.has(dateStr);
                    
                    // Include if it's a weekday OR a working Saturday
                    if (dayOfWeek !== 0 && (!isSaturday || isWorkingSaturday)) {
                        if (!plannedMap[dateStr]) plannedMap[dateStr] = [];
                        if (!plannedMap[dateStr].includes(abbr)) {
                            plannedMap[dateStr].push(abbr);
                        }
                    }
                    d.setDate(d.getDate() + 1);
                }
            }
        });
        
        allDates.forEach(date => {
            const dayOfWeek = date.getDay();
            const dateStr = date.toISOString().split('T')[0];
            const isSunday = dayOfWeek === 0;
            const isSaturday = dayOfWeek === 6;
            const isWorkingSaturday = isSaturday && workingSaturdays.has(dateStr);
            const isWeekend = isSunday || (isSaturday && !isWorkingSaturday);
            
            const bgColor = isWeekend ? '#FFFF00' : 'white';
            const value = plannedMap[dateStr] ? plannedMap[dateStr].sort().join(',') : '';
            
            html += `<td style="border: 1px solid #000; padding: 6px; background: ${bgColor}; text-align: center; font-weight: bold; font-size: 9px; min-width: 50px; vertical-align: middle;">${value}</td>`;
        });
        html += '</tr>';
        
        // ==========================================
        // RESCHEDULE ROWS (1-4) - MATCHING BACKEND LOGIC
        // ==========================================
        const stageRescheduleMap = {1: {}, 2: {}, 3: {}, 4: {}};
        
        // Build reschedule map matching backend logic
        stages.forEach(stage => {
            const parts = stage.name.split('-');
            const stageAbbr = parts.length > 1 ? parts[parts.length - 1].trim() : stage.name.substring(0, 6);
            
            const taskReschedules = rescheduleHistory.filter(r => r.stage_id === stage.id);
            const uniqueNums = [...new Set(taskReschedules.map(r => r.reschedule_number).filter(n => n))].sort((a, b) => a - b);
            
            uniqueNums.forEach((rNum, idx) => {
                const targetRow = idx + 1;
                if (targetRow > 4) return;
                
                const eventTasks = taskReschedules.filter(t => t.reschedule_number === rNum);
                eventTasks.forEach(t => {
                    const dateStr = t.new_date.split('T')[0];
                    if (!stageRescheduleMap[targetRow][dateStr]) {
                        stageRescheduleMap[targetRow][dateStr] = [];
                    }
                    if (!stageRescheduleMap[targetRow][dateStr].includes(stageAbbr)) {
                        stageRescheduleMap[targetRow][dateStr].push(stageAbbr);
                    }
                });
            });
        });
        
        // Render reschedule rows
        for (let rNum = 1; rNum <= 4; rNum++) {
            html += '<tr style="height: 30px;">';
            html += '<td style="border: 1px solid #000; padding: 8px;"></td>';
            html += `<td style="border: 1px solid #000; padding: 8px; font-weight: bold; text-align: center;">Reschedule -${rNum}</td>`;
            
            const rData = stageRescheduleMap[rNum] || {};
            
            allDates.forEach(date => {
                const dayOfWeek = date.getDay();
                const dateStr = date.toISOString().split('T')[0];
                const isSunday = dayOfWeek === 0;
                const isSaturday = dayOfWeek === 6;
                const isWorkingSaturday = isSaturday && workingSaturdays.has(dateStr);
                const isWeekend = isSunday || (isSaturday && !isWorkingSaturday);
                
                const bgColor = isWeekend ? '#FFFF00' : 'white';
                const value = rData[dateStr] ? rData[dateStr].sort().join(',') : '';
                
                html += `<td style="border: 1px solid #000; padding: 6px; background: ${bgColor}; text-align: center; font-weight: bold; font-size: 9px; min-width: 50px; vertical-align: middle;">${value}</td>`;
            });
            html += '</tr>';
        }
        
        // ==========================================
        // ACTUAL ROW - MATCHING BACKEND LOGIC
        // ==========================================
        html += '<tr style="height: 40px;">';
        html += '<td style="border: 1px solid #000; padding: 8px;"></td>';
        html += '<td style="border: 1px solid #000; padding: 8px; background: #C0C0C0; font-weight: bold; text-align: center;">Actual</td>';
        
        const actualMap = {};
        const holdDatesMap = {};
        
        // Build maps matching backend logic - FIXED VERSION
        stages.forEach(stage => {
            const parts = stage.name.split('-');
            const abbr = parts.length > 1 ? parts[parts.length - 1].trim() : stage.name.substring(0, 6);
            const tasks = dailyTasks.filter(t => t.stage_id === stage.id);
            
            tasks.forEach(t => {
                const ds = t.scheduled_date.split('T')[0];
                const originalDs = t.original_date ? t.original_date.split('T')[0] : ds;
                
                // CRITICAL FIX: Only show in Actual row if:
                // 1. Task is on its ORIGINAL scheduled date (not rescheduled)
                // 2. OR task is completed (show on completion date regardless)
                const isOnOriginalDate = !t.original_date || t.original_date === t.scheduled_date;
                const isCompleted = t.status === 'completed';
                
                // Handle manual hold
                if (t.status === 'hold') {
                    if (!holdDatesMap[ds]) holdDatesMap[ds] = [];
                    if (!holdDatesMap[ds].includes(abbr)) {
                        holdDatesMap[ds].push(abbr);
                    }
                } else if (isOnOriginalDate || isCompleted) {
                    // Only add to Actual if it's on original date OR completed
                    if (!actualMap[ds]) actualMap[ds] = [];
                    actualMap[ds].push({abbr, status: t.status});
                }
                
                // Handle rescheduled hold - mark original date as HOLD
                if (t.original_date && t.original_date !== t.scheduled_date) {
                    const hds = t.original_date.split('T')[0];
                    if (!holdDatesMap[hds]) holdDatesMap[hds] = [];
                    if (!holdDatesMap[hds].includes(abbr)) {
                        holdDatesMap[hds].push(abbr);
                    }
                }
            });
        });
        
        allDates.forEach(date => {
            const dayOfWeek = date.getDay();
            const dateStr = date.toISOString().split('T')[0];
            const isSunday = dayOfWeek === 0;
            const isSaturday = dayOfWeek === 6;
            const isWorkingSaturday = isSaturday && workingSaturdays.has(dateStr);
            const isWeekend = isSunday || (isSaturday && !isWorkingSaturday);
            
            const active = actualMap[dateStr] || [];
            const activeAbbrs = new Set(active.map(x => x.abbr));
            const holdAbbrs = new Set(holdDatesMap[dateStr] || []);
            
            // Remove active tasks from holds
            const realHolds = [...holdAbbrs].filter(h => !activeAbbrs.has(h));
            
            const parts = [];
            if (realHolds.length > 0) {
                parts.push(`${realHolds.sort().join(',')}=HOLD`);
            }
            if (activeAbbrs.size > 0) {
                parts.push([...activeAbbrs].sort().join(','));
            }
            
            const value = parts.join(',');
            
            // Determine background color
            let bgColor = 'white';
            
            if (isWeekend) {
                bgColor = '#FFFF00'; // Yellow for weekends
            } else if (realHolds.length > 0) {
                bgColor = '#FFA500'; // Orange for hold
            } else if (activeAbbrs.size > 0) {
                const stats = new Set(active.map(x => x.status));
                if (stats.has('completed')) {
                    bgColor = '#00FF00'; // Green for completed
                } else if (stats.has('rescheduled')) {
                    bgColor = '#00FFFF'; // Cyan for rescheduled
                }
            }
            
            html += `<td style="border: 1px solid #000; padding: 6px; background: ${bgColor}; text-align: center; font-weight: bold; font-size: 9px; min-width: 50px; vertical-align: middle;">${value}</td>`;
        });
        html += '</tr>';
        
        // ==========================================
        // REMARKS ROW - NEW ADDITION TO MATCH EXCEL
        // ==========================================
        html += '<tr style="height: 60px;">';
        html += '<td style="border: 1px solid #000; padding: 8px;"></td>';
        html += '<td style="border: 1px solid #000; padding: 8px; font-weight: bold; font-style: italic; text-align: center;">Remarks</td>';
        
        allDates.forEach(date => {
            const dayOfWeek = date.getDay();
            const dateStr = date.toISOString().split('T')[0];
            const isSunday = dayOfWeek === 0;
            const isSaturday = dayOfWeek === 6;
            const isWorkingSaturday = isSaturday && workingSaturdays.has(dateStr);
            const isWeekend = isSunday || (isSaturday && !isWorkingSaturday);
            
            const active = actualMap[dateStr] || [];
            const activeAbbrs = new Set(active.map(x => x.abbr));
            const holdAbbrs = new Set(holdDatesMap[dateStr] || []);
            const realHolds = [...holdAbbrs].filter(h => !activeAbbrs.has(h));
            
            let remark = '';
            let bgColor = 'white';
            
            if (realHolds.length > 0) {
                remark = "Waiting for issue tracker";
                
                // Try to find the actual reason from tasks
                for (const stage of stages) {
                    const parts = stage.name.split('-');
                    const abbr = parts.length > 1 ? parts[parts.length - 1].trim() : stage.name.substring(0, 6);
                    
                    if (realHolds.includes(abbr)) {
                        // Check for manual hold
                        const task = dailyTasks.find(t => 
                            t.stage_id === stage.id && 
                            t.scheduled_date.split('T')[0] === dateStr && 
                            t.status === 'hold'
                        );
                        
                        // If not found, check for rescheduled hold
                        const rescheduleTask = task || dailyTasks.find(t => 
                            t.stage_id === stage.id && 
                            t.original_date && 
                            t.original_date.split('T')[0] === dateStr
                        );
                        
                        if (rescheduleTask && rescheduleTask.rescheduled_reason) {
                            remark = rescheduleTask.rescheduled_reason;
                            break;
                        }
                    }
                }
            } else if (isWeekend) {
                bgColor = '#FFFF00';
            }
            
            html += `<td style="border: 1px solid #000; padding: 6px; background: ${bgColor}; text-align: left; vertical-align: top; font-size: 9px; min-width: 50px; word-wrap: break-word;">${remark}</td>`;
        });
        html += '</tr>';
        
        // ==========================================
        // SPACING BEFORE LEGEND
        // ==========================================
        html += `<tr><td colspan="${allDates.length + 2}" style="border: none; height: 20px;"></td></tr>`;
        
        // ==========================================
        // LEGEND SECTION - MATCHING EXCEL EXACTLY
        // ==========================================
        html += '<tr style="height: 25px;">';
        html += '<td style="border: 1px solid #000; padding: 8px; background: #FFA500; min-width: 180px;"></td>';
        html += '<td style="border: 1px solid #000; padding: 8px; min-width: 150px;">Hold</td>';
        html += '<td colspan="2" style="border: 1px solid #000; padding: 8px;">If project goes on hold from Customer</td>';
        html += '</tr>';
        
        html += '<tr style="height: 25px;">';
        html += '<td style="border: 1px solid #000; padding: 8px; background: white;"></td>';
        html += '<td style="border: 1px solid #000; padding: 8px;">Changes</td>';
        html += '<td colspan="2" style="border: 1px solid #000; padding: 8px;"></td>';
        html += '</tr>';
        
        html += '<tr style="height: 25px;">';
        html += '<td style="border: 1px solid #000; padding: 8px; background: #FFFF00;"></td>';
        html += '<td style="border: 1px solid #000; padding: 8px;">Holidays</td>';
        html += '<td colspan="2" style="border: 1px solid #000; padding: 8px;"></td>';
        html += '</tr>';
        
        html += '</table></div>';
        
        // ==========================================
        // CREATE MODAL
        // ==========================================
        const completedTasksCount = dailyTasks.filter(t => t.status === 'completed').length;
        
        const modalHTML = `
            <div class="modal fade" id="exportPreviewModal" tabindex="-1">
                <div class="modal-dialog modal-fullscreen">
                    <div class="modal-content">
                        <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <h5 class="modal-title">ðŸ“Š Excel Preview - ${projData.name}</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" style="background: #f5f5f5; padding: 20px;">
                            ${html}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-2"></i>Close Preview
                            </button>
                            <button class="btn btn-success btn-lg" onclick="downloadExcelFromPreview(${projectId})">
                                <i class="fas fa-file-excel me-2"></i> Download Excel File
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        const existingModal = document.getElementById('exportPreviewModal');
        if (existingModal) existingModal.remove();
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        const modal = new bootstrap.Modal(document.getElementById('exportPreviewModal'));
        modal.show();
        
        document.getElementById('exportPreviewModal').addEventListener('hidden.bs.modal', function () {
            this.remove();
        });
        
        showNotification(`âœ… Preview loaded with ${stages.length} stages!`, 'success');
        
    } catch (error) {
        console.error('Preview error:', error);
        showNotification('âŒ Preview error: ' + error.message, 'error');
    }
}

// Keep these at the end
window.showExportPreview = showExcelPreview;
console.log('âœ… Excel Preview with stage data loaded!');

async function downloadExcelFromPreview(projectId) {
    try {
        showNotification('ðŸ“¥ Generating Excel file...', 'info');
        
        const response = await fetch(`/api/projects/${projectId}/export-excel`);
        
        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        
        const contentDisposition = response.headers.get('content-disposition');
        let filename = `Project_${projectId}_Tracker.xlsx`;
        
        if (contentDisposition) {
            const match = contentDisposition.match(/filename="?(.+)"?/i);
            if (match) filename = match[1];
        }
        
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        
        setTimeout(() => {
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }, 100);
        
        showNotification('âœ… Excel file downloaded: ' + filename, 'success');
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('exportPreviewModal'));
        if (modal) modal.hide();
        
    } catch (error) {
        console.error('Download error:', error);
        showNotification('âŒ Download failed: ' + error.message, 'error');
    }
}

window.showExportPreview = showExcelPreview;
console.log('âœ… Excel Preview with stage data loaded!');


// Override just the export function to work with the current preview
window.exportCurrentProject = async function(projectId) {
    try {
        console.log('Export button clicked for project:', projectId);
        showNotification('Preparing Excel export...', 'info');
        
        const response = await fetch(`/api/projects/${projectId}/export-excel`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `Project_${projectId}_${new Date().toISOString().split('T')[0]}.xlsx`;
        
        document.body.appendChild(a);
        a.click();
        
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showNotification('Excel file downloaded successfully!', 'success');
        
    } catch (error) {
        console.error('Export error:', error);
        showNotification('Export failed: ' + error.message, 'error');
    }
};

console.log('âœ… Export function fixed!');


// Load projects with caching
async function loadProjects() {
    try {
        const response = await fetch(`/api/projects?_t=${Date.now()}`, {
            cache: 'no-store',
            headers: {'Cache-Control': 'no-cache'}
        });
        projects = await response.json();
        allProjectsCache = projects;
        
        // Initial filter and display
        handleProjectSearch();
        
    } catch (error) {
        console.error('Error loading projects:', error);
        const container = document.getElementById('allProjectsSection');
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error loading jobs: ${error.message}
                <button class="btn btn-sm btn-outline-danger ms-3" onclick="loadProjects()">
                    <i class="fas fa-redo me-1"></i> Retry
                </button>
            </div>
        `;
    }
}
// âœ… NEW FUNCTION: Handle clicks on parallel stages
function setupParallelStageClickHandlers() {
    document.querySelectorAll('.stage-group-container').forEach(container => {
        // Add click event to the container
        container.addEventListener('click', function(e) {
            const stageStep = e.target.closest('.progress-step');
            
            if (stageStep && stageStep.getAttribute('data-in-parallel') === 'true') {
                const stageId = parseInt(stageStep.getAttribute('data-stage-id'));
                const projectId = parseInt(stageStep.getAttribute('data-project-id'));
                
                // Get current status from circle classes
                const circle = stageStep.querySelector('.step-circle');
                let currentStatus = 'pending';
                
                if (circle.classList.contains('completed')) {
                    currentStatus = 'completed';
                } else if (circle.classList.contains('active')) {
                    currentStatus = 'in-progress';
                }
                
                // Update the stage
                updateStageStatus(projectId, stageId, currentStatus);
            }
        });
        
        // Make parallel stages look clickable
        container.querySelectorAll('.progress-step[data-in-parallel="true"]').forEach(step => {
            step.style.cursor = 'pointer';
        });
    });
}

// Handle search with debouncing
function handleProjectSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        performSearch();
    }, 300); // Wait 300ms after user stops typing
}

// Perform the actual search and filter
function performSearch() {
    const searchTerm = document.getElementById('projectSearchInput').value.toLowerCase().trim();
    const statusFilter = document.getElementById('statusFilter').value;
    const sortBy = document.getElementById('sortBy').value;
    
    // Show/hide clear button
    document.getElementById('clearSearchBtn').style.display = searchTerm ? 'block' : 'none';
    
    // Filter projects
    filteredProjects = allProjectsCache.filter(project => {
        const matchesSearch = searchTerm === '' || 
            project.name.toLowerCase().includes(searchTerm) ||
            (project.description && project.description.toLowerCase().includes(searchTerm)) ||
            (project.start_date && project.start_date.includes(searchTerm)) ||
            (project.end_date && project.end_date.includes(searchTerm));
        
        const matchesStatus = statusFilter === '' || project.status === statusFilter;
        
        return matchesSearch && matchesStatus;
    });
    
    // Sort projects
    filteredProjects.sort((a, b) => {
        switch(sortBy) {
            case 'newest':
                return new Date(b.created_at || 0) - new Date(a.created_at || 0);
            case 'oldest':
                return new Date(a.created_at || 0) - new Date(b.created_at || 0);
            case 'name':
                return a.name.localeCompare(b.name);
            case 'progress':
                return (b.progress || 0) - (a.progress || 0);
            default:
                return 0;
        }
    });
    
    // Update results count
    document.getElementById('resultsCount').textContent = 
        `Showing ${filteredProjects.length} job${filteredProjects.length !== 1 ? 's' : ''}`;
    
    // Reset to first page
    currentPage = 1;
    
    // Display results
    displayPaginatedProjects();
}

// Display projects with pagination
async function displayPaginatedProjects() {
    const container = document.getElementById('allProjectsSection');
    
    if (filteredProjects.length === 0) {
        container.innerHTML = `
            <div class="no-results">
                <i class="fas fa-search"></i>
                <h5>No jobs found</h5>
                <p>Try adjusting your search or filters</p>
            </div>
        `;
        updatePaginationControls();
        return;
    }
    
    // Show loading spinner
    container.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
    
    // Calculate pagination
    const startIndex = (currentPage - 1) * projectsPerPage;
    const endIndex = startIndex + projectsPerPage;
    const projectsToDisplay = filteredProjects.slice(startIndex, endIndex);
    
    // Fetch details for visible projects only
    const projectsWithDetails = await Promise.all(
        projectsToDisplay.map(async (project) => {
            try {
                const response = await fetch(`/api/projects/${project.id}/details`);
                return await response.json();
            } catch (error) {
                console.error(`Error loading project ${project.id}:`, error);
                return null;
            }
        })
    );
    
    // Filter out failed requests
    const validProjects = projectsWithDetails.filter(p => p !== null);
    
    // Render projects
    renderProjectsWithStages(validProjects);
    
    // Update pagination controls
    updatePaginationControls();
}

// Update pagination controls
function updatePaginationControls() {
    const totalPages = Math.ceil(filteredProjects.length / projectsPerPage);
    const container = document.getElementById('allProjectsSection');
    
    let paginationHTML = '';
    
    if (totalPages > 1) {
        paginationHTML = `
            <div class="pagination-container">
                <button class="pagination-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                
                <span class="pagination-info">
                    Page ${currentPage} of ${totalPages}
                </span>
                
                <button class="pagination-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        `;
    }
    
    container.insertAdjacentHTML('beforeend', paginationHTML);
}

// Navigate to specific page
function goToPage(page) {
    const totalPages = Math.ceil(filteredProjects.length / projectsPerPage);
    
    if (page < 1 || page > totalPages) return;
    
    currentPage = page;
    displayPaginatedProjects();
    
    // Scroll to top of projects section
    document.getElementById('allProjectsSection').scrollIntoView({ behavior: 'smooth' });
}

// Clear search
function clearProjectSearch() {
    document.getElementById('projectSearchInput').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('sortBy').value = 'newest';
    handleProjectSearch();
}




// ============================================================================
// EDIT PROJECT FUNCTIONALITY
// ============================================================================

let isEditMode = false;
let editingProjectId = null;

async function openEditProjectModal(projectId, event) {
    if (event) event.stopPropagation();
    
    try {
        // â­ Clear any old cached data first â­
        window.originalProjectData = null;
        
        console.log('=== OPENING EDIT MODAL ===');
        console.log('Project ID:', projectId);
        
        showNotification('Loading job details...', 'info');
        
        // Fetch project details
        const timestamp = new Date().getTime();
        const response = await fetch(`/api/projects/${projectId}/details?_=${timestamp}`, {
            cache: 'no-cache',
            headers: {
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'
            }
        });        
        const project = await response.json();

        // â­ Store fresh original data â­
        window.originalProjectData = project;

        console.log('Loaded project:', project);
        
        // Set edit mode
        isEditMode = true;
        editingProjectId = projectId;
        
        console.log('Set isEditMode to:', isEditMode);
        console.log('Set editingProjectId to:', editingProjectId);
        
        // Update modal title
        document.querySelector('#projectModal .modal-title').textContent = 'Edit Job';
        
        // Update submit button text
        document.querySelector('#projectForm button[type="submit"]').textContent = 'Update Job';
        
        // Fill in basic project info
        document.getElementById('projectName').value = project.name;
        document.getElementById('projectStartDate').value = project.start_date;
        
        // Load working Saturdays
        workingSaturdays.clear();
        if (project.saturdayWorkingDays) {
            project.saturdayWorkingDays.forEach(date => workingSaturdays.add(date));
        }
        
        // Load employees first
        await loadEmployees();
        
        // Fill in members
        selectedMembers = project.members.map(m => m.id);
        const membersContainer = document.getElementById('selectedMembers');
        membersContainer.innerHTML = '';
        project.members.forEach(member => {
            const badge = document.createElement('span');
            badge.className = 'badge bg-primary me-2 mb-2';
            badge.innerHTML = `
                ${member.username}
                <i class="fas fa-times ms-2" style="cursor: pointer;" onclick="removeMember(${member.id})"></i>
            `;
            membersContainer.appendChild(badge);
        });
        
        // Clear stages container
        stageCounter = 0;
        document.getElementById('stagesContainer').innerHTML = '';
        
        // Load stages
        for (const stage of project.stages) {
            addEditStage(stage);
        }
        
        // Update projected end date
        if (typeof updateProjectEndDate === 'function') {
            updateProjectEndDate();
        }
        
        // Show modal
        projectModal.show();
        
        showNotification('Job loaded successfully', 'success');
        
    } catch (error) {
        console.error('Error loading project for edit:', error);
        showNotification('Error loading job details: ' + error.message, 'error');
    }
}

// Add stage for editing
function addEditStage(stageData) {
    const stageId = stageCounter++;
    const container = document.getElementById('stagesContainer');
    
    const stageDiv = document.createElement('div');
    stageDiv.id = `stage-${stageId}`;
    stageDiv.className = 'stage-item p-2 mb-2 border rounded';
    stageDiv.style.backgroundColor = '#f8f9fa';
    
    // âœ… Store database ID for updates
    if (stageData.id) {
        stageDiv.setAttribute('data-db-id', stageData.id);
    }
    
    // âœ… Store parallel_group_id for preservation during edits
    if (stageData.parallel_group_id) {
        stageDiv.setAttribute('data-parallel-group-id', stageData.parallel_group_id);
        console.log(`  ðŸ’¾ Stored parallel_group_id: ${stageData.parallel_group_id} for stage "${stageData.name}"`);
    }
    
    // âœ… NEW: Store original values for change detection
    if (stageData.name) {
        stageDiv.setAttribute('data-original-name', stageData.name);
    }
    if (stageData.duration_days) {
        stageDiv.setAttribute('data-original-duration', stageData.duration_days);
    }
    
    stageDiv.innerHTML = `
        <div class="d-flex align-items-start gap-2">
            <div style="min-width: 30px;">
                <input type="checkbox" class="form-check-input mt-1" id="stageCheck-${stageId}" checked>
            </div>
            <div class="flex-grow-1">
                <div class="row g-2">
                    <div class="col-md-6">
                        <input type="text" class="form-control form-control-sm" id="stageName-${stageId}" 
                               placeholder="Stage name" value="${stageData.name || ''}" style="font-size: 0.85rem;">
                    </div>
                    <div class="col-md-3">
                        <div class="input-group input-group-sm">
                            <input type="number" class="form-control" id="stageDuration-${stageId}" 
                                   value="${stageData.duration_days || 1}" min="1" onchange="updateProjectEndDate()" style="font-size: 0.85rem;">
                            <span class="input-group-text" style="font-size: 0.75rem;">days</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select form-select-sm" id="stageManager-${stageId}" style="font-size: 0.85rem;">
                            <option value="">No manager</option>
                        </select>
                    </div>
                </div>
                <div class="row g-2 mt-1">
                    <div class="col-md-6">
                        <input type="date" class="form-control form-control-sm" id="stageStartDate-${stageId}" 
                               value="${stageData.start_date || ''}"
                               data-is-custom="${stageData.start_date ? 'true' : 'false'}"
                               onchange="this.setAttribute('data-is-custom','true'); updateProjectEndDate();" style="font-size: 0.85rem;">
                        <small class="text-muted" style="font-size: 0.7rem;">Custom start (optional)</small>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-danger" onclick="removeStage(${stageId})" style="font-size: 0.75rem;">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    
    container.appendChild(stageDiv);
    
    // Populate manager dropdown
    const managerSelect = document.getElementById(`stageManager-${stageId}`);
    if (typeof employees !== 'undefined' && employees && employees.length > 0) {
        employees.forEach(emp => {
            const option = document.createElement('option');
            option.value = emp.id;
            option.textContent = `${emp.username} (${emp.role})`;
            if (stageData.manager_id && emp.id === stageData.manager_id) {
                option.selected = true;
            }
            managerSelect.appendChild(option);
        });
    }
}

// ============================================================================
// PROGRESS LINE STATUS UPDATE FUNCTIONALITY
// ============================================================================

// Update progress line with calendar status
async function updateProgressLineStatus(projectId) {
    try {
        console.log(`[Progress Line] Fetching status for project ${projectId}...`);
        const response = await fetch(`/api/projects/${projectId}/stage-status`);
        const data = await response.json();
        
        if (data.success) {
            console.log(`[Progress Line] Received ${data.stages.length} stages:`, data.stages);
            
            let updatedCount = 0;
            data.stages.forEach(stage => {
                // Find the circle element for this stage
                const stepElement = document.querySelector(`[data-stage-id="${stage.id}"]`);
                const circleElement = stepElement ? stepElement.querySelector('.step-circle') : null;
                
                if (circleElement) {
                    // Remove all status classes
                    circleElement.classList.remove(
                        'not-started', 
                        'in-progress', 
                        'completed', 
                        'completed-rescheduled',
                        'overdue',
                        'active'  // Remove legacy class
                    );
                    
                    // Add new status class
                    circleElement.classList.add(stage.status);
                    updatedCount++;
                    
                    console.log(`[Progress Line] âœ“ Updated stage "${stage.name}" (ID: ${stage.id}) to ${stage.status} (rescheduled: ${stage.was_rescheduled})`);
                    
                    // Optional: Add tooltip with details
                    let tooltipText = `${stage.name}\nStatus: ${stage.status}\nProgress: ${stage.progress}%`;
                    if (stage.was_rescheduled) {
                        tooltipText += `\nRescheduled ${stage.reschedule_count} time(s)`;
                    }
                    circleElement.title = tooltipText;
                } else {
                    console.warn(`[Progress Line] âš ï¸ Could not find element for stage "${stage.name}" (ID: ${stage.id})`);
                }
            });
            
            console.log(`[Progress Line] âœ… Updated ${updatedCount}/${data.stages.length} circles`);
        } else {
            console.error('[Progress Line] API returned success: false', data);
        }
    } catch (error) {
        console.error('[Progress Line] Error updating progress line status:', error);
    }
}

// Auto-refresh progress line every 30 seconds
let progressRefreshIntervals = {};

function startProgressLineAutoRefresh(projectId) {
    // Clear existing interval for this project
    if (progressRefreshIntervals[projectId]) {
        clearInterval(progressRefreshIntervals[projectId]);
    }
    
    // Initial update
    updateProgressLineStatus(projectId);
    
    // Set up auto-refresh
    progressRefreshIntervals[projectId] = setInterval(() => {
        updateProgressLineStatus(projectId);
    }, 30000); // Refresh every 30 seconds
}

// Stop auto-refresh when needed
function stopProgressLineAutoRefresh(projectId) {
    if (progressRefreshIntervals[projectId]) {
        clearInterval(progressRefreshIntervals[projectId]);
        delete progressRefreshIntervals[projectId];
    }
}

// Stop all auto-refresh intervals
function stopAllProgressLineAutoRefresh() {
    Object.keys(progressRefreshIntervals).forEach(projectId => {
        stopProgressLineAutoRefresh(projectId);
    });
}


// Helper function to reset form
function resetProjectForm() {
    document.getElementById('projectForm').reset();
    document.getElementById('stagesContainer').innerHTML = '';
    document.getElementById('selectedMembers').innerHTML = '';
    document.querySelector('#projectModal .modal-title').textContent = 'Create New Job';
    document.querySelector('#projectForm button[type="submit"]').textContent = 'Create Job';
    stageCounter = 0;
    selectedMembers = [];
    workingSaturdays.clear();
    isEditMode = false;
    editingProjectId = null;
    
    // âœ… ADD THESE TWO LINES - Clear cached data
    window.originalProjectData = null;
    currentProjectData = null;
}</script>
</body>
</html>
